<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电子课本 - Alex的学习助手</title>
    <link rel="icon" href="assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Dropdown Menu Styles */
        .main-nav ul li {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #fff;
            min-width: 180px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 100;
            padding: 10px 0;
            display: block;
            flex-direction: column;
        }

        .main-nav ul li:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu li {
            display: block;
            width: 100%;
            float: none;
            margin: 0;
            padding: 0;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 20px;
            color: #333;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
            white-space: nowrap;
            box-sizing: border-box;
        }

        .dropdown-menu a:hover {
            background-color: rgba(67, 97, 238, 0.1);
            color: #4361ee;
        }

        /* Add dropdown indicator */
        .has-dropdown > a::after {
            content: "\f107";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            margin-left: 5px;
            font-size: 0.8rem;
        }

        /* Mobile dropdown adjustments */
        @media (max-width: 768px) {
            .dropdown-menu {
                position: static;
                background-color: rgba(67, 97, 238, 0.05);
                box-shadow: none;
                display: none;
                opacity: 1;
                visibility: visible;
                transform: none;
                padding: 0;
                margin-top: 5px;
                border-radius: 5px;
            }
            
            .main-nav.active ul li.has-dropdown.open .dropdown-menu {
                display: block;
            }
            
            .has-dropdown > a {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
        }

        /* Make sure dropdown menu UL doesn't inherit flex properties */
        .main-nav ul li .dropdown-menu {
            display: block;
            flex-direction: column;
        }
        
        /* Override the flex layout from main nav for dropdown */
        .main-nav ul.dropdown-menu {
            display: block;
            flex-direction: column;
            gap: 0;
        }

        /* COMPREHENSIVE FIX FOR DROPDOWN MENU */
        /* Reset flex display for the dropdown menu */
        .main-nav ul.dropdown-menu,
        nav.main-nav ul.dropdown-menu {
            display: block !important;
            flex-direction: column !important;
            gap: 0 !important;
            width: 100% !important;
        }
        
        /* Ensure dropdown items are stacked */
        .main-nav ul.dropdown-menu li,
        nav.main-nav ul.dropdown-menu li {
            display: block !important;
            width: 100% !important;
            float: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Make dropdown links full width */
        .main-nav ul.dropdown-menu li a,
        nav.main-nav ul.dropdown-menu li a {
            display: block !important;
            padding: 10px 20px !important;
            width: 100% !important;
            text-align: left !important;
            box-sizing: border-box !important;
        }
        
        /* Textbook page specific styles */
        .textbook-section {
            padding: 40px 0;
        }
        
        .textbook-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .textbook-header h1 {
            color: #2c3e50;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .textbook-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .filter-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .filter-group select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            font-size: 1rem;
            color: #333;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234361ee' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: calc(100% - 12px) center;
        }
        
        .filter-group select:focus {
            border-color: #4361ee;
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .filter-actions {
            display: flex;
            justify-content: center;
        }
        
        .filter-actions button {
            background: linear-gradient(135deg, #4361ee, #7209b7);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }
        
        .filter-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3);
        }
        
        .file-list {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 30px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .file-list h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .file-item:hover {
            background-color: rgba(67, 97, 238, 0.08);
        }
        
        .file-item .file-icon {
            margin-right: 12px;
            color: #e74c3c;
            font-size: 1.2rem;
        }
        
        .file-item .file-name {
            flex: 1;
            font-weight: 500;
            color: #333;
        }
        
        .file-item .file-info {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .no-files-message {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .pdf-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            height: 800px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .pdf-viewer-wrapper {
            height: 100%;
        }
        
        /* Log panel styles */
        .log-panel {
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            padding: 15px;
            margin-bottom: 30px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #333;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-panel h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #7f8c8d;
            margin-right: 10px;
        }
        
        .log-message {
            color: #2c3e50;
        }
        
        .log-path {
            color: #e74c3c;
            word-break: break-all;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .pdf-container {
                height: 600px;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span class="gradient-text">Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="index.html">首页</a></li>
                        <li class="has-dropdown">
                            <a href="#subjects">科目</a>
                            <ul class="dropdown-menu">
                                <li><a href="subjects/chinese/main.html">语文</a></li>
                                <li><a href="subjects/math/main.html">数学</a></li>
                                <li><a href="subjects/english/main.html">英语</a></li>
                                <li><a href="subjects/history/main.html">历史</a></li>
                            </ul>
                        </li>
                        <li><a href="textbook.html" class="active">电子课本</a></li>
                        <li class="has-dropdown">
                            <a href="tts.html">语音</a>
                            <ul class="dropdown-menu">
                                <li><a href="tts.html">语音转换</a></li>
                                <li><a href="tts_dialog.html">对话语音</a></li>
                            </ul>
                        </li>
                        <li><a href="draw.html">绘图</a></li>
                    </ul>
                </nav>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <section class="textbook-section">
            <div class="container">
                <div class="textbook-header">
                    <h1>电子课本</h1>
                    <p>查找并浏览各学科、各年级的官方电子课本。在线阅读，随时随地学习更便捷。</p>
                </div>
                
                <div class="filter-container">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="subject-filter">选择学科</label>
                            <select id="subject-filter">
                                <option value="">全部学科</option>
                                <option value="Chinese">语文</option>
                                <option value="Maths">数学</option>
                                <option value="English">英语</option>
                                <option value="History">历史</option>
                                <option value="Geography">地理</option>
                                <option value="Biology">生物</option>
                                <option value="Chemistry">化学</option>
                                <option value="Physics">物理</option>
                                <option value="Politics">政治</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="grade-filter">选择年级</label>
                            <select id="grade-filter">
                                <option value="">全部年级</option>
                                <option value="Grade 1">一年级</option>
                                <option value="Grade 2">二年级</option>
                                <option value="Grade 3">三年级</option>
                                <option value="Grade 4">四年级</option>
                                <option value="Grade 5">五年级</option>
                                <option value="Grade 6">六年级</option>
                                <option value="Grade 7">七年级</option>
                                <option value="Grade 8">八年级</option>
                                <option value="Grade 9">九年级</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button id="filter-button">筛选课本</button>
                    </div>
                </div>
                
                <div class="log-panel" id="log-panel">
                    <h3>检索日志</h3>
                    <div id="log-entries">
                        <!-- Log entries will be added here by JavaScript -->
                    </div>
                </div>
                
                <div class="file-list" id="pdf-file-list">
                    <h3>课本列表</h3>
                    <div class="no-files-message">请选择学科和年级进行筛选</div>
                    <!-- File items will be populated here by JavaScript -->
                </div>
                
                <div id="pdf-viewer-container"></div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <p class="copyright-text">study-llm.me域名为Alex所有。保留所有权利。</p>
            </div>
        </div>
    </footer>
    
    <!-- Load the PDF reader script -->
    <script src="js/pdf-reader.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const subjectFilter = document.getElementById('subject-filter');
            const gradeFilter = document.getElementById('grade-filter');
            const filterButton = document.getElementById('filter-button');
            const pdfFileList = document.getElementById('pdf-file-list');
            const logPanel = document.getElementById('log-entries');
            
            // Log a message with timestamp
            function logMessage(message, path = null) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                let logContent = `<span class="log-time">[${timeString}]</span> <span class="log-message">${message}</span>`;
                if (path) {
                    logContent += ` <span class="log-path">${path}</span>`;
                }
                
                logEntry.innerHTML = logContent;
                logPanel.appendChild(logEntry);
                
                // Auto-scroll to the bottom
                logPanel.scrollTop = logPanel.scrollHeight;
            }
            
            // Function to scan directory for PDF files
            async function scanDirectory(subject, grade) {
                const baseDir = `assets/textbook/${subject}/${grade}`;
                logMessage(`正在检索目录:`, baseDir);
                
                try {
                    // In a real environment, this would make a server request to list files
                    // For demonstration, we'll simulate finding files based on common patterns
                    
                    // In a production environment, you would replace this with actual file system scanning
                    // This is just a simulation for the demonstration
                    
                    const files = [];
                    
                    if (subject === 'Chinese') {
                        if (grade === 'Grade 1') {
                            files.push({name: '语文一年级上册', filename: 'yuwen_1_1.pdf'});
                            files.push({name: '语文一年级下册', filename: 'yuwen_1_2.pdf'});
                            logMessage(`找到文件:`, `${baseDir}/yuwen_1_1.pdf`);
                            logMessage(`找到文件:`, `${baseDir}/yuwen_1_2.pdf`);
                        } else if (grade === 'Grade 2') {
                            files.push({name: '语文二年级上册', filename: 'yuwen_2_1.pdf'});
                            files.push({name: '语文二年级下册', filename: 'yuwen_2_2.pdf'});
                            logMessage(`找到文件:`, `${baseDir}/yuwen_2_1.pdf`);
                            logMessage(`找到文件:`, `${baseDir}/yuwen_2_2.pdf`);
                        }
                    } else if (subject === 'Maths') {
                        if (grade === 'Grade 1') {
                            files.push({name: '数学一年级上册', filename: 'shuxue_1_1.pdf'});
                            files.push({name: '数学一年级下册', filename: 'shuxue_1_2.pdf'});
                            logMessage(`找到文件:`, `${baseDir}/shuxue_1_1.pdf`);
                            logMessage(`找到文件:`, `${baseDir}/shuxue_1_2.pdf`);
                        } else if (grade === 'Grade 2') {
                            files.push({name: '数学二年级上册', filename: 'shuxue_2_1.pdf'});
                            files.push({name: '数学二年级下册', filename: 'shuxue_2_2.pdf'});
                            logMessage(`找到文件:`, `${baseDir}/shuxue_2_1.pdf`);
                            logMessage(`找到文件:`, `${baseDir}/shuxue_2_2.pdf`);
                        }
                    } else if (subject === 'English') {
                        if (grade === 'Grade 3') {
                            files.push({name: '英语三年级上册', filename: 'english_3_1.pdf'});
                            files.push({name: '英语三年级下册', filename: 'english_3_2.pdf'});
                            logMessage(`找到文件:`, `${baseDir}/english_3_1.pdf`);
                            logMessage(`找到文件:`, `${baseDir}/english_3_2.pdf`);
                        } else if (grade === 'Grade 4') {
                            files.push({name: '英语四年级上册', filename: 'english_4_1.pdf'});
                            files.push({name: '英语四年级下册', filename: 'english_4_2.pdf'});
                            logMessage(`找到文件:`, `${baseDir}/english_4_1.pdf`);
                            logMessage(`找到文件:`, `${baseDir}/english_4_2.pdf`);
                        }
                    } else if (subject === 'History') {
                        if (grade === 'Grade 7') {
                            files.push({name: '历史七年级上册', filename: 'history_7_1.pdf'});
                            files.push({name: '历史七年级下册', filename: 'history_7_2.pdf'});
                            logMessage(`找到文件:`, `${baseDir}/history_7_1.pdf`);
                            logMessage(`找到文件:`, `${baseDir}/history_7_2.pdf`);
                        } else if (grade === 'Grade 8') {
                            files.push({name: '历史八年级上册', filename: 'history_8_1.pdf'});
                            files.push({name: '历史八年级下册', filename: 'history_8_2.pdf'});
                            logMessage(`找到文件:`, `${baseDir}/history_8_1.pdf`);
                            logMessage(`找到文件:`, `${baseDir}/history_8_2.pdf`);
                        }
                    }
                    
                    // Log summary
                    logMessage(`检索完成，共找到 ${files.length} 个文件`);
                    
                    return files;
                } catch (error) {
                    logMessage(`检索错误:`, error.message);
                    return [];
                }
            }
            
            // Filter textbooks based on selected subject and grade
            async function filterTextbooks() {
                const subject = subjectFilter.value;
                const grade = gradeFilter.value;
                
                // Clear previous log entries
                logPanel.innerHTML = '';
                
                // Clear file list and show loading message
                pdfFileList.innerHTML = '<h3>课本列表</h3><div class="no-files-message">正在检索课本...</div>';
                
                // Log search criteria
                if (subject && grade) {
                    logMessage(`正在检索 ${getSubjectName(subject)} ${getGradeName(grade)} 课本`);
                } else if (subject) {
                    logMessage(`正在检索所有 ${getSubjectName(subject)} 课本`);
                } else if (grade) {
                    logMessage(`正在检索所有 ${getGradeName(grade)} 课本`);
                } else {
                    logMessage(`正在检索所有课本`);
                }
                
                // Build a list of directories to search
                const subjectsToSearch = subject ? [subject] : ['Chinese', 'Maths', 'English', 'History', 'Geography', 'Biology', 'Chemistry', 'Physics', 'Politics'];
                const gradesToSearch = grade ? [grade] : ['Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9'];
                
                let allFiles = [];
                
                // Scan all relevant directories
                for (const subj of subjectsToSearch) {
                    for (const grd of gradesToSearch) {
                        const files = await scanDirectory(subj, grd);
                        files.forEach(file => {
                            allFiles.push({
                                subject: subj,
                                grade: grd,
                                name: file.name,
                                file: file.filename
                            });
                        });
                    }
                }
                
                displayFilteredBooks(allFiles);
            }
            
            // Display the filtered books in the file list
            function displayFilteredBooks(books) {
                pdfFileList.innerHTML = '<h3>课本列表</h3>';
                
                if (books.length === 0) {
                    pdfFileList.innerHTML += '<div class="no-files-message">没有找到符合条件的课本</div>';
                    logMessage(`没有找到符合条件的课本`);
                    return;
                }
                
                books.forEach(book => {
                    const filePath = `assets/textbook/${book.subject}/${book.grade}/${book.file}`;
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.path = filePath;
                    fileItem.dataset.name = book.name;
                    
                    fileItem.innerHTML = `
                        <i class="fas fa-file-pdf file-icon"></i>
                        <span class="file-name">${book.name}</span>
                        <span class="file-info">${getGradeName(book.grade)} | ${getSubjectName(book.subject)}</span>
                    `;
                    
                    fileItem.addEventListener('click', function() {
                        loadPdf(filePath, book.name);
                        logMessage(`正在加载PDF文件:`, filePath);
                    });
                    
                    pdfFileList.appendChild(fileItem);
                });
            }
            
            // Get localized subject name
            function getSubjectName(subjectCode) {
                const subjectMap = {
                    'Chinese': '语文',
                    'Maths': '数学',
                    'English': '英语',
                    'History': '历史',
                    'Geography': '地理',
                    'Biology': '生物',
                    'Chemistry': '化学',
                    'Physics': '物理',
                    'Politics': '政治'
                };
                
                return subjectMap[subjectCode] || subjectCode;
            }
            
            // Get localized grade name
            function getGradeName(gradeCode) {
                const gradeMap = {
                    'Grade 1': '一年级',
                    'Grade 2': '二年级',
                    'Grade 3': '三年级',
                    'Grade 4': '四年级',
                    'Grade 5': '五年级',
                    'Grade 6': '六年级',
                    'Grade 7': '七年级',
                    'Grade 8': '八年级',
                    'Grade 9': '九年级'
                };
                
                return gradeMap[gradeCode] || gradeCode;
            }
            
            // Load a PDF file
            function loadPdf(filePath, title) {
                // Check if PDFReader is initialized
                if (window.PDFReader) {
                    try {
                        // Load PDF with options
                        window.PDFReader.loadPDF(filePath, {
                            initialPage: 1,
                            scale: 1.0,
                            lazyLoad: true,
                            preloadPages: 2,
                            cacheSize: 10
                        });
                        
                        logMessage(`PDF加载成功:`, title);
                    } catch (error) {
                        console.error('Error loading PDF:', error);
                        logMessage(`PDF加载失败:`, error.message);
                        alert('无法加载PDF文件。请检查文件路径是否正确或刷新页面重试。');
                    }
                } else {
                    console.error('PDF Reader not initialized');
                    logMessage(`PDF阅读器未初始化`);
                    alert('PDF阅读器未正确初始化。请刷新页面重试。');
                }
            }
            
            // Add event listeners
            filterButton.addEventListener('click', filterTextbooks);
            
            // Mobile menu toggle
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const mainNav = document.querySelector('.main-nav');
            
            if (mobileMenuToggle && mainNav) {
                mobileMenuToggle.addEventListener('click', function() {
                    mainNav.classList.toggle('active');
                    this.classList.toggle('active');
                });
            }
            
            // Initialize with welcome message
            logMessage(`欢迎使用电子课本检索系统，请选择科目和年级进行筛选`);
        });
    </script>
</body>
</html> 