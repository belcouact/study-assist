<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学 - 学习助手</title>
    <link rel="icon" href="../../assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/utilities.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- MathJax will be loaded dynamically when needed -->
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../../index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span>Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="../../index.html#subjects">科目</a></li>
                        <li><a href="https://study-llm.me/draw">AI绘图</a></li>
                        <li><a href="../../index.html#quote">名言</a></li>
                        <li><a href="../../index.html#about">关于</a></li>
                    </ul>
                </nav>
                <div class="profile-section">
                    <button id="profile-button" class="profile-button">
                        <i class="fas fa-user-circle"></i>
                        学习阶段
                    </button>
                    <div id="profile-display" class="profile-display"></div>
                </div>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- 英雄部分 -->
        <section class="subject-hero">
            <div class="container">
                <div class="subject-hero-content">
                    <h1>数学<span class="gradient-text">学习</span></h1>
                    <p class="subject-description">在DeepSeek AI的辅助下探索数学。获取解题帮助、通过个性化测验练习，并按照自己的节奏掌握数学概念。</p>
                </div>
            </div>
        </section>

        <!-- 数学主题部分 -->
        <section class="topics-section">
            <div class="container">
                <div class="section-header">
                    <h2>探索数学<span class="gradient-text">主题</span></h2>
                    <p>选择一个主题，开始使用AI辅助学习</p>
                </div>
                <div class="topics-grid">
                    <div class="topic-card" data-topic="algebra">
                        <div class="topic-icon">
                            <img src="../../assets/icons/algebra-icon.svg" alt="代数图标">
                        </div>
                        <h3>代数</h3>
                        <p>方程、函数和多项式</p>
                    </div>
                    <div class="topic-card" data-topic="geometry">
                        <div class="topic-icon">
                            <img src="../../assets/icons/geometry-icon.svg" alt="几何图标">
                        </div>
                        <h3>几何</h3>
                        <p>形状、角度和空间推理</p>
                    </div>
                    <div class="topic-card" data-topic="calculus">
                        <div class="topic-icon">
                            <img src="../../assets/icons/calculus-icon.svg" alt="微积分图标">
                        </div>
                        <h3>微积分</h3>
                        <p>导数、积分和极限</p>
                    </div>
                    <div class="topic-card" data-topic="statistics">
                        <div class="topic-icon">
                            <img src="../../assets/icons/statistics-icon.svg" alt="统计学图标">
                        </div>
                        <h3>统计学</h3>
                        <p>数据分析、概率和分布</p>
                    </div>
                    <div class="topic-card" data-topic="arithmetic">
                        <div class="topic-icon">
                            <img src="../../assets/icons/arithmetic-icon.svg" alt="算术图标">
                        </div>
                        <h3>算术</h3>
                        <p>基本运算和数论</p>
                    </div>
                    <div class="topic-card" data-topic="trigonometry">
                        <div class="topic-icon">
                            <img src="../../assets/icons/trigonometry-icon.svg" alt="三角学图标">
                        </div>
                        <h3>三角学</h3>
                        <p>正弦、余弦和三角关系</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI数学助手部分 -->
        <section class="ai-assistant-section">
            <div class="container">
                <div class="section-header">
                    <h2>AI数学<span class="gradient-text">助手</span></h2>
                    <p>获取数学问题和习题的帮助</p>
                </div>
                <div class="chat-container">
                    <div class="chat-header">
                        <img src="../../assets/icons/math-assistant-icon.svg" alt="数学助手图标">
                        <h3>DeepSeek数学助手</h3>
                    </div>
                    <div class="chat-messages" id="math-chat-messages">
                        <div class="message message-ai">
                            <p>你好！我是你的DeepSeek数学助手。今天我能如何帮助你学习数学？</p>
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="math-question-input" placeholder="在此输入您的数学问题...">
                        <button class="btn btn-primary" id="send-math-question">提问</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 数学练习测验部分 -->
        <section class="quiz-section bg-light">
            <div class="container">
                <div class="section-header">
                    <h2>通过<span class="gradient-text">AI测验</span>练习</h2>
                    <p>用DeepSeek AI生成的个性化测验测试您的数学知识</p>
                </div>
                <div class="quiz-generator">
                    <div class="quiz-controls">
                        <div class="form-group">
                            <label for="quiz-topic">主题</label>
                            <select id="quiz-topic" class="form-control">
                                <option value="algebra">代数</option>
                                <option value="geometry">几何</option>
                                <option value="calculus">微积分</option>
                                <option value="statistics">统计学</option>
                                <option value="arithmetic">算术</option>
                                <option value="trigonometry">三角学</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quiz-difficulty">难度</label>
                            <select id="quiz-difficulty" class="form-control">
                                <option value="easy">简单</option>
                                <option value="medium" selected>中等</option>
                                <option value="hard">困难</option>
                                <option value="complex">复杂</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quiz-questions">问题数量</label>
                            <select id="quiz-questions" class="form-control">
                                <option value="5">5个问题</option>
                                <option value="10">10个问题</option>
                                <option value="15">15个问题</option>
                            </select>
                        </div>
                        <div class="quiz-actions">
                            <button id="generate-quiz" class="btn btn-primary">生成测验</button>
                        </div>
                    </div>
                    
                    <div id="quiz-container" class="quiz-content">
                        <p class="text-center">配置您的测验选项并点击"生成测验"开始练习。</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 数学常用公式部分 -->
        <section class="common-formulas bg-light">
            <div class="container">
                <div class="section-header">
                    <h2>数学<span class="gradient-text">常用公式</span></h2>
                    <p>根据您的学习阶段展示相关的数学公式和解释</p>
                </div>
                <div class="formula-content" style="min-height: 400px;">
                    <!-- Lazy load placeholder -->
                    <div id="formula-loading-placeholder" class="text-center py-4">
                        <p>加载公式中...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 数学概念可视化部分 -->
        <section class="visualizer-section">
            <div class="container">
                <div class="section-header">
                    <h2>数学概念<span class="gradient-text">可视化</span></h2>
                    <p>通过交互式可视化探索数学概念</p>
                </div>
                <div class="visualizer-container">
                    <div class="visualizer-controls">
                        <div class="form-group">
                            <label for="visualizer-topic">选择概念</label>
                            <select id="visualizer-topic" class="form-control">
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <button id="load-visualization" class="btn btn-primary">加载可视化</button>
                    </div>
                    <div id="visualization-container" class="visualization-display">
                        <!-- Visualization will be loaded here -->
                        <div class="text-center py-4">可视化加载时请等待...</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Alex的学习助手。保留所有权利。</p>
            </div>
        </div>
    </footer>

    <script src="../../js/common.js"></script>
    <script src="../../js/navigation.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/profile.js"></script>
    <script src="../../js/education-level.js"></script>
    
    <!-- Defer loading of heavy libraries -->
    <script>
        // Global initialization flag to prevent duplicate initialization
        window.scriptInitialized = false;
        
        // Function to load script with fallback
        function loadScript(src, callback, fallbackSrc) {
            const script = document.createElement('script');
            script.src = src;
            script.defer = true;
            script.onerror = function() {
                console.warn(`Failed to load script from ${src}, trying fallback...`);
                if (fallbackSrc) {
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = fallbackSrc;
                    fallbackScript.defer = true;
                    fallbackScript.onload = function() {
                        if (callback) callback();
                    };
                    fallbackScript.onerror = function() {
                        console.error(`Failed to load fallback script from ${fallbackSrc}`);
                        // Still call callback to avoid blocking the page
                        if (callback) callback();
                    };
                    document.body.appendChild(fallbackScript);
                } else if (callback) {
                    callback(); // Call callback even if script fails to load
                }
            };
            script.onload = function() {
                if (callback) callback();
            };
            document.body.appendChild(script);
        }
        
        // Load MathJax only when needed
        let mathJaxLoaded = false;
        function loadMathJax(callback) {
            if (mathJaxLoaded) {
                if (callback) callback();
                return;
            }
            
            // Configure MathJax first
            window.MathJax = window.MathJax || {
                tex: {
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                svg: {
                    fontCache: 'global'
                },
                startup: {
                    typeset: false
                }
            };
            
            // Skip external CDN and use local polyfill directly
            loadScript('../../libs/polyfill/polyfill.min.js', function() {
                // Then attempt to load MathJax (with fallback)
                loadScript('https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js', function() {
                    mathJaxLoaded = true;
                    if (callback) callback();
                }, '../../libs/mathjax/tex-mml-chtml.js');
            });
        }
        
        // Lazy load Plotly only when needed
        let plotlyLoaded = false;
        function loadPlotly(callback) {
            if (plotlyLoaded) {
                if (callback) callback();
                return;
            }
            
            // Use local Plotly directly to avoid network issues
            loadScript('../../libs/plotly/plotly.min.js', function() {
                plotlyLoaded = true;
                if (callback) callback();
            });
        }
        
        // Add basic error handling for all visualizations
        function handleVisualizationError(container, error) {
            container.innerHTML = `
                <div style="padding: 20px; background-color: #fff3f3; border-radius: 8px; text-align: center;">
                    <h4 style="color: #cc0000;">加载可视化时出现错误</h4>
                    <p>请检查您的网络连接或使用简化版本</p>
                    <p style="font-size: 0.8em; color: #777;">${error?.message || '无法加载外部资源'}</p>
                </div>
            `;
        }
        
        // Initialize app components safely
        function initializeComponents() {
            if (window.scriptInitialized) return;
            
            try {
                if (window.initTopicCards) window.initTopicCards();
                if (window.initMathAssistant) window.initMathAssistant();
                if (window.initQuizGenerator) window.initQuizGenerator();
                if (window.initFormulaSelector) window.initFormulaSelector();
                window.scriptInitialized = true;
            } catch (e) {
                console.error('Error initializing page components:', e);
            }
        }
        
        // Initialize intersection observer for lazy loading
        document.addEventListener('DOMContentLoaded', function() {
            const formulaSection = document.querySelector('.common-formulas');
            const visualizerSection = document.querySelector('.visualizer-section');
            
            // Load main script first
            loadScript('script.js', function() {
                // Initialize basic components once script is loaded
                initializeComponents();
                
                // Only set up observers if IntersectionObserver is supported
                if (window.IntersectionObserver) {
                    // Create observer for lazy loading
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                if (entry.target === formulaSection) {
                                    // Load MathJax and initialize formulas when section becomes visible
                                    loadMathJax(() => {
                                        try {
                                            // Initialize formulas specifically
                                            if (window.initCommonFormulas) {
                                                window.initCommonFormulas();
                                            } else {
                                                // Simple fallback for formulas if script fails
                                                const formulaContent = document.querySelector('.formula-content');
                                                if (formulaContent) {
                                                    formulaContent.innerHTML = `
                                                        <div style="background: white; padding: 20px; border-radius: 8px;">
                                                            <h3>基础数学公式</h3>
                                                            <p>加载完整公式集失败。以下是常用公式：</p>
                                                            <ul style="list-style: none; padding: 0;">
                                                                <li style="padding: 10px; border-bottom: 1px solid #eee;">
                                                                    <strong>二次公式：</strong> x = (-b ± √(b² - 4ac)) / 2a
                                                                </li>
                                                                <li style="padding: 10px; border-bottom: 1px solid #eee;">
                                                                    <strong>勾股定理：</strong> a² + b² = c²
                                                                </li>
                                                                <li style="padding: 10px; border-bottom: 1px solid #eee;">
                                                                    <strong>三角函数：</strong> sin²θ + cos²θ = 1
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    `;
                                                }
                                            }
                                        } catch (e) {
                                            console.error('Error initializing formulas:', e);
                                        }
                                    });
                                    observer.unobserve(formulaSection);
                                } else if (entry.target === visualizerSection) {
                                    // Load Plotly when visualization section becomes visible
                                    loadPlotly(() => {
                                        try {
                                            if (window.initVisualization && !window.visualizationInitialized) {
                                                window.initVisualization();
                                                window.visualizationInitialized = true;
                                            } else if (!window.Plotly) {
                                                // Simple fallback if Plotly fails to load
                                                const container = document.getElementById('visualization-container');
                                                handleVisualizationError(container, new Error('无法加载可视化库'));
                                            }
                                        } catch (e) {
                                            console.error('Error initializing visualization:', e);
                                            const container = document.getElementById('visualization-container');
                                            if (container) {
                                                handleVisualizationError(container, e);
                                            }
                                        }
                                    });
                                    observer.unobserve(visualizerSection);
                                }
                            }
                        });
                    }, { threshold: 0.1 }); // Start loading when 10% of the section is visible
                    
                    // Observe the sections
                    if (formulaSection) observer.observe(formulaSection);
                    if (visualizerSection) observer.observe(visualizerSection);
                } else {
                    // Fallback for browsers without IntersectionObserver
                    console.warn('IntersectionObserver not supported, loading all resources immediately');
                    
                    // Load everything immediately
                    loadMathJax(() => {
                        if (window.initCommonFormulas) window.initCommonFormulas();
                    });
                    
                    loadPlotly(() => {
                        if (window.initVisualization) {
                            window.initVisualization();
                            window.visualizationInitialized = true;
                        }
                    });
                }
            });
        });
    </script>
</body>
</html> 