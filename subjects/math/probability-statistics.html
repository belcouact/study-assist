<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>概率统计 - 数学学习助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .visualization-area {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-container {
            position: relative;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }

        .stats-canvas {
            border: 2px solid #45b7d1;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
        }

        .controls-panel {
            background: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
            max-height: 100vh;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            min-width: 80px;
        }

        .tab-btn:hover {
            background: #e9ecef;
            color: #45b7d1;
        }

        .tab-btn.active {
            color: #45b7d1;
            border-bottom-color: #45b7d1;
            background: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .control-group h4 {
            color: #45b7d1;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #45b7d1;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #45b7d1, #4ecdc4);
            color: white;
            box-shadow: 0 2px 8px rgba(69, 183, 209, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a55eea, #8b5cf6);
            color: white;
            box-shadow: 0 2px 8px rgba(165, 94, 234, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .info-panel {
            background: #e3f2fd;
            border-left: 4px solid #45b7d1;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }

        .info-panel h5 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .info-panel p {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 5px;
        }

        .result-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .data-input {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .probability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .prob-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .prob-card:hover {
            border-color: #45b7d1;
            transform: translateY(-2px);
        }

        .prob-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #45b7d1;
            margin-bottom: 5px;
        }

        .prob-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .controls-panel {
                order: -1;
                max-height: 400px;
            }
            
            .visualization-area {
                padding: 10px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                border-bottom: 1px solid #e9ecef;
                border-right: none;
                flex: none;
            }

            .input-row {
                flex-direction: column;
                align-items: stretch;
            }

            .probability-grid {
                grid-template-columns: 1fr;
            }

            .stats-canvas {
                width: 100%;
                max-width: 350px;
            }
        }

        @media (max-width: 480px) {
            .back-btn {
                position: static;
                margin-bottom: 10px;
                width: 100%;
            }

            .header {
                margin-top: 10px;
            }

            .btn {
                width: 100%;
                justify-content: center;
                margin: 2px 0;
            }
        }

        /* Chart legend */
        .chart-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='main.html'">← 返回数学主页</button>
    
    <div class="container">
        <div class="header">
            <h1>🎲 概率统计</h1>
            <p>数据分析、概率计算与统计图表的可视化学习</p>
        </div>

        <div class="main-content">
            <div class="visualization-area">
                <div class="chart-container">
                    <canvas id="statsCanvas" class="stats-canvas" width="600" height="400"></canvas>
                </div>
                <div class="chart-legend" id="chartLegend"></div>
                <div class="result-display" id="resultDisplay">
                    选择一个功能开始探索概率统计
                </div>
            </div>

            <div class="controls-panel">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="probability">概率</button>
                    <button class="tab-btn" data-tab="statistics">统计</button>
                    <button class="tab-btn" data-tab="distributions">分布</button>
                    <button class="tab-btn" data-tab="charts">图表</button>
                </div>

                <!-- 概率计算 -->
                <div class="tab-content active" id="probability">
                    <div class="info-panel">
                        <h5>🎯 概率计算</h5>
                        <p>计算各种概率问题，包括基本概率、条件概率和组合概率</p>
                    </div>

                    <div class="control-group">
                        <h4>基本概率</h4>
                        <div class="input-row">
                            <input type="number" id="favorableOutcomes" class="input-field" placeholder="有利结果数" min="0">
                            <input type="number" id="totalOutcomes" class="input-field" placeholder="总结果数" min="1">
                        </div>
                        <button class="btn btn-primary" onclick="calculateBasicProbability()" style="width: 100%;">
                            计算基本概率
                        </button>
                    </div>

                    <div class="control-group">
                        <h4>掷骰子模拟</h4>
                        <div class="input-row">
                            <select id="diceCount" class="input-field">
                                <option value="1">1个骰子</option>
                                <option value="2">2个骰子</option>
                                <option value="3">3个骰子</option>
                            </select>
                            <input type="number" id="diceTarget" class="input-field" placeholder="目标点数" min="1">
                        </div>
                        <div class="input-row">
                            <input type="number" id="simulationCount" class="input-field" placeholder="模拟次数" value="1000" min="100">
                            <button class="btn btn-secondary" onclick="simulateDice()">模拟掷骰子</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>抽卡概率</h4>
                        <div class="input-row">
                            <input type="number" id="cardTotal" class="input-field" placeholder="总卡片数" value="100" min="1">
                            <input type="number" id="cardRare" class="input-field" placeholder="稀有卡片数" value="5" min="1">
                        </div>
                        <div class="input-row">
                            <input type="number" id="drawCount" class="input-field" placeholder="抽取次数" value="10" min="1">
                            <button class="btn btn-success" onclick="calculateCardProbability()">计算抽卡概率</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>条件概率</h4>
                        <div class="input-row">
                            <input type="number" id="probA" class="input-field" placeholder="P(A)" step="0.01" min="0" max="1">
                            <input type="number" id="probB" class="input-field" placeholder="P(B)" step="0.01" min="0" max="1">
                        </div>
                        <div class="input-row">
                            <input type="number" id="probAB" class="input-field" placeholder="P(A∩B)" step="0.01" min="0" max="1">
                            <button class="btn btn-primary" onclick="calculateConditionalProbability()">计算条件概率</button>
                        </div>
                    </div>
                </div>

                <!-- 统计分析 -->
                <div class="tab-content" id="statistics">
                    <div class="info-panel">
                        <h5>📊 统计分析</h5>
                        <p>计算数据的描述性统计量，包括均值、方差、标准差等</p>
                    </div>

                    <div class="control-group">
                        <h4>数据输入</h4>
                        <textarea id="dataInput" class="data-input" placeholder="输入数据，用逗号或空格分隔&#10;例如: 1, 2, 3, 4, 5&#10;或者: 1 2 3 4 5"></textarea>
                        <button class="btn btn-primary" onclick="analyzeData()" style="width: 100%; margin-top: 10px;">
                            分析数据
                        </button>
                    </div>

                    <div class="control-group">
                        <h4>生成随机数据</h4>
                        <div class="input-row">
                            <select id="distributionType" class="input-field">
                                <option value="normal">正态分布</option>
                                <option value="uniform">均匀分布</option>
                                <option value="exponential">指数分布</option>
                            </select>
                            <input type="number" id="sampleSize" class="input-field" placeholder="样本大小" value="100" min="10">
                        </div>
                        <button class="btn btn-secondary" onclick="generateRandomData()" style="width: 100%;">
                            生成随机数据
                        </button>
                    </div>

                    <div class="control-group">
                        <h4>假设检验</h4>
                        <div class="input-row">
                            <input type="number" id="hypothesisValue" class="input-field" placeholder="假设均值" step="0.01">
                            <select id="testType" class="input-field">
                                <option value="two-tailed">双尾检验</option>
                                <option value="left-tailed">左尾检验</option>
                                <option value="right-tailed">右尾检验</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <input type="number" id="significanceLevel" class="input-field" placeholder="显著性水平" value="0.05" step="0.01" min="0.01" max="0.1">
                            <button class="btn btn-success" onclick="performHypothesisTest()">执行检验</button>
                        </div>
                    </div>
                </div>

                <!-- 概率分布 -->
                <div class="tab-content" id="distributions">
                    <div class="info-panel">
                        <h5>📈 概率分布</h5>
                        <p>可视化各种概率分布，包括正态分布、二项分布、泊松分布等</p>
                    </div>

                    <div class="control-group">
                        <h4>分布类型</h4>
                        <select id="distType" class="input-field" onchange="updateDistributionControls()">
                            <option value="normal">正态分布</option>
                            <option value="binomial">二项分布</option>
                            <option value="poisson">泊松分布</option>
                            <option value="exponential">指数分布</option>
                            <option value="uniform">均匀分布</option>
                        </select>
                    </div>

                    <div class="control-group" id="normalControls">
                        <h4>正态分布参数</h4>
                        <div class="input-row">
                            <input type="number" id="normalMean" class="input-field" placeholder="均值 μ" value="0" step="0.1">
                            <input type="number" id="normalStd" class="input-field" placeholder="标准差 σ" value="1" step="0.1" min="0.1">
                        </div>
                        <button class="btn btn-primary" onclick="drawNormalDistribution()" style="width: 100%;">
                            绘制正态分布
                        </button>
                    </div>

                    <div class="control-group" id="binomialControls" style="display: none;">
                        <h4>二项分布参数</h4>
                        <div class="input-row">
                            <input type="number" id="binomialN" class="input-field" placeholder="试验次数 n" value="20" min="1">
                            <input type="number" id="binomialP" class="input-field" placeholder="成功概率 p" value="0.5" step="0.01" min="0" max="1">
                        </div>
                        <button class="btn btn-primary" onclick="drawBinomialDistribution()" style="width: 100%;">
                            绘制二项分布
                        </button>
                    </div>

                    <div class="control-group" id="poissonControls" style="display: none;">
                        <h4>泊松分布参数</h4>
                        <div class="input-row">
                            <input type="number" id="poissonLambda" class="input-field" placeholder="参数 λ" value="3" step="0.1" min="0.1">
                            <button class="btn btn-primary" onclick="drawPoissonDistribution()" style="width: 100%;">
                                绘制泊松分布
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>分布计算</h4>
                        <div class="input-row">
                            <input type="number" id="calcValue" class="input-field" placeholder="计算值">
                            <button class="btn btn-secondary" onclick="calculateDistributionValue()">计算概率</button>
                        </div>
                    </div>
                </div>

                <!-- 图表制作 -->
                <div class="tab-content" id="charts">
                    <div class="info-panel">
                        <h5>📊 统计图表</h5>
                        <p>制作各种统计图表，包括柱状图、饼图、散点图等</p>
                    </div>

                    <div class="control-group">
                        <h4>图表类型</h4>
                        <select id="chartType" class="input-field" onchange="updateChartControls()">
                            <option value="bar">柱状图</option>
                            <option value="pie">饼图</option>
                            <option value="line">折线图</option>
                            <option value="scatter">散点图</option>
                            <option value="histogram">直方图</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <h4>数据输入</h4>
                        <textarea id="chartData" class="data-input" placeholder="输入数据，格式：&#10;标签1:值1&#10;标签2:值2&#10;例如：&#10;苹果:30&#10;香蕉:25&#10;橙子:20"></textarea>
                        <button class="btn btn-primary" onclick="createChart()" style="width: 100%; margin-top: 10px;">
                            生成图表
                        </button>
                    </div>

                    <div class="control-group">
                        <h4>预设数据</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-secondary" onclick="loadSampleData('grades')">学生成绩</button>
                            <button class="btn btn-secondary" onclick="loadSampleData('sales')">销售数据</button>
                            <button class="btn btn-secondary" onclick="loadSampleData('weather')">天气统计</button>
                            <button class="btn btn-secondary" onclick="loadSampleData('survey')">调查结果</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>图表设置</h4>
                        <div class="input-row">
                            <input type="text" id="chartTitle" class="input-field" placeholder="图表标题">
                            <input type="color" id="chartColor" class="input-field" value="#45b7d1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('statsCanvas');
        const ctx = canvas.getContext('2d');
        const resultDisplay = document.getElementById('resultDisplay');
        const chartLegend = document.getElementById('chartLegend');

        // Current data
        let currentData = [];
        let currentMode = 'probability';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            clearCanvas();
        });

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                    currentMode = btn.dataset.tab;
                    
                    clearCanvas();
                    resultDisplay.textContent = '选择一个功能开始探索概率统计';
                });
            });
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            chartLegend.innerHTML = '';
        }

        // Probability functions
        function calculateBasicProbability() {
            const favorable = parseInt(document.getElementById('favorableOutcomes').value);
            const total = parseInt(document.getElementById('totalOutcomes').value);
            
            if (!favorable || !total || total <= 0 || favorable < 0 || favorable > total) {
                resultDisplay.innerHTML = '请输入有效的数值（有利结果数 ≤ 总结果数）';
                return;
            }
            
            const probability = favorable / total;
            const percentage = (probability * 100).toFixed(2);
            
            resultDisplay.innerHTML = `
                <strong>基本概率计算结果：</strong><br>
                有利结果数：${favorable}<br>
                总结果数：${total}<br>
                概率：${probability.toFixed(4)} = ${percentage}%<br>
                分数形式：${favorable}/${total}
            `;
            
            drawProbabilityBar(probability, '基本概率');
        }

        function simulateDice() {
            const diceCount = parseInt(document.getElementById('diceCount').value);
            const target = parseInt(document.getElementById('diceTarget').value);
            const simCount = parseInt(document.getElementById('simulationCount').value);
            
            if (!target || !simCount || simCount < 100) {
                resultDisplay.innerHTML = '请输入有效的参数';
                return;
            }
            
            let successCount = 0;
            const results = {};
            
            for (let i = 0; i < simCount; i++) {
                let sum = 0;
                for (let j = 0; j < diceCount; j++) {
                    sum += Math.floor(Math.random() * 6) + 1;
                }
                
                results[sum] = (results[sum] || 0) + 1;
                if (sum === target) successCount++;
            }
            
            const probability = successCount / simCount;
            const theoretical = calculateDiceTheoretical(diceCount, target);
            
            resultDisplay.innerHTML = `
                <strong>掷骰子模拟结果：</strong><br>
                骰子数量：${diceCount}<br>
                目标点数：${target}<br>
                模拟次数：${simCount}<br>
                成功次数：${successCount}<br>
                实际概率：${(probability * 100).toFixed(2)}%<br>
                理论概率：${(theoretical * 100).toFixed(2)}%<br>
                误差：${Math.abs(probability - theoretical).toFixed(4)}
            `;
            
            drawDiceResults(results, simCount, target);
        }

        function calculateDiceTheoretical(diceCount, target) {
            if (diceCount === 1) {
                return target >= 1 && target <= 6 ? 1/6 : 0;
            } else if (diceCount === 2) {
                const ways = Math.min(target - 1, 13 - target, 6);
                return ways > 0 ? ways / 36 : 0;
            } else if (diceCount === 3) {
                // Simplified calculation for 3 dice
                if (target < 3 || target > 18) return 0;
                const totalWays = 216;
                let ways = 0;
                
                for (let i = 1; i <= 6; i++) {
                    for (let j = 1; j <= 6; j++) {
                        for (let k = 1; k <= 6; k++) {
                            if (i + j + k === target) ways++;
                        }
                    }
                }
                return ways / totalWays;
            }
            return 0;
        }

        function calculateCardProbability() {
            const total = parseInt(document.getElementById('cardTotal').value);
            const rare = parseInt(document.getElementById('cardRare').value);
            const draws = parseInt(document.getElementById('drawCount').value);
            
            if (!total || !rare || !draws || rare > total) {
                resultDisplay.innerHTML = '请输入有效的参数';
                return;
            }
            
            // Calculate probability of getting at least one rare card
            const probNoRare = 1;
            let probAtLeastOne = 1;
            
            for (let i = 0; i < draws; i++) {
                probAtLeastOne *= (total - rare - i) / (total - i);
            }
            probAtLeastOne = 1 - probAtLeastOne;
            
            const probExactlyOne = (rare / total) * Math.pow((total - rare) / total, draws - 1) * draws;
            
            resultDisplay.innerHTML = `
                <strong>抽卡概率计算：</strong><br>
                总卡片数：${total}<br>
                稀有卡片数：${rare}<br>
                抽取次数：${draws}<br>
                单次抽中概率：${(rare/total * 100).toFixed(2)}%<br>
                至少抽中一张：${(probAtLeastOne * 100).toFixed(2)}%<br>
                一张都抽不中：${((1-probAtLeastOne) * 100).toFixed(2)}%
            `;
            
            drawCardProbability(probAtLeastOne, 1-probAtLeastOne);
        }

        function calculateConditionalProbability() {
            const pA = parseFloat(document.getElementById('probA').value);
            const pB = parseFloat(document.getElementById('probB').value);
            const pAB = parseFloat(document.getElementById('probAB').value);
            
            if (isNaN(pA) || isNaN(pB) || isNaN(pAB) || pA < 0 || pA > 1 || pB < 0 || pB > 1 || pAB < 0 || pAB > 1) {
                resultDisplay.innerHTML = '请输入有效的概率值（0-1之间）';
                return;
            }
            
            const pAGivenB = pB > 0 ? pAB / pB : 0;
            const pBGivenA = pA > 0 ? pAB / pA : 0;
            const pAOrB = pA + pB - pAB;
            
            resultDisplay.innerHTML = `
                <strong>条件概率计算：</strong><br>
                P(A) = ${pA}<br>
                P(B) = ${pB}<br>
                P(A∩B) = ${pAB}<br>
                P(A|B) = ${pAGivenB.toFixed(4)}<br>
                P(B|A) = ${pBGivenA.toFixed(4)}<br>
                P(A∪B) = ${pAOrB.toFixed(4)}<br>
                独立性检验：${Math.abs(pAB - pA * pB) < 0.001 ? '独立' : '不独立'}
            `;
            
            drawVennDiagram(pA, pB, pAB);
        }

        // Statistics functions
        function analyzeData() {
            const input = document.getElementById('dataInput').value.trim();
            if (!input) {
                resultDisplay.innerHTML = '请输入数据';
                return;
            }
            
            const data = input.split(/[,\s]+/).map(x => parseFloat(x)).filter(x => !isNaN(x));
            if (data.length === 0) {
                resultDisplay.innerHTML = '请输入有效的数值数据';
                return;
            }
            
            currentData = data;
            const stats = calculateDescriptiveStats(data);
            
            resultDisplay.innerHTML = `
                <strong>描述性统计分析：</strong><br>
                样本大小：${stats.count}<br>
                均值：${stats.mean.toFixed(4)}<br>
                中位数：${stats.median.toFixed(4)}<br>
                众数：${stats.mode}<br>
                标准差：${stats.std.toFixed(4)}<br>
                方差：${stats.variance.toFixed(4)}<br>
                最小值：${stats.min}<br>
                最大值：${stats.max}<br>
                范围：${stats.range}<br>
                偏度：${stats.skewness.toFixed(4)}<br>
                峰度：${stats.kurtosis.toFixed(4)}
            `;
            
            drawHistogram(data);
        }

        function calculateDescriptiveStats(data) {
            const n = data.length;
            const sorted = [...data].sort((a, b) => a - b);
            
            // Mean
            const mean = data.reduce((sum, x) => sum + x, 0) / n;
            
            // Median
            const median = n % 2 === 0 
                ? (sorted[n/2 - 1] + sorted[n/2]) / 2 
                : sorted[Math.floor(n/2)];
            
            // Mode
            const freq = {};
            data.forEach(x => freq[x] = (freq[x] || 0) + 1);
            const maxFreq = Math.max(...Object.values(freq));
            const modes = Object.keys(freq).filter(x => freq[x] === maxFreq);
            const mode = modes.length === n ? '无众数' : modes.join(', ');
            
            // Variance and standard deviation
            const variance = data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / (n - 1);
            const std = Math.sqrt(variance);
            
            // Range
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min;
            
            // Skewness
            const skewness = data.reduce((sum, x) => sum + Math.pow((x - mean) / std, 3), 0) / n;
            
            // Kurtosis
            const kurtosis = data.reduce((sum, x) => sum + Math.pow((x - mean) / std, 4), 0) / n - 3;
            
            return { count: n, mean, median, mode, std, variance, min, max, range, skewness, kurtosis };
        }

        function generateRandomData() {
            const distType = document.getElementById('distributionType').value;
            const size = parseInt(document.getElementById('sampleSize').value);
            
            if (!size || size < 10) {
                resultDisplay.innerHTML = '请输入有效的样本大小（≥10）';
                return;
            }
            
            let data = [];
            
            switch (distType) {
                case 'normal':
                    data = generateNormalData(size, 0, 1);
                    break;
                case 'uniform':
                    data = generateUniformData(size, 0, 1);
                    break;
                case 'exponential':
                    data = generateExponentialData(size, 1);
                    break;
            }
            
            document.getElementById('dataInput').value = data.map(x => x.toFixed(3)).join(', ');
            analyzeData();
        }

        function generateNormalData(n, mean = 0, std = 1) {
            const data = [];
            for (let i = 0; i < n; i += 2) {
                const u1 = Math.random();
                const u2 = Math.random();
                const z1 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                const z2 = Math.sqrt(-2 * Math.log(u1)) * Math.sin(2 * Math.PI * u2);
                data.push(mean + std * z1);
                if (i + 1 < n) data.push(mean + std * z2);
            }
            return data.slice(0, n);
        }

        function generateUniformData(n, min = 0, max = 1) {
            return Array.from({length: n}, () => min + Math.random() * (max - min));
        }

        function generateExponentialData(n, lambda = 1) {
            return Array.from({length: n}, () => -Math.log(Math.random()) / lambda);
        }

        function performHypothesisTest() {
            if (currentData.length === 0) {
                resultDisplay.innerHTML = '请先输入或生成数据';
                return;
            }
            
            const h0 = parseFloat(document.getElementById('hypothesisValue').value);
            const testType = document.getElementById('testType').value;
            const alpha = parseFloat(document.getElementById('significanceLevel').value);
            
            if (isNaN(h0) || isNaN(alpha)) {
                resultDisplay.innerHTML = '请输入有效的参数';
                return;
            }
            
            const n = currentData.length;
            const mean = currentData.reduce((sum, x) => sum + x, 0) / n;
            const std = Math.sqrt(currentData.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / (n - 1));
            const se = std / Math.sqrt(n);
            const tStat = (mean - h0) / se;
            
            // Critical values (simplified)
            let critical, pValue;
            const df = n - 1;
            
            switch (testType) {
                case 'two-tailed':
                    critical = 1.96; // Approximate for large samples
                    pValue = 2 * (1 - normalCDF(Math.abs(tStat)));
                    break;
                case 'left-tailed':
                    critical = -1.645;
                    pValue = normalCDF(tStat);
                    break;
                case 'right-tailed':
                    critical = 1.645;
                    pValue = 1 - normalCDF(tStat);
                    break;
            }
            
            const reject = pValue < alpha;
            
            resultDisplay.innerHTML = `
                <strong>假设检验结果：</strong><br>
                H₀: μ = ${h0}<br>
                样本均值：${mean.toFixed(4)}<br>
                样本标准差：${std.toFixed(4)}<br>
                t统计量：${tStat.toFixed(4)}<br>
                p值：${pValue.toFixed(4)}<br>
                显著性水平：${alpha}<br>
                结论：${reject ? '拒绝H₀' : '不能拒绝H₀'}<br>
                ${reject ? '有显著差异' : '无显著差异'}
            `;
        }

        function normalCDF(x) {
            // Approximation of normal CDF
            return 0.5 * (1 + erf(x / Math.sqrt(2)));
        }

        function erf(x) {
            // Approximation of error function
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            
            const sign = x >= 0 ? 1 : -1;
            x = Math.abs(x);
            
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            
            return sign * y;
        }

        // Distribution functions
        function updateDistributionControls() {
            const distType = document.getElementById('distType').value;
            
            document.getElementById('normalControls').style.display = distType === 'normal' ? 'block' : 'none';
            document.getElementById('binomialControls').style.display = distType === 'binomial' ? 'block' : 'none';
            document.getElementById('poissonControls').style.display = distType === 'poisson' ? 'block' : 'none';
        }

        function drawNormalDistribution() {
            const mean = parseFloat(document.getElementById('normalMean').value) || 0;
            const std = parseFloat(document.getElementById('normalStd').value) || 1;
            
            clearCanvas();
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 50;
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw normal curve
            ctx.strokeStyle = '#45b7d1';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const xMin = mean - 4 * std;
            const xMax = mean + 4 * std;
            const xRange = xMax - xMin;
            
            for (let i = 0; i <= width - 2 * margin; i++) {
                const x = xMin + (i / (width - 2 * margin)) * xRange;
                const y = normalPDF(x, mean, std);
                const canvasX = margin + i;
                const canvasY = height - margin - (y * (height - 2 * margin) * std * Math.sqrt(2 * Math.PI));
                
                if (i === 0) {
                    ctx.moveTo(canvasX, canvasY);
                } else {
                    ctx.lineTo(canvasX, canvasY);
                }
            }
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`正态分布 N(${mean}, ${std}²)`, width / 2, 30);
            
            resultDisplay.innerHTML = `
                <strong>正态分布 N(${mean}, ${std}²)</strong><br>
                均值：${mean}<br>
                标准差：${std}<br>
                方差：${(std * std).toFixed(2)}<br>
                68%数据范围：[${(mean - std).toFixed(2)}, ${(mean + std).toFixed(2)}]<br>
                95%数据范围：[${(mean - 2*std).toFixed(2)}, ${(mean + 2*std).toFixed(2)}]<br>
                99.7%数据范围：[${(mean - 3*std).toFixed(2)}, ${(mean + 3*std).toFixed(2)}]
            `;
        }

        function normalPDF(x, mean, std) {
            return Math.exp(-0.5 * Math.pow((x - mean) / std, 2)) / (std * Math.sqrt(2 * Math.PI));
        }

        function drawBinomialDistribution() {
            const n = parseInt(document.getElementById('binomialN').value) || 20;
            const p = parseFloat(document.getElementById('binomialP').value) || 0.5;
            
            clearCanvas();
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 50;
            
            // Calculate probabilities
            const probs = [];
            for (let k = 0; k <= n; k++) {
                probs.push(binomialPMF(k, n, p));
            }
            
            const maxProb = Math.max(...probs);
            const barWidth = (width - 2 * margin) / (n + 1);
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw bars
            ctx.fillStyle = '#45b7d1';
            for (let k = 0; k <= n; k++) {
                const barHeight = (probs[k] / maxProb) * (height - 2 * margin);
                const x = margin + k * barWidth;
                const y = height - margin - barHeight;
                
                ctx.fillRect(x, y, barWidth * 0.8, barHeight);
            }
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`二项分布 B(${n}, ${p})`, width / 2, 30);
            
            const mean = n * p;
            const variance = n * p * (1 - p);
            
            resultDisplay.innerHTML = `
                <strong>二项分布 B(${n}, ${p})</strong><br>
                试验次数：${n}<br>
                成功概率：${p}<br>
                期望值：${mean.toFixed(2)}<br>
                方差：${variance.toFixed(2)}<br>
                标准差：${Math.sqrt(variance).toFixed(2)}<br>
                最可能值：${Math.floor((n + 1) * p)}
            `;
        }

        function binomialPMF(k, n, p) {
            return combination(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
        }

        function combination(n, k) {
            if (k > n) return 0;
            if (k === 0 || k === n) return 1;
            
            let result = 1;
            for (let i = 0; i < k; i++) {
                result *= (n - i) / (i + 1);
            }
            return result;
        }

        function drawPoissonDistribution() {
            const lambda = parseFloat(document.getElementById('poissonLambda').value) || 3;
            
            clearCanvas();
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 50;
            
            // Calculate probabilities for k = 0 to 20
            const maxK = Math.min(20, lambda + 10);
            const probs = [];
            for (let k = 0; k <= maxK; k++) {
                probs.push(poissonPMF(k, lambda));
            }
            
            const maxProb = Math.max(...probs);
            const barWidth = (width - 2 * margin) / (maxK + 1);
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw bars
            ctx.fillStyle = '#45b7d1';
            for (let k = 0; k <= maxK; k++) {
                const barHeight = (probs[k] / maxProb) * (height - 2 * margin);
                const x = margin + k * barWidth;
                const y = height - margin - barHeight;
                
                ctx.fillRect(x, y, barWidth * 0.8, barHeight);
            }
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`泊松分布 P(${lambda})`, width / 2, 30);
            
            resultDisplay.innerHTML = `
                <strong>泊松分布 P(${lambda})</strong><br>
                参数 λ：${lambda}<br>
                期望值：${lambda}<br>
                方差：${lambda}<br>
                标准差：${Math.sqrt(lambda).toFixed(2)}<br>
                最可能值：${Math.floor(lambda)}
            `;
        }

        function poissonPMF(k, lambda) {
            return Math.pow(lambda, k) * Math.exp(-lambda) / factorial(k);
        }

        function factorial(n) {
            if (n <= 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function calculateDistributionValue() {
            const value = parseFloat(document.getElementById('calcValue').value);
            const distType = document.getElementById('distType').value;
            
            if (isNaN(value)) {
                resultDisplay.innerHTML = '请输入有效的计算值';
                return;
            }
            
            let result = '';
            
            switch (distType) {
                case 'normal':
                    const mean = parseFloat(document.getElementById('normalMean').value) || 0;
                    const std = parseFloat(document.getElementById('normalStd').value) || 1;
                    const prob = normalCDF((value - mean) / std);
                    result = `P(X ≤ ${value}) = ${prob.toFixed(4)}`;
                    break;
                    
                case 'binomial':
                    const n = parseInt(document.getElementById('binomialN').value) || 20;
                    const p = parseFloat(document.getElementById('binomialP').value) || 0.5;
                    if (value >= 0 && value <= n && Number.isInteger(value)) {
                        const exactProb = binomialPMF(value, n, p);
                        result = `P(X = ${value}) = ${exactProb.toFixed(4)}`;
                    } else {
                        result = '请输入0到n之间的整数';
                    }
                    break;
                    
                case 'poisson':
                    const lambda = parseFloat(document.getElementById('poissonLambda').value) || 3;
                    if (value >= 0 && Number.isInteger(value)) {
                        const exactProb = poissonPMF(value, lambda);
                        result = `P(X = ${value}) = ${exactProb.toFixed(4)}`;
                    } else {
                        result = '请输入非负整数';
                    }
                    break;
            }
            
            resultDisplay.innerHTML += '<br><br><strong>概率计算：</strong><br>' + result;
        }

        // Chart functions
        function updateChartControls() {
            const chartType = document.getElementById('chartType').value;
            // Could add specific controls for different chart types
        }

        function createChart() {
            const chartType = document.getElementById('chartType').value;
            const dataText = document.getElementById('chartData').value.trim();
            const title = document.getElementById('chartTitle').value || '统计图表';
            const color = document.getElementById('chartColor').value;
            
            if (!dataText) {
                resultDisplay.innerHTML = '请输入图表数据';
                return;
            }
            
            const data = parseChartData(dataText);
            if (!data) {
                resultDisplay.innerHTML = '数据格式错误，请检查输入格式';
                return;
            }
            
            clearCanvas();
            
            switch (chartType) {
                case 'bar':
                    drawBarChart(data, title, color);
                    break;
                case 'pie':
                    drawPieChart(data, title);
                    break;
                case 'line':
                    drawLineChart(data, title, color);
                    break;
                case 'histogram':
                    drawHistogramFromData(data, title, color);
                    break;
            }
        }

        function parseChartData(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const data = { labels: [], values: [] };
            
            for (const line of lines) {
                const parts = line.split(':');
                if (parts.length === 2) {
                    const label = parts[0].trim();
                    const value = parseFloat(parts[1].trim());
                    if (!isNaN(value)) {
                        data.labels.push(label);
                        data.values.push(value);
                    }
                }
            }
            
            return data.labels.length > 0 ? data : null;
        }

        function drawBarChart(data, title, color) {
            const width = canvas.width;
            const height = canvas.height;
            const margin = 60;
            
            const maxValue = Math.max(...data.values);
            const barWidth = (width - 2 * margin) / data.labels.length;
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw bars
            ctx.fillStyle = color;
            for (let i = 0; i < data.values.length; i++) {
                const barHeight = (data.values[i] / maxValue) * (height - 2 * margin);
                const x = margin + i * barWidth + barWidth * 0.1;
                const y = height - margin - barHeight;
                
                ctx.fillRect(x, y, barWidth * 0.8, barHeight);
                
                // Value labels
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(data.values[i].toString(), x + barWidth * 0.4, y - 5);
                
                // Category labels
                ctx.save();
                ctx.translate(x + barWidth * 0.4, height - margin + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(data.labels[i], 0, 0);
                ctx.restore();
                
                ctx.fillStyle = color;
            }
            
            // Title
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, width / 2, 30);
            
            resultDisplay.innerHTML = `
                <strong>${title}</strong><br>
                图表类型：柱状图<br>
                数据项数：${data.labels.length}<br>
                最大值：${Math.max(...data.values)}<br>
                最小值：${Math.min(...data.values)}<br>
                总和：${data.values.reduce((a, b) => a + b, 0)}
            `;
        }

        function drawPieChart(data, title) {
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 3;
            
            const total = data.values.reduce((sum, val) => sum + val, 0);
            const colors = generateColors(data.values.length);
            
            let currentAngle = -Math.PI / 2;
            
            // Draw pie slices
            for (let i = 0; i < data.values.length; i++) {
                const sliceAngle = (data.values[i] / total) * 2 * Math.PI;
                
                ctx.fillStyle = colors[i];
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();
                
                // Labels
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(data.labels[i], labelX, labelY);
                ctx.fillText(`${((data.values[i] / total) * 100).toFixed(1)}%`, labelX, labelY + 15);
                
                currentAngle += sliceAngle;
            }
            
            // Title
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, width / 2, 30);
            
            // Legend
            createLegend(data.labels, colors);
            
            resultDisplay.innerHTML = `
                <strong>${title}</strong><br>
                图表类型：饼图<br>
                数据项数：${data.labels.length}<br>
                总计：${total}
            `;
        }

        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 360 / count) % 360;
                colors.push(`hsl(${hue}, 70%, 60%)`);
            }
            return colors;
        }

        function createLegend(labels, colors) {
            chartLegend.innerHTML = '';
            for (let i = 0; i < labels.length; i++) {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = colors[i];
                
                const label = document.createElement('span');
                label.textContent = labels[i];
                
                item.appendChild(colorBox);
                item.appendChild(label);
                chartLegend.appendChild(item);
            }
        }

        function loadSampleData(type) {
            let data = '';
            
            switch (type) {
                case 'grades':
                    data = '优秀:25\n良好:35\n中等:20\n及格:15\n不及格:5';
                    break;
                case 'sales':
                    data = '一月:120\n二月:150\n三月:180\n四月:200\n五月:175\n六月:220';
                    break;
                case 'weather':
                    data = '晴天:180\n多云:120\n雨天:50\n雪天:15';
                    break;
                case 'survey':
                    data = '非常满意:45\n满意:120\n一般:80\n不满意:30\n非常不满意:10';
                    break;
            }
            
            document.getElementById('chartData').value = data;
        }

        // Drawing helper functions
        function drawProbabilityBar(probability, label) {
            clearCanvas();
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 50;
            
            const barWidth = width - 2 * margin;
            const barHeight = 40;
            const y = height / 2 - barHeight / 2;
            
            // Background bar
            ctx.fillStyle = '#e9ecef';
            ctx.fillRect(margin, y, barWidth, barHeight);
            
            // Probability bar
            ctx.fillStyle = '#45b7d1';
            ctx.fillRect(margin, y, barWidth * probability, barHeight);
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(label, width / 2, y - 20);
            ctx.fillText(`${(probability * 100).toFixed(2)}%`, width / 2, y + barHeight + 30);
        }

        function drawDiceResults(results, total, target) {
            clearCanvas();
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 50;
            
            const values = Object.keys(results).map(Number).sort((a, b) => a - b);
            const maxCount = Math.max(...Object.values(results));
            const barWidth = (width - 2 * margin) / values.length;
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw bars
            for (let i = 0; i < values.length; i++) {
                const value = values[i];
                const count = results[value];
                const barHeight = (count / maxCount) * (height - 2 * margin);
                const x = margin + i * barWidth;
                const y = height - margin - barHeight;
                
                ctx.fillStyle = value === target ? '#ff6b6b' : '#45b7d1';
                ctx.fillRect(x + barWidth * 0.1, y, barWidth * 0.8, barHeight);
                
                // Labels
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value.toString(), x + barWidth / 2, height - margin + 15);
                ctx.fillText(count.toString(), x + barWidth / 2, y - 5);
            }
            
            // Title
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('掷骰子结果分布', width / 2, 30);
        }

        function drawCardProbability(probSuccess, probFail) {
            clearCanvas();
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 3;
            
            // Success slice
            ctx.fillStyle = '#4ecdc4';
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + probSuccess * 2 * Math.PI);
            ctx.closePath();
            ctx.fill();
            
            // Fail slice
            ctx.fillStyle = '#ff6b6b';
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, -Math.PI / 2 + probSuccess * 2 * Math.PI, -Math.PI / 2 + 2 * Math.PI);
            ctx.closePath();
            ctx.fill();
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('抽卡概率分布', width / 2, 30);
            
            // Legend
            createLegend(['至少抽中一张', '一张都抽不中'], ['#4ecdc4', '#ff6b6b']);
        }

        function drawVennDiagram(pA, pB, pAB) {
            clearCanvas();
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = 80;
            const offset = 40;
            
            // Circle A
            ctx.fillStyle = 'rgba(69, 183, 209, 0.5)';
            ctx.beginPath();
            ctx.arc(centerX - offset, centerY, radius, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#45b7d1';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Circle B
            ctx.fillStyle = 'rgba(255, 107, 107, 0.5)';
            ctx.beginPath();
            ctx.arc(centerX + offset, centerY, radius, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('A', centerX - offset - 50, centerY);
            ctx.fillText('B', centerX + offset + 50, centerY);
            ctx.fillText('A∩B', centerX, centerY);
            
            // Title
            ctx.fillText('维恩图', width / 2, 30);
        }

        function drawHistogram(data) {
            clearCanvas();
            
            const width = canvas.width;
            const height = canvas.height;
            const margin = 50;
            
            // Calculate bins
            const min = Math.min(...data);
            const max = Math.max(...data);
            const binCount = Math.min(20, Math.ceil(Math.sqrt(data.length)));
            const binWidth = (max - min) / binCount;
            
            const bins = new Array(binCount).fill(0);
            data.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binWidth), binCount - 1);
                bins[binIndex]++;
            });
            
            const maxBin = Math.max(...bins);
            const barWidth = (width - 2 * margin) / binCount;
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw bars
            ctx.fillStyle = '#45b7d1';
            for (let i = 0; i < binCount; i++) {
                const barHeight = (bins[i] / maxBin) * (height - 2 * margin);
                const x = margin + i * barWidth;
                const y = height - margin - barHeight;
                
                ctx.fillRect(x, y, barWidth * 0.9, barHeight);
            }
            
            // Title
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('数据直方图', width / 2, 30);
        }

        function drawHistogramFromData(data, title, color) {
            // Similar to drawHistogram but for chart data
            const values = data.values;
            drawHistogram(values);
            
            resultDisplay.innerHTML = `
                <strong>${title}</strong><br>
                图表类型：直方图<br>
                数据点数：${values.length}<br>
                最大值：${Math.max(...values)}<br>
                最小值：${Math.min(...values)}<br>
                平均值：${(values.reduce((a, b) => a + b, 0) / values.length).toFixed(2)}
            `;
        }

        function drawLineChart(data, title, color) {
            const width = canvas.width;
            const height = canvas.height;
            const margin = 60;
            
            const maxValue = Math.max(...data.values);
            const minValue = Math.min(...data.values);
            const valueRange = maxValue - minValue || 1;
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw line
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const stepX = (width - 2 * margin) / (data.values.length - 1);
            
            for (let i = 0; i < data.values.length; i++) {
                const x = margin + i * stepX;
                const y = height - margin - ((data.values[i] - minValue) / valueRange) * (height - 2 * margin);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // Draw points
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
                
                // Labels
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.save();
                ctx.translate(x, height - margin + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(data.labels[i], 0, 0);
                ctx.restore();
            }
            
            ctx.stroke();
            
            // Title
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, width / 2, 30);
            
            resultDisplay.innerHTML = `
                <strong>${title}</strong><br>
                图表类型：折线图<br>
                数据点数：${data.values.length}<br>
                最大值：${maxValue}<br>
                最小值：${minValue}<br>
                平均值：${(data.values.reduce((a, b) => a + b, 0) / data.values.length).toFixed(2)}
            `;
        }
    </script>
</body>
</html> 