<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>立体几何 - 数学学习助手</title>
    <link rel="icon" href="../../assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/utilities.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Try multiple CDN sources for Three.js -->
    <script>
        // Create a fallback loading system for Three.js
        function loadThreeJS() {
            return new Promise((resolve, reject) => {
                // Try threejs.org first
                const script1 = document.createElement('script');
                script1.src = 'https://threejs.org/build/three.min.js';
                script1.onload = () => {
                    // Load OrbitControls
                    const script2 = document.createElement('script');
                    script2.src = 'https://threejs.org/examples/js/controls/OrbitControls.js';
                    script2.onload = () => resolve();
                    script2.onerror = () => {
                        // Fallback to jsdelivr
                        const script3 = document.createElement('script');
                        script3.src = 'https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js';
                        script3.onload = () => resolve();
                        script3.onerror = () => reject('Failed to load OrbitControls');
                        document.head.appendChild(script3);
                    };
                    document.head.appendChild(script2);
                };
                script1.onerror = () => {
                    // Fallback to jsdelivr
                    const script4 = document.createElement('script');
                    script4.src = 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js';
                    script4.onload = () => {
                        const script5 = document.createElement('script');
                        script5.src = 'https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js';
                        script5.onload = () => resolve();
                        script5.onerror = () => reject('Failed to load Three.js components');
                        document.head.appendChild(script5);
                    };
                    script4.onerror = () => reject('Failed to load Three.js');
                    document.head.appendChild(script4);
                };
                document.head.appendChild(script1);
            });
        }
    </script>
    <style>
        .solid-geometry-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .geometry-header {
            text-align: center;
            padding: 3rem 0 2rem;
        }

        .geometry-header h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6347);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .geometry-header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .main-workspace {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            height: fit-content;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .control-section {
            margin-bottom: 2rem;
        }

        .control-section h3 {
            color: #FFD700;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 0.5rem;
        }

        .geometry-viewer {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            height: 700px;
        }

        .shape-button {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .shape-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FFD700;
        }

        .shape-button.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }

        .parameter-input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #fff;
            font-size: 0.9rem;
        }

        .parameter-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .parameter-input:focus {
            outline: none;
            border-color: #FFD700;
        }

        .action-button {
            width: 100%;
            padding: 0.7rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #4361ee, #7209b7);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }

        .coordinate-input {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .coord-input {
            padding: 0.4rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
            text-align: center;
            font-size: 0.8rem;
        }

        .line-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .line-type-button {
            flex: 1;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .line-type-button.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }

        .transparency-slider {
            width: 100%;
            margin: 0.5rem 0;
        }

        .info-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.6);
            border-radius: 10px;
            padding: 15px;
            max-width: 250px;
            color: #FFD700;
            font-size: 0.9rem;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .toolbar {
            position: absolute;
            bottom: 15px;
            left: 15px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .tool-button {
            width: 45px;
            height: 45px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.6);
            border-radius: 10px;
            color: #FFD700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tool-button:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
            transform: scale(1.05);
        }

        .coordinates-display {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.6);
            border-radius: 10px;
            padding: 10px;
            color: #FFD700;
            font-size: 0.8rem;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .objects-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .object-item {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: 0.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-button {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
            border-radius: 3px;
            color: #fff;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .color-picker {
            width: 100%;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-workspace {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .control-panel {
                order: 2;
            }
            
            .geometry-viewer {
                order: 1;
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .geometry-header h1 {
                font-size: 2rem;
            }
            
            .geometry-viewer {
                height: 400px;
            }
            
            .control-panel {
                padding: 1rem;
            }
            
            .info-panel {
                font-size: 0.8rem;
                padding: 10px;
                max-width: 200px;
            }
            
            .toolbar {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../../index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span>Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="main.html">数学</a></li>
                        <li><a href="#" class="active">立体几何</a></li>
                        <li><a href="../../tts.html">语音</a></li>
                        <li><a href="../../draw.html">绘图</a></li>
                    </ul>
                </nav>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="solid-geometry-page">
        <section class="geometry-header">
            <div class="container">
                <h1><i class="fas fa-cube"></i> 3D 立体几何工具</h1>
                <p>交互式3D几何体绘制与空间坐标系学习平台</p>
            </div>
        </section>

        <section class="container">
            <div class="main-workspace">
                <!-- 控制面板 -->
                <div class="control-panel">
                    <!-- 几何体选择 -->
                    <div class="control-section">
                        <h3>🎯 选择几何体</h3>
                        <button class="shape-button active" data-shape="cube">
                            <i class="fas fa-cube"></i>
                            立方体
                        </button>
                        <button class="shape-button" data-shape="sphere">
                            <i class="fas fa-circle"></i>
                            球体
                        </button>
                        <button class="shape-button" data-shape="cylinder">
                            <i class="fas fa-arrow-up"></i>
                            圆柱体
                        </button>
                        <button class="shape-button" data-shape="cone">
                            <i class="fas fa-triangle"></i>
                            圆锥体
                        </button>
                        <button class="shape-button" data-shape="pyramid">
                            <i class="fas fa-mountain"></i>
                            四角锥
                        </button>
                        <button class="shape-button" data-shape="prism">
                            <i class="fas fa-gem"></i>
                            三角柱
                        </button>
                    </div>

                    <!-- 参数设置 -->
                    <div class="control-section">
                        <h3>📏 设置参数</h3>
                        <div id="shape-parameters">
                            <input type="number" class="parameter-input" id="param1" placeholder="长度/半径 (单位)" min="0.1" max="20" step="0.1" value="2">
                            <input type="number" class="parameter-input" id="param2" placeholder="宽度/高度 (单位)" min="0.1" max="20" step="0.1" value="2">
                            <input type="number" class="parameter-input" id="param3" placeholder="高度/深度 (单位)" min="0.1" max="20" step="0.1" value="2">
                        </div>
                        <button class="action-button" onclick="createShape()">
                            <i class="fas fa-plus"></i> 创建几何体
                        </button>
                    </div>

                    <!-- 外观设置 -->
                    <div class="control-section">
                        <h3>🎨 外观设置</h3>
                        <input type="color" class="color-picker" id="shape-color" value="#4361ee">
                        <label style="font-size: 0.9rem; opacity: 0.8;">透明度:</label>
                        <input type="range" class="transparency-slider" id="transparency" min="0.1" max="1" step="0.1" value="0.7">
                        <label style="font-size: 0.9rem; opacity: 0.8;">
                            <input type="checkbox" id="wireframe"> 线框模式
                        </label>
                    </div>

                    <!-- 坐标连线 -->
                    <div class="control-section">
                        <h3>📍 坐标连线</h3>
                        <div class="coordinate-input">
                            <input type="number" class="coord-input" id="x1" placeholder="X1" step="0.1">
                            <input type="number" class="coord-input" id="y1" placeholder="Y1" step="0.1">
                            <input type="number" class="coord-input" id="z1" placeholder="Z1" step="0.1">
                        </div>
                        <div class="coordinate-input">
                            <input type="number" class="coord-input" id="x2" placeholder="X2" step="0.1">
                            <input type="number" class="coord-input" id="y2" placeholder="Y2" step="0.1">
                            <input type="number" class="coord-input" id="z2" placeholder="Z2" step="0.1">
                        </div>
                        <div class="line-type-selector">
                            <button class="line-type-button active" data-type="straight">直线</button>
                            <button class="line-type-button" data-type="curve">曲线</button>
                        </div>
                        <button class="action-button" onclick="createLine()">
                            <i class="fas fa-drafting-compass"></i> 连接坐标
                        </button>
                    </div>

                    <!-- 对象管理 -->
                    <div class="control-section">
                        <h3>📋 对象管理</h3>
                        <div class="objects-list" id="objects-list">
                            <div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8rem;">
                                暂无对象
                            </div>
                        </div>
                        <button class="action-button" onclick="clearAll()" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                            <i class="fas fa-trash"></i> 清空所有
                        </button>
                    </div>
                </div>

                <!-- 3D视图区域 -->
                <div class="geometry-viewer">
                    <div id="geometry-container"></div>
                    
                    <!-- 信息面板 -->
                    <div class="info-panel">
                        <strong>操作指南</strong><br>
                        🖱️ 左键拖拽：旋转视角<br>
                        🔄 滚轮：缩放画面<br>
                        ✋ 右键拖拽：平移视图<br>
                        📏 点击对象：查看属性
                    </div>

                    <!-- 工具栏 -->
                    <div class="toolbar">
                        <button class="tool-button" onclick="resetView()" title="重置视图">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="tool-button" onclick="toggleGrid()" title="显示/隐藏网格">
                            <i class="fas fa-border-all"></i>
                        </button>
                        <button class="tool-button" onclick="toggleAxes()" title="显示/隐藏坐标轴">
                            <i class="fas fa-arrows-alt"></i>
                        </button>
                        <button class="tool-button" onclick="exportScene()" title="导出场景">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>

                    <!-- 坐标显示 -->
                    <div class="coordinates-display" id="coordinates-display">
                        鼠标坐标: (0, 0, 0)
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <p class="copyright-text">study-llm.me域名为Alex所有。保留所有权利。</p>
            </div>
        </div>
    </footer>

    <script src="../../js/common.js"></script>
    <script src="../../js/navigation.js"></script>
    <script>
        // 3D立体几何可视化系统
        class SolidGeometryVisualizationSystem {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.objects = [];
                this.selectedShape = 'cube';
                this.lineType = 'straight';
                this.gridHelper = null;
                this.axesHelper = null;
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                
                this.init();
            }

            init() {
                try {
                    console.log('🔄 开始初始化3D立体几何系统...');
                    console.log('THREE.js版本:', THREE.REVISION);
                    
                    this.setupScene();
                    console.log('✅ 场景设置完成');
                    
                    this.setupCamera();
                    console.log('✅ 相机设置完成');
                    
                    this.setupRenderer();
                    console.log('✅ 渲染器设置完成');
                    
                    this.setupLights();
                    console.log('✅ 光照设置完成');
                    
                    this.setupControls();
                    console.log('✅ 控制器设置完成');
                    
                    this.setupHelpers();
                    console.log('✅ 辅助工具设置完成');
                    
                    this.setupEventListeners();
                    console.log('✅ 事件监听器设置完成');
                    
                    this.animate();
                    console.log('✅ 动画循环启动');
                    
                    console.log('✅ 3D立体几何系统初始化完成');
                } catch (error) {
                    console.error('❌ 初始化失败:', error);
                    alert('3D系统初始化失败，请刷新页面重试');
                }
            }

            setupScene() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x1a1a2e);
            }

            setupCamera() {
                const container = document.getElementById('geometry-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                this.camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                this.camera.position.set(10, 10, 10);
                this.camera.lookAt(0, 0, 0);
            }

            setupRenderer() {
                const container = document.getElementById('geometry-container');
                
                this.renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true
                });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                container.appendChild(this.renderer.domElement);
            }

            setupLights() {
                // 环境光
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                // 方向光
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                this.scene.add(directionalLight);
                
                // 点光源
                const pointLight = new THREE.PointLight(0x4361ee, 0.6, 100);
                pointLight.position.set(-10, 10, 10);
                this.scene.add(pointLight);
            }

            setupControls() {
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.minDistance = 5;
                this.controls.maxDistance = 50;
                
                // 移动端支持
                this.controls.touches = {
                    ONE: THREE.TOUCH.ROTATE,
                    TWO: THREE.TOUCH.DOLLY_PAN
                };
            }

            setupHelpers() {
                // 网格辅助线
                this.gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x444444);
                this.scene.add(this.gridHelper);
                
                // 坐标轴
                this.axesHelper = new THREE.AxesHelper(5);
                this.scene.add(this.axesHelper);
            }

            setupEventListeners() {
                // 窗口大小调整
                window.addEventListener('resize', () => this.onWindowResize());
                
                // 鼠标移动
                this.renderer.domElement.addEventListener('mousemove', (event) => this.onMouseMove(event));
                
                // 鼠标点击
                this.renderer.domElement.addEventListener('click', (event) => this.onMouseClick(event));
                
                // 形状选择按钮
                document.querySelectorAll('.shape-button').forEach(button => {
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.shape-button').forEach(b => b.classList.remove('active'));
                        button.classList.add('active');
                        this.selectedShape = button.dataset.shape;
                        this.updateParameterInputs();
                    });
                });
                
                // 线型选择
                document.querySelectorAll('.line-type-button').forEach(button => {
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.line-type-button').forEach(b => b.classList.remove('active'));
                        button.classList.add('active');
                        this.lineType = button.dataset.type;
                    });
                });
            }

            updateParameterInputs() {
                const param1 = document.getElementById('param1');
                const param2 = document.getElementById('param2');
                const param3 = document.getElementById('param3');
                
                switch(this.selectedShape) {
                    case 'cube':
                        param1.placeholder = '边长 (单位)';
                        param2.style.display = 'none';
                        param3.style.display = 'none';
                        break;
                    case 'sphere':
                        param1.placeholder = '半径 (单位)';
                        param2.style.display = 'none';
                        param3.style.display = 'none';
                        break;
                    case 'cylinder':
                        param1.placeholder = '半径 (单位)';
                        param2.placeholder = '高度 (单位)';
                        param2.style.display = 'block';
                        param3.style.display = 'none';
                        break;
                    case 'cone':
                        param1.placeholder = '底面半径 (单位)';
                        param2.placeholder = '高度 (单位)';
                        param2.style.display = 'block';
                        param3.style.display = 'none';
                        break;
                    default:
                        param1.placeholder = '长度 (单位)';
                        param2.placeholder = '宽度 (单位)';
                        param3.placeholder = '高度 (单位)';
                        param2.style.display = 'block';
                        param3.style.display = 'block';
                }
            }

            createGeometry(shape, params) {
                let geometry;
                
                switch(shape) {
                    case 'cube':
                        geometry = new THREE.BoxGeometry(params[0], params[0], params[0]);
                        break;
                    case 'sphere':
                        geometry = new THREE.SphereGeometry(params[0], 32, 32);
                        break;
                    case 'cylinder':
                        geometry = new THREE.CylinderGeometry(params[0], params[0], params[1], 32);
                        break;
                    case 'cone':
                        geometry = new THREE.ConeGeometry(params[0], params[1], 32);
                        break;
                    case 'pyramid':
                        geometry = new THREE.ConeGeometry(params[0], params[1], 4);
                        break;
                    case 'prism':
                        const shape = new THREE.Shape();
                        shape.moveTo(0, 0);
                        shape.lineTo(params[0], 0);
                        shape.lineTo(params[0]/2, params[1]);
                        shape.lineTo(0, 0);
                        geometry = new THREE.ExtrudeGeometry(shape, { depth: params[2] });
                        break;
                    default:
                        geometry = new THREE.BoxGeometry(params[0], params[1], params[2]);
                }
                
                return geometry;
            }

            createShape() {
                try {
                    console.log('🔄 开始创建几何体...');
                    console.log('选择的形状:', this.selectedShape);
                    
                    const param1 = parseFloat(document.getElementById('param1').value) || 2;
                    const param2 = parseFloat(document.getElementById('param2').value) || 2;
                    const param3 = parseFloat(document.getElementById('param3').value) || 2;
                    const color = document.getElementById('shape-color').value;
                    const transparency = parseFloat(document.getElementById('transparency').value);
                    const wireframe = document.getElementById('wireframe').checked;
                    
                    console.log('参数:', { param1, param2, param3, color, transparency, wireframe });
                    
                    const params = [param1, param2, param3];
                    const geometry = this.createGeometry(this.selectedShape, params);
                    console.log('✅ 几何体创建完成:', geometry);
                    
                    const material = new THREE.MeshPhongMaterial({
                        color: color,
                        transparent: true,
                        opacity: transparency,
                        wireframe: wireframe
                    });
                    console.log('✅ 材质创建完成:', material);
                    
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    console.log('✅ 网格创建完成:', mesh);
                    
                    // 随机位置
                    mesh.position.set(
                        (Math.random() - 0.5) * 10,
                        Math.random() * 5,
                        (Math.random() - 0.5) * 10
                    );
                    console.log('✅ 位置设置完成:', mesh.position);
                    
                    this.scene.add(mesh);
                    console.log('✅ 添加到场景完成');
                    
                    // 存储对象信息
                    const objectInfo = {
                        id: Date.now(),
                        mesh: mesh,
                        type: this.selectedShape,
                        parameters: params,
                        color: color
                    };
                    
                    this.objects.push(objectInfo);
                    this.updateObjectsList();
                    console.log('✅ 几何体创建成功！对象总数:', this.objects.length);
                } catch (error) {
                    console.error('❌ 创建几何体失败:', error);
                    alert('创建几何体失败: ' + error.message);
                }
            }

            createLine() {
                const x1 = parseFloat(document.getElementById('x1').value);
                const y1 = parseFloat(document.getElementById('y1').value);
                const z1 = parseFloat(document.getElementById('z1').value);
                const x2 = parseFloat(document.getElementById('x2').value);
                const y2 = parseFloat(document.getElementById('y2').value);
                const z2 = parseFloat(document.getElementById('z2').value);
                
                if (isNaN(x1) || isNaN(y1) || isNaN(z1) || isNaN(x2) || isNaN(y2) || isNaN(z2)) {
                    alert('请输入有效的坐标值');
                    return;
                }
                
                const material = new THREE.LineBasicMaterial({ 
                    color: 0xFFD700,
                    linewidth: 3
                });
                
                let geometry;
                
                if (this.lineType === 'straight') {
                    // 直线
                    const points = [
                        new THREE.Vector3(x1, y1, z1),
                        new THREE.Vector3(x2, y2, z2)
                    ];
                    geometry = new THREE.BufferGeometry().setFromPoints(points);
                } else {
                    // 曲线
                    const curve = new THREE.QuadraticBezierCurve3(
                        new THREE.Vector3(x1, y1, z1),
                        new THREE.Vector3((x1+x2)/2, Math.max(y1,y2) + 2, (z1+z2)/2),
                        new THREE.Vector3(x2, y2, z2)
                    );
                    const points = curve.getPoints(50);
                    geometry = new THREE.BufferGeometry().setFromPoints(points);
                }
                
                const line = new THREE.Line(geometry, material);
                this.scene.add(line);
                
                // 添加端点标记
                this.addPointMarker(x1, y1, z1);
                this.addPointMarker(x2, y2, z2);
                
                // 存储线段信息
                const lineInfo = {
                    id: Date.now(),
                    mesh: line,
                    type: 'line',
                    start: [x1, y1, z1],
                    end: [x2, y2, z2],
                    lineType: this.lineType
                };
                
                this.objects.push(lineInfo);
                this.updateObjectsList();
            }

            addPointMarker(x, y, z) {
                const geometry = new THREE.SphereGeometry(0.1, 16, 16);
                const material = new THREE.MeshPhongMaterial({ color: 0xFF6B6B });
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.set(x, y, z);
                this.scene.add(sphere);
            }

            updateObjectsList() {
                const listContainer = document.getElementById('objects-list');
                
                if (this.objects.length === 0) {
                    listContainer.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8rem;">暂无对象</div>';
                    return;
                }
                
                listContainer.innerHTML = this.objects.map(obj => `
                    <div class="object-item">
                        <span>${this.getObjectDisplayName(obj)}</span>
                        <button class="delete-button" onclick="geometrySystem.deleteObject(${obj.id})">删除</button>
                    </div>
                `).join('');
            }

            getObjectDisplayName(obj) {
                const typeNames = {
                    cube: '立方体',
                    sphere: '球体',
                    cylinder: '圆柱体',
                    cone: '圆锥体',
                    pyramid: '四角锥',
                    prism: '三角柱',
                    line: '线段'
                };
                return typeNames[obj.type] || obj.type;
            }

            deleteObject(id) {
                const index = this.objects.findIndex(obj => obj.id === id);
                if (index !== -1) {
                    this.scene.remove(this.objects[index].mesh);
                    this.objects.splice(index, 1);
                    this.updateObjectsList();
                }
            }

            clearAll() {
                this.objects.forEach(obj => {
                    this.scene.remove(obj.mesh);
                });
                this.objects = [];
                this.updateObjectsList();
            }

            resetView() {
                this.camera.position.set(10, 10, 10);
                this.camera.lookAt(0, 0, 0);
                this.controls.reset();
            }

            toggleGrid() {
                this.gridHelper.visible = !this.gridHelper.visible;
            }

            toggleAxes() {
                this.axesHelper.visible = !this.axesHelper.visible;
            }

            exportScene() {
                const sceneData = {
                    objects: this.objects.map(obj => ({
                        type: obj.type,
                        parameters: obj.parameters,
                        color: obj.color,
                        position: obj.mesh.position.toArray(),
                        rotation: obj.mesh.rotation.toArray()
                    }))
                };
                
                const dataStr = JSON.stringify(sceneData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'geometry-scene.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }

            onWindowResize() {
                const container = document.getElementById('geometry-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }

            onMouseMove(event) {
                const rect = this.renderer.domElement.getBoundingClientRect();
                this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                // 更新坐标显示
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObject(this.gridHelper);
                
                if (intersects.length > 0) {
                    const point = intersects[0].point;
                    document.getElementById('coordinates-display').textContent = 
                        `鼠标坐标: (${point.x.toFixed(2)}, ${point.y.toFixed(2)}, ${point.z.toFixed(2)})`;
                }
            }

            onMouseClick(event) {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObjects(this.objects.map(obj => obj.mesh));
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    const objectInfo = this.objects.find(obj => obj.mesh === object);
                    
                    if (objectInfo) {
                        this.showObjectInfo(objectInfo);
                    }
                }
            }

            showObjectInfo(objectInfo) {
                let info = `对象类型: ${this.getObjectDisplayName(objectInfo)}\n`;
                
                if (objectInfo.parameters) {
                    info += `参数: ${objectInfo.parameters.join(', ')}\n`;
                }
                
                info += `位置: (${objectInfo.mesh.position.x.toFixed(2)}, ${objectInfo.mesh.position.y.toFixed(2)}, ${objectInfo.mesh.position.z.toFixed(2)})`;
                
                alert(info);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }
        }

        // 全局变量和函数
        let geometrySystem;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('📄 DOM内容已加载');
            
            try {
                console.log('🔄 正在加载Three.js...');
                await loadThreeJS();
                console.log('✅ Three.js加载完成');
                
                console.log('检查THREE.js是否加载:', typeof THREE !== 'undefined');
                console.log('检查OrbitControls是否加载:', typeof THREE.OrbitControls !== 'undefined');
                
                geometrySystem = new SolidGeometryVisualizationSystem();
                console.log('✅ 几何系统实例化成功:', geometrySystem);
            } catch (error) {
                console.error('❌ 几何系统实例化失败:', error);
                document.getElementById('geometry-container').innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #FFD700; text-align: center; padding: 20px;">
                        <div>
                            <h3>❌ 无法加载3D渲染引擎</h3>
                            <p>请检查网络连接或刷新页面重试</p>
                            <p style="font-size: 0.8em; opacity: 0.7;">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        });

        // 全局函数供HTML调用
        function createShape() {
            console.log('🎯 createShape函数被调用');
            if (!geometrySystem) {
                console.error('❌ 几何系统未初始化');
                alert('3D系统未初始化，请刷新页面');
                return;
            }
            geometrySystem.createShape();
        }

        function createLine() {
            geometrySystem.createLine();
        }

        function clearAll() {
            if (confirm('确定要清空所有对象吗？')) {
                geometrySystem.clearAll();
            }
        }

        function resetView() {
            geometrySystem.resetView();
        }

        function toggleGrid() {
            geometrySystem.toggleGrid();
        }

        function toggleAxes() {
            geometrySystem.toggleAxes();
        }

        function exportScene() {
            geometrySystem.exportScene();
        }
    </script>
</body>
</html> 