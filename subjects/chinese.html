<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语文学习助手</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/components.css">
    <style>
        .literature-section {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .poem-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
            position: relative;
            min-height: 300px;
        }

        .poem-title {
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 1rem;
            color: #333;
        }

        .poem-info {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
        }

        .poem-content {
            font-size: 1.2rem;
            line-height: 2;
            text-align: center;
            white-space: pre-wrap;
            margin-bottom: 2rem;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
        }

        .nav-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-button:hover {
            background: #357abd;
        }

        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .explanation-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .explanation-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .explanation-content {
            line-height: 1.8;
            color: #444;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 1rem;
            background: #ffe6e6;
            border-radius: 4px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>语文学习助手</h1>
        </header>

        <section class="literature-section">
            <h2>文学欣赏</h2>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="dynasty-select">朝代</label>
                    <select id="dynasty-select">
                        <option value="">全部朝代</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="author-select">作者</label>
                    <select id="author-select">
                        <option value="">全部作者</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="title-select">诗词标题</label>
                    <select id="title-select">
                        <option value="">全部作品</option>
                    </select>
                </div>
                <button id="query-btn" class="btn btn-primary">查询</button>
            </div>

            <div class="navigation-buttons">
                <button id="prev-btn" class="nav-button" disabled>上一首</button>
                <button id="next-btn" class="nav-button" disabled>下一首</button>
            </div>

            <div id="poem-display" class="poem-card">
                <p class="loading">请选择筛选条件并点击查询按钮</p>
            </div>

            <button id="explain-btn" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" disabled>
                解析诗词内容
            </button>

            <div id="explanation" class="explanation-section" style="display: none;">
                <h3 class="explanation-title">诗词解析</h3>
                <div class="explanation-content"></div>
            </div>
        </section>
    </div>

    <script>
        let currentPoemIndex = 0;
        let poemResults = [];
        let userEducationLevel = 'middle'; // This should be fetched from user profile

        // Fetch dropdown options when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch unique dynasties
                const dynastyResponse = await fetch('/api/db/query/chinese_poem');
                const dynastyData = await dynastyResponse.json();
                if (dynastyData.success) {
                    const uniqueDynasties = [...new Set(dynastyData.data.map(item => item.Dynasty).filter(Boolean))];
                    const dynastySelect = document.getElementById('dynasty-select');
                    uniqueDynasties.forEach(dynasty => {
                        const option = document.createElement('option');
                        option.value = dynasty;
                        option.textContent = dynasty;
                        dynastySelect.appendChild(option);
                    });
                }

                // Fetch unique authors
                const authorResponse = await fetch('/api/db/query/chinese_poem');
                const authorData = await authorResponse.json();
                if (authorData.success) {
                    const uniqueAuthors = [...new Set(authorData.data.map(item => item.Author).filter(Boolean))];
                    const authorSelect = document.getElementById('author-select');
                    uniqueAuthors.forEach(author => {
                        const option = document.createElement('option');
                        option.value = author;
                        option.textContent = author;
                        authorSelect.appendChild(option);
                    });
                }

                // Update title dropdown based on selected dynasty and author
                updateTitleDropdown();
            } catch (error) {
                console.error('Error fetching dropdown options:', error);
            }
        });

        // Update title dropdown when dynasty or author selection changes
        document.getElementById('dynasty-select').addEventListener('change', updateTitleDropdown);
        document.getElementById('author-select').addEventListener('change', updateTitleDropdown);

        async function updateTitleDropdown() {
            const dynasty = document.getElementById('dynasty-select').value;
            const author = document.getElementById('author-select').value;

            try {
                const response = await fetch('/api/db/query/chinese_poem');
                const data = await response.json();
                if (data.success) {
                    let filteredPoems = data.data;
                    if (dynasty) {
                        filteredPoems = filteredPoems.filter(poem => poem.Dynasty === dynasty);
                    }
                    if (author) {
                        filteredPoems = filteredPoems.filter(poem => poem.Author === author);
                    }

                    const titleSelect = document.getElementById('title-select');
                    titleSelect.innerHTML = '<option value="">全部作品</option>';
                    
                    const uniqueTitles = [...new Set(filteredPoems.map(poem => poem.Title).filter(Boolean))];
                    uniqueTitles.forEach(title => {
                        const option = document.createElement('option');
                        option.value = title;
                        option.textContent = title;
                        titleSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error updating title dropdown:', error);
            }
        }

        // Query button click handler
        document.getElementById('query-btn').addEventListener('click', async () => {
            const dynasty = document.getElementById('dynasty-select').value;
            const author = document.getElementById('author-select').value;
            const title = document.getElementById('title-select').value;

            try {
                const response = await fetch('/api/db/query/chinese_poem');
                const data = await response.json();
                if (data.success) {
                    let filteredPoems = data.data;
                    if (dynasty) {
                        filteredPoems = filteredPoems.filter(poem => poem.Dynasty === dynasty);
                    }
                    if (author) {
                        filteredPoems = filteredPoems.filter(poem => poem.Author === author);
                    }
                    if (title) {
                        filteredPoems = filteredPoems.filter(poem => poem.Title === title);
                    }

                    poemResults = filteredPoems;
                    currentPoemIndex = 0;
                    updatePoemDisplay();
                    updateNavigationButtons();
                }
            } catch (error) {
                console.error('Error querying poems:', error);
                document.getElementById('poem-display').innerHTML = `
                    <div class="error">查询诗词时出错：${error.message}</div>
                `;
            }
        });

        // Navigation button click handlers
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentPoemIndex > 0) {
                currentPoemIndex--;
                updatePoemDisplay();
                updateNavigationButtons();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentPoemIndex < poemResults.length - 1) {
                currentPoemIndex++;
                updatePoemDisplay();
                updateNavigationButtons();
            }
        });

        function updatePoemDisplay() {
            const poemDisplay = document.getElementById('poem-display');
            const explainBtn = document.getElementById('explain-btn');
            const explanation = document.getElementById('explanation');

            if (poemResults.length === 0) {
                poemDisplay.innerHTML = '<p class="loading">未找到符合条件的诗词</p>';
                explainBtn.disabled = true;
                explanation.style.display = 'none';
                return;
            }

            const poem = poemResults[currentPoemIndex];
            poemDisplay.innerHTML = `
                <h3 class="poem-title">${poem.Title}</h3>
                <div class="poem-info">
                    <span>${poem.Dynasty} · ${poem.Author}</span>
                </div>
                <div class="poem-content">${poem.Poem}</div>
            `;
            explainBtn.disabled = false;
            explanation.style.display = 'none';
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            prevBtn.disabled = currentPoemIndex === 0;
            nextBtn.disabled = currentPoemIndex === poemResults.length - 1;
        }

        // Explain button click handler
        document.getElementById('explain-btn').addEventListener('click', async () => {
            const poem = poemResults[currentPoemIndex];
            const explanation = document.getElementById('explanation');
            const explanationContent = explanation.querySelector('.explanation-content');

            explanation.style.display = 'block';
            explanationContent.innerHTML = '<p class="loading">正在生成解析...</p>';

            try {
                // This is where you would make the call to the Deepseek API
                // For now, we'll simulate the API call with a placeholder
                const response = await fetch('/api/deepseek/explain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        poem: poem,
                        educationLevel: userEducationLevel
                    })
                });

                const data = await response.json();
                if (data.success) {
                    explanationContent.innerHTML = data.explanation;
                } else {
                    throw new Error(data.error || '解析失败');
                }
            } catch (error) {
                explanationContent.innerHTML = `
                    <div class="error">生成解析时出错：${error.message}</div>
                `;
            }
        });
    </script>
</body>
</html> 