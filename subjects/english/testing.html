<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能力测试 - 英语学习助手</title>
    <link rel="icon" href="../../assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/utilities.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .testing-hero {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            padding: 4rem 0;
            text-align: center;
        }

        .testing-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .testing-hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .testing-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
            overflow: hidden;
            flex-wrap: wrap;
        }

        .testing-tab {
            flex: 1;
            min-width: 150px;
            padding: 1rem 2rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .testing-tab.active {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .testing-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .testing-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .testing-panel {
            display: none;
        }

        .testing-panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .test-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .test-type-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
        }

        .test-type-card:hover {
            background: #e9ecef;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .test-type-card.selected {
            border-color: #6c5ce7;
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.1));
        }

        .test-type-card h3 {
            color: #6c5ce7;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .test-icon {
            font-size: 2.5rem;
            color: #6c5ce7;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: #6c5ce7;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.25);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-question {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3436;
        }

        .options-list {
            list-style: none;
            padding: 0;
        }

        .option-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-item:hover {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.05);
        }

        .option-item.selected {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.1);
        }

        .option-item.correct {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.1);
        }

        .option-item.incorrect {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .result-summary {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.1));
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .score-display {
            font-size: 3rem;
            font-weight: 700;
            color: #6c5ce7;
            margin-bottom: 1rem;
        }

        .level-badge {
            display: inline-block;
            background: #6c5ce7;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .feedback-list {
            text-align: left;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .feedback-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .feedback-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .progress-container {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #6c5ce7, #a29bfe);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* AI Quiz Generation Styles */
        .ai-quiz-config {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(114, 9, 183, 0.1));
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .topic-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-card:hover {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.05);
        }

        .topic-card.selected {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.1);
        }

        .topic-icon {
            font-size: 2rem;
            color: #6c5ce7;
            margin-bottom: 0.5rem;
        }

        .difficulty-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .difficulty-btn:hover {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.05);
        }

        .difficulty-btn.selected {
            border-color: #6c5ce7;
            background: #6c5ce7;
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e9ecef;
            border-top: 5px solid #6c5ce7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .quiz-counter {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            gap: 1rem;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        /* Reading Test Styles */
        .reading-test-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .reading-passage-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }

        .passage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .reading-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: #5a4dcf;
            transform: translateY(-1px);
        }

        .reading-passage {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.8;
            font-size: 16px;
            border: 1px solid #e9ecef;
        }

        .passage-title {
            color: #6c5ce7;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .passage-content p {
            margin-bottom: 1rem;
            text-align: justify;
        }

        .questions-container {
            margin-top: 2rem;
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #6c5ce7, #a29bfe);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-weight: 500;
            color: #6c5ce7;
            margin-bottom: 1.5rem;
        }

        .test-question {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s;
        }

        .test-question:hover {
            box-shadow: 0 2px 10px rgba(108, 92, 231, 0.1);
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3436;
            line-height: 1.6;
        }

        .question-number {
            color: #6c5ce7;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .option-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-height: 48px; /* Touch-friendly size */
        }

        .option-item:hover {
            background: #e9ecef;
            border-color: #6c5ce7;
        }

        .option-item.selected {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.1));
            border-color: #6c5ce7;
            color: #6c5ce7;
        }

        .option-letter {
            background: #6c5ce7;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
            line-height: 1.5;
        }

        .submit-container {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }

        /* Cloze Test Styles */
        .cloze-instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .cloze-passage-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }

        .cloze-passage {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.8;
            font-size: 16px;
            border: 1px solid #e9ecef;
        }

        .cloze-blank {
            background: linear-gradient(135deg, #ff7675, #fd79a8);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
            margin: 0 2px;
        }

        .cloze-questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .cloze-question {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .question-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .context-hint {
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
        }

        .options-list.compact .option-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        /* Matching Test Styles */
        .matching-instructions {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .matching-left, .matching-right {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .matching-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-height: 48px;
        }

        .matching-item:hover {
            background: #e9ecef;
            border-color: #6c5ce7;
        }

        .matching-item.selected {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.1));
            border-color: #6c5ce7;
        }

        .matching-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-height: 48px;
        }

        .matching-option:hover {
            background: #e9ecef;
            border-color: #00b894;
        }

        .item-number {
            background: #6c5ce7;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .item-content {
            flex: 1;
            line-height: 1.5;
        }

        .match-indicator {
            color: #ddd;
            font-size: 1.2rem;
        }

        .matching-answers {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .answer-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .answer-item.answered {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .answer-number {
            font-weight: 600;
            color: #6c5ce7;
        }

        .answer-content {
            flex: 1;
            font-size: 0.9rem;
        }

        /* Result Styles */
        .result-summary {
            text-align: center;
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .score-display {
            font-size: 3rem;
            font-weight: 700;
            color: #6c5ce7;
            margin: 1rem 0;
        }

        .level-badge {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.2rem;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .result-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .testing-tabs {
                flex-direction: column;
            }

            .testing-tab {
                padding: 0.8rem 1rem;
                min-width: auto;
            }

            .testing-hero h1 {
                font-size: 2rem;
            }

            .test-type-grid {
                grid-template-columns: 1fr;
            }

            .topic-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .difficulty-selector {
                justify-content: center;
            }

            .quiz-navigation {
                flex-direction: column;
                align-items: stretch;
            }

            .passage-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .reading-controls {
                align-self: flex-end;
            }

            .cloze-questions-grid {
                grid-template-columns: 1fr;
            }

            .matching-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .answers-grid {
                grid-template-columns: 1fr;
            }

            .progress-sections {
                grid-template-columns: 1fr;
            }

            .result-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .score-display {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .reading-passage, .cloze-passage {
                padding: 1rem;
                font-size: 14px;
                line-height: 1.6;
            }

            .option-item {
                padding: 0.75rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .option-letter {
                align-self: flex-start;
            }

            .btn-icon {
                min-width: 36px;
                min-height: 36px;
            }

            .matching-item, .matching-option {
                padding: 0.75rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .item-number {
                align-self: flex-start;
            }
        }
        
        /* Detailed Results Styles */
        .reading-test-results {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .detailed-results {
            margin-top: 30px;
        }
        
        .result-item {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 15px;
            background: white;
            overflow: hidden;
        }
        
        .result-item.correct {
            border-left: 4px solid #00b894;
        }
        
        .result-item.incorrect {
            border-left: 4px solid #e74c3c;
        }
        
        .result-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .result-header h5 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-content {
            padding: 15px;
        }
        
        .answer-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .answer-comparison {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .user-answer, .correct-answer {
            padding: 10px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .user-answer {
            border-left: 3px solid #007bff;
        }
        
        .correct-answer {
            border-left: 3px solid #00b894;
        }
        
        .explanation {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .explanation strong {
            color: #8b4513;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .explanation p {
            margin: 0;
            line-height: 1.6;
            color: #5d4e37;
        }
        
        .text-success {
            color: #00b894 !important;
        }
        
        .text-danger {
            color: #e74c3c !important;
        }
        
        .result-actions {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid #e1e5e9;
        }
        
        .result-actions .btn {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../../index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span class="gradient-text">Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="../../index.html#subjects">科目</a></li>
                        <li><a href="../../tts.html">语音</a></li>
                        <li><a href="../../draw.html">绘图</a></li>
                        <li><a href="main.html">返回英语</a></li>
                    </ul>
                </nav>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="testing-hero">
            <div class="container">
                <h1><i class="fas fa-tasks"></i> 英语能力测试</h1>
                <p>全面评估你的英语听说读写能力，找出需要提高的方面</p>
            </div>
        </section>

        <!-- Main Content -->
        <section class="main-content">
            <div class="container">
                <!-- Testing Tabs -->
                <div class="testing-tabs">
                    <button class="testing-tab active" data-tab="ai-quiz">
                        <i class="fas fa-brain"></i> AI智能测试
                    </button>
                    <button class="testing-tab" data-tab="reading">
                        <i class="fas fa-book-open"></i> 阅读测试
                    </button>
                    <button class="testing-tab" data-tab="results">
                        <i class="fas fa-chart-bar"></i> 测试报告
                    </button>
                </div>
                
                <!-- AI Quiz Panel -->
                <div id="ai-quiz-panel" class="testing-content testing-panel active">
                    <h2><i class="fas fa-brain"></i> AI智能测试</h2>
                    <p>基于AI技术生成个性化英语测试题目，支持多种话题和难度级别</p>
                    
                    <div class="ai-quiz-config">
                        <h3><i class="fas fa-cog"></i> 测试配置</h3>
                        
                        <!-- Topic Selection -->
                        <div class="form-group">
                            <label><strong>选择测试话题：</strong></label>
                            <div class="topic-grid" id="topic-grid">
                                <div class="topic-card" data-topic="grammar">
                                    <div class="topic-icon"><i class="fas fa-font"></i></div>
                                    <h4>语法</h4>
                                    <p>Grammar</p>
                                </div>
                                <div class="topic-card" data-topic="vocabulary">
                                    <div class="topic-icon"><i class="fas fa-book"></i></div>
                                    <h4>词汇</h4>
                                    <p>Vocabulary</p>
                                </div>
                                <div class="topic-card" data-topic="reading">
                                    <div class="topic-icon"><i class="fas fa-book-open"></i></div>
                                    <h4>阅读理解</h4>
                                    <p>Reading</p>
                                </div>

                                <div class="topic-card" data-topic="toefl">
                                    <div class="topic-icon"><i class="fas fa-graduation-cap"></i></div>
                                    <h4>托福练习</h4>
                                    <p>TOEFL</p>
                                </div>
                                <div class="topic-card" data-topic="ielts">
                                    <div class="topic-icon"><i class="fas fa-certificate"></i></div>
                                    <h4>雅思练习</h4>
                                    <p>IELTS</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Difficulty Selection -->
                        <div class="form-group">
                            <label><strong>选择难度级别：</strong></label>
                            <div class="difficulty-selector" id="difficulty-selector">
                                <button class="difficulty-btn" data-difficulty="beginner">
                                    <i class="fas fa-seedling"></i> 初级
                                </button>
                                <button class="difficulty-btn" data-difficulty="intermediate">
                                    <i class="fas fa-tree"></i> 中级
                                </button>
                                <button class="difficulty-btn" data-difficulty="advanced">
                                    <i class="fas fa-mountain"></i> 高级
                                </button>
                            </div>
                        </div>
                        
                        <!-- Question Count -->
                        <div class="form-group">
                            <label for="question-count"><strong>题目数量：</strong></label>
                            <select id="question-count" class="form-control" style="max-width: 200px;">
                                <option value="5">5题</option>
                                <option value="10" selected>10题</option>
                                <option value="15">15题</option>
                                <option value="20">20题</option>
                            </select>
                        </div>
                        
                        <!-- Custom Topic -->
                        <div class="form-group">
                            <label for="custom-topic"><strong>自定义话题（可选）：</strong></label>
                            <input type="text" id="custom-topic" class="form-control" placeholder="例如：商务英语、日常对话、学术写作等">
                        </div>
                        
                        <div class="form-group">
                            <button id="generate-ai-quiz" class="btn btn-primary">
                                <i class="fas fa-magic"></i> 生成AI测试
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quiz Display Area -->
                    <div id="ai-quiz-container" style="display: none;">
                        <!-- AI generated quiz will appear here -->
                    </div>
                </div>



                <!-- Reading Panel -->
                <div id="reading-panel" class="testing-content testing-panel">
                    <h2><i class="fas fa-book-open"></i> 阅读测试</h2>
                    <p>测试你的英语阅读理解能力，包括各种文体和主题</p>
                    
                    <div class="form-group">
                        <label for="reading-level">选择难度级别：</label>
                        <select id="reading-level" class="form-control">
                            <option value="beginner">初级 (A1-A2)</option>
                            <option value="intermediate" selected>中级 (B1-B2)</option>
                            <option value="advanced">高级 (C1-C2)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reading-type">测试类型：</label>
                        <select id="reading-type" class="form-control">
                            <option value="comprehension" selected>阅读理解 (5题)</option>
                            <option value="cloze">完形填空 (10题)</option>
                            <option value="matching">匹配题</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reading-topic">内容主题：</label>
                        <select id="reading-topic" class="form-control">
                            <option value="story">故事类</option>
                            <option value="news" selected>时事新闻</option>
                            <option value="technology">科技发展</option>
                            <option value="education">教育学习</option>
                            <option value="environment">环境保护</option>
                            <option value="culture">文化社会</option>
                            <option value="health">健康生活</option>
                            <option value="travel">旅行探索</option>
                            <option value="sports">体育运动</option>
                            <option value="science">科学发现</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button id="start-reading-test" class="btn btn-primary">
                            <i class="fas fa-play"></i> 开始阅读测试
                        </button>
                    </div>
                    
                    <div id="reading-test-container" style="display: none;">
                        <!-- Test content will be loaded here -->
                    </div>
                </div>



                <!-- Results Panel -->
                <div id="results-panel" class="testing-content testing-panel">
                    <h2><i class="fas fa-chart-bar"></i> 测试报告</h2>
                    <p>查看你的英语能力测试结果和个性化学习建议</p>
                    
                    <div id="no-results-message">
                        <p class="text-center">你还没有完成任何测试。请完成至少一项测试以查看报告。</p>
                    </div>
                    
                    <div id="results-container" style="display: none;">
                        <div class="result-summary">
                            <h3>综合英语水平</h3>
                            <div class="score-display" id="overall-score">B1</div>
                            <div class="level-badge" id="level-description">中级</div>
                            <p>基于你的测试结果，你的英语水平相当于欧洲共同语言参考框架 (CEFR) 的 <strong>B1</strong> 级别。</p>
                        </div>
                        
                        <div class="test-type-grid">
                            <div class="test-type-card">
                                <div class="test-icon"><i class="fas fa-book-open"></i></div>
                                <h3>阅读能力</h3>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: 75%"></div>
                                </div>
                                <p>B2 (75%)</p>
                            </div>
                        </div>
                        
                        <div class="feedback-list">
                            <h3>个性化学习建议</h3>
                            <div class="feedback-item">
                                <h4>阅读提升</h4>
                                <p>你的阅读能力较强，建议尝试阅读更复杂的材料，如新闻文章、学术文章等。继续练习不同类型的阅读理解题目，包括完形填空和匹配题，以进一步提高阅读技能。</p>
                            </div>
                        </div>
                        
                        <div class="form-group" style="text-align: center; margin-top: 2rem;">
                            <button id="download-report" class="btn btn-primary">
                                <i class="fas fa-download"></i> 下载完整报告
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="../../js/common.js"></script>
    <script src="../../js/navigation.js"></script>
    <script src="../../js/profile.js"></script>
    <script>
        // AI Quiz Global Variables
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let selectedTopic = '';
        let selectedDifficulty = '';
        let questionCount = 10;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Tab navigation
            const tabs = document.querySelectorAll('.testing-tab');
            const panels = document.querySelectorAll('.testing-panel');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetPanel = this.getAttribute('data-tab') + '-panel';
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active panel
                    panels.forEach(p => p.classList.remove('active'));
                    document.getElementById(targetPanel).classList.add('active');
                });
            });

            // AI Quiz Functionality
            initializeAIQuizEvents();

            // Test type selection
            const testTypeCards = document.querySelectorAll('.test-type-card');
            testTypeCards.forEach(card => {
                card.addEventListener('click', function() {
                    testTypeCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Reading test
            const startReadingBtn = document.getElementById('start-reading-test');
            const readingContainer = document.getElementById('reading-test-container');
            
            startReadingBtn.addEventListener('click', function() {
                const level = document.getElementById('reading-level').value;
                const type = document.getElementById('reading-type').value;
                const topic = document.getElementById('reading-topic').value;
                startReadingTest(level, type, topic, readingContainer);
            });

            // Results view
            const downloadReportBtn = document.getElementById('download-report');
            downloadReportBtn.addEventListener('click', function() {
                alert('报告已开始下载（模拟）');
                // In a real app, generate and download PDF here
            });

            // Test implementation functions



            async function startReadingTest(level, type, topic, container) {
                container.style.display = 'block';
                container.innerHTML = '<p class="text-center"><i class="fas fa-brain"></i> AI正在生成阅读测试，请稍候...</p>';
                
                try {
                    await generateReadingTest(level, type, topic, container);
                } catch (error) {
                    console.error('Reading test generation failed:', error);
                    container.innerHTML = '<p class="text-center error-message">生成测试失败，请重试</p>';
                }
            }

            async function generateReadingTest(level, type, topic, container) {
                let html = '';
                
                switch(type) {
                    case 'comprehension':
                        html = await generateReadingComprehensionTest(level, topic);
                        break;
                    case 'cloze':
                        html = await generateClozeTest(level, topic);
                        break;
                    case 'matching':
                        html = await generateMatchingTest(level, topic);
                        break;
                    default:
                        html = await generateReadingComprehensionTest(level, topic);
                }
                
                container.innerHTML = html;
                
                // Add event listeners
                addReadingTestEventListeners(container, type);
                
                // Scroll to test container
                container.scrollIntoView({ behavior: 'smooth' });
            }

            // Static Test Data Functions (fallback when AI fails)
            function getReadingPassages(level) {
                return {
                    beginner: [
                        {
                            title: "My Daily Routine",
                            content: `<p>My name is Sarah and I am a high school student. Every morning, I wake up at 6:30 AM. I brush my teeth, wash my face, and get dressed. Then I have breakfast with my family. We usually eat bread, eggs, and drink milk or juice.</p>
                            <p>At 7:30 AM, I walk to school with my friends. Our school starts at 8:00 AM. I have six classes every day: English, Math, Science, History, Art, and Physical Education. My favorite subject is English because I like reading stories and writing essays.</p>
                            <p>After school, I go home and do my homework. In the evening, I sometimes watch TV or play games with my younger brother. I go to bed at 10:00 PM.</p>`,
                            questions: [
                                {
                                    question: "What time does Sarah wake up?",
                                    options: ["6:00 AM", "6:30 AM", "7:00 AM", "7:30 AM"],
                                    correct: 1,
                                    explanation: "根据文章第一段'Every morning, I wake up at 6:30 AM'可知，Sarah每天早上6:30起床，所以答案是B。A项6:00太早，C项7:00和D项7:30都比实际时间晚。"
                                },
                                {
                                    question: "What is Sarah's favorite subject?",
                                    options: ["Math", "Science", "English", "History"],
                                    correct: 2,
                                    explanation: "文章第二段明确提到'My favorite subject is English because I like reading stories and writing essays'，说明Sarah最喜欢的科目是英语，因为她喜欢阅读故事和写作文。其他选项Math、Science、History虽然都是她学习的科目，但不是最喜欢的。"
                                },
                                {
                                    question: "How does Sarah go to school?",
                                    options: ["By bus", "By car", "On foot", "By bike"],
                                    correct: 2,
                                    explanation: "文章第二段提到'I walk to school with my friends'，表明Sarah是步行上学的，所以答案是C。walk to school意思就是步行上学。"
                                },
                                {
                                    question: "How many classes does Sarah have every day?",
                                    options: ["Five", "Six", "Seven", "Eight"],
                                    correct: 1,
                                    explanation: "文章明确写道'I have six classes every day: English, Math, Science, History, Art, and Physical Education'，Sarah每天有六节课，所以答案是B。"
                                },
                                {
                                    question: "What does Sarah do in the evening?",
                                    options: ["Only does homework", "Only watches TV", "Sometimes watches TV or plays games", "Always goes to bed early"],
                                    correct: 2,
                                    explanation: "文章最后一段提到'In the evening, I sometimes watch TV or play games with my younger brother'，说明Sarah晚上有时看电视或和弟弟玩游戏，关键词是'sometimes'，所以答案是C。"
                                }
                            ]
                        }
                    ],
                    intermediate: [
                        {
                            title: "The Benefits of Reading",
                            content: `<p>Reading is one of the most valuable skills a person can develop. It not only provides entertainment but also offers numerous educational and personal benefits. When we read regularly, we expand our vocabulary, improve our writing skills, and enhance our understanding of the world around us.</p>
                            <p>Research has shown that people who read frequently have better concentration and analytical thinking skills. Reading different types of books exposes us to various writing styles, cultures, and perspectives. This exposure helps us become more empathetic and open-minded individuals.</p>
                            <p>Furthermore, reading can reduce stress and improve mental health. When we immerse ourselves in a good book, we can temporarily escape from daily worries and pressures. This mental break is essential for maintaining psychological well-being.</p>`,
                            questions: [
                                {
                                    question: "According to the passage, reading helps improve all of the following EXCEPT:",
                                    options: ["vocabulary", "writing skills", "physical strength", "understanding of the world"],
                                    correct: 2,
                                    explanation: "文章第一段提到阅读可以扩展词汇量(expand vocabulary)、提高写作技能(improve writing skills)和增强对世界的理解(enhance understanding of the world)，但没有提到改善身体力量(physical strength)。阅读是一种脑力活动，不涉及身体锻炼。"
                                },
                                {
                                    question: "What does the passage suggest about people who read frequently?",
                                    options: ["They are always happy", "They have better concentration", "They earn more money", "They live longer"],
                                    correct: 1,
                                    explanation: "文章第二段明确提到'people who read frequently have better concentration and analytical thinking skills'，经常阅读的人有更好的专注力和分析思维能力。其他选项在文中都没有提及。"
                                },
                                {
                                    question: "The word 'empathetic' in paragraph 2 most likely means:",
                                    options: ["emotional", "understanding", "intelligent", "creative"],
                                    correct: 1,
                                    explanation: "根据上下文'Reading different types of books exposes us to various writing styles, cultures, and perspectives. This exposure helps us become more empathetic'可知，接触不同的文化和观点有助于我们变得更加empathetic，这里指的是更能理解他人，所以答案是understanding。"
                                },
                                {
                                    question: "What is the main purpose of the passage?",
                                    options: ["To teach reading techniques", "To promote the benefits of reading", "To compare different types of books", "To criticize non-readers"],
                                    correct: 1,
                                    explanation: "文章的主要目的是宣传阅读的好处。文章从多个角度论述了阅读的益处：提高语言技能、增强思维能力、促进心理健康等，明显是在推广阅读的价值。"
                                },
                                {
                                    question: "According to the passage, reading can help reduce:",
                                    options: ["vocabulary size", "stress levels", "learning ability", "writing skills"],
                                    correct: 1,
                                    explanation: "文章第三段提到'reading can reduce stress and improve mental health'，阅读可以减少压力并改善心理健康。其他选项都与文章内容相反。"
                                }
                            ]
                        }
                    ],
                    advanced: [
                        {
                            title: "The Impact of Artificial Intelligence on Society",
                            content: `<p>Artificial Intelligence (AI) has emerged as one of the most transformative technologies of the 21st century, fundamentally altering how we work, communicate, and interact with the world. From autonomous vehicles to sophisticated chatbots, AI applications are becoming increasingly prevalent across various sectors, including healthcare, finance, education, and entertainment.</p>
                            <p>While the potential benefits of AI are substantial—increased efficiency, enhanced decision-making capabilities, and the automation of mundane tasks—there are also significant concerns that must be addressed. The displacement of traditional jobs, privacy issues related to data collection, and the ethical implications of algorithmic decision-making represent challenges that society must navigate carefully.</p>
                            <p>Moreover, the rapid pace of AI development has outstripped regulatory frameworks, creating a gap between technological capabilities and governance structures. This discrepancy raises questions about accountability, transparency, and the equitable distribution of AI's benefits across different socioeconomic groups.</p>`,
                            questions: [
                                {
                                    question: "The author's attitude toward AI can best be described as:",
                                    options: ["entirely optimistic", "completely pessimistic", "cautiously balanced", "indifferent"],
                                    correct: 2,
                                    explanation: "作者对AI的态度是谨慎平衡的。文章既提到了AI的潜在好处(increased efficiency, enhanced decision-making)，也指出了重大担忧(job displacement, privacy issues)，体现了客观理性的分析态度。"
                                },
                                {
                                    question: "What does the passage suggest about AI regulation?",
                                    options: ["It is too strict", "It is keeping pace with technology", "It is lagging behind technological development", "It is unnecessary"],
                                    correct: 2,
                                    explanation: "文章第三段明确提到'the rapid pace of AI development has outstripped regulatory frameworks'，AI发展的快速步伐已经超越了监管框架，说明监管滞后于技术发展。"
                                },
                                {
                                    question: "The word 'substantial' in paragraph 2 is closest in meaning to:",
                                    options: ["minor", "significant", "theoretical", "temporary"],
                                    correct: 1,
                                    explanation: "'substantial'在这里意思是'重大的、显著的'。文章说AI的潜在好处是substantial的，即显著的、重要的，所以答案是significant。"
                                },
                                {
                                    question: "Which of the following best describes the main concern about AI mentioned in the passage?",
                                    options: ["It is too expensive", "It lacks accuracy", "It may widen social inequality", "It is difficult to understand"],
                                    correct: 2,
                                    explanation: "文章最后提到AI发展与治理结构的差距引发了关于'equitable distribution of AI's benefits across different socioeconomic groups'的问题，即AI可能加剧社会不平等。"
                                },
                                {
                                    question: "The passage implies that successful AI implementation requires:",
                                    options: ["faster development", "less regulation", "better governance frameworks", "more funding"],
                                    correct: 2,
                                    explanation: "文章强调了AI发展超越监管框架的问题，以及关于accountability、transparency等治理问题的担忧，暗示成功的AI实施需要更好的治理框架。"
                                }
                            ]
                        }
                    ]
                };
            }

            function getClozeTexts(level) {
                return {
                    beginner: [
                        {
                            title: "Tom的校园生活",
                            content: "Tom is a {0} student. He goes to {1} every day by bus. His favorite {2} is English because he wants to {3} to other countries. After school, he {4} his homework and then plays with his friends. Tom also {5} in the school basketball team. He {6} very hard for the games. His teachers {7} him because he is polite and helpful. Tom's {8} is to become a teacher when he grows up. He believes that {9} can change the world.",
                            blanks: [
                                {
                                    context: "Tom is a ___ student",
                                    options: ["good", "bad", "lazy", "tired"],
                                    correct: 0,
                                    explanation: "从上下文可以看出Tom是个积极向上的学生，所以应该选'good'。后文提到他努力学习、参加体育队、有礼貌等都说明他是个好学生。"
                                },
                                {
                                    context: "He goes to ___ every day",
                                    options: ["work", "school", "home", "store"],
                                    correct: 1,
                                    explanation: "从上下文'student'和'by bus'可知，学生每天去的地方是学校。work(工作)、home(家)、store(商店)都不符合学生的日常行为。"
                                },
                                {
                                    context: "His favorite ___ is English",
                                    options: ["color", "food", "subject", "game"],
                                    correct: 2,
                                    explanation: "从语法结构和逻辑来看，这里说的是最喜欢的学科是英语。subject意为'学科'，符合语境。"
                                },
                                {
                                    context: "because he wants to ___ to other countries",
                                    options: ["walk", "drive", "swim", "travel"],
                                    correct: 3,
                                    explanation: "want to travel to other countries意为'想要去其他国家旅行'，这是学习英语的常见目的。travel是最合适的动词。"
                                },
                                {
                                    context: "After school, he ___ his homework",
                                    options: ["does", "forgets", "loses", "buys"],
                                    correct: 0,
                                    explanation: "do homework是固定搭配，意为'做作业'。这是学生放学后的正常活动，符合Tom作为好学生的形象。"
                                },
                                {
                                    context: "Tom also ___ in the school basketball team",
                                    options: ["works", "plays", "studies", "teaches"],
                                    correct: 1,
                                    explanation: "play in the team意为'在队里打球'，这是参加体育队的常用表达。works、studies、teaches都不符合语境。"
                                },
                                {
                                    context: "He ___ very hard for the games",
                                    options: ["sleeps", "eats", "practices", "talks"],
                                    correct: 2,
                                    explanation: "practice hard意为'努力练习'，这是为比赛做准备的正确表达。体育队员需要刻苦训练才能在比赛中表现好。"
                                },
                                {
                                    context: "His teachers ___ him",
                                    options: ["hate", "ignore", "forget", "like"],
                                    correct: 3,
                                    explanation: "从后文'because he is polite and helpful'可知，老师们喜欢Tom，因为他有礼貌且乐于助人。like符合逻辑。"
                                },
                                {
                                    context: "Tom's ___ is to become a teacher",
                                    options: ["dream", "hobby", "problem", "fear"],
                                    correct: 0,
                                    explanation: "dream意为'梦想'，成为老师是Tom的梦想/目标。这里表达的是对未来的期望和目标。"
                                },
                                {
                                    context: "He believes that ___ can change the world",
                                    options: ["money", "education", "games", "food"],
                                    correct: 1,
                                    explanation: "education意为'教育'，这与Tom想成为老师的梦想呼应。教育确实有改变世界的力量，这是一个积极向上的观点。"
                                }
                            ]
                        }
                    ],
                    intermediate: [
                        {
                            title: "环境保护的重要性",
                            content: "Climate change is one of the most {0} challenges facing our planet today. Scientists {1} that global temperatures have risen significantly over the past century. To {2} this problem, we must reduce our carbon emissions and develop {3} energy sources. Every individual can {4} by making small changes in their daily lives. Governments should {5} strict environmental policies. Companies need to {6} more responsibility for their environmental impact. The {7} generation depends on our actions today. We must {8} together to protect our planet. Only through {9} efforts can we create a sustainable future.",
                            blanks: [
                                {
                                    context: "one of the most ___ challenges",
                                    options: ["serious", "easy", "funny", "simple"],
                                    correct: 0,
                                    explanation: "气候变化是一个严重的(serious)挑战。easy、funny、simple都不符合气候变化问题的严重性。"
                                },
                                {
                                    context: "Scientists ___ that global temperatures",
                                    options: ["deny", "report", "ignore", "forget"],
                                    correct: 1,
                                    explanation: "科学家报告(report)全球气温上升的发现。deny(否认)、ignore(忽视)、forget(忘记)都与科学研究的性质不符。"
                                },
                                {
                                    context: "To ___ this problem",
                                    options: ["create", "ignore", "solve", "avoid"],
                                    correct: 2,
                                    explanation: "为了解决(solve)这个问题。solve problem是固定搭配，其他选项都不符合逻辑。"
                                },
                                {
                                    context: "develop ___ energy sources",
                                    options: ["dirty", "expensive", "dangerous", "renewable"],
                                    correct: 3,
                                    explanation: "发展可再生能源(renewable energy)是解决环境问题的关键。renewable energy是环保领域的专业术语。"
                                },
                                {
                                    context: "Every individual can ___",
                                    options: ["contribute", "quit", "complain", "escape"],
                                    correct: 0,
                                    explanation: "每个人都可以贡献力量(contribute)。contribute符合后文'making small changes'的语境。"
                                },
                                {
                                    context: "Governments should ___ strict policies",
                                    options: ["avoid", "implement", "cancel", "delay"],
                                    correct: 1,
                                    explanation: "政府应该实施(implement)严格的环保政策。implement policies是常用搭配。"
                                },
                                {
                                    context: "Companies need to ___ more responsibility",
                                    options: ["avoid", "refuse", "take", "deny"],
                                    correct: 2,
                                    explanation: "公司需要承担(take)更多责任。take responsibility是固定搭配，意为'承担责任'。"
                                },
                                {
                                    context: "The ___ generation depends on our actions",
                                    options: ["past", "current", "old", "future"],
                                    correct: 3,
                                    explanation: "未来的(future)一代取决于我们今天的行动。这强调了环保行动对后代的重要性。"
                                },
                                {
                                    context: "We must ___ together",
                                    options: ["work", "fight", "argue", "compete"],
                                    correct: 0,
                                    explanation: "我们必须共同努力(work together)。work together是固定搭配，表示'合作、协作'。"
                                },
                                {
                                    context: "Only through ___ efforts",
                                    options: ["individual", "collective", "minimal", "random"],
                                    correct: 1,
                                    explanation: "只有通过集体(collective)努力才能创造可持续的未来。collective efforts强调团结合作的重要性。"
                                }
                            ]
                        }
                    ],
                    advanced: [
                        {
                            title: "科技创新的双刃剑",
                            content: "The {0} advancement of technology has {1} transformed modern society. Innovations in artificial intelligence and machine learning have {2} new possibilities for automation and efficiency. However, these developments also {3} significant ethical and social {4} that require careful consideration. The {5} of technology on employment patterns cannot be ignored. While some jobs become {6}, new opportunities emerge in tech-related fields. Society must {7} to these changes by investing in education and retraining programs. The {8} lies in balancing technological progress with human welfare. We must ensure that technology {9} humanity rather than replacing it.",
                            blanks: [
                                {
                                    context: "The ___ advancement of technology",
                                    options: ["slow", "rapid", "backward", "limited"],
                                    correct: 1,
                                    explanation: "技术的快速(rapid)发展。从上下文可以看出技术发展迅速，fundamentally transformed说明变化巨大且快速。"
                                },
                                {
                                    context: "has ___ transformed modern society",
                                    options: ["slightly", "rarely", "fundamentally", "barely"],
                                    correct: 2,
                                    explanation: "从根本上(fundamentally)改变了现代社会。fundamentally表示彻底的、根本性的改变，符合技术对社会的深远影响。"
                                },
                                {
                                    context: "have ___ new possibilities",
                                    options: ["limited", "destroyed", "ignored", "created"],
                                    correct: 3,
                                    explanation: "AI和机器学习创造了(created)新的可能性。create possibilities是常用搭配，表示'创造机会'。"
                                },
                                {
                                    context: "also ___ significant challenges",
                                    options: ["present", "solve", "avoid", "ignore"],
                                    correct: 0,
                                    explanation: "这些发展也带来了(present)重大挑战。present challenges意为'提出挑战、带来问题'。"
                                },
                                {
                                    context: "ethical and social ___",
                                    options: ["benefits", "challenges", "rewards", "advantages"],
                                    correct: 1,
                                    explanation: "伦理和社会挑战(challenges)。从however可以看出这是转折，前面说好处，这里说挑战。"
                                },
                                {
                                    context: "The ___ of technology on employment",
                                    options: ["benefit", "advantage", "impact", "pleasure"],
                                    correct: 2,
                                    explanation: "技术对就业的影响(impact)。impact on是固定搭配，表示'对...的影响'。"
                                },
                                {
                                    context: "some jobs become ___",
                                    options: ["popular", "easier", "profitable", "obsolete"],
                                    correct: 3,
                                    explanation: "一些工作变得过时了(obsolete)。与后文new opportunities形成对比，说明技术让一些工作消失。"
                                },
                                {
                                    context: "Society must ___ to these changes",
                                    options: ["adapt", "resist", "object", "surrender"],
                                    correct: 0,
                                    explanation: "社会必须适应(adapt)这些变化。adapt to是固定搭配，意为'适应'。"
                                },
                                {
                                    context: "The ___ lies in balancing",
                                    options: ["problem", "challenge", "solution", "answer"],
                                    correct: 1,
                                    explanation: "挑战(challenge)在于平衡技术进步与人类福利。这里指出了关键难题所在。"
                                },
                                {
                                    context: "technology ___ humanity",
                                    options: ["replaces", "controls", "serves", "dominates"],
                                    correct: 2,
                                    explanation: "技术应该服务于(serves)人类而不是取代人类。serve表示'为...服务'，体现了正确的技术发展理念。"
                                }
                            ]
                        }
                    ]
                };
            }

            function getMatchingTests(level) {
                return {
                    beginner: [
                        {
                            instructions: "Match each profession with the place where they work.",
                            leftTitle: "Professions",
                            rightTitle: "Workplaces",
                            leftItems: ["Doctor", "Teacher", "Chef", "Firefighter", "Librarian"],
                            rightItems: ["Fire station", "Kitchen", "Hospital", "Library", "School"],
                            correctMatches: [2, 4, 1, 0, 3]
                        }
                    ],
                    intermediate: [
                        {
                            instructions: "Match each environmental problem with its primary solution.",
                            leftTitle: "Environmental Problems",
                            rightTitle: "Solutions",
                            leftItems: ["Air pollution", "Deforestation", "Water shortage", "Global warming", "Plastic waste"],
                            rightItems: ["Recycling programs", "Renewable energy", "Tree planting", "Clean transportation", "Water conservation"],
                            correctMatches: [3, 2, 4, 1, 0]
                        }
                    ],
                    advanced: [
                        {
                            instructions: "Match each scientific discovery with its social impact.",
                            leftTitle: "Scientific Discoveries",
                            rightTitle: "Social Impacts",
                            leftItems: ["Internet", "Antibiotics", "DNA sequencing", "Artificial Intelligence", "Renewable energy"],
                            rightItems: ["Personalized medicine", "Global communication", "Automation of jobs", "Sustainable development", "Extended life expectancy"],
                            correctMatches: [1, 4, 0, 2, 3]
                        }
                    ]
                };
            }

            // AI-Powered Test Generation Functions
            async function generateReadingComprehensionTest(level, topic) {
                try {
                    const topicName = getTopicName(topic);
                    // Create prompt for AI reading comprehension generation
                    const prompt = `请为英语${getLevelName(level)}水平的初高中学习者生成一篇${topicName}主题的阅读理解测试。

要求：
1. 生成一篇适合${getLevelName(level)}难度的英语文章（200-400词），主题为：${topicName}
2. 文章内容要有趣、具有教育意义，适合初高中学生阅读
3. 根据文章内容设计5道阅读理解选择题
4. 每道题有4个选项(A、B、C、D)，只有一个正确答案
5. 题目要测试不同的理解技能：主旨大意、细节理解、推理判断、词义猜测、作者态度等
6. 每道题必须提供详细的中文讲解，帮助学生理解为什么这个答案是正确的
7. **重要：正确答案必须随机分布在A、B、C、D选项中，不能都集中在同一个选项**

请严格按照以下JSON格式返回：

{
  "title": "文章标题",
  "content": "文章内容（用<p>标签分段）",
  "questions": [
    {
      "question": "问题内容",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correct": 正确答案的索引(请在0,1,2,3之间随机选择，不要都是0),
      "explanation": "详细的中文答案讲解，解释为什么这个选项是正确的，其他选项为什么不对"
    }
  ]
}

注意：correct字段表示正确答案的索引(0=A, 1=B, 2=C, 3=D)，正确答案要在0,1,2,3之间随机分布，explanation必须是详细的中文讲解`;

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'AI生成失败');
                    }

                    // Parse the AI response
                    const passage = parseAIResponse(result.output, 'reading');
                    
                    return generateReadingHTML(passage, level);
                    
                } catch (error) {
                    console.error('生成阅读理解测试失败:', error);
                    // Fallback to static content
                    const passages = getReadingPassages(level);
                    const passage = passages[level][Math.floor(Math.random() * passages[level].length)];
                    
                    return generateReadingHTML(passage, level, true);
                }
            }

            async function generateClozeTest(level, topic) {
                try {
                    const topicName = getTopicName(topic);
                    // Create prompt for AI cloze test generation
                    const prompt = `请为英语${getLevelName(level)}水平的初高中学习者生成一道${topicName}主题的完形填空测试。

要求：
1. 生成一篇适合${getLevelName(level)}难度的英语短文（150-250词），主题为：${topicName}
2. 从文中选择10个关键词设为空白，用{0}, {1}, {2}...{9}等标记
3. 为每个空白提供4个选项(A、B、C、D)，只有一个正确答案
4. 空白应该测试语法、词汇、语境理解、逻辑关系等不同技能
5. 选项要有一定迷惑性，但只有一个明显正确
6. 每个空白必须提供详细的中文讲解，帮助学生理解语法和词汇知识
7. **重要：正确答案必须随机分布在A、B、C、D选项中，不能都集中在同一个选项**

请严格按照以下JSON格式返回：

{
  "title": "文章标题",
  "content": "文章内容（用{0}, {1}, {2}...{9}等标记空白位置）",
  "blanks": [
    {
      "context": "空白前后的语境提示",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correct": 正确答案的索引(请随机分布0,1,2,3，不要都是0),
      "explanation": "详细的中文讲解，解释为什么这个选项正确，涉及什么语法或词汇知识"
    }
  ]
}

注意：correct字段表示正确答案的索引(0=A, 1=B, 2=C, 3=D)，必须生成10个空白，正确答案要在0,1,2,3之间随机分布，explanation必须是详细的中文讲解`;

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'AI生成失败');
                    }

                    // Parse the AI response
                    const clozeTest = parseAIResponse(result.output, 'cloze');
                    
                    return generateClozeHTML(clozeTest, level);
                    
                } catch (error) {
                    console.error('生成完形填空测试失败:', error);
                    // Fallback to static content
                    const clozeTexts = getClozeTexts(level);
                    const clozeTest = clozeTexts[level][Math.floor(Math.random() * clozeTexts[level].length)];
                    
                    return generateClozeHTML(clozeTest, level, true);
                }
            }

            async function generateMatchingTest(level, topic) {
                try {
                    const topicName = getTopicName(topic);
                    // Create prompt for AI matching test generation
                    const prompt = `请为英语${getLevelName(level)}水平的初高中学习者生成一道${topicName}主题的匹配题测试。

要求：
1. 基于${topicName}主题，选择适合${getLevelName(level)}难度的内容
2. 创建5个左边项目和5个右边项目
3. 题目要测试词汇理解、语言知识或相关文化常识
4. 确保匹配关系明确且符合逻辑
5. 提供清晰的指导说明
6. 为每对正确匹配提供中文解释

请严格按照以下JSON格式返回：

{
  "instructions": "匹配指导说明",
  "leftTitle": "左边栏目标题",
  "rightTitle": "右边栏目标题",
  "leftItems": ["左边项目1", "左边项目2", "左边项目3", "左边项目4", "左边项目5"],
  "rightItems": ["右边项目1", "右边项目2", "右边项目3", "右边项目4", "右边项目5"],
  "correctMatches": [2, 0, 4, 1, 3],
  "explanations": ["匹配1的解释", "匹配2的解释", "匹配3的解释", "匹配4的解释", "匹配5的解释"]
}

注意：correctMatches数组表示每个左边项目对应的右边项目索引(从0开始)，explanations数组按照左边项目的顺序解释每个匹配`;

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'AI生成失败');
                    }

                    // Parse the AI response
                    const test = parseAIResponse(result.output, 'matching');
                    
                    return generateMatchingHTML(test, level);
                    
                } catch (error) {
                    console.error('生成匹配题测试失败:', error);
                    // Fallback to static content
                    const matchingTests = getMatchingTests(level);
                    const test = matchingTests[level][Math.floor(Math.random() * matchingTests[level].length)];
                    
                    return generateMatchingHTML(test, level, true);
                }
            }

            // HTML Generation Helper Functions
            function generateReadingHTML(passage, level, isStaticFallback = false) {
                let html = `
                    <div class="reading-test-container">
                        <h3><i class="fas fa-book-open"></i> 阅读理解测试 - ${getLevelName(level)}</h3>
                        ${isStaticFallback ? '<div class="error-message" style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><p><i class="fas fa-exclamation-triangle"></i> AI生成失败，使用备用题目</p></div>' : ''}
                        
                        <!-- 移动端友好的阅读区域 -->
                        <div class="reading-passage-container">
                            <div class="passage-header">
                                <h4><i class="fas fa-file-text"></i> 阅读文章</h4>
                                <div class="reading-controls">
                                    <button class="btn-icon" id="increase-font" title="增大字体">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button class="btn-icon" id="decrease-font" title="减小字体">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="reading-passage" id="reading-passage">
                                <h5 class="passage-title">${passage.title}</h5>
                                <div class="passage-content">
                                    ${passage.content}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 问题区域 -->
                        <div class="questions-container">
                            <h4><i class="fas fa-question-circle"></i> 问题 (${passage.questions.length}题)</h4>
                            <div class="progress-container">
                                <div class="progress-bar" id="reading-progress" style="width: 0%"></div>
                            </div>
                            <p class="progress-text">已完成: <span id="reading-progress-text">0/${passage.questions.length}</span></p>
                `;
                
                passage.questions.forEach((question, index) => {
                    html += `
                        <div class="test-question" data-question="${index}" data-explanation="${question.explanation || ''}">
                            <div class="question-text">
                                <span class="question-number">${index + 1}.</span>
                                ${question.question}
                            </div>
                            <ul class="options-list">
                    `;
                    
                    question.options.forEach((option, optionIndex) => {
                        const letter = String.fromCharCode(65 + optionIndex);
                        const isCorrect = optionIndex === question.correct;
                        html += `
                            <li class="option-item" data-question="${index}" data-option="${optionIndex}" ${isCorrect ? 'data-correct="true"' : ''} data-explanation="${question.explanation || ''}">
                                <span class="option-letter">${letter}.</span>
                                <span class="option-text">${option}</span>
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="submit-container">
                            <button id="submit-reading-test" class="btn btn-primary" disabled>
                                <i class="fas fa-check"></i> 提交答案
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            }

            function generateClozeHTML(clozeTest, level, isStaticFallback = false) {
                let html = `
                    <div class="reading-test-container">
                        <h3><i class="fas fa-edit"></i> 完形填空测试 - ${getLevelName(level)}</h3>
                        ${isStaticFallback ? '<div class="error-message" style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><p><i class="fas fa-exclamation-triangle"></i> AI生成失败，使用备用题目</p></div>' : ''}
                        
                        <div class="cloze-instructions">
                            <p><i class="fas fa-info-circle"></i> 阅读下面的短文，从每题所给的四个选项中选出最佳答案。</p>
                        </div>
                        
                        <div class="cloze-passage-container">
                            <div class="passage-header">
                                <h4><i class="fas fa-file-text"></i> ${clozeTest.title}</h4>
                                <div class="reading-controls">
                                    <button class="btn-icon" id="increase-font" title="增大字体">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button class="btn-icon" id="decrease-font" title="减小字体">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="cloze-passage" id="cloze-passage">
                `;
                
                // 处理完形填空文本，插入题目
                let passageHTML = clozeTest.content;
                clozeTest.blanks.forEach((blank, index) => {
                    const blankHTML = `<span class="cloze-blank" data-blank="${index}">____${index + 1}____</span>`;
                    passageHTML = passageHTML.replace(`{${index}}`, blankHTML);
                });
                
                html += `
                                ${passageHTML}
                            </div>
                        </div>
                        
                        <!-- 选择题区域 -->
                        <div class="cloze-questions-container">
                            <h4><i class="fas fa-list-ol"></i> 选择题 (${clozeTest.blanks.length}题)</h4>
                            <div class="progress-container">
                                <div class="progress-bar" id="cloze-progress" style="width: 0%"></div>
                            </div>
                            <p class="progress-text">已完成: <span id="cloze-progress-text">0/${clozeTest.blanks.length}</span></p>
                            
                            <div class="cloze-questions-grid">
                `;
                
                clozeTest.blanks.forEach((blank, index) => {
                    html += `
                        <div class="cloze-question" data-question="${index}" data-explanation="${blank.explanation || ''}">
                            <div class="question-header">
                                <span class="question-number">${index + 1}.</span>
                                <span class="context-hint">"...${blank.context}..."</span>
                            </div>
                            <ul class="options-list compact">
                    `;
                    
                    blank.options.forEach((option, optionIndex) => {
                        const letter = String.fromCharCode(65 + optionIndex);
                        const isCorrect = optionIndex === blank.correct;
                        html += `
                            <li class="option-item" data-question="${index}" data-option="${optionIndex}" ${isCorrect ? 'data-correct="true"' : ''} data-explanation="${blank.explanation || ''}">
                                <span class="option-letter">${letter}</span>
                                <span class="option-text">${option}</span>
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="submit-container">
                            <button id="submit-cloze-test" class="btn btn-primary" disabled>
                                <i class="fas fa-check"></i> 提交答案
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            }

            function generateMatchingHTML(test, level, isStaticFallback = false) {
                let html = `
                    <div class="reading-test-container">
                        <h3><i class="fas fa-link"></i> 匹配题测试 - ${getLevelName(level)}</h3>
                        ${isStaticFallback ? '<div class="error-message" style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><p><i class="fas fa-exclamation-triangle"></i> AI生成失败，使用备用题目</p></div>' : ''}
                        
                        <div class="matching-instructions">
                            <p><i class="fas fa-info-circle"></i> ${test.instructions}</p>
                        </div>
                        
                        <div class="matching-container">
                            <div class="matching-left">
                                <h4><i class="fas fa-list"></i> ${test.leftTitle}</h4>
                                <div class="matching-items">
                `;
                
                test.leftItems.forEach((item, index) => {
                    const explanation = test.explanations && test.explanations[index] ? test.explanations[index] : '';
                    html += `
                        <div class="matching-item" data-left="${index}" data-correct="${test.correctMatches[index]}" data-explanation="${explanation}">
                            <span class="item-number">${index + 1}.</span>
                            <span class="item-content">${item}</span>
                            <span class="match-indicator" id="match-${index}">
                                <i class="fas fa-circle-notch"></i>
                            </span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                            
                            <div class="matching-right">
                                <h4><i class="fas fa-list"></i> ${test.rightTitle}</h4>
                                <div class="matching-options">
                `;
                
                test.rightItems.forEach((item, index) => {
                    const letter = String.fromCharCode(65 + index);
                    html += `
                        <div class="matching-option" data-right="${index}">
                            <span class="option-letter">${letter}.</span>
                            <span class="option-content">${item}</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                        </div>
                        
                        <!-- 匹配答案区域 -->
                        <div class="matching-answers">
                            <h4><i class="fas fa-check-double"></i> 你的答案</h4>
                            <div class="answers-grid" id="matching-answers-grid">
                                <!-- 答案会在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="submit-container">
                            <button id="submit-matching-test" class="btn btn-primary" disabled>
                                <i class="fas fa-check"></i> 提交答案
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            }

            // AI Response Parsing Functions
            function parseAIResponse(aiOutput, testType) {
                try {
                    let cleanOutput = aiOutput.trim();
                    cleanOutput = cleanOutput.replace(/```json\s*/g, '');
                    cleanOutput = cleanOutput.replace(/```\s*$/g, '');
                    
                    const jsonMatch = cleanOutput.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('No valid JSON found in AI response');
                    }
                    
                    const jsonString = jsonMatch[0];
                    const parsedData = JSON.parse(jsonString);
                    
                    switch(testType) {
                        case 'reading':
                            return validateReadingData(parsedData);
                        case 'cloze':
                            return validateClozeData(parsedData);
                        case 'matching':
                            return validateMatchingData(parsedData);
                        default:
                            return parsedData;
                    }
                } catch (error) {
                    console.error('Failed to parse AI response:', error);
                    return getDefaultTestData(testType);
                }
            }

            function validateReadingData(data) {
                if (!data.title || !data.content || !data.questions || !Array.isArray(data.questions)) {
                    throw new Error('Invalid reading test data structure');
                }
                
                data.questions.forEach((question, index) => {
                    if (!question.question || !question.options || !Array.isArray(question.options) || 
                        typeof question.correct !== 'number') {
                        throw new Error(`Invalid question data at index ${index}`);
                    }
                });
                
                return data;
            }

            function validateClozeData(data) {
                if (!data.title || !data.content || !data.blanks || !Array.isArray(data.blanks)) {
                    throw new Error('Invalid cloze test data structure');
                }
                
                data.blanks.forEach((blank, index) => {
                    if (!blank.options || !Array.isArray(blank.options) || typeof blank.correct !== 'number') {
                        throw new Error(`Invalid blank data at index ${index}`);
                    }
                    if (!blank.context) {
                        blank.context = `blank ${index + 1}`;
                    }
                });
                
                return data;
            }

            function validateMatchingData(data) {
                if (!data.instructions || !data.leftTitle || !data.rightTitle || 
                    !data.leftItems || !data.rightItems || !data.correctMatches) {
                    throw new Error('Invalid matching test data structure');
                }
                
                return data;
            }

            function getDefaultTestData(testType) {
                switch(testType) {
                    case 'reading':
                        return {
                            title: "Default Reading Test",
                            content: "<p>This is a default reading passage. Please read and answer the questions below.</p>",
                            questions: [
                                {
                                    question: "What is this passage about?",
                                    options: ["Reading", "Writing", "Speaking", "Listening"],
                                    correct: 0,
                                    explanation: "The passage is about reading."
                                }
                            ]
                        };
                    case 'cloze':
                        return {
                            title: "Default Cloze Test",
                            content: "This is a {0} test where you need to {1} the blanks.",
                            blanks: [
                                {
                                    context: "This is a ___ test",
                                    options: ["cloze", "reading", "writing", "speaking"],
                                    correct: 0,
                                    explanation: "This is a cloze test."
                                },
                                {
                                    context: "you need to ___ the blanks",
                                    options: ["read", "fill", "write", "speak"],
                                    correct: 1,
                                    explanation: "You need to fill the blanks."
                                }
                            ]
                        };
                    case 'matching':
                        return {
                            instructions: "Match the items on the left with the items on the right.",
                            leftTitle: "Words",
                            rightTitle: "Definitions",
                            leftItems: ["Apple", "Book", "Car", "Dog", "House"],
                            rightItems: ["A fruit", "Reading material", "Vehicle", "Animal", "Building"],
                            correctMatches: [0, 1, 2, 3, 4]
                        };
                    default:
                        return {};
                }
            }

            function addReadingTestEventListeners(container, type) {
                // Add font size controls
                const increaseFontBtn = container.querySelector('#increase-font');
                const decreaseFontBtn = container.querySelector('#decrease-font');
                const readingPassage = container.querySelector('#reading-passage, #cloze-passage');
                
                if (increaseFontBtn && readingPassage) {
                    increaseFontBtn.addEventListener('click', function() {
                        const currentSize = parseInt(window.getComputedStyle(readingPassage).fontSize);
                        readingPassage.style.fontSize = (currentSize + 2) + 'px';
                    });
                }
                
                if (decreaseFontBtn && readingPassage) {
                    decreaseFontBtn.addEventListener('click', function() {
                        const currentSize = parseInt(window.getComputedStyle(readingPassage).fontSize);
                        if (currentSize > 12) {
                            readingPassage.style.fontSize = (currentSize - 2) + 'px';
                        }
                    });
                }
                
                // Add option selection listeners
                const options = container.querySelectorAll('.option-item');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        const questionId = this.getAttribute('data-question');
                        const questionOptions = container.querySelectorAll(`.option-item[data-question="${questionId}"]`);
                        questionOptions.forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        // Update progress
                        updateReadingProgress(container);
                    });
                });
                
                // Add submit handler
                const submitBtn = container.querySelector('#submit-reading-test, #submit-cloze-test, #submit-matching-test');
                if (submitBtn) {
                    submitBtn.addEventListener('click', function() {
                        handleReadingTestSubmit(container, type);
                    });
                }
            }

            function updateReadingProgress(container) {
                const totalQuestions = container.querySelectorAll('.test-question, .cloze-question').length;
                const answeredQuestions = container.querySelectorAll('.option-item.selected').length;
                const progressBar = container.querySelector('.progress-bar');
                const progressText = container.querySelector('#reading-progress-text, #cloze-progress-text');
                const submitBtn = container.querySelector('#submit-reading-test, #submit-cloze-test, #submit-matching-test');
                
                if (progressBar && progressText) {
                    const percentage = (answeredQuestions / totalQuestions) * 100;
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = answeredQuestions + '/' + totalQuestions;
                }
                
                if (submitBtn) {
                    submitBtn.disabled = answeredQuestions < totalQuestions;
                }
            }

            function handleReadingTestSubmit(container, type) {
                const results = [];
                let totalScore = 0;
                
                // Collect answers and calculate results
                if (type === 'comprehension') {
                    const questions = container.querySelectorAll('.test-question');
                    questions.forEach((question, index) => {
                        const selectedOption = question.querySelector('.option-item.selected');
                        const correctOption = question.querySelector('.option-item[data-correct="true"]');
                        const questionText = question.querySelector('.question-text')?.textContent || `题目 ${index + 1}`;
                        const explanation = selectedOption?.getAttribute('data-explanation') || correctOption?.getAttribute('data-explanation') || '';
                        
                        if (selectedOption && correctOption) {
                            const userOptionIndex = parseInt(selectedOption.getAttribute('data-option'));
                            const correctOptionIndex = parseInt(correctOption.getAttribute('data-option'));
                            const userLetter = String.fromCharCode(65 + userOptionIndex);
                            const correctLetter = String.fromCharCode(65 + correctOptionIndex);
                            
                            const userChoice = selectedOption.querySelector('.option-text')?.textContent || selectedOption.textContent;
                            const correctChoice = correctOption.querySelector('.option-text')?.textContent || correctOption.textContent;
                            const isCorrect = selectedOption === correctOption;
                            
                            results.push({
                                question: questionText,
                                userAnswer: `${userLetter}. ${userChoice}`,
                                correctAnswer: `${correctLetter}. ${correctChoice}`,
                                isCorrect: isCorrect,
                                explanation: explanation,
                                type: 'choice'
                            });
                            
                            if (isCorrect) totalScore++;
                        }
                    });
                } else if (type === 'cloze') {
                    const clozeQuestions = container.querySelectorAll('.cloze-question');
                    clozeQuestions.forEach((question, index) => {
                        const selectedOption = question.querySelector('.option-item.selected');
                        const correctOption = question.querySelector('.option-item[data-correct="true"]');
                        const questionText = `第${index + 1}空`;
                        const contextHint = question.querySelector('.context-hint')?.textContent || '';
                        const explanation = selectedOption?.getAttribute('data-explanation') || correctOption?.getAttribute('data-explanation') || '';
                        
                        if (selectedOption && correctOption) {
                            const userOptionIndex = parseInt(selectedOption.getAttribute('data-option'));
                            const correctOptionIndex = parseInt(correctOption.getAttribute('data-option'));
                            const userLetter = String.fromCharCode(65 + userOptionIndex);
                            const correctLetter = String.fromCharCode(65 + correctOptionIndex);
                            
                            const userChoice = selectedOption.querySelector('.option-text')?.textContent || selectedOption.textContent;
                            const correctChoice = correctOption.querySelector('.option-text')?.textContent || correctOption.textContent;
                            const isCorrect = selectedOption === correctOption;
                            
                            results.push({
                                question: `${questionText} - ${contextHint}`,
                                userAnswer: `${userLetter}. ${userChoice}`,
                                correctAnswer: `${correctLetter}. ${correctChoice}`,
                                isCorrect: isCorrect,
                                explanation: explanation,
                                type: 'blank'
                            });
                            
                            if (isCorrect) totalScore++;
                        }
                    });
                } else if (type === 'matching') {
                    // Handle matching test results
                    const matchingItems = container.querySelectorAll('.matching-item');
                    matchingItems.forEach((item, index) => {
                        const userMatch = item.getAttribute('data-user-match') || '';
                        const correctMatch = item.getAttribute('data-correct') || '';
                        const explanation = item.getAttribute('data-explanation') || '';
                        const leftContent = item.querySelector('.item-content')?.textContent || '';
                        const isCorrect = userMatch === correctMatch;
                        
                        results.push({
                            question: `匹配 ${index + 1}: ${leftContent}`,
                            userAnswer: userMatch,
                            correctAnswer: correctMatch,
                            isCorrect: isCorrect,
                            explanation: explanation,
                            type: 'match'
                        });
                        
                        if (isCorrect) totalScore++;
                    });
                }
                
                const totalQuestions = results.length;
                const percentage = Math.round((totalScore / totalQuestions) * 100);
                
                // Generate detailed results with explanations
                let html = `
                    <div class="reading-test-results">
                        <div class="result-summary">
                            <h3><i class="fas fa-trophy"></i> 测试完成！</h3>
                            <div class="score-display">${totalScore}/${totalQuestions}</div>
                            <div class="level-badge">${percentage}%</div>
                            <p>恭喜你完成了测试！你的正确率为 ${percentage}%。</p>
                        </div>
                        
                        <div class="detailed-results">
                            <h4><i class="fas fa-list-alt"></i> 详细答题情况</h4>
                `;
                
                results.forEach((result, index) => {
                    const statusIcon = result.isCorrect ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>';
                    const statusClass = result.isCorrect ? 'correct' : 'incorrect';
                    
                    html += `
                        <div class="result-item ${statusClass}">
                            <div class="result-header">
                                <h5>${statusIcon} ${result.question}</h5>
                            </div>
                            <div class="result-content">
                                <div class="answer-comparison">
                                    <div class="user-answer">
                                        <strong>你的答案：</strong>
                                        <span class="${result.isCorrect ? 'text-success' : 'text-danger'}">${result.userAnswer}</span>
                                    </div>
                                    <div class="correct-answer">
                                        <strong>正确答案：</strong>
                                        <span class="text-success">${result.correctAnswer}</span>
                                    </div>
                                </div>
                                ${result.explanation ? `
                                    <div class="explanation">
                                        <strong><i class="fas fa-lightbulb"></i> 详细讲解：</strong>
                                        <p>${result.explanation}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <div class="result-actions">
                            <button class="btn btn-secondary" onclick="location.reload()">
                                <i class="fas fa-redo"></i> 重新测试
                            </button>
                            <button class="btn btn-primary" onclick="document.querySelector('[data-tab=\\'results\\']').click()">
                                <i class="fas fa-chart-bar"></i> 查看详细报告
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Update results tab
                updateResultsTab(totalScore, totalQuestions, percentage, '');
            }

            function updateResultsTab(score, total, percentage, level) {
                document.getElementById('no-results-message').style.display = 'none';
                document.getElementById('results-container').style.display = 'block';
                document.getElementById('overall-score').textContent = level;
                document.getElementById('level-description').textContent = `${percentage}% (${score}/${total})`;
            }



            // AI Quiz Functions
            function initializeAIQuizEvents() {
                // Topic selection
                const topicCards = document.querySelectorAll('.topic-card');
                topicCards.forEach(card => {
                    card.addEventListener('click', function() {
                        topicCards.forEach(c => c.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedTopic = this.getAttribute('data-topic');
                    });
                });

                // Difficulty selection
                const difficultyBtns = document.querySelectorAll('.difficulty-btn');
                difficultyBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        difficultyBtns.forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedDifficulty = this.getAttribute('data-difficulty');
                    });
                });

                // Question count selection
                const questionCountSelect = document.getElementById('question-count');
                questionCountSelect.addEventListener('change', function() {
                    questionCount = parseInt(this.value);
                });

                // Generate AI Quiz button
                const generateBtn = document.getElementById('generate-ai-quiz');
                generateBtn.addEventListener('click', generateAIQuiz);
            }

            async function generateAIQuiz() {
                // Validate selections
                if (!selectedTopic) {
                    alert('请选择一个测试话题');
                    return;
                }
                if (!selectedDifficulty) {
                    alert('请选择难度级别');
                    return;
                }

                const generateBtn = document.getElementById('generate-ai-quiz');
                const customTopic = document.getElementById('custom-topic').value.trim();

                // Show loading
                showLoadingOverlay('AI正在生成测试题目，请稍候...');
                generateBtn.disabled = true;

                try {
                    // Prepare the prompt for DeepSeek API
                    const prompt = createQuizPrompt(selectedTopic, selectedDifficulty, questionCount, customTopic);
                    
                    // Call DeepSeek API
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'API调用失败');
                    }

                    // Parse the AI response and create quiz
                    currentQuiz = parseAIQuizResponse(result.output);
                    currentQuestionIndex = 0;
                    userAnswers = [];

                    // Display the quiz
                    displayAIQuiz();

                } catch (error) {
                    console.error('生成AI测试失败:', error);
                    hideLoadingOverlay();
                    showError('生成测试失败: ' + error.message + '. 请检查网络连接后重试。');
                } finally {
                    generateBtn.disabled = false;
                    hideLoadingOverlay();
                }
            }

            function createQuizPrompt(topic, difficulty, count, customTopic) {
                const topicMap = {
                    'grammar': '英语语法',
                    'vocabulary': '英语词汇',
                    'reading': '英语阅读理解',
                    'listening': '英语听力理解',
                    'speaking': '英语口语表达',
                    'writing': '英语写作技能',
                    'toefl': '托福水平英语',
                    'ielts': '雅思水平英语'
                };

                const difficultyMap = {
                    'beginner': '初级(A1-A2)',
                    'intermediate': '中级(B1-B2)',
                    'advanced': '高级(C1-C2)'
                };

                const topicName = customTopic || topicMap[topic] || '英语';
                const difficultyName = difficultyMap[difficulty] || '中级';

                // Special handling for TOEFL and IELTS
                let specificInstructions = '';
                if (topic === 'toefl') {
                    specificInstructions = `
特殊要求 - 托福水平测试：
- 题目应该测试托福考试所需的英语能力水平
- 包含学术词汇、复杂语法结构、阅读理解等
- 难度应相当于托福80-100分水平的英语能力
- 题目内容应涉及学术场景、校园生活、学术讨论等托福常见话题
- 重点测试英语运用能力，而不是关于托福考试本身的知识`;
                } else if (topic === 'ielts') {
                    specificInstructions = `
特殊要求 - 雅思水平测试：
- 题目应该测试雅思考试所需的英语能力水平
- 包含多样化词汇、语法运用、阅读理解等
- 难度应相当于雅思6.0-7.0分水平的英语能力
- 题目内容应涉及日常生活、工作场景、社会话题等雅思常见主题
- 重点测试英语运用能力，而不是关于雅思考试本身的知识`;
                }

                return `请生成${count}道关于"${topicName}"的${difficultyName}难度英语测试题目。

要求：
1. 每道题必须是单选题，有4个选项(A、B、C、D)
2. 题目要符合${difficultyName}水平的难度要求
3. 每道题都要有明确的正确答案
4. 题目要有教育价值，能够测试学习者的相关技能
5. 题目应该测试英语语言能力，而不是关于考试本身的知识${specificInstructions}

请严格按照以下JSON格式返回，不要添加任何其他文字说明：

{
  "questions": [
    {
      "question": "题目内容",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correct": 0,
      "explanation": "答案解释"
    }
  ]
}

注意：correct字段表示正确答案的索引(0=A, 1=B, 2=C, 3=D)`;
            }

            function parseAIQuizResponse(response) {
                try {
                    // Try to extract JSON from the response
                    let jsonStr = response.trim();
                    
                    // Remove markdown code blocks if present
                    if (jsonStr.startsWith('```json')) {
                        jsonStr = jsonStr.replace(/```json\n?/, '').replace(/\n?```$/, '');
                    } else if (jsonStr.startsWith('```')) {
                        jsonStr = jsonStr.replace(/```\n?/, '').replace(/\n?```$/, '');
                    }
                    
                    const quiz = JSON.parse(jsonStr);
                    
                    if (!quiz.questions || !Array.isArray(quiz.questions)) {
                        throw new Error('无效的题目格式');
                    }
                    
                    // Validate each question
                    quiz.questions.forEach((q, index) => {
                        if (!q.question || !q.options || !Array.isArray(q.options) || q.options.length !== 4) {
                            throw new Error(`第${index + 1}题格式错误`);
                        }
                        if (typeof q.correct !== 'number' || q.correct < 0 || q.correct > 3) {
                            throw new Error(`第${index + 1}题答案索引无效`);
                        }
                    });
                    
                    return quiz;
                    
                } catch (error) {
                    console.error('解析AI响应失败:', error);
                    // Return a fallback quiz if parsing fails
                    return createFallbackQuiz();
                }
            }

            function createFallbackQuiz() {
                return {
                    questions: [
                        {
                            question: "Which of the following is the correct form of the verb 'to be' in present tense for 'I'?",
                            options: ["am", "is", "are", "be"],
                            correct: 0,
                            explanation: "'I am' is the correct form of 'to be' for the first person singular."
                        },
                        {
                            question: "What is the past tense of 'go'?",
                            options: ["goed", "went", "gone", "going"],
                            correct: 1,
                            explanation: "'Went' is the past tense of the irregular verb 'go'."
                        },
                        {
                            question: "Choose the correct sentence:",
                            options: [
                                "She don't like coffee",
                                "She doesn't like coffee", 
                                "She doesn't likes coffee",
                                "She don't likes coffee"
                            ],
                            correct: 1,
                            explanation: "For third person singular, we use 'doesn't' + base form of the verb."
                        }
                    ]
                };
            }

            function displayAIQuiz() {
                const container = document.getElementById('ai-quiz-container');
                container.style.display = 'block';
                
                // Scroll to quiz container
                container.scrollIntoView({ behavior: 'smooth' });
                
                displayCurrentQuestion();
            }

            function displayCurrentQuestion() {
                const container = document.getElementById('ai-quiz-container');
                const question = currentQuiz.questions[currentQuestionIndex];
                const totalQuestions = currentQuiz.questions.length;
                
                let html = `
                    <div class="quiz-counter">
                        <h3><i class="fas fa-brain"></i> AI智能测试进行中</h3>
                        <p>题目 ${currentQuestionIndex + 1} / ${totalQuestions}</p>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${((currentQuestionIndex + 1) / totalQuestions) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="test-question">
                        <div class="question-text">${currentQuestionIndex + 1}. ${question.question}</div>
                        <ul class="options-list">
                `;
                
                question.options.forEach((option, index) => {
                    const letter = String.fromCharCode(65 + index); // A, B, C, D
                    html += `
                        <li class="option-item" data-option="${index}">
                            ${letter}. ${option}
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                    
                    <div class="quiz-navigation">
                        ${currentQuestionIndex > 0 ? 
                            '<button class="btn btn-secondary" onclick="previousQuestion()"><i class="fas fa-arrow-left"></i> 上一题</button>' : 
                            '<div></div>'
                        }
                        <button class="btn btn-primary" id="next-question-btn" disabled>
                            ${currentQuestionIndex < totalQuestions - 1 ? 
                                '<i class="fas fa-arrow-right"></i> 下一题' : 
                                '<i class="fas fa-check"></i> 完成测试'
                            }
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Add event listeners to options
                const options = container.querySelectorAll('.option-item');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        options.forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        const selectedIndex = parseInt(this.getAttribute('data-option'));
                        userAnswers[currentQuestionIndex] = selectedIndex;
                        
                        // Enable next button
                        document.getElementById('next-question-btn').disabled = false;
                    });
                });
                
                // Add next button event listener
                document.getElementById('next-question-btn').addEventListener('click', function() {
                    if (currentQuestionIndex < totalQuestions - 1) {
                        currentQuestionIndex++;
                        displayCurrentQuestion();
                    } else {
                        finishAIQuiz();
                    }
                });
                
                // Restore previous answer if exists
                if (userAnswers[currentQuestionIndex] !== undefined) {
                    const selectedOption = container.querySelector(`[data-option="${userAnswers[currentQuestionIndex]}"]`);
                    if (selectedOption) {
                        selectedOption.classList.add('selected');
                        document.getElementById('next-question-btn').disabled = false;
                    }
                }
            }

            function previousQuestion() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayCurrentQuestion();
                }
            }

            function finishAIQuiz() {
                // Calculate score
                let score = 0;
                const results = [];
                
                currentQuiz.questions.forEach((question, index) => {
                    const userAnswer = userAnswers[index];
                    const isCorrect = userAnswer === question.correct;
                    if (isCorrect) score++;
                    
                    results.push({
                        question: question.question,
                        userAnswer: userAnswer,
                        correctAnswer: question.correct,
                        isCorrect: isCorrect,
                        explanation: question.explanation || ''
                    });
                });
                
                const percentage = Math.round((score / currentQuiz.questions.length) * 100);
                
                displayAIQuizResults(score, currentQuiz.questions.length, percentage, results);
            }

            function displayAIQuizResults(score, total, percentage, results) {
                const container = document.getElementById('ai-quiz-container');
                
                let level = 'A1';
                if (percentage >= 90) level = 'C2';
                else if (percentage >= 80) level = 'C1'; 
                else if (percentage >= 70) level = 'B2';
                else if (percentage >= 60) level = 'B1';
                else if (percentage >= 50) level = 'A2';
                
                let html = `
                    <div class="result-summary">
                        <h3><i class="fas fa-trophy"></i> AI测试完成！</h3>
                        <div class="score-display">${score}/${total}</div>
                        <div class="level-badge">${level} (${percentage}%)</div>
                        <p>恭喜完成AI智能测试！您的正确率为${percentage}%。</p>
                    </div>
                    
                    <div class="feedback-section">
                        <h4><i class="fas fa-chart-line"></i> 详细结果</h4>
                `;
                
                results.forEach((result, index) => {
                    const letter = String.fromCharCode(65 + result.correctAnswer);
                    const userLetter = result.userAnswer !== undefined ? String.fromCharCode(65 + result.userAnswer) : '未答';
                    
                    html += `
                        <div class="feedback-item">
                            <h5>题目 ${index + 1} ${result.isCorrect ? '<span style="color: #00b894;">✓</span>' : '<span style="color: #e74c3c;">✗</span>'}</h5>
                            <p><strong>题目：</strong>${result.question}</p>
                            <p><strong>您的答案：</strong>${userLetter} ${result.isCorrect ? '(正确)' : '(错误)'}</p>
                            <p><strong>正确答案：</strong>${letter}</p>
                            ${result.explanation ? `<p><strong>解释：</strong>${result.explanation}</p>` : ''}
                        </div>
                    `;
                });
                
                html += `
                    </div>
                    
                    <div class="quiz-navigation">
                        <button class="btn btn-secondary" onclick="restartAIQuiz()">
                            <i class="fas fa-redo"></i> 重新测试
                        </button>
                        <button class="btn btn-primary" onclick="document.querySelector('[data-tab=\\'results\\']').click()">
                            <i class="fas fa-chart-bar"></i> 查看详细报告
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Scroll to results
                container.scrollIntoView({ behavior: 'smooth' });
                
                // Update results tab data
                updateResultsTab(score, total, percentage, level);
            }

            function restartAIQuiz() {
                currentQuiz = null;
                currentQuestionIndex = 0;
                userAnswers = [];
                
                // Hide quiz container and show config
                document.getElementById('ai-quiz-container').style.display = 'none';
                
                // Reset selections
                document.querySelectorAll('.topic-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelectorAll('.difficulty-btn.selected').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                selectedTopic = '';
                selectedDifficulty = '';
            }

            function showLoadingOverlay(message) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.id = 'loading-overlay';
                overlay.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            function hideLoadingOverlay() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }

            function showError(message) {
                const container = document.getElementById('ai-quiz-container');
                container.style.display = 'block';
                container.innerHTML = `
                    <div class="error-message">
                        <h4><i class="fas fa-exclamation-triangle"></i> 错误</h4>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="restartAIQuiz()">
                            <i class="fas fa-redo"></i> 重试
                        </button>
                    </div>
                `;
            }

            // Helper functions
            function getLevelName(level) {
                return level === 'beginner' ? '初级' : 
                       level === 'intermediate' ? '中级' : '高级';
            }
            
            function getTopicName(topic) {
                const topics = {
                    story: '故事类',
                    news: '时事新闻',
                    technology: '科技发展',
                    education: '教育学习',
                    environment: '环境保护',
                    culture: '文化社会',
                    health: '健康生活',
                    travel: '旅行探索',
                    sports: '体育运动',
                    science: '科学发现'
                };
                return topics[topic] || '时事新闻';
            }

            function getWritingTypeName(type) {
                const typeMap = {
                    'essay': '议论文',
                    'letter': '书信',
                    'report': '报告',
                    'story': '故事'
                };
                return typeMap[type] || '作文';
            }

            function getSpeakingTypeName(type) {
                const typeMap = {
                    'description': '描述类',
                    'opinion': '观点表达',
                    'conversation': '对话练习'
                };
                return typeMap[type] || '口语练习';
            }

            function generateQuestions(level, count) {
                let html = '';
                
                // Sample questions for demonstration
                const questions = [
                    {
                        text: '下列哪个单词与其他三个意思不同？',
                        options: ['Happy', 'Joyful', 'Sad', 'Pleased']
                    },
                    {
                        text: '选择正确的时态填空：He _____ in this company for five years.',
                        options: ['works', 'is working', 'has worked', 'had worked']
                    },
                    {
                        text: '以下哪个句子是被动语态？',
                        options: [
                            'She wrote a letter.',
                            'A letter was written by her.',
                            'They are writing letters.',
                            'We will write letters.'
                        ]
                    },
                    {
                        text: '选择正确的连词：_____ it was raining, we decided to go out.',
                        options: ['Although', 'Because', 'So', 'Unless']
                    },
                    {
                        text: '下列哪个是正确的问句？',
                        options: [
                            'Where you are going?',
                            'Where are you going?',
                            'Where going you are?',
                            'You are going where?'
                        ]
                    }
                ];
                
                for (let i = 0; i < count; i++) {
                    const question = questions[i];
                    
                    html += `
                        <div class="test-question">
                            <div class="question-text">${i+1}. ${question.text}</div>
                            <ul class="options-list">
                    `;
                    
                    question.options.forEach((option, index) => {
                        html += `
                            <li class="option-item" data-question="${i+1}" data-option="${index}">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                }
                
                return html;
            }

            function showComprehensiveResults(container) {
                container.innerHTML = `
                    <div class="result-summary">
                        <h3>测试完成！</h3>
                        <div class="score-display">75%</div>
                        <div class="level-badge">B1-B2</div>
                        <p>恭喜你完成了测试！基于你的表现，你的英语水平处于中级水平。</p>
                        <button class="btn btn-primary" onclick="document.querySelector('[data-tab=\\'results\\']').click()">
                            <i class="fas fa-chart-bar"></i> 查看详细报告
                        </button>
                    </div>
                `;
                
                // Show results panel data
                document.getElementById('no-results-message').style.display = 'none';
                document.getElementById('results-container').style.display = 'block';
            }

            // Make functions globally available
            window.previousQuestion = previousQuestion;
            window.restartAIQuiz = restartAIQuiz;
            window.getLevelName = getLevelName;
        });
    </script>
</body>
</html>