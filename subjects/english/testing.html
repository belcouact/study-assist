<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能力测试 - 英语学习助手</title>
    <link rel="icon" href="../../assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/utilities.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .testing-hero {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            padding: 4rem 0;
            text-align: center;
        }

        .testing-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .testing-hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .testing-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
            overflow: hidden;
            flex-wrap: wrap;
        }

        .testing-tab {
            flex: 1;
            min-width: 150px;
            padding: 1rem 2rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .testing-tab.active {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .testing-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .testing-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .testing-panel {
            display: none;
        }

        .testing-panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .test-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .test-type-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
        }

        .test-type-card:hover {
            background: #e9ecef;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .test-type-card.selected {
            border-color: #6c5ce7;
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.1));
        }

        .test-type-card h3 {
            color: #6c5ce7;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .test-icon {
            font-size: 2.5rem;
            color: #6c5ce7;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: #6c5ce7;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.25);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-question {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3436;
        }

        .options-list {
            list-style: none;
            padding: 0;
        }

        .option-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-item:hover {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.05);
        }

        .option-item.selected {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.1);
        }

        .option-item.correct {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.1);
        }

        .option-item.incorrect {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .result-summary {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.1));
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .score-display {
            font-size: 3rem;
            font-weight: 700;
            color: #6c5ce7;
            margin-bottom: 1rem;
        }

        .level-badge {
            display: inline-block;
            background: #6c5ce7;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .feedback-list {
            text-align: left;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .feedback-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .feedback-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .progress-container {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #6c5ce7, #a29bfe);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* AI Quiz Generation Styles */
        .ai-quiz-config {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(114, 9, 183, 0.1));
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .topic-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-card:hover {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.05);
        }

        .topic-card.selected {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.1);
        }

        .topic-icon {
            font-size: 2rem;
            color: #6c5ce7;
            margin-bottom: 0.5rem;
        }

        .difficulty-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .difficulty-btn:hover {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.05);
        }

        .difficulty-btn.selected {
            border-color: #6c5ce7;
            background: #6c5ce7;
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e9ecef;
            border-top: 5px solid #6c5ce7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .quiz-counter {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            gap: 1rem;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        /* Reading Test Styles */
        .reading-test-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .reading-passage-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }

        .passage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .reading-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: #5a4dcf;
            transform: translateY(-1px);
        }

        .reading-passage {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.8;
            font-size: 16px;
            border: 1px solid #e9ecef;
        }

        .passage-title {
            color: #6c5ce7;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .passage-content p {
            margin-bottom: 1rem;
            text-align: justify;
        }

        .questions-container {
            margin-top: 2rem;
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #6c5ce7, #a29bfe);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-weight: 500;
            color: #6c5ce7;
            margin-bottom: 1.5rem;
        }

        .test-question {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s;
        }

        .test-question:hover {
            box-shadow: 0 2px 10px rgba(108, 92, 231, 0.1);
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3436;
            line-height: 1.6;
        }

        .question-number {
            color: #6c5ce7;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .option-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-height: 48px; /* Touch-friendly size */
        }

        .option-item:hover {
            background: #e9ecef;
            border-color: #6c5ce7;
        }

        .option-item.selected {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.1));
            border-color: #6c5ce7;
            color: #6c5ce7;
        }

        .option-letter {
            background: #6c5ce7;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
            line-height: 1.5;
        }

        .submit-container {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }

        /* Cloze Test Styles */
        .cloze-instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .cloze-passage-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }

        .cloze-passage {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.8;
            font-size: 16px;
            border: 1px solid #e9ecef;
        }

        .cloze-blank {
            background: linear-gradient(135deg, #ff7675, #fd79a8);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
            margin: 0 2px;
        }

        .cloze-questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .cloze-question {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .question-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .context-hint {
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
        }

        .options-list.compact .option-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        /* Matching Test Styles */
        .matching-instructions {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .matching-left, .matching-right {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .matching-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-height: 48px;
        }

        .matching-item:hover {
            background: #e9ecef;
            border-color: #6c5ce7;
        }

        .matching-item.selected {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.1));
            border-color: #6c5ce7;
        }

        .matching-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-height: 48px;
        }

        .matching-option:hover {
            background: #e9ecef;
            border-color: #00b894;
        }

        .item-number {
            background: #6c5ce7;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .item-content {
            flex: 1;
            line-height: 1.5;
        }

        .match-indicator {
            color: #ddd;
            font-size: 1.2rem;
        }

        .matching-answers {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .answer-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .answer-item.answered {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .answer-number {
            font-weight: 600;
            color: #6c5ce7;
        }

        .answer-content {
            flex: 1;
            font-size: 0.9rem;
        }

        /* Mixed Test Styles */
        .mixed-test-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            flex-wrap: wrap;
        }

        .test-tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .test-tab.active {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .test-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .test-section {
            display: none;
        }

        .test-section.active {
            display: block;
        }

        .mixed-test-progress {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #e9ecef;
        }

        .progress-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .section-progress {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }

        .section-progress span {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3436;
        }

        /* Result Styles */
        .result-summary {
            text-align: center;
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .score-display {
            font-size: 3rem;
            font-weight: 700;
            color: #6c5ce7;
            margin: 1rem 0;
        }

        .level-badge {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.2rem;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .result-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .testing-tabs {
                flex-direction: column;
            }

            .testing-tab {
                padding: 0.8rem 1rem;
                min-width: auto;
            }

            .testing-hero h1 {
                font-size: 2rem;
            }

            .test-type-grid {
                grid-template-columns: 1fr;
            }

            .topic-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .difficulty-selector {
                justify-content: center;
            }

            .quiz-navigation {
                flex-direction: column;
                align-items: stretch;
            }

            .passage-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .reading-controls {
                align-self: flex-end;
            }

            .cloze-questions-grid {
                grid-template-columns: 1fr;
            }

            .matching-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .mixed-test-tabs {
                flex-direction: column;
            }

            .test-tab {
                padding: 0.75rem;
                border-bottom: 1px solid #e9ecef;
            }

            .test-tab:last-child {
                border-bottom: none;
            }

            .answers-grid {
                grid-template-columns: 1fr;
            }

            .progress-sections {
                grid-template-columns: 1fr;
            }

            .result-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .score-display {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .reading-passage, .cloze-passage {
                padding: 1rem;
                font-size: 14px;
                line-height: 1.6;
            }

            .option-item {
                padding: 0.75rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .option-letter {
                align-self: flex-start;
            }

            .btn-icon {
                min-width: 36px;
                min-height: 36px;
            }

            .matching-item, .matching-option {
                padding: 0.75rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .item-number {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../../index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span class="gradient-text">Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="../../index.html#subjects">科目</a></li>
                        <li><a href="../../tts.html">语音</a></li>
                        <li><a href="../../draw.html">绘图</a></li>
                        <li><a href="main.html">返回英语</a></li>
                    </ul>
                </nav>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="testing-hero">
            <div class="container">
                <h1><i class="fas fa-tasks"></i> 英语能力测试</h1>
                <p>全面评估你的英语听说读写能力，找出需要提高的方面</p>
            </div>
        </section>

        <!-- Main Content -->
        <section class="main-content">
            <div class="container">
                <!-- Testing Tabs -->
                <div class="testing-tabs">
                    <button class="testing-tab active" data-tab="ai-quiz">
                        <i class="fas fa-brain"></i> AI智能测试
                    </button>
                    <button class="testing-tab" data-tab="comprehensive">
                        <i class="fas fa-star"></i> 综合能力
                    </button>
                    <button class="testing-tab" data-tab="listening">
                        <i class="fas fa-headphones"></i> 听力测试
                    </button>
                    <button class="testing-tab" data-tab="reading">
                        <i class="fas fa-book-open"></i> 阅读测试
                    </button>
                    <button class="testing-tab" data-tab="writing">
                        <i class="fas fa-pen"></i> 写作测试
                    </button>
                    <button class="testing-tab" data-tab="speaking">
                        <i class="fas fa-microphone"></i> 口语测试
                    </button>
                    <button class="testing-tab" data-tab="results">
                        <i class="fas fa-chart-bar"></i> 测试报告
                    </button>
                </div>
                
                <!-- AI Quiz Panel -->
                <div id="ai-quiz-panel" class="testing-content testing-panel active">
                    <h2><i class="fas fa-brain"></i> AI智能测试</h2>
                    <p>基于AI技术生成个性化英语测试题目，支持多种话题和难度级别</p>
                    
                    <div class="ai-quiz-config">
                        <h3><i class="fas fa-cog"></i> 测试配置</h3>
                        
                        <!-- Topic Selection -->
                        <div class="form-group">
                            <label><strong>选择测试话题：</strong></label>
                            <div class="topic-grid" id="topic-grid">
                                <div class="topic-card" data-topic="grammar">
                                    <div class="topic-icon"><i class="fas fa-font"></i></div>
                                    <h4>语法</h4>
                                    <p>Grammar</p>
                                </div>
                                <div class="topic-card" data-topic="vocabulary">
                                    <div class="topic-icon"><i class="fas fa-book"></i></div>
                                    <h4>词汇</h4>
                                    <p>Vocabulary</p>
                                </div>
                                <div class="topic-card" data-topic="reading">
                                    <div class="topic-icon"><i class="fas fa-book-open"></i></div>
                                    <h4>阅读理解</h4>
                                    <p>Reading</p>
                                </div>
                                <div class="topic-card" data-topic="listening">
                                    <div class="topic-icon"><i class="fas fa-headphones"></i></div>
                                    <h4>听力理解</h4>
                                    <p>Listening</p>
                                </div>
                                <div class="topic-card" data-topic="speaking">
                                    <div class="topic-icon"><i class="fas fa-microphone"></i></div>
                                    <h4>口语表达</h4>
                                    <p>Speaking</p>
                                </div>
                                <div class="topic-card" data-topic="writing">
                                    <div class="topic-icon"><i class="fas fa-pen"></i></div>
                                    <h4>写作技能</h4>
                                    <p>Writing</p>
                                </div>
                                <div class="topic-card" data-topic="toefl">
                                    <div class="topic-icon"><i class="fas fa-graduation-cap"></i></div>
                                    <h4>托福练习</h4>
                                    <p>TOEFL</p>
                                </div>
                                <div class="topic-card" data-topic="ielts">
                                    <div class="topic-icon"><i class="fas fa-certificate"></i></div>
                                    <h4>雅思练习</h4>
                                    <p>IELTS</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Difficulty Selection -->
                        <div class="form-group">
                            <label><strong>选择难度级别：</strong></label>
                            <div class="difficulty-selector" id="difficulty-selector">
                                <button class="difficulty-btn" data-difficulty="beginner">
                                    <i class="fas fa-seedling"></i> 初级
                                </button>
                                <button class="difficulty-btn" data-difficulty="intermediate">
                                    <i class="fas fa-tree"></i> 中级
                                </button>
                                <button class="difficulty-btn" data-difficulty="advanced">
                                    <i class="fas fa-mountain"></i> 高级
                                </button>
                            </div>
                        </div>
                        
                        <!-- Question Count -->
                        <div class="form-group">
                            <label for="question-count"><strong>题目数量：</strong></label>
                            <select id="question-count" class="form-control" style="max-width: 200px;">
                                <option value="5">5题</option>
                                <option value="10" selected>10题</option>
                                <option value="15">15题</option>
                                <option value="20">20题</option>
                            </select>
                        </div>
                        
                        <!-- Custom Topic -->
                        <div class="form-group">
                            <label for="custom-topic"><strong>自定义话题（可选）：</strong></label>
                            <input type="text" id="custom-topic" class="form-control" placeholder="例如：商务英语、日常对话、学术写作等">
                        </div>
                        
                        <div class="form-group">
                            <button id="generate-ai-quiz" class="btn btn-primary">
                                <i class="fas fa-magic"></i> 生成AI测试
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quiz Display Area -->
                    <div id="ai-quiz-container" style="display: none;">
                        <!-- AI generated quiz will appear here -->
                    </div>
                </div>

                <!-- Comprehensive Panel -->
                <div id="comprehensive-panel" class="testing-content testing-panel">
                    <h2><i class="fas fa-star"></i> 综合能力测试</h2>
                    <p>全面评估你的英语听说读写能力，测试时间约30分钟</p>
                    
                    <div class="test-type-grid">
                        <div class="test-type-card" data-test="beginner">
                            <div class="test-icon"><i class="fas fa-seedling"></i></div>
                            <h3>初级测试</h3>
                            <p>适合英语初学者或基础水平学习者</p>
                        </div>
                        <div class="test-type-card" data-test="intermediate">
                            <div class="test-icon"><i class="fas fa-tree"></i></div>
                            <h3>中级测试</h3>
                            <p>适合有一定英语基础的学习者</p>
                        </div>
                        <div class="test-type-card" data-test="advanced">
                            <div class="test-icon"><i class="fas fa-mountain"></i></div>
                            <h3>高级测试</h3>
                            <p>适合英语水平较高的学习者</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button id="start-comprehensive-test" class="btn btn-primary">
                            <i class="fas fa-play"></i> 开始综合测试
                        </button>
                    </div>
                    
                    <div id="comprehensive-test-container" style="display: none;">
                        <!-- Test content will be loaded here -->
                    </div>
                </div>

                <!-- Listening Panel -->
                <div id="listening-panel" class="testing-content testing-panel">
                    <h2><i class="fas fa-headphones"></i> 听力测试</h2>
                    <p>测试你的英语听力理解能力，包括对话、讲座和广播</p>
                    
                    <div class="form-group">
                        <label for="listening-level">选择难度级别：</label>
                        <select id="listening-level" class="form-control">
                            <option value="beginner">初级 (A1-A2)</option>
                            <option value="intermediate" selected>中级 (B1-B2)</option>
                            <option value="advanced">高级 (C1-C2)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="listening-type">测试类型：</label>
                        <select id="listening-type" class="form-control">
                            <option value="conversation" selected>对话理解</option>
                            <option value="lecture">讲座理解</option>
                            <option value="broadcast">广播理解</option>
                            <option value="mixed">混合类型</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button id="start-listening-test" class="btn btn-primary">
                            <i class="fas fa-play"></i> 开始听力测试
                        </button>
                    </div>
                    
                    <div id="listening-test-container" style="display: none;">
                        <!-- Test content will be loaded here -->
                    </div>
                </div>

                <!-- Reading Panel -->
                <div id="reading-panel" class="testing-content testing-panel">
                    <h2><i class="fas fa-book-open"></i> 阅读测试</h2>
                    <p>测试你的英语阅读理解能力，包括各种文体和主题</p>
                    
                    <div class="form-group">
                        <label for="reading-level">选择难度级别：</label>
                        <select id="reading-level" class="form-control">
                            <option value="beginner">初级 (A1-A2)</option>
                            <option value="intermediate" selected>中级 (B1-B2)</option>
                            <option value="advanced">高级 (C1-C2)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reading-type">测试类型：</label>
                        <select id="reading-type" class="form-control">
                            <option value="comprehension" selected>阅读理解</option>
                            <option value="cloze">完形填空</option>
                            <option value="matching">匹配题</option>
                            <option value="mixed">混合类型</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button id="start-reading-test" class="btn btn-primary">
                            <i class="fas fa-play"></i> 开始阅读测试
                        </button>
                    </div>
                    
                    <div id="reading-test-container" style="display: none;">
                        <!-- Test content will be loaded here -->
                    </div>
                </div>

                <!-- Writing Panel -->
                <div id="writing-panel" class="testing-content testing-panel">
                    <h2><i class="fas fa-pen"></i> 写作测试</h2>
                    <p>测试你的英语写作能力，包括不同体裁和目的的写作任务</p>
                    
                    <div class="form-group">
                        <label for="writing-level">选择难度级别：</label>
                        <select id="writing-level" class="form-control">
                            <option value="beginner">初级 (A1-A2)</option>
                            <option value="intermediate" selected>中级 (B1-B2)</option>
                            <option value="advanced">高级 (C1-C2)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="writing-type">测试类型：</label>
                        <select id="writing-type" class="form-control">
                            <option value="essay" selected>议论文</option>
                            <option value="letter">书信/邮件</option>
                            <option value="report">报告</option>
                            <option value="story">故事</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button id="generate-writing-topic" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> 生成写作题目
                        </button>
                    </div>
                    
                    <div id="writing-topic-container" style="display: none;">
                        <div class="test-question">
                            <div class="question-text" id="writing-topic-text"></div>
                            <div class="form-group">
                                <label for="writing-response">你的答案：</label>
                                <textarea id="writing-response" class="form-control" rows="10" placeholder="在此输入你的写作内容..."></textarea>
                            </div>
                            <div class="form-group">
                                <button id="submit-writing" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> 提交答案
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="writing-feedback-container" style="display: none;">
                        <!-- Feedback will be displayed here -->
                    </div>
                </div>

                <!-- Speaking Panel -->
                <div id="speaking-panel" class="testing-content testing-panel">
                    <h2><i class="fas fa-microphone"></i> 口语测试</h2>
                    <p>测试你的英语口语表达能力，包括发音、流利度和表达能力</p>
                    
                    <div class="form-group">
                        <label for="speaking-level">选择难度级别：</label>
                        <select id="speaking-level" class="form-control">
                            <option value="beginner">初级 (A1-A2)</option>
                            <option value="intermediate" selected>中级 (B1-B2)</option>
                            <option value="advanced">高级 (C1-C2)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="speaking-type">测试类型：</label>
                        <select id="speaking-type" class="form-control">
                            <option value="description" selected>图片描述</option>
                            <option value="opinion">观点陈述</option>
                            <option value="conversation">模拟对话</option>
                            <option value="mixed">混合类型</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button id="generate-speaking-topic" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> 生成口语题目
                        </button>
                    </div>
                    
                    <div id="speaking-topic-container" style="display: none;">
                        <div class="test-question">
                            <div class="question-text" id="speaking-topic-text"></div>
                            <div class="form-group">
                                <p>准备时间: <span id="prep-timer">30</span> 秒</p>
                                <button id="start-recording" class="btn btn-primary" disabled>
                                    <i class="fas fa-microphone"></i> 开始录音
                                </button>
                                <button id="stop-recording" class="btn btn-primary" style="display: none;">
                                    <i class="fas fa-stop"></i> 停止录音 (<span id="recording-timer">60</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="speaking-feedback-container" style="display: none;">
                        <!-- Feedback will be displayed here -->
                    </div>
                </div>

                <!-- Results Panel -->
                <div id="results-panel" class="testing-content testing-panel">
                    <h2><i class="fas fa-chart-bar"></i> 测试报告</h2>
                    <p>查看你的英语能力测试结果和个性化学习建议</p>
                    
                    <div id="no-results-message">
                        <p class="text-center">你还没有完成任何测试。请完成至少一项测试以查看报告。</p>
                    </div>
                    
                    <div id="results-container" style="display: none;">
                        <div class="result-summary">
                            <h3>综合英语水平</h3>
                            <div class="score-display" id="overall-score">B1</div>
                            <div class="level-badge" id="level-description">中级</div>
                            <p>基于你的测试结果，你的英语水平相当于欧洲共同语言参考框架 (CEFR) 的 <strong>B1</strong> 级别。</p>
                        </div>
                        
                        <div class="test-type-grid">
                            <div class="test-type-card">
                                <div class="test-icon"><i class="fas fa-headphones"></i></div>
                                <h3>听力能力</h3>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: 65%"></div>
                                </div>
                                <p>B1 (65%)</p>
                            </div>
                            <div class="test-type-card">
                                <div class="test-icon"><i class="fas fa-book-open"></i></div>
                                <h3>阅读能力</h3>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: 75%"></div>
                                </div>
                                <p>B2 (75%)</p>
                            </div>
                            <div class="test-type-card">
                                <div class="test-icon"><i class="fas fa-pen"></i></div>
                                <h3>写作能力</h3>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: 60%"></div>
                                </div>
                                <p>B1 (60%)</p>
                            </div>
                            <div class="test-type-card">
                                <div class="test-icon"><i class="fas fa-microphone"></i></div>
                                <h3>口语能力</h3>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: 55%"></div>
                                </div>
                                <p>B1 (55%)</p>
                            </div>
                        </div>
                        
                        <div class="feedback-list">
                            <h3>个性化学习建议</h3>
                            <div class="feedback-item">
                                <h4>听力提升</h4>
                                <p>多听不同口音的英语材料，尝试不看字幕理解内容。建议每天练习15-20分钟的听力。</p>
                            </div>
                            <div class="feedback-item">
                                <h4>阅读提升</h4>
                                <p>你的阅读能力较强，建议尝试阅读更复杂的材料，如新闻文章、学术文章等。</p>
                            </div>
                            <div class="feedback-item">
                                <h4>写作提升</h4>
                                <p>重点提高句式多样性和词汇准确性。建议定期练习不同类型的写作，并寻求反馈。</p>
                            </div>
                            <div class="feedback-item">
                                <h4>口语提升</h4>
                                <p>增加英语口语练习频率，可以通过语言交换、朗读或录音练习来提高流利度。</p>
                            </div>
                        </div>
                        
                        <div class="form-group" style="text-align: center; margin-top: 2rem;">
                            <button id="download-report" class="btn btn-primary">
                                <i class="fas fa-download"></i> 下载完整报告
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <p class="copyright-text">study-llm.me域名为Alex所有。保留所有权利。</p>
                <div class="profile-section">
                    <button id="profile-button" class="profile-button">
                        <i class="fas fa-user-circle"></i>
                        学习阶段
                    </button>
                    <div id="profile-display" class="profile-display"></div>
                </div>
            </div>
        </div>
    </footer>

    <script src="../../js/common.js"></script>
    <script src="../../js/navigation.js"></script>
    <script src="../../js/profile.js"></script>
    <script>
        // AI Quiz Global Variables
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let selectedTopic = '';
        let selectedDifficulty = '';
        let questionCount = 10;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Tab navigation
            const tabs = document.querySelectorAll('.testing-tab');
            const panels = document.querySelectorAll('.testing-panel');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetPanel = this.getAttribute('data-tab') + '-panel';
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active panel
                    panels.forEach(p => p.classList.remove('active'));
                    document.getElementById(targetPanel).classList.add('active');
                });
            });

            // AI Quiz Functionality
            initializeAIQuizEvents();

            // Test type selection
            const testTypeCards = document.querySelectorAll('.test-type-card');
            testTypeCards.forEach(card => {
                card.addEventListener('click', function() {
                    testTypeCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Comprehensive test
            const startComprehensiveBtn = document.getElementById('start-comprehensive-test');
            const comprehensiveContainer = document.getElementById('comprehensive-test-container');
            
            startComprehensiveBtn.addEventListener('click', function() {
                const selectedType = document.querySelector('.test-type-card.selected');
                if (!selectedType) {
                    alert('请先选择测试难度级别');
                    return;
                }
                
                const testLevel = selectedType.getAttribute('data-test');
                startComprehensiveTest(testLevel, comprehensiveContainer);
            });

            // Listening test
            const startListeningBtn = document.getElementById('start-listening-test');
            const listeningContainer = document.getElementById('listening-test-container');
            
            startListeningBtn.addEventListener('click', function() {
                const level = document.getElementById('listening-level').value;
                const type = document.getElementById('listening-type').value;
                startListeningTest(level, type, listeningContainer);
            });

            // Reading test
            const startReadingBtn = document.getElementById('start-reading-test');
            const readingContainer = document.getElementById('reading-test-container');
            
            startReadingBtn.addEventListener('click', function() {
                const level = document.getElementById('reading-level').value;
                const type = document.getElementById('reading-type').value;
                startReadingTest(level, type, readingContainer);
            });

            // Writing test
            const generateWritingTopicBtn = document.getElementById('generate-writing-topic');
            const writingTopicContainer = document.getElementById('writing-topic-container');
            const writingTopicText = document.getElementById('writing-topic-text');
            const submitWritingBtn = document.getElementById('submit-writing');
            const writingFeedbackContainer = document.getElementById('writing-feedback-container');
            
            generateWritingTopicBtn.addEventListener('click', function() {
                const level = document.getElementById('writing-level').value;
                const type = document.getElementById('writing-type').value;
                generateWritingTopic(level, type, writingTopicText, writingTopicContainer);
            });
            
            submitWritingBtn.addEventListener('click', function() {
                const response = document.getElementById('writing-response').value;
                if (!response.trim()) {
                    alert('请先完成写作任务');
                    return;
                }
                
                provideWritingFeedback(response, writingFeedbackContainer);
            });

            // Speaking test
            const generateSpeakingTopicBtn = document.getElementById('generate-speaking-topic');
            const speakingTopicContainer = document.getElementById('speaking-topic-container');
            const speakingTopicText = document.getElementById('speaking-topic-text');
            const startRecordingBtn = document.getElementById('start-recording');
            const stopRecordingBtn = document.getElementById('stop-recording');
            const speakingFeedbackContainer = document.getElementById('speaking-feedback-container');
            
            generateSpeakingTopicBtn.addEventListener('click', function() {
                const level = document.getElementById('speaking-level').value;
                const type = document.getElementById('speaking-type').value;
                generateSpeakingTopic(level, type, speakingTopicText, speakingTopicContainer);
                startPrepTimer();
            });
            
            startRecordingBtn.addEventListener('click', function() {
                this.style.display = 'none';
                stopRecordingBtn.style.display = 'inline-block';
                startRecordingTimer();
                // In a real app, start recording here
            });
            
            stopRecordingBtn.addEventListener('click', function() {
                this.style.display = 'none';
                // In a real app, stop recording here
                provideSpeakingFeedback(speakingFeedbackContainer);
            });

            // Results view
            const downloadReportBtn = document.getElementById('download-report');
            downloadReportBtn.addEventListener('click', function() {
                alert('报告已开始下载（模拟）');
                // In a real app, generate and download PDF here
            });

            // Test implementation functions
            async function startComprehensiveTest(level, container) {
                container.style.display = 'block';
                container.innerHTML = '<p class="text-center">正在生成AI综合测试，请稍候...</p>';
                
                try {
                    // Create prompt for AI comprehensive test generation
                    const prompt = `请生成5道英语${getLevelName(level)}综合能力测试题目，涵盖语法、词汇、阅读理解等多个方面。

要求：
1. 每道题必须是单选题，有4个选项(A、B、C、D)
2. 题目要符合${getLevelName(level)}水平的难度要求
3. 题目类型要多样化，包括语法、词汇、阅读理解等
4. 每道题都要有明确的正确答案

请严格按照以下JSON格式返回：

{
  "questions": [
    {
      "question": "题目内容",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correct": 0,
      "explanation": "答案解释"
    }
  ]
}

注意：correct字段表示正确答案的索引(0=A, 1=B, 2=C, 3=D)`;

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'AI生成失败');
                    }

                    // Parse the AI response and create quiz
                    const quiz = parseAIQuizResponse(result.output);
                    displayComprehensiveTest(level, container, quiz);
                    
                } catch (error) {
                    console.error('生成综合测试失败:', error);
                    // Fallback to default test
                    setTimeout(() => {
                        generateComprehensiveTest(level, container);
                    }, 1000);
                }
            }

            function displayComprehensiveTest(level, container, quiz) {
                let html = '<h3>AI综合能力测试 - ' + getLevelName(level) + '</h3>';
                html += '<div class="progress-container"><div class="progress-bar" style="width: 0%"></div></div>';
                html += '<p>完成进度: <span id="test-progress">0/' + quiz.questions.length + '</span></p>';
                
                // Generate questions from AI quiz
                quiz.questions.forEach((question, index) => {
                    html += `
                        <div class="test-question">
                            <div class="question-text">${index+1}. ${question.question}</div>
                            <ul class="options-list">
                    `;
                    
                    question.options.forEach((option, optionIndex) => {
                        html += `
                            <li class="option-item" data-question="${index+1}" data-option="${optionIndex}" data-correct="${question.correct}">
                                ${String.fromCharCode(65 + optionIndex)}. ${option}
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                });
                
                html += '<div class="form-group">';
                html += '<button id="submit-comprehensive" class="btn btn-primary"><i class="fas fa-check"></i> 提交答案</button>';
                html += '</div>';
                
                container.innerHTML = html;
                
                // Add event listeners to options
                const options = container.querySelectorAll('.option-item');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        const questionId = this.getAttribute('data-question');
                        const questionOptions = document.querySelectorAll(`.option-item[data-question="${questionId}"]`);
                        questionOptions.forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        // Update progress
                        updateComprehensiveProgress();
                    });
                });
                
                // Add submit handler
                const submitBtn = container.querySelector('#submit-comprehensive');
                submitBtn.addEventListener('click', function() {
                    const selectedOptions = container.querySelectorAll('.option-item.selected');
                    if (selectedOptions.length < quiz.questions.length) {
                        alert('请回答所有问题');
                        return;
                    }
                    
                    showAIComprehensiveResults(container, quiz);
                });
            }

            function updateComprehensiveProgress() {
                const totalQuestions = document.querySelectorAll('.test-question').length;
                const answeredQuestions = document.querySelectorAll('.option-item.selected').length;
                const progressBar = document.querySelector('.progress-bar');
                const progressText = document.getElementById('test-progress');
                
                if (progressBar && progressText) {
                    const percentage = (answeredQuestions / totalQuestions) * 100;
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = answeredQuestions + '/' + totalQuestions;
                }
            }

            function showAIComprehensiveResults(container, quiz) {
                // Calculate score
                let score = 0;
                const selectedOptions = container.querySelectorAll('.option-item.selected');
                
                selectedOptions.forEach(selectedOption => {
                    const selectedIndex = parseInt(selectedOption.getAttribute('data-option'));
                    const correctIndex = parseInt(selectedOption.getAttribute('data-correct'));
                    if (selectedIndex === correctIndex) {
                        score++;
                    }
                });

                const percentage = Math.round((score / quiz.questions.length) * 100);
                
                container.innerHTML = `
                    <div class="result-summary">
                        <h3>AI综合测试完成！</h3>
                        <div class="score-display">${score}/${quiz.questions.length}</div>
                        <div class="level-badge">${percentage}%</div>
                        <p>恭喜你完成了AI生成的综合测试！基于你的表现，你的正确率为${percentage}%。</p>
                        <button class="btn btn-primary" onclick="document.querySelector('[data-tab=\\'results\\']').click()">
                            <i class="fas fa-chart-bar"></i> 查看详细报告
                        </button>
                    </div>
                `;
                
                // Update results panel data
                updateResultsTab(score, quiz.questions.length, percentage, 'B1');
            }

            function generateComprehensiveTest(level, container) {
                let html = '<h3>综合能力测试 - ' + getLevelName(level) + '</h3>';
                html += '<div class="progress-container"><div class="progress-bar" style="width: 0%"></div></div>';
                html += '<p>完成进度: <span id="test-progress">0/5</span></p>';
                
                // Generate questions based on level
                html += generateQuestions(level, 5);
                
                html += '<div class="form-group">';
                html += '<button id="submit-comprehensive" class="btn btn-primary"><i class="fas fa-check"></i> 提交答案</button>';
                html += '</div>';
                
                container.innerHTML = html;
                
                // Add event listeners to options
                const options = container.querySelectorAll('.option-item');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        const questionId = this.getAttribute('data-question');
                        const questionOptions = document.querySelectorAll(`.option-item[data-question="${questionId}"]`);
                        questionOptions.forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                });
                
                // Add submit handler
                const submitBtn = container.querySelector('#submit-comprehensive');
                submitBtn.addEventListener('click', function() {
                    const selectedOptions = container.querySelectorAll('.option-item.selected');
                    if (selectedOptions.length < 5) {
                        alert('请回答所有问题');
                        return;
                    }
                    
                    showComprehensiveResults(container);
                });
            }

            function startListeningTest(level, type, container) {
                container.style.display = 'block';
                container.innerHTML = '<p class="text-center">正在加载听力测试，请稍候...</p>';
                
                // Simulate loading time
                setTimeout(() => {
                    generateListeningTest(level, type, container);
                }, 1000);
            }

            async function startReadingTest(level, type, container) {
                container.style.display = 'block';
                container.innerHTML = '<p class="text-center"><i class="fas fa-brain"></i> AI正在生成阅读测试，请稍候...</p>';
                
                try {
                    await generateReadingTest(level, type, container);
                } catch (error) {
                    console.error('Reading test generation failed:', error);
                    container.innerHTML = '<p class="text-center error-message">生成测试失败，请重试</p>';
                }
            }

            async function generateReadingTest(level, type, container) {
                let html = '';
                
                switch(type) {
                    case 'comprehension':
                        html = await generateReadingComprehensionTest(level);
                        break;
                    case 'cloze':
                        html = await generateClozeTest(level);
                        break;
                    case 'matching':
                        html = await generateMatchingTest(level);
                        break;
                    case 'mixed':
                        html = await generateMixedReadingTest(level);
                        break;
                    default:
                        html = await generateReadingComprehensionTest(level);
                }
                
                container.innerHTML = html;
                
                // Add event listeners
                addReadingTestEventListeners(container, type);
                
                // Scroll to test container
                container.scrollIntoView({ behavior: 'smooth' });
            }

            // Mixed Reading Test Function
            async function generateMixedReadingTest(level) {
                try {
                    const [comprehension, cloze, matching] = await Promise.all([
                        generateReadingComprehensionTest(level),
                        generateClozeTest(level),
                        generateMatchingTest(level)
                    ]);
                    
                    return `
                        <div class="reading-test-container">
                            <h3><i class="fas fa-layer-group"></i> 混合阅读测试 - ${getLevelName(level)}</h3>
                            
                            <div class="mixed-test-tabs">
                                <button class="test-tab active" data-section="comprehension">
                                    <i class="fas fa-book-open"></i> 阅读理解
                                </button>
                                <button class="test-tab" data-section="cloze">
                                    <i class="fas fa-edit"></i> 完形填空
                                </button>
                                <button class="test-tab" data-section="matching">
                                    <i class="fas fa-link"></i> 匹配题
                                </button>
                            </div>
                            
                            <div class="mixed-test-content">
                                <div class="test-section active" id="section-comprehension">
                                    ${comprehension}
                                </div>
                                <div class="test-section" id="section-cloze" style="display: none;">
                                    ${cloze}
                                </div>
                                <div class="test-section" id="section-matching" style="display: none;">
                                    ${matching}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Mixed reading test generation failed:', error);
                    return '<div class="error-message">混合测试生成失败，请重试</div>';
                }
            }

            // Static Test Data Functions (fallback when AI fails)
            function getReadingPassages(level) {
                return {
                    beginner: [
                        {
                            title: "My Daily Routine",
                            content: `<p>My name is Sarah and I am a high school student. Every morning, I wake up at 6:30 AM. I brush my teeth, wash my face, and get dressed. Then I have breakfast with my family. We usually eat bread, eggs, and drink milk or juice.</p>
                            <p>At 7:30 AM, I walk to school with my friends. Our school starts at 8:00 AM. I have six classes every day: English, Math, Science, History, Art, and Physical Education. My favorite subject is English because I like reading stories and writing essays.</p>
                            <p>After school, I go home and do my homework. In the evening, I sometimes watch TV or play games with my younger brother. I go to bed at 10:00 PM.</p>`,
                            questions: [
                                {
                                    question: "What time does Sarah wake up?",
                                    options: ["6:00 AM", "6:30 AM", "7:00 AM", "7:30 AM"],
                                    correct: 1,
                                    explanation: "Sarah wakes up at 6:30 AM according to the text."
                                },
                                {
                                    question: "What is Sarah's favorite subject?",
                                    options: ["Math", "Science", "English", "History"],
                                    correct: 2,
                                    explanation: "Sarah's favorite subject is English because she likes reading stories and writing essays."
                                }
                            ]
                        }
                    ],
                    intermediate: [
                        {
                            title: "The Benefits of Reading",
                            content: `<p>Reading is one of the most valuable skills a person can develop. It not only provides entertainment but also offers numerous educational and personal benefits. When we read regularly, we expand our vocabulary, improve our writing skills, and enhance our understanding of the world around us.</p>
                            <p>Research has shown that people who read frequently have better concentration and analytical thinking skills. Reading different types of books exposes us to various writing styles, cultures, and perspectives. This exposure helps us become more empathetic and open-minded individuals.</p>
                            <p>Furthermore, reading can reduce stress and improve mental health. When we immerse ourselves in a good book, we can temporarily escape from daily worries and pressures. This mental break is essential for maintaining psychological well-being.</p>`,
                            questions: [
                                {
                                    question: "According to the passage, reading helps improve all of the following EXCEPT:",
                                    options: ["vocabulary", "writing skills", "physical strength", "understanding of the world"],
                                    correct: 2,
                                    explanation: "The passage mentions vocabulary, writing skills, and understanding of the world as benefits of reading, but not physical strength."
                                },
                                {
                                    question: "What does the passage suggest about people who read frequently?",
                                    options: ["They are always happy", "They have better concentration", "They earn more money", "They live longer"],
                                    correct: 1,
                                    explanation: "The passage states that people who read frequently have better concentration and analytical thinking skills."
                                }
                            ]
                        }
                    ],
                    advanced: [
                        {
                            title: "The Impact of Artificial Intelligence on Society",
                            content: `<p>Artificial Intelligence (AI) has emerged as one of the most transformative technologies of the 21st century, fundamentally altering how we work, communicate, and interact with the world. From autonomous vehicles to sophisticated chatbots, AI applications are becoming increasingly prevalent across various sectors, including healthcare, finance, education, and entertainment.</p>
                            <p>While the potential benefits of AI are substantial—increased efficiency, enhanced decision-making capabilities, and the automation of mundane tasks—there are also significant concerns that must be addressed. The displacement of traditional jobs, privacy issues related to data collection, and the ethical implications of algorithmic decision-making represent challenges that society must navigate carefully.</p>
                            <p>Moreover, the rapid pace of AI development has outstripped regulatory frameworks, creating a gap between technological capabilities and governance structures. This discrepancy raises questions about accountability, transparency, and the equitable distribution of AI's benefits across different socioeconomic groups.</p>`,
                            questions: [
                                {
                                    question: "The author's attitude toward AI can best be described as:",
                                    options: ["entirely optimistic", "completely pessimistic", "cautiously balanced", "indifferent"],
                                    correct: 2,
                                    explanation: "The author presents both benefits and concerns about AI, showing a balanced perspective."
                                },
                                {
                                    question: "What does the passage suggest about AI regulation?",
                                    options: ["It is too strict", "It is keeping pace with technology", "It is lagging behind technological development", "It is unnecessary"],
                                    correct: 2,
                                    explanation: "The passage mentions that the rapid pace of AI development has outstripped regulatory frameworks."
                                }
                            ]
                        }
                    ]
                };
            }

            function getClozeTexts(level) {
                return {
                    beginner: [
                        {
                            title: "At School",
                            content: "Tom is a {0} student. He goes to {1} every day by bus. His favorite {2} is English because he wants to {3} to other countries. After school, he {4} his homework and then plays with his friends.",
                            blanks: [
                                {
                                    context: "Tom is a ___ student",
                                    options: ["good", "bad", "lazy", "tired"],
                                    correct: 0,
                                    explanation: "The context suggests Tom is a good student."
                                },
                                {
                                    context: "He goes to ___ every day",
                                    options: ["work", "school", "home", "store"],
                                    correct: 1,
                                    explanation: "Students go to school every day."
                                }
                            ]
                        }
                    ],
                    intermediate: [
                        {
                            title: "Environmental Protection",
                            content: "Climate change is one of the most {0} challenges facing our planet today. Scientists {1} that global temperatures have risen significantly over the past century. To {2} this problem, we must reduce our carbon emissions and develop {3} energy sources. Every individual can {4} by making small changes in their daily lives.",
                            blanks: [
                                {
                                    context: "one of the most ___ challenges",
                                    options: ["serious", "easy", "funny", "simple"],
                                    correct: 0,
                                    explanation: "Climate change is a serious challenge."
                                },
                                {
                                    context: "Scientists ___ that global temperatures",
                                    options: ["deny", "report", "ignore", "forget"],
                                    correct: 1,
                                    explanation: "Scientists report their findings about temperature rises."
                                }
                            ]
                        }
                    ],
                    advanced: [
                        {
                            title: "Technological Innovation",
                            content: "The {0} advancement of technology has {1} transformed modern society. Innovations in artificial intelligence and machine learning have {2} new possibilities for automation and efficiency. However, these developments also {3} significant ethical and social {4} that require careful consideration.",
                            blanks: [
                                {
                                    context: "The ___ advancement of technology",
                                    options: ["slow", "rapid", "backward", "limited"],
                                    correct: 1,
                                    explanation: "Technology advancement has been rapid in recent times."
                                },
                                {
                                    context: "has ___ transformed modern society",
                                    options: ["slightly", "fundamentally", "rarely", "barely"],
                                    correct: 1,
                                    explanation: "Technology has fundamentally transformed society."
                                }
                            ]
                        }
                    ]
                };
            }

            function getMatchingTests(level) {
                return {
                    beginner: [
                        {
                            instructions: "Match each profession with the place where they work.",
                            leftTitle: "Professions",
                            rightTitle: "Workplaces",
                            leftItems: ["Doctor", "Teacher", "Chef", "Firefighter", "Librarian"],
                            rightItems: ["Fire station", "Kitchen", "Hospital", "Library", "School"],
                            correctMatches: [2, 4, 1, 0, 3]
                        }
                    ],
                    intermediate: [
                        {
                            instructions: "Match each environmental problem with its primary solution.",
                            leftTitle: "Environmental Problems",
                            rightTitle: "Solutions",
                            leftItems: ["Air pollution", "Deforestation", "Water shortage", "Global warming", "Plastic waste"],
                            rightItems: ["Recycling programs", "Renewable energy", "Tree planting", "Clean transportation", "Water conservation"],
                            correctMatches: [3, 2, 4, 1, 0]
                        }
                    ],
                    advanced: [
                        {
                            instructions: "Match each scientific discovery with its social impact.",
                            leftTitle: "Scientific Discoveries",
                            rightTitle: "Social Impacts",
                            leftItems: ["Internet", "Antibiotics", "DNA sequencing", "Artificial Intelligence", "Renewable energy"],
                            rightItems: ["Personalized medicine", "Global communication", "Automation of jobs", "Sustainable development", "Extended life expectancy"],
                            correctMatches: [1, 4, 0, 2, 3]
                        }
                    ]
                };
            }

            // AI-Powered Test Generation Functions
            async function generateReadingComprehensionTest(level) {
                try {
                    // Create prompt for AI reading comprehension generation
                    const prompt = `请为英语${getLevelName(level)}水平的学习者生成一篇阅读理解测试。

要求：
1. 生成一篇适合${getLevelName(level)}难度的英语文章（150-300词）
2. 文章主题要有趣且具有教育意义
3. 根据文章内容设计4道阅读理解选择题
4. 每道题有4个选项(A、B、C、D)，只有一个正确答案
5. 题目要测试不同的理解技能：主旨大意、细节理解、推理判断、词义猜测等

请严格按照以下JSON格式返回：

{
  "title": "文章标题",
  "content": "文章内容（用<p>标签分段）",
  "questions": [
    {
      "question": "问题内容",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correct": 0,
      "explanation": "答案解释"
    }
  ]
}

注意：correct字段表示正确答案的索引(0=A, 1=B, 2=C, 3=D)`;

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'AI生成失败');
                    }

                    // Parse the AI response
                    const passage = parseAIResponse(result.output, 'reading');
                    
                    return generateReadingHTML(passage, level);
                    
                } catch (error) {
                    console.error('生成阅读理解测试失败:', error);
                    // Fallback to static content
                    const passages = getReadingPassages(level);
                    const passage = passages[level][Math.floor(Math.random() * passages[level].length)];
                    
                    return generateReadingHTML(passage, level, true);
                }
            }

            async function generateClozeTest(level) {
                try {
                    // Create prompt for AI cloze test generation
                    const prompt = `请为英语${getLevelName(level)}水平的学习者生成一道完形填空测试。

要求：
1. 生成一篇适合${getLevelName(level)}难度的英语短文（100-200词）
2. 从文中选择6-8个关键词设为空白，用{0}, {1}, {2}等标记
3. 为每个空白提供4个选项(A、B、C、D)，只有一个正确答案
4. 空白应该测试语法、词汇、语境理解等不同技能
5. 选项要有一定迷惑性，但只有一个明显正确

请严格按照以下JSON格式返回：

{
  "title": "文章标题",
  "content": "文章内容（用{0}, {1}, {2}等标记空白位置）",
  "blanks": [
    {
      "context": "空白前后的语境提示",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correct": 0,
      "explanation": "答案解释"
    }
  ]
}

注意：correct字段表示正确答案的索引(0=A, 1=B, 2=C, 3=D)`;

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'AI生成失败');
                    }

                    // Parse the AI response
                    const clozeTest = parseAIResponse(result.output, 'cloze');
                    
                    return generateClozeHTML(clozeTest, level);
                    
                } catch (error) {
                    console.error('生成完形填空测试失败:', error);
                    // Fallback to static content
                    const clozeTexts = getClozeTexts(level);
                    const clozeTest = clozeTexts[level][Math.floor(Math.random() * clozeTexts[level].length)];
                    
                    return generateClozeHTML(clozeTest, level, true);
                }
            }

            async function generateMatchingTest(level) {
                try {
                    // Create prompt for AI matching test generation
                    const prompt = `请为英语${getLevelName(level)}水平的学习者生成一道匹配题测试。

要求：
1. 选择一个适合${getLevelName(level)}难度的主题
2. 创建5个左边项目和5个右边项目
3. 题目要测试词汇理解、语言知识或文化常识
4. 确保匹配关系明确且符合逻辑
5. 提供清晰的指导说明

请严格按照以下JSON格式返回：

{
  "instructions": "匹配指导说明",
  "leftTitle": "左边栏目标题",
  "rightTitle": "右边栏目标题",
  "leftItems": ["左边项目1", "左边项目2", "左边项目3", "左边项目4", "左边项目5"],
  "rightItems": ["右边项目1", "右边项目2", "右边项目3", "右边项目4", "右边项目5"],
  "correctMatches": [2, 0, 4, 1, 3]
}

注意：correctMatches数组表示每个左边项目对应的右边项目索引(从0开始)`;

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'AI生成失败');
                    }

                    // Parse the AI response
                    const test = parseAIResponse(result.output, 'matching');
                    
                    return generateMatchingHTML(test, level);
                    
                } catch (error) {
                    console.error('生成匹配题测试失败:', error);
                    // Fallback to static content
                    const matchingTests = getMatchingTests(level);
                    const test = matchingTests[level][Math.floor(Math.random() * matchingTests[level].length)];
                    
                    return generateMatchingHTML(test, level, true);
                }
            }

            // HTML Generation Helper Functions
            function generateReadingHTML(passage, level, isStaticFallback = false) {
                let html = `
                    <div class="reading-test-container">
                        <h3><i class="fas fa-book-open"></i> 阅读理解测试 - ${getLevelName(level)}</h3>
                        ${isStaticFallback ? '<div class="error-message" style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><p><i class="fas fa-exclamation-triangle"></i> AI生成失败，使用备用题目</p></div>' : ''}
                        
                        <!-- 移动端友好的阅读区域 -->
                        <div class="reading-passage-container">
                            <div class="passage-header">
                                <h4><i class="fas fa-file-text"></i> 阅读文章</h4>
                                <div class="reading-controls">
                                    <button class="btn-icon" id="increase-font" title="增大字体">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button class="btn-icon" id="decrease-font" title="减小字体">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="reading-passage" id="reading-passage">
                                <h5 class="passage-title">${passage.title}</h5>
                                <div class="passage-content">
                                    ${passage.content}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 问题区域 -->
                        <div class="questions-container">
                            <h4><i class="fas fa-question-circle"></i> 问题 (${passage.questions.length}题)</h4>
                            <div class="progress-container">
                                <div class="progress-bar" id="reading-progress" style="width: 0%"></div>
                            </div>
                            <p class="progress-text">已完成: <span id="reading-progress-text">0/${passage.questions.length}</span></p>
                `;
                
                passage.questions.forEach((question, index) => {
                    html += `
                        <div class="test-question" data-question="${index}">
                            <div class="question-text">
                                <span class="question-number">${index + 1}.</span>
                                ${question.question}
                            </div>
                            <ul class="options-list">
                    `;
                    
                    question.options.forEach((option, optionIndex) => {
                        const letter = String.fromCharCode(65 + optionIndex);
                        html += `
                            <li class="option-item" data-question="${index}" data-option="${optionIndex}" data-correct="${question.correct}">
                                <span class="option-letter">${letter}.</span>
                                <span class="option-text">${option}</span>
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="submit-container">
                            <button id="submit-reading-test" class="btn btn-primary" disabled>
                                <i class="fas fa-check"></i> 提交答案
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            }

            function generateClozeHTML(clozeTest, level, isStaticFallback = false) {
                let html = `
                    <div class="reading-test-container">
                        <h3><i class="fas fa-edit"></i> 完形填空测试 - ${getLevelName(level)}</h3>
                        ${isStaticFallback ? '<div class="error-message" style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><p><i class="fas fa-exclamation-triangle"></i> AI生成失败，使用备用题目</p></div>' : ''}
                        
                        <div class="cloze-instructions">
                            <p><i class="fas fa-info-circle"></i> 阅读下面的短文，从每题所给的四个选项中选出最佳答案。</p>
                        </div>
                        
                        <div class="cloze-passage-container">
                            <div class="passage-header">
                                <h4><i class="fas fa-file-text"></i> ${clozeTest.title}</h4>
                                <div class="reading-controls">
                                    <button class="btn-icon" id="increase-font" title="增大字体">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button class="btn-icon" id="decrease-font" title="减小字体">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="cloze-passage" id="cloze-passage">
                `;
                
                // 处理完形填空文本，插入题目
                let passageHTML = clozeTest.content;
                clozeTest.blanks.forEach((blank, index) => {
                    const blankHTML = `<span class="cloze-blank" data-blank="${index}">____${index + 1}____</span>`;
                    passageHTML = passageHTML.replace(`{${index}}`, blankHTML);
                });
                
                html += `
                                ${passageHTML}
                            </div>
                        </div>
                        
                        <!-- 选择题区域 -->
                        <div class="cloze-questions-container">
                            <h4><i class="fas fa-list-ol"></i> 选择题 (${clozeTest.blanks.length}题)</h4>
                            <div class="progress-container">
                                <div class="progress-bar" id="cloze-progress" style="width: 0%"></div>
                            </div>
                            <p class="progress-text">已完成: <span id="cloze-progress-text">0/${clozeTest.blanks.length}</span></p>
                            
                            <div class="cloze-questions-grid">
                `;
                
                clozeTest.blanks.forEach((blank, index) => {
                    html += `
                        <div class="cloze-question" data-question="${index}">
                            <div class="question-header">
                                <span class="question-number">${index + 1}.</span>
                                <span class="context-hint">"...${blank.context}..."</span>
                            </div>
                            <ul class="options-list compact">
                    `;
                    
                    blank.options.forEach((option, optionIndex) => {
                        const letter = String.fromCharCode(65 + optionIndex);
                        html += `
                            <li class="option-item" data-question="${index}" data-option="${optionIndex}" data-correct="${blank.correct}">
                                <span class="option-letter">${letter}.</span>
                                <span class="option-text">${option}</span>
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="submit-container">
                            <button id="submit-cloze-test" class="btn btn-primary" disabled>
                                <i class="fas fa-check"></i> 提交答案
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            }

            function generateMatchingHTML(test, level, isStaticFallback = false) {
                let html = `
                    <div class="reading-test-container">
                        <h3><i class="fas fa-link"></i> 匹配题测试 - ${getLevelName(level)}</h3>
                        ${isStaticFallback ? '<div class="error-message" style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><p><i class="fas fa-exclamation-triangle"></i> AI生成失败，使用备用题目</p></div>' : ''}
                        
                        <div class="matching-instructions">
                            <p><i class="fas fa-info-circle"></i> ${test.instructions}</p>
                        </div>
                        
                        <div class="matching-container">
                            <div class="matching-left">
                                <h4><i class="fas fa-list"></i> ${test.leftTitle}</h4>
                                <div class="matching-items">
                `;
                
                test.leftItems.forEach((item, index) => {
                    html += `
                        <div class="matching-item" data-left="${index}" data-correct="${test.correctMatches[index]}">
                            <span class="item-number">${index + 1}.</span>
                            <span class="item-content">${item}</span>
                            <span class="match-indicator" id="match-${index}">
                                <i class="fas fa-circle-notch"></i>
                            </span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                            
                            <div class="matching-right">
                                <h4><i class="fas fa-list"></i> ${test.rightTitle}</h4>
                                <div class="matching-options">
                `;
                
                test.rightItems.forEach((item, index) => {
                    const letter = String.fromCharCode(65 + index);
                    html += `
                        <div class="matching-option" data-right="${index}">
                            <span class="option-letter">${letter}.</span>
                            <span class="option-content">${item}</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                        </div>
                        
                        <!-- 匹配答案区域 -->
                        <div class="matching-answers">
                            <h4><i class="fas fa-check-double"></i> 你的答案</h4>
                            <div class="answers-grid" id="matching-answers-grid">
                                <!-- 答案会在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="submit-container">
                            <button id="submit-matching-test" class="btn btn-primary" disabled>
                                <i class="fas fa-check"></i> 提交答案
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            }

            // AI Response Parsing Functions
            function parseAIResponse(aiOutput, testType) {
                try {
                    let cleanOutput = aiOutput.trim();
                    cleanOutput = cleanOutput.replace(/```json\s*/g, '');
                    cleanOutput = cleanOutput.replace(/```\s*$/g, '');
                    
                    const jsonMatch = cleanOutput.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('No valid JSON found in AI response');
                    }
                    
                    const jsonString = jsonMatch[0];
                    const parsedData = JSON.parse(jsonString);
                    
                    switch(testType) {
                        case 'reading':
                            return validateReadingData(parsedData);
                        case 'cloze':
                            return validateClozeData(parsedData);
                        case 'matching':
                            return validateMatchingData(parsedData);
                        default:
                            return parsedData;
                    }
                } catch (error) {
                    console.error('Failed to parse AI response:', error);
                    return getDefaultTestData(testType);
                }
            }

            function validateReadingData(data) {
                if (!data.title || !data.content || !data.questions || !Array.isArray(data.questions)) {
                    throw new Error('Invalid reading test data structure');
                }
                
                data.questions.forEach((question, index) => {
                    if (!question.question || !question.options || !Array.isArray(question.options) || 
                        typeof question.correct !== 'number') {
                        throw new Error(`Invalid question data at index ${index}`);
                    }
                });
                
                return data;
            }

            function validateClozeData(data) {
                if (!data.title || !data.content || !data.blanks || !Array.isArray(data.blanks)) {
                    throw new Error('Invalid cloze test data structure');
                }
                
                data.blanks.forEach((blank, index) => {
                    if (!blank.options || !Array.isArray(blank.options) || typeof blank.correct !== 'number') {
                        throw new Error(`Invalid blank data at index ${index}`);
                    }
                    if (!blank.context) {
                        blank.context = `blank ${index + 1}`;
                    }
                });
                
                return data;
            }

            function validateMatchingData(data) {
                if (!data.instructions || !data.leftTitle || !data.rightTitle || 
                    !data.leftItems || !data.rightItems || !data.correctMatches) {
                    throw new Error('Invalid matching test data structure');
                }
                
                return data;
            }

            function getDefaultTestData(testType) {
                switch(testType) {
                    case 'reading':
                        return {
                            title: "Default Reading Test",
                            content: "<p>This is a default reading passage. Please read and answer the questions below.</p>",
                            questions: [
                                {
                                    question: "What is this passage about?",
                                    options: ["Reading", "Writing", "Speaking", "Listening"],
                                    correct: 0,
                                    explanation: "The passage is about reading."
                                }
                            ]
                        };
                    case 'cloze':
                        return {
                            title: "Default Cloze Test",
                            content: "This is a {0} test where you need to {1} the blanks.",
                            blanks: [
                                {
                                    context: "This is a ___ test",
                                    options: ["cloze", "reading", "writing", "speaking"],
                                    correct: 0,
                                    explanation: "This is a cloze test."
                                },
                                {
                                    context: "you need to ___ the blanks",
                                    options: ["read", "fill", "write", "speak"],
                                    correct: 1,
                                    explanation: "You need to fill the blanks."
                                }
                            ]
                        };
                    case 'matching':
                        return {
                            instructions: "Match the items on the left with the items on the right.",
                            leftTitle: "Words",
                            rightTitle: "Definitions",
                            leftItems: ["Apple", "Book", "Car", "Dog", "House"],
                            rightItems: ["A fruit", "Reading material", "Vehicle", "Animal", "Building"],
                            correctMatches: [0, 1, 2, 3, 4]
                        };
                    default:
                        return {};
                }
            }

            function addReadingTestEventListeners(container, type) {
                // Add font size controls
                const increaseFontBtn = container.querySelector('#increase-font');
                const decreaseFontBtn = container.querySelector('#decrease-font');
                const readingPassage = container.querySelector('#reading-passage, #cloze-passage');
                
                if (increaseFontBtn && readingPassage) {
                    increaseFontBtn.addEventListener('click', function() {
                        const currentSize = parseInt(window.getComputedStyle(readingPassage).fontSize);
                        readingPassage.style.fontSize = (currentSize + 2) + 'px';
                    });
                }
                
                if (decreaseFontBtn && readingPassage) {
                    decreaseFontBtn.addEventListener('click', function() {
                        const currentSize = parseInt(window.getComputedStyle(readingPassage).fontSize);
                        if (currentSize > 12) {
                            readingPassage.style.fontSize = (currentSize - 2) + 'px';
                        }
                    });
                }
                
                // Add option selection listeners
                const options = container.querySelectorAll('.option-item');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        const questionId = this.getAttribute('data-question');
                        const questionOptions = container.querySelectorAll(`.option-item[data-question="${questionId}"]`);
                        questionOptions.forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        // Update progress
                        updateReadingProgress(container);
                    });
                });
                
                // Add submit handler
                const submitBtn = container.querySelector('#submit-reading-test, #submit-cloze-test, #submit-matching-test');
                if (submitBtn) {
                    submitBtn.addEventListener('click', function() {
                        handleReadingTestSubmit(container, type);
                    });
                }
            }

            function updateReadingProgress(container) {
                const totalQuestions = container.querySelectorAll('.test-question, .cloze-question').length;
                const answeredQuestions = container.querySelectorAll('.option-item.selected').length;
                const progressBar = container.querySelector('.progress-bar');
                const progressText = container.querySelector('#reading-progress-text, #cloze-progress-text');
                const submitBtn = container.querySelector('#submit-reading-test, #submit-cloze-test, #submit-matching-test');
                
                if (progressBar && progressText) {
                    const percentage = (answeredQuestions / totalQuestions) * 100;
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = answeredQuestions + '/' + totalQuestions;
                }
                
                if (submitBtn) {
                    submitBtn.disabled = answeredQuestions < totalQuestions;
                }
            }

            function handleReadingTestSubmit(container, type) {
                const selectedOptions = container.querySelectorAll('.option-item.selected');
                const correctAnswers = container.querySelectorAll('.option-item[data-correct]');
                
                let score = 0;
                selectedOptions.forEach(selected => {
                    const questionId = selected.getAttribute('data-question');
                    const selectedOption = parseInt(selected.getAttribute('data-option'));
                    const correctOption = parseInt(selected.getAttribute('data-correct'));
                    
                    if (selectedOption === correctOption) {
                        score++;
                    }
                });
                
                const percentage = Math.round((score / selectedOptions.length) * 100);
                
                container.innerHTML = `
                    <div class="result-summary">
                        <h3>阅读测试完成！</h3>
                        <div class="score-display">${score}/${selectedOptions.length}</div>
                        <div class="level-badge">${percentage}%</div>
                        <p>恭喜你完成了阅读测试！基于你的表现，你的正确率为${percentage}%。</p>
                        <div class="result-actions">
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i class="fas fa-redo"></i> 重新测试
                            </button>
                            <button class="btn btn-primary" onclick="document.querySelector('[data-tab=\\'results\\']').click()">
                                <i class="fas fa-chart-bar"></i> 查看详细报告
                            </button>
                        </div>
                    </div>
                `;
            }

            function updateResultsTab(score, total, percentage, level) {
                document.getElementById('no-results-message').style.display = 'none';
                document.getElementById('results-container').style.display = 'block';
                document.getElementById('overall-score').textContent = level;
                document.getElementById('level-description').textContent = `${percentage}% (${score}/${total})`;
            }

            function generateListeningTest(level, type, container) {
                let html = `
                    <h3>听力测试 - ${getLevelName(level)}</h3>
                    <p>请听录音，然后回答问题。</p>
                    
                    <div class="test-question">
                        <div class="audio-player">
                            <button class="btn btn-primary">
                                <i class="fas fa-play"></i> 播放录音
                            </button>
                            <p><small>注：实际测试中会有真实录音</small></p>
                        </div>
                        
                        <div class="question-text">1. 根据录音，以下哪项是正确的？</div>
                        <ul class="options-list">
                            <li class="option-item">A. 选项一</li>
                            <li class="option-item">B. 选项二</li>
                            <li class="option-item">C. 选项三</li>
                            <li class="option-item">D. 选项四</li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary">
                            <i class="fas fa-check"></i> 提交答案
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
            }

            function generateWritingFeedback(container) {
                let html = `
                    <h3><i class="fas fa-chart-line"></i> 写作评估</h3>
                    
                    <div class="result-summary">
                        <div class="score-display">7.0</div>
                        <div class="level-badge">B2</div>
                        <p>你的写作整体表现良好，属于中高级水平。</p>
                    </div>
                    
                    <div class="feedback-section">
                        <h4>详细反馈</h4>
                        
                        <div class="feedback-item">
                            <h5>内容与任务完成 (7.0)</h5>
                            <p>你很好地回应了题目要求，提供了相关的观点和例子。可以进一步展开某些论点以增强说服力。</p>
                        </div>
                        
                        <div class="feedback-item">
                            <h5>连贯与衔接 (6.5)</h5>
                            <p>文章整体结构清晰，但段落之间的过渡可以更流畅。建议增加更多的连接词。</p>
                        </div>
                        
                        <div class="feedback-item">
                            <h5>词汇 (7.5)</h5>
                            <p>使用了多样化的词汇，表达相对准确。偶有不自然的表达，可以关注同义词的选择。</p>
                        </div>
                        
                        <div class="feedback-item">
                            <h5>语法 (7.0)</h5>
                            <p>整体语法正确，使用了一些复杂句式。有少量语法错误，主要在时态和介词使用方面。</p>
                        </div>
                    </div>
                    
                    <div class="feedback-section">
                        <h4>改进建议</h4>
                        <ul>
                            <li>增加段落间的过渡词，提高文章连贯性</li>
                            <li>注意时态一致性，特别是在描述过去事件时</li>
                            <li>尝试使用更多高级连接词，如 nevertheless, consequently 等</li>
                            <li>进一步展开你的主要论点，提供更具体的例子</li>
                        </ul>
                    </div>
                `;
                
                container.innerHTML = html;
            }

            function generateSpeakingFeedback(container) {
                let html = `
                    <h3><i class="fas fa-chart-line"></i> 口语评估</h3>
                    
                    <div class="result-summary">
                        <div class="score-display">6.5</div>
                        <div class="level-badge">B2</div>
                        <p>你的口语整体表现良好，属于中高级水平。</p>
                    </div>
                    
                    <div class="feedback-section">
                        <h4>详细反馈</h4>
                        
                        <div class="feedback-item">
                            <h5>流利度与连贯性 (6.5)</h5>
                            <p>你能够相对流利地表达，但有时会有停顿。可以通过更多练习来减少犹豫和重复。</p>
                        </div>
                        
                        <div class="feedback-item">
                            <h5>词汇 (7.0)</h5>
                            <p>使用了一定范围的词汇来表达观点。可以增加更多描述性和学术性词汇。</p>
                        </div>
                        
                        <div class="feedback-item">
                            <h5>语法 (6.5)</h5>
                            <p>基本语法正确，但在更复杂结构中有一些错误。可以尝试使用更多复合句和从句。</p>
                        </div>
                        
                        <div class="feedback-item">
                            <h5>发音 (6.0)</h5>
                            <p>整体发音清晰，但某些音素和重音需要改进。特别注意元音和连读。</p>
                        </div>
                    </div>
                    
                    <div class="feedback-section">
                        <h4>改进建议</h4>
                        <ul>
                            <li>通过朗读练习改善流利度，减少停顿</li>
                            <li>注意单词重音，特别是多音节单词</li>
                            <li>练习连读和弱读，使语音更自然</li>
                            <li>扩展表达观点的词汇和句型</li>
                        </ul>
                    </div>
                `;
                
                container.innerHTML = html;
            }

            // AI Quiz Functions
            function initializeAIQuizEvents() {
                // Topic selection
                const topicCards = document.querySelectorAll('.topic-card');
                topicCards.forEach(card => {
                    card.addEventListener('click', function() {
                        topicCards.forEach(c => c.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedTopic = this.getAttribute('data-topic');
                    });
                });

                // Difficulty selection
                const difficultyBtns = document.querySelectorAll('.difficulty-btn');
                difficultyBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        difficultyBtns.forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedDifficulty = this.getAttribute('data-difficulty');
                    });
                });

                // Question count selection
                const questionCountSelect = document.getElementById('question-count');
                questionCountSelect.addEventListener('change', function() {
                    questionCount = parseInt(this.value);
                });

                // Generate AI Quiz button
                const generateBtn = document.getElementById('generate-ai-quiz');
                generateBtn.addEventListener('click', generateAIQuiz);
            }

            async function generateAIQuiz() {
                // Validate selections
                if (!selectedTopic) {
                    alert('请选择一个测试话题');
                    return;
                }
                if (!selectedDifficulty) {
                    alert('请选择难度级别');
                    return;
                }

                const generateBtn = document.getElementById('generate-ai-quiz');
                const customTopic = document.getElementById('custom-topic').value.trim();

                // Show loading
                showLoadingOverlay('AI正在生成测试题目，请稍候...');
                generateBtn.disabled = true;

                try {
                    // Prepare the prompt for DeepSeek API
                    const prompt = createQuizPrompt(selectedTopic, selectedDifficulty, questionCount, customTopic);
                    
                    // Call DeepSeek API
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message || 'API调用失败');
                    }

                    // Parse the AI response and create quiz
                    currentQuiz = parseAIQuizResponse(result.output);
                    currentQuestionIndex = 0;
                    userAnswers = [];

                    // Display the quiz
                    displayAIQuiz();

                } catch (error) {
                    console.error('生成AI测试失败:', error);
                    hideLoadingOverlay();
                    showError('生成测试失败: ' + error.message + '. 请检查网络连接后重试。');
                } finally {
                    generateBtn.disabled = false;
                    hideLoadingOverlay();
                }
            }

            function createQuizPrompt(topic, difficulty, count, customTopic) {
                const topicMap = {
                    'grammar': '英语语法',
                    'vocabulary': '英语词汇',
                    'reading': '英语阅读理解',
                    'listening': '英语听力理解',
                    'speaking': '英语口语表达',
                    'writing': '英语写作技能',
                    'toefl': '托福水平英语',
                    'ielts': '雅思水平英语'
                };

                const difficultyMap = {
                    'beginner': '初级(A1-A2)',
                    'intermediate': '中级(B1-B2)',
                    'advanced': '高级(C1-C2)'
                };

                const topicName = customTopic || topicMap[topic] || '英语';
                const difficultyName = difficultyMap[difficulty] || '中级';

                // Special handling for TOEFL and IELTS
                let specificInstructions = '';
                if (topic === 'toefl') {
                    specificInstructions = `
特殊要求 - 托福水平测试：
- 题目应该测试托福考试所需的英语能力水平
- 包含学术词汇、复杂语法结构、阅读理解等
- 难度应相当于托福80-100分水平的英语能力
- 题目内容应涉及学术场景、校园生活、学术讨论等托福常见话题
- 重点测试英语运用能力，而不是关于托福考试本身的知识`;
                } else if (topic === 'ielts') {
                    specificInstructions = `
特殊要求 - 雅思水平测试：
- 题目应该测试雅思考试所需的英语能力水平
- 包含多样化词汇、语法运用、阅读理解等
- 难度应相当于雅思6.0-7.0分水平的英语能力
- 题目内容应涉及日常生活、工作场景、社会话题等雅思常见主题
- 重点测试英语运用能力，而不是关于雅思考试本身的知识`;
                }

                return `请生成${count}道关于"${topicName}"的${difficultyName}难度英语测试题目。

要求：
1. 每道题必须是单选题，有4个选项(A、B、C、D)
2. 题目要符合${difficultyName}水平的难度要求
3. 每道题都要有明确的正确答案
4. 题目要有教育价值，能够测试学习者的相关技能
5. 题目应该测试英语语言能力，而不是关于考试本身的知识${specificInstructions}

请严格按照以下JSON格式返回，不要添加任何其他文字说明：

{
  "questions": [
    {
      "question": "题目内容",
      "options": ["选项A", "选项B", "选项C", "选项D"],
      "correct": 0,
      "explanation": "答案解释"
    }
  ]
}

注意：correct字段表示正确答案的索引(0=A, 1=B, 2=C, 3=D)`;
            }

            function parseAIQuizResponse(response) {
                try {
                    // Try to extract JSON from the response
                    let jsonStr = response.trim();
                    
                    // Remove markdown code blocks if present
                    if (jsonStr.startsWith('```json')) {
                        jsonStr = jsonStr.replace(/```json\n?/, '').replace(/\n?```$/, '');
                    } else if (jsonStr.startsWith('```')) {
                        jsonStr = jsonStr.replace(/```\n?/, '').replace(/\n?```$/, '');
                    }
                    
                    const quiz = JSON.parse(jsonStr);
                    
                    if (!quiz.questions || !Array.isArray(quiz.questions)) {
                        throw new Error('无效的题目格式');
                    }
                    
                    // Validate each question
                    quiz.questions.forEach((q, index) => {
                        if (!q.question || !q.options || !Array.isArray(q.options) || q.options.length !== 4) {
                            throw new Error(`第${index + 1}题格式错误`);
                        }
                        if (typeof q.correct !== 'number' || q.correct < 0 || q.correct > 3) {
                            throw new Error(`第${index + 1}题答案索引无效`);
                        }
                    });
                    
                    return quiz;
                    
                } catch (error) {
                    console.error('解析AI响应失败:', error);
                    // Return a fallback quiz if parsing fails
                    return createFallbackQuiz();
                }
            }

            function createFallbackQuiz() {
                return {
                    questions: [
                        {
                            question: "Which of the following is the correct form of the verb 'to be' in present tense for 'I'?",
                            options: ["am", "is", "are", "be"],
                            correct: 0,
                            explanation: "'I am' is the correct form of 'to be' for the first person singular."
                        },
                        {
                            question: "What is the past tense of 'go'?",
                            options: ["goed", "went", "gone", "going"],
                            correct: 1,
                            explanation: "'Went' is the past tense of the irregular verb 'go'."
                        },
                        {
                            question: "Choose the correct sentence:",
                            options: [
                                "She don't like coffee",
                                "She doesn't like coffee", 
                                "She doesn't likes coffee",
                                "She don't likes coffee"
                            ],
                            correct: 1,
                            explanation: "For third person singular, we use 'doesn't' + base form of the verb."
                        }
                    ]
                };
            }

            function displayAIQuiz() {
                const container = document.getElementById('ai-quiz-container');
                container.style.display = 'block';
                
                // Scroll to quiz container
                container.scrollIntoView({ behavior: 'smooth' });
                
                displayCurrentQuestion();
            }

            function displayCurrentQuestion() {
                const container = document.getElementById('ai-quiz-container');
                const question = currentQuiz.questions[currentQuestionIndex];
                const totalQuestions = currentQuiz.questions.length;
                
                let html = `
                    <div class="quiz-counter">
                        <h3><i class="fas fa-brain"></i> AI智能测试进行中</h3>
                        <p>题目 ${currentQuestionIndex + 1} / ${totalQuestions}</p>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${((currentQuestionIndex + 1) / totalQuestions) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="test-question">
                        <div class="question-text">${currentQuestionIndex + 1}. ${question.question}</div>
                        <ul class="options-list">
                `;
                
                question.options.forEach((option, index) => {
                    const letter = String.fromCharCode(65 + index); // A, B, C, D
                    html += `
                        <li class="option-item" data-option="${index}">
                            ${letter}. ${option}
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                    
                    <div class="quiz-navigation">
                        ${currentQuestionIndex > 0 ? 
                            '<button class="btn btn-secondary" onclick="previousQuestion()"><i class="fas fa-arrow-left"></i> 上一题</button>' : 
                            '<div></div>'
                        }
                        <button class="btn btn-primary" id="next-question-btn" disabled>
                            ${currentQuestionIndex < totalQuestions - 1 ? 
                                '<i class="fas fa-arrow-right"></i> 下一题' : 
                                '<i class="fas fa-check"></i> 完成测试'
                            }
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Add event listeners to options
                const options = container.querySelectorAll('.option-item');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        options.forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        const selectedIndex = parseInt(this.getAttribute('data-option'));
                        userAnswers[currentQuestionIndex] = selectedIndex;
                        
                        // Enable next button
                        document.getElementById('next-question-btn').disabled = false;
                    });
                });
                
                // Add next button event listener
                document.getElementById('next-question-btn').addEventListener('click', function() {
                    if (currentQuestionIndex < totalQuestions - 1) {
                        currentQuestionIndex++;
                        displayCurrentQuestion();
                    } else {
                        finishAIQuiz();
                    }
                });
                
                // Restore previous answer if exists
                if (userAnswers[currentQuestionIndex] !== undefined) {
                    const selectedOption = container.querySelector(`[data-option="${userAnswers[currentQuestionIndex]}"]`);
                    if (selectedOption) {
                        selectedOption.classList.add('selected');
                        document.getElementById('next-question-btn').disabled = false;
                    }
                }
            }

            function previousQuestion() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayCurrentQuestion();
                }
            }

            function finishAIQuiz() {
                // Calculate score
                let score = 0;
                const results = [];
                
                currentQuiz.questions.forEach((question, index) => {
                    const userAnswer = userAnswers[index];
                    const isCorrect = userAnswer === question.correct;
                    if (isCorrect) score++;
                    
                    results.push({
                        question: question.question,
                        userAnswer: userAnswer,
                        correctAnswer: question.correct,
                        isCorrect: isCorrect,
                        explanation: question.explanation || ''
                    });
                });
                
                const percentage = Math.round((score / currentQuiz.questions.length) * 100);
                
                displayAIQuizResults(score, currentQuiz.questions.length, percentage, results);
            }

            function displayAIQuizResults(score, total, percentage, results) {
                const container = document.getElementById('ai-quiz-container');
                
                let level = 'A1';
                if (percentage >= 90) level = 'C2';
                else if (percentage >= 80) level = 'C1'; 
                else if (percentage >= 70) level = 'B2';
                else if (percentage >= 60) level = 'B1';
                else if (percentage >= 50) level = 'A2';
                
                let html = `
                    <div class="result-summary">
                        <h3><i class="fas fa-trophy"></i> AI测试完成！</h3>
                        <div class="score-display">${score}/${total}</div>
                        <div class="level-badge">${level} (${percentage}%)</div>
                        <p>恭喜完成AI智能测试！您的正确率为${percentage}%。</p>
                    </div>
                    
                    <div class="feedback-section">
                        <h4><i class="fas fa-chart-line"></i> 详细结果</h4>
                `;
                
                results.forEach((result, index) => {
                    const letter = String.fromCharCode(65 + result.correctAnswer);
                    const userLetter = result.userAnswer !== undefined ? String.fromCharCode(65 + result.userAnswer) : '未答';
                    
                    html += `
                        <div class="feedback-item">
                            <h5>题目 ${index + 1} ${result.isCorrect ? '<span style="color: #00b894;">✓</span>' : '<span style="color: #e74c3c;">✗</span>'}</h5>
                            <p><strong>题目：</strong>${result.question}</p>
                            <p><strong>您的答案：</strong>${userLetter} ${result.isCorrect ? '(正确)' : '(错误)'}</p>
                            <p><strong>正确答案：</strong>${letter}</p>
                            ${result.explanation ? `<p><strong>解释：</strong>${result.explanation}</p>` : ''}
                        </div>
                    `;
                });
                
                html += `
                    </div>
                    
                    <div class="quiz-navigation">
                        <button class="btn btn-secondary" onclick="restartAIQuiz()">
                            <i class="fas fa-redo"></i> 重新测试
                        </button>
                        <button class="btn btn-primary" onclick="document.querySelector('[data-tab=\\'results\\']').click()">
                            <i class="fas fa-chart-bar"></i> 查看详细报告
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Scroll to results
                container.scrollIntoView({ behavior: 'smooth' });
                
                // Update results tab data
                updateResultsTab(score, total, percentage, level);
            }

            function restartAIQuiz() {
                currentQuiz = null;
                currentQuestionIndex = 0;
                userAnswers = [];
                
                // Hide quiz container and show config
                document.getElementById('ai-quiz-container').style.display = 'none';
                
                // Reset selections
                document.querySelectorAll('.topic-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelectorAll('.difficulty-btn.selected').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                selectedTopic = '';
                selectedDifficulty = '';
            }

            function showLoadingOverlay(message) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.id = 'loading-overlay';
                overlay.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            function hideLoadingOverlay() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }

            function showError(message) {
                const container = document.getElementById('ai-quiz-container');
                container.style.display = 'block';
                container.innerHTML = `
                    <div class="error-message">
                        <h4><i class="fas fa-exclamation-triangle"></i> 错误</h4>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="restartAIQuiz()">
                            <i class="fas fa-redo"></i> 重试
                        </button>
                    </div>
                `;
            }

            // Helper functions
            function getLevelName(level) {
                return level === 'beginner' ? '初级' : 
                       level === 'intermediate' ? '中级' : '高级';
            }

            function getWritingTypeName(type) {
                const typeMap = {
                    'essay': '议论文',
                    'letter': '书信',
                    'report': '报告',
                    'story': '故事'
                };
                return typeMap[type] || '作文';
            }

            function getSpeakingTypeName(type) {
                const typeMap = {
                    'description': '描述类',
                    'opinion': '观点表达',
                    'conversation': '对话练习',
                    'mixed': '综合练习'
                };
                return typeMap[type] || '口语练习';
            }

            function generateQuestions(level, count) {
                let html = '';
                
                // Sample questions for demonstration
                const questions = [
                    {
                        text: '下列哪个单词与其他三个意思不同？',
                        options: ['Happy', 'Joyful', 'Sad', 'Pleased']
                    },
                    {
                        text: '选择正确的时态填空：He _____ in this company for five years.',
                        options: ['works', 'is working', 'has worked', 'had worked']
                    },
                    {
                        text: '以下哪个句子是被动语态？',
                        options: [
                            'She wrote a letter.',
                            'A letter was written by her.',
                            'They are writing letters.',
                            'We will write letters.'
                        ]
                    },
                    {
                        text: '选择正确的连词：_____ it was raining, we decided to go out.',
                        options: ['Although', 'Because', 'So', 'Unless']
                    },
                    {
                        text: '下列哪个是正确的问句？',
                        options: [
                            'Where you are going?',
                            'Where are you going?',
                            'Where going you are?',
                            'You are going where?'
                        ]
                    }
                ];
                
                for (let i = 0; i < count; i++) {
                    const question = questions[i];
                    
                    html += `
                        <div class="test-question">
                            <div class="question-text">${i+1}. ${question.text}</div>
                            <ul class="options-list">
                    `;
                    
                    question.options.forEach((option, index) => {
                        html += `
                            <li class="option-item" data-question="${i+1}" data-option="${index}">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                }
                
                return html;
            }

            function showComprehensiveResults(container) {
                container.innerHTML = `
                    <div class="result-summary">
                        <h3>测试完成！</h3>
                        <div class="score-display">75%</div>
                        <div class="level-badge">B1-B2</div>
                        <p>恭喜你完成了测试！基于你的表现，你的英语水平处于中级水平。</p>
                        <button class="btn btn-primary" onclick="document.querySelector('[data-tab=\\'results\\']').click()">
                            <i class="fas fa-chart-bar"></i> 查看详细报告
                        </button>
                    </div>
                `;
                
                // Show results panel data
                document.getElementById('no-results-message').style.display = 'none';
                document.getElementById('results-container').style.display = 'block';
            }

            // Make functions globally available
            window.previousQuestion = previousQuestion;
            window.restartAIQuiz = restartAIQuiz;
            window.getLevelName = getLevelName;
        });
    </script>
</body>
</html>