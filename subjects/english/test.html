<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语能力测试 - 学习助手</title>
    <link rel="icon" href="../../assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/utilities.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Test Page Specific Styles */
        .test-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4rem 0;
            text-align: center;
        }

        .test-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .test-hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Test Type Cards */
        .test-types-section {
            padding: 4rem 0;
            background: #f8f9fa;
        }

        .test-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .test-type-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .test-type-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .test-type-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }

        .test-card-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .test-card-icon i {
            font-size: 2.5rem;
            color: white;
        }

        .test-card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
            color: #2d3748;
        }

        .test-card-description {
            color: #718096;
            text-align: center;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .test-card-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .test-card-features li {
            padding: 0.5rem 0;
            color: #4a5568;
            display: flex;
            align-items: center;
        }

        .test-card-features li i {
            color: #667eea;
            margin-right: 0.5rem;
            width: 16px;
        }

        /* Test Configuration */
        .test-config-section {
            padding: 4rem 0;
            display: none;
        }

        .test-config-section.active {
            display: block;
        }

        .config-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .config-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .config-header h2 {
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .config-header p {
            color: #718096;
        }

        .config-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .config-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        /* Test Interface */
        .test-interface {
            display: none;
            padding: 2rem 0;
        }

        .test-interface.active {
            display: block;
        }

        .test-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .test-header {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .test-info h3 {
            margin: 0;
            color: #2d3748;
        }

        .test-info p {
            margin: 0.5rem 0 0;
            color: #718096;
            font-size: 0.9rem;
        }

        .test-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }

        .timer {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1rem;
        }

        .question-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .question-number {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .question-text {
            font-size: 1.1rem;
            color: #2d3748;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .question-options {
            display: grid;
            gap: 1rem;
        }

        .option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .option.correct {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .option.incorrect {
            border-color: #f56565;
            background: rgba(245, 101, 101, 0.1);
        }

        .option-label {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: 600;
            color: #4a5568;
        }

        .option.selected .option-label {
            background: #667eea;
            color: white;
        }

        .option.correct .option-label {
            background: #48bb78;
            color: white;
        }

        .option.incorrect .option-label {
            background: #f56565;
            color: white;
        }

        .test-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .question-nav {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .question-nav-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s ease;
        }

        .question-nav-btn:hover {
            border-color: #667eea;
        }

        .question-nav-btn.current {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .question-nav-btn.answered {
            background: #48bb78;
            border-color: #48bb78;
            color: white;
        }

        /* Results */
        .test-results {
            display: none;
            padding: 4rem 0;
        }

        .test-results.active {
            display: block;
        }

        .results-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .results-card {
            background: white;
            border-radius: 15px;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            display: block;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .performance-chart {
            background: #f7fafc;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-label {
            width: 100px;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .chart-progress {
            flex: 1;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            margin: 0 1rem;
            overflow: hidden;
        }

        .chart-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .chart-value {
            font-weight: 600;
            color: #667eea;
            min-width: 40px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .test-hero h1 {
                font-size: 2.5rem;
            }
            
            .test-types-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .test-hero {
                padding: 3rem 0;
            }
            
            .test-hero h1 {
                font-size: 2rem;
            }
            
            .test-hero p {
                font-size: 1rem;
            }
            
            .test-types-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .config-form {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .config-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .test-header {
                flex-direction: column;
                text-align: center;
            }
            
            .progress-bar {
                width: 150px;
            }
            
            .test-navigation {
                flex-direction: column;
                gap: 1.5rem;
            }
            
            .question-nav {
                justify-content: center;
            }
            
            .results-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .test-type-card {
                padding: 1.5rem;
            }
            
            .config-container {
                padding: 1.5rem;
            }
            
            .question-card {
                padding: 1.5rem;
            }
            
            .results-card {
                padding: 2rem;
            }
            
            .score-circle {
                width: 120px;
                height: 120px;
                font-size: 2rem;
            }
            
            .results-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        .test-type-card:focus,
        .option:focus,
        .question-nav-btn:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../../index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span class="gradient-text">Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="../../index.html#subjects">科目</a></li>
                        <li><a href="../../tts.html">语音</a></li>
                        <li><a href="../../draw.html">绘图</a></li>
                    </ul>
                </nav>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="test-hero">
            <div class="container">
                <h1>英语能力<span style="color: #ffd700;">测试</span></h1>
                <p>通过AI驱动的个性化测试评估您的英语水平，获得详细的能力分析和学习建议</p>
            </div>
        </section>

        <!-- Test Type Selection -->
        <section class="test-types-section">
            <div class="container">
                <div class="section-header">
                    <h2>选择<span class="gradient-text">测试类型</span></h2>
                    <p>选择适合您的测试类型，开始您的英语能力评估</p>
                </div>
                
                <div class="test-types-grid">
                    <!-- Grammar Test -->
                    <div class="test-type-card" data-test-type="grammar" tabindex="0">
                        <div class="test-card-icon">
                            <i class="fas fa-spell-check"></i>
                        </div>
                        <h3 class="test-card-title">语法测试</h3>
                        <p class="test-card-description">测试您的英语语法知识，包括时态、语态、句型结构等</p>
                        <ul class="test-card-features">
                            <li><i class="fas fa-check"></i> 时态运用</li>
                            <li><i class="fas fa-check"></i> 句型结构</li>
                            <li><i class="fas fa-check"></i> 语法规则</li>
                            <li><i class="fas fa-check"></i> 常见错误</li>
                        </ul>
                    </div>

                    <!-- Vocabulary Test -->
                    <div class="test-type-card" data-test-type="vocabulary" tabindex="0">
                        <div class="test-card-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3 class="test-card-title">词汇测试</h3>
                        <p class="test-card-description">评估您的词汇量和词汇运用能力</p>
                        <ul class="test-card-features">
                            <li><i class="fas fa-check"></i> 词汇量评估</li>
                            <li><i class="fas fa-check"></i> 词义理解</li>
                            <li><i class="fas fa-check"></i> 词汇搭配</li>
                            <li><i class="fas fa-check"></i> 同义词辨析</li>
                        </ul>
                    </div>

                    <!-- Reading Comprehension -->
                    <div class="test-type-card" data-test-type="reading" tabindex="0">
                        <div class="test-card-icon">
                            <i class="fas fa-book-reader"></i>
                        </div>
                        <h3 class="test-card-title">阅读理解</h3>
                        <p class="test-card-description">测试您的英语阅读理解能力和分析技巧</p>
                        <ul class="test-card-features">
                            <li><i class="fas fa-check"></i> 文章理解</li>
                            <li><i class="fas fa-check"></i> 细节把握</li>
                            <li><i class="fas fa-check"></i> 推理分析</li>
                            <li><i class="fas fa-check"></i> 主旨概括</li>
                        </ul>
                    </div>

                    <!-- Listening Test -->
                    <div class="test-type-card" data-test-type="listening" tabindex="0">
                        <div class="test-card-icon">
                            <i class="fas fa-headphones"></i>
                        </div>
                        <h3 class="test-card-title">听力测试</h3>
                        <p class="test-card-description">评估您的英语听力理解能力</p>
                        <ul class="test-card-features">
                            <li><i class="fas fa-check"></i> 对话理解</li>
                            <li><i class="fas fa-check"></i> 信息捕捉</li>
                            <li><i class="fas fa-check"></i> 语音识别</li>
                            <li><i class="fas fa-check"></i> 语调理解</li>
                        </ul>
                    </div>

                    <!-- Comprehensive Test -->
                    <div class="test-type-card" data-test-type="comprehensive" tabindex="0">
                        <div class="test-card-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <h3 class="test-card-title">综合测试</h3>
                        <p class="test-card-description">全面评估您的英语综合能力</p>
                        <ul class="test-card-features">
                            <li><i class="fas fa-check"></i> 语法词汇</li>
                            <li><i class="fas fa-check"></i> 阅读理解</li>
                            <li><i class="fas fa-check"></i> 听力测试</li>
                            <li><i class="fas fa-check"></i> 综合评估</li>
                        </ul>
                    </div>

                    <!-- IELTS/TOEFL Prep -->
                    <div class="test-type-card" data-test-type="exam-prep" tabindex="0">
                        <div class="test-card-icon">
                            <i class="fas fa-certificate"></i>
                        </div>
                        <h3 class="test-card-title">考试准备</h3>
                        <p class="test-card-description">针对IELTS、TOEFL等标准化考试的专项训练</p>
                        <ul class="test-card-features">
                            <li><i class="fas fa-check"></i> IELTS模拟</li>
                            <li><i class="fas fa-check"></i> TOEFL练习</li>
                            <li><i class="fas fa-check"></i> 考试技巧</li>
                            <li><i class="fas fa-check"></i> 时间管理</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Test Configuration -->
        <section class="test-config-section" id="test-config">
            <div class="container">
                <div class="config-container">
                    <div class="config-header">
                        <h2 id="config-title">配置测试</h2>
                        <p id="config-description">请选择测试参数以获得最佳的测试体验</p>
                    </div>
                    
                    <form class="config-form" id="test-config-form">
                        <div class="form-group">
                            <label for="test-difficulty">难度级别</label>
                            <select id="test-difficulty" class="form-control" required>
                                <option value="beginner">初级 (A1-A2)</option>
                                <option value="intermediate" selected>中级 (B1-B2)</option>
                                <option value="advanced">高级 (C1-C2)</option>
                                <option value="mixed">混合难度</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="test-duration">测试时长</label>
                            <select id="test-duration" class="form-control" required>
                                <option value="10">10分钟 (快速测试)</option>
                                <option value="20" selected>20分钟 (标准测试)</option>
                                <option value="30">30分钟 (深度测试)</option>
                                <option value="45">45分钟 (全面测试)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="question-count">题目数量</label>
                            <select id="question-count" class="form-control" required>
                                <option value="10">10题</option>
                                <option value="15">15题</option>
                                <option value="20" selected>20题</option>
                                <option value="25">25题</option>
                                <option value="30">30题</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="exam-type-group" style="display: none;">
                            <label for="exam-type">考试类型</label>
                            <select id="exam-type" class="form-control">
                                <option value="ielts">IELTS</option>
                                <option value="toefl">TOEFL</option>
                                <option value="toeic">TOEIC</option>
                                <option value="cambridge">剑桥英语</option>
                            </select>
                        </div>
                    </form>
                    
                    <div class="config-actions">
                        <button type="button" class="btn btn-secondary" id="back-to-types">返回选择</button>
                        <button type="button" class="btn btn-primary" id="start-test">开始测试</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Test Interface -->
        <section class="test-interface" id="test-interface">
            <div class="container">
                <div class="test-container">
                    <!-- Test Header -->
                    <div class="test-header">
                        <div class="test-info">
                            <h3 id="test-title">英语测试</h3>
                            <p id="test-subtitle">题目 <span id="current-question">1</span> / <span id="total-questions">20</span></p>
                        </div>
                        <div class="test-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="timer" id="timer">20:00</div>
                        </div>
                    </div>

                    <!-- Question Card -->
                    <div class="question-card" id="question-card">
                        <div class="question-number" id="question-number">题目 1</div>
                        <div class="question-text" id="question-text">
                            <!-- Question content will be loaded here -->
                        </div>
                        <div class="question-options" id="question-options">
                            <!-- Options will be loaded here -->
                        </div>
                    </div>

                    <!-- Test Navigation -->
                    <div class="test-navigation">
                        <div class="question-nav" id="question-nav">
                            <!-- Question navigation buttons will be generated here -->
                        </div>
                        <div class="nav-actions">
                            <button class="btn btn-secondary" id="prev-question" disabled>上一题</button>
                            <button class="btn btn-primary" id="next-question">下一题</button>
                            <button class="btn btn-success" id="finish-test" style="display: none;">完成测试</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Test Results -->
        <section class="test-results" id="test-results">
            <div class="container">
                <div class="results-container">
                    <div class="results-card">
                        <h2>测试完成！</h2>
                        <div class="score-circle" id="score-circle">
                            <span id="final-score">85%</span>
                        </div>
                        
                        <div class="results-stats">
                            <div class="stat-item">
                                <span class="stat-value" id="correct-answers">17</span>
                                <div class="stat-label">正确答案</div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="total-time">18:32</span>
                                <div class="stat-label">用时</div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="accuracy-rate">85%</span>
                                <div class="stat-label">准确率</div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="level-assessment">B2</span>
                                <div class="stat-label">水平评估</div>
                            </div>
                        </div>

                        <div class="performance-chart">
                            <h4>能力分析</h4>
                            <div class="chart-bar">
                                <div class="chart-label">语法</div>
                                <div class="chart-progress">
                                    <div class="chart-fill" id="grammar-score" style="width: 0%"></div>
                                </div>
                                <div class="chart-value" id="grammar-percentage">0%</div>
                            </div>
                            <div class="chart-bar">
                                <div class="chart-label">词汇</div>
                                <div class="chart-progress">
                                    <div class="chart-fill" id="vocabulary-score" style="width: 0%"></div>
                                </div>
                                <div class="chart-value" id="vocabulary-percentage">0%</div>
                            </div>
                            <div class="chart-bar">
                                <div class="chart-label">阅读</div>
                                <div class="chart-progress">
                                    <div class="chart-fill" id="reading-score" style="width: 0%"></div>
                                </div>
                                <div class="chart-value" id="reading-percentage">0%</div>
                            </div>
                            <div class="chart-bar">
                                <div class="chart-label">理解</div>
                                <div class="chart-progress">
                                    <div class="chart-fill" id="comprehension-score" style="width: 0%"></div>
                                </div>
                                <div class="chart-value" id="comprehension-percentage">0%</div>
                            </div>
                        </div>

                        <div id="recommendations" class="recommendations">
                            <h4>学习建议</h4>
                            <div id="recommendation-content">
                                <!-- AI-generated recommendations will be displayed here -->
                            </div>
                        </div>

                        <div class="config-actions">
                            <button class="btn btn-secondary" id="retake-test">重新测试</button>
                            <button class="btn btn-primary" id="view-detailed-results">查看详细结果</button>
                            <a href="main.html" class="btn btn-success">返回英语学习</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading Overlay -->
        <div class="loading" id="loading" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <p class="copyright-text">study-llm.me域名为Alex所有。保留所有权利。</p>
                <div class="profile-section">
                    <button id="profile-button" class="profile-button">
                        <i class="fas fa-user-circle"></i>
                        学习阶段
                    </button>
                    <div id="profile-display" class="profile-display"></div>
                </div>
            </div>
        </div>
    </footer>

    <script src="../../js/common.js"></script>
    <script src="../../js/navigation.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/profile.js"></script>
    <script src="script.js"></script>
    <script>
        // Test Application State
        let currentTestType = null;
        let currentQuestionIndex = 0;
        let testQuestions = [];
        let userAnswers = [];
        let testStartTime = null;
        let testTimer = null;
        let testDuration = 20; // minutes

        // DOM Elements
        const testTypeCards = document.querySelectorAll('.test-type-card');
        const testConfigSection = document.getElementById('test-config');
        const testInterface = document.getElementById('test-interface');
        const testResults = document.getElementById('test-results');
        const loading = document.getElementById('loading');

        // Initialize the test application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTestApp();
        });

        function initializeTestApp() {
            // Test type selection
            testTypeCards.forEach(card => {
                card.addEventListener('click', function() {
                    selectTestType(this.dataset.testType);
                });
                
                card.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectTestType(this.dataset.testType);
                    }
                });
            });

            // Configuration form
            document.getElementById('start-test').addEventListener('click', startTest);
            document.getElementById('back-to-types').addEventListener('click', backToTypeSelection);

            // Test navigation
            document.getElementById('prev-question').addEventListener('click', previousQuestion);
            document.getElementById('next-question').addEventListener('click', nextQuestion);
            document.getElementById('finish-test').addEventListener('click', finishTest);

            // Results actions
            document.getElementById('retake-test').addEventListener('click', retakeTest);
            document.getElementById('view-detailed-results').addEventListener('click', viewDetailedResults);

            // Initialize profile system
            if (typeof initProfile === 'function') {
                initProfile();
            }
        }

        function selectTestType(testType) {
            currentTestType = testType;
            
            // Update active state
            testTypeCards.forEach(card => card.classList.remove('active'));
            document.querySelector(`[data-test-type="${testType}"]`).classList.add('active');
            
            // Update configuration UI
            updateConfigurationUI(testType);
            
            // Show configuration section
            testConfigSection.classList.add('active');
            testConfigSection.scrollIntoView({ behavior: 'smooth' });
        }

        function updateConfigurationUI(testType) {
            const configTitle = document.getElementById('config-title');
            const configDescription = document.getElementById('config-description');
            const examTypeGroup = document.getElementById('exam-type-group');
            
            const testTypeNames = {
                'grammar': '语法测试',
                'vocabulary': '词汇测试',
                'reading': '阅读理解测试',
                'listening': '听力测试',
                'comprehensive': '综合测试',
                'exam-prep': '考试准备测试'
            };
            
            configTitle.textContent = `配置${testTypeNames[testType]}`;
            
            if (testType === 'exam-prep') {
                examTypeGroup.style.display = 'block';
                configDescription.textContent = '选择您要准备的考试类型和测试参数';
            } else {
                examTypeGroup.style.display = 'none';
                configDescription.textContent = '请选择测试参数以获得最佳的测试体验';
            }
        }

        function backToTypeSelection() {
            testConfigSection.classList.remove('active');
            testTypeCards.forEach(card => card.classList.remove('active'));
            currentTestType = null;
        }

        async function startTest() {
            const difficulty = document.getElementById('test-difficulty').value;
            const duration = parseInt(document.getElementById('test-duration').value);
            const questionCount = parseInt(document.getElementById('question-count').value);
            const examType = document.getElementById('exam-type').value;
            
            testDuration = duration;
            
            // Show loading
            showLoading();
            
            try {
                // Generate test questions using AI
                testQuestions = await generateTestQuestions(currentTestType, difficulty, questionCount, examType);
                userAnswers = new Array(testQuestions.length).fill(null);
                currentQuestionIndex = 0;
                
                // Hide loading and show test interface
                hideLoading();
                showTestInterface();
                
                // Start timer
                startTestTimer();
                
                // Load first question
                loadQuestion(0);
                
            } catch (error) {
                hideLoading();
                alert('生成测试题目时出错，请重试。');
                console.error('Error generating test:', error);
            }
        }

        async function generateTestQuestions(testType, difficulty, questionCount, examType) {
            // This would typically call your AI API
            // For now, we'll generate sample questions
            const questions = [];
            
            for (let i = 0; i < questionCount; i++) {
                questions.push(generateSampleQuestion(testType, difficulty, i + 1));
            }
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            return questions;
        }

        function generateSampleQuestion(testType, difficulty, questionNumber) {
            const sampleQuestions = {
                grammar: [
                    {
                        question: "Choose the correct form of the verb: 'She _____ to the store yesterday.'",
                        options: ["go", "goes", "went", "going"],
                        correct: 2,
                        explanation: "Past tense is used for actions completed in the past."
                    },
                    {
                        question: "Which sentence is grammatically correct?",
                        options: [
                            "I have been living here since five years.",
                            "I have been living here for five years.",
                            "I am living here since five years.",
                            "I live here since five years."
                        ],
                        correct: 1,
                        explanation: "Use 'for' with periods of time and 'since' with specific points in time."
                    }
                ],
                vocabulary: [
                    {
                        question: "What does 'ubiquitous' mean?",
                        options: ["Rare", "Present everywhere", "Ancient", "Expensive"],
                        correct: 1,
                        explanation: "Ubiquitous means present, appearing, or found everywhere."
                    },
                    {
                        question: "Choose the best synonym for 'meticulous':",
                        options: ["Careless", "Detailed", "Quick", "Lazy"],
                        correct: 1,
                        explanation: "Meticulous means showing great attention to detail; very careful and precise."
                    }
                ],
                reading: [
                    {
                        passage: "Climate change is one of the most pressing issues of our time. Rising global temperatures are causing ice caps to melt, sea levels to rise, and weather patterns to become more extreme.",
                        question: "According to the passage, what is causing sea levels to rise?",
                        options: ["Extreme weather", "Melting ice caps", "Climate change", "Global warming"],
                        correct: 1,
                        explanation: "The passage states that rising temperatures are causing ice caps to melt, which leads to rising sea levels."
                    }
                ]
            };
            
            const typeQuestions = sampleQuestions[testType] || sampleQuestions.grammar;
            const baseQuestion = typeQuestions[questionNumber % typeQuestions.length];
            
            return {
                ...baseQuestion,
                id: questionNumber,
                type: testType,
                difficulty: difficulty
            };
        }

        function showTestInterface() {
            testConfigSection.classList.remove('active');
            testInterface.classList.add('active');
            
            // Update test header
            document.getElementById('test-title').textContent = getTestTypeTitle(currentTestType);
            document.getElementById('total-questions').textContent = testQuestions.length;
            
            // Generate question navigation
            generateQuestionNavigation();
        }

        function getTestTypeTitle(testType) {
            const titles = {
                'grammar': '语法测试',
                'vocabulary': '词汇测试',
                'reading': '阅读理解测试',
                'listening': '听力测试',
                'comprehensive': '综合测试',
                'exam-prep': '考试准备测试'
            };
            return titles[testType] || '英语测试';
        }

        function generateQuestionNavigation() {
            const questionNav = document.getElementById('question-nav');
            questionNav.innerHTML = '';
            
            for (let i = 0; i < testQuestions.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'question-nav-btn';
                btn.textContent = i + 1;
                btn.addEventListener('click', () => loadQuestion(i));
                questionNav.appendChild(btn);
            }
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            const question = testQuestions[index];
            
            // Update question content
            document.getElementById('question-number').textContent = `题目 ${index + 1}`;
            document.getElementById('current-question').textContent = index + 1;
            
            let questionHTML = '';
            if (question.passage) {
                questionHTML += `<div class="passage" style="background: #f7fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; line-height: 1.6;">${question.passage}</div>`;
            }
            questionHTML += question.question;
            
            document.getElementById('question-text').innerHTML = questionHTML;
            
            // Update options
            const optionsContainer = document.getElementById('question-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, optionIndex) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.innerHTML = `
                    <div class="option-label">${String.fromCharCode(65 + optionIndex)}</div>
                    <div class="option-text">${option}</div>
                `;
                
                optionElement.addEventListener('click', () => selectOption(index, optionIndex));
                optionsContainer.appendChild(optionElement);
            });
            
            // Update selected option
            if (userAnswers[index] !== null) {
                const selectedOption = optionsContainer.children[userAnswers[index]];
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }
            
            // Update navigation buttons
            updateNavigationButtons();
            updateQuestionNavigation();
            updateProgress();
        }

        function selectOption(questionIndex, optionIndex) {
            userAnswers[questionIndex] = optionIndex;
            
            // Update UI
            const options = document.querySelectorAll('.option');
            options.forEach(option => option.classList.remove('selected'));
            options[optionIndex].classList.add('selected');
            
            updateQuestionNavigation();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-question');
            const nextBtn = document.getElementById('next-question');
            const finishBtn = document.getElementById('finish-test');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === testQuestions.length - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                finishBtn.style.display = 'none';
            }
        }

        function updateQuestionNavigation() {
            const navButtons = document.querySelectorAll('.question-nav-btn');
            navButtons.forEach((btn, index) => {
                btn.classList.remove('current', 'answered');
                
                if (index === currentQuestionIndex) {
                    btn.classList.add('current');
                } else if (userAnswers[index] !== null) {
                    btn.classList.add('answered');
                }
            });
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / testQuestions.length) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < testQuestions.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            }
        }

        function startTestTimer() {
            testStartTime = Date.now();
            const endTime = testStartTime + (testDuration * 60 * 1000);
            
            testTimer = setInterval(() => {
                const now = Date.now();
                const remaining = endTime - now;
                
                if (remaining <= 0) {
                    clearInterval(testTimer);
                    finishTest();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function finishTest() {
            if (testTimer) {
                clearInterval(testTimer);
            }
            
            // Calculate results
            const results = calculateResults();
            
            // Show results
            showResults(results);
        }

        function calculateResults() {
            let correctAnswers = 0;
            const categoryScores = {
                grammar: { correct: 0, total: 0 },
                vocabulary: { correct: 0, total: 0 },
                reading: { correct: 0, total: 0 },
                comprehension: { correct: 0, total: 0 }
            };
            
            testQuestions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correct;
                
                if (isCorrect) {
                    correctAnswers++;
                }
                
                // Categorize by question type
                const category = question.type || 'comprehension';
                if (categoryScores[category]) {
                    categoryScores[category].total++;
                    if (isCorrect) {
                        categoryScores[category].correct++;
                    }
                }
            });
            
            const accuracy = (correctAnswers / testQuestions.length) * 100;
            const testEndTime = Date.now();
            const totalTime = testEndTime - testStartTime;
            
            return {
                correctAnswers,
                totalQuestions: testQuestions.length,
                accuracy,
                totalTime,
                categoryScores,
                levelAssessment: getLevelAssessment(accuracy)
            };
        }

        function getLevelAssessment(accuracy) {
            if (accuracy >= 90) return 'C2';
            if (accuracy >= 80) return 'C1';
            if (accuracy >= 70) return 'B2';
            if (accuracy >= 60) return 'B1';
            if (accuracy >= 50) return 'A2';
            return 'A1';
        }

        function showResults(results) {
            testInterface.classList.remove('active');
            testResults.classList.add('active');
            
            // Update results display
            document.getElementById('final-score').textContent = `${Math.round(results.accuracy)}%`;
            document.getElementById('correct-answers').textContent = results.correctAnswers;
            document.getElementById('accuracy-rate').textContent = `${Math.round(results.accuracy)}%`;
            document.getElementById('level-assessment').textContent = results.levelAssessment;
            
            // Format time
            const minutes = Math.floor(results.totalTime / 60000);
            const seconds = Math.floor((results.totalTime % 60000) / 1000);
            document.getElementById('total-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update category scores with animation
            setTimeout(() => {
                Object.keys(results.categoryScores).forEach(category => {
                    const score = results.categoryScores[category];
                    const percentage = score.total > 0 ? (score.correct / score.total) * 100 : 0;
                    
                    const fillElement = document.getElementById(`${category}-score`);
                    const percentageElement = document.getElementById(`${category}-percentage`);
                    
                    if (fillElement && percentageElement) {
                        fillElement.style.width = `${percentage}%`;
                        percentageElement.textContent = `${Math.round(percentage)}%`;
                    }
                });
            }, 500);
            
            // Generate AI recommendations
            generateRecommendations(results);
        }

        function generateRecommendations(results) {
            const recommendationContent = document.getElementById('recommendation-content');
            let recommendations = [];
            
            // Analyze performance and generate recommendations
            if (results.accuracy < 60) {
                recommendations.push('建议从基础语法和词汇开始，加强基本功训练。');
            }
            
            Object.keys(results.categoryScores).forEach(category => {
                const score = results.categoryScores[category];
                const percentage = score.total > 0 ? (score.correct / score.total) * 100 : 0;
                
                if (percentage < 70) {
                    const categoryNames = {
                        grammar: '语法',
                        vocabulary: '词汇',
                        reading: '阅读理解',
                        comprehension: '综合理解'
                    };
                    recommendations.push(`${categoryNames[category]}方面需要加强练习。`);
                }
            });
            
            if (recommendations.length === 0) {
                recommendations.push('您的英语水平很好！建议继续保持并挑战更高难度的内容。');
            }
            
            recommendationContent.innerHTML = recommendations.map(rec => `<p>• ${rec}</p>`).join('');
        }

        function retakeTest() {
            // Reset test state
            currentQuestionIndex = 0;
            testQuestions = [];
            userAnswers = [];
            testStartTime = null;
            
            if (testTimer) {
                clearInterval(testTimer);
                testTimer = null;
            }
            
            // Show configuration
            testResults.classList.remove('active');
            testConfigSection.classList.add('active');
        }

        function viewDetailedResults() {
            // This would show a detailed breakdown of answers
            alert('详细结果功能正在开发中...');
        }

        function showLoading() {
            loading.style.display = 'flex';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (testInterface.classList.contains('active')) {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        previousQuestion();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        nextQuestion();
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                        e.preventDefault();
                        const optionIndex = parseInt(e.key) - 1;
                        if (optionIndex < testQuestions[currentQuestionIndex].options.length) {
                            selectOption(currentQuestionIndex, optionIndex);
                        }
                        break;
                }
            }
        });
    </script>
</body>
</html> 