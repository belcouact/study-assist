<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国历朝历代 - 学习助手</title>
    <link rel="icon" href="../../assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/utilities.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .subject-hero {
            position: relative;
            padding: 1rem 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            overflow: hidden;
        }

        .subject-hero-content {
            position: relative;
            text-align: left;
            padding: 0.5rem 0;
            z-index: 1;
        }

        .subject-hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .subject-hero h1 .gradient-text {
            background: linear-gradient(90deg, #4361ee, #7209b7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subject-description {
            color: #666;
            max-width: 800px;
            margin: 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .dynasty-container {
            display: flex;
            flex-direction: column;
            padding: 1rem 2rem;
            min-height: calc(100vh - 150px);
        }

        .timeline-container {
            flex: none;
            width: 100%;
            position: relative;
            padding: 20px 10px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            height: auto;
            overflow-x: auto;
            margin-bottom: 30px;
            white-space: nowrap;
            scrollbar-width: thin;
            scrollbar-color: #4361ee #e2e8f0;
        }

        .timeline-container::-webkit-scrollbar {
            height: 6px;
        }

        .timeline-container::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 3px;
        }

        .timeline-container::-webkit-scrollbar-thumb {
            background: #4361ee;
            border-radius: 3px;
        }

        .vertical-timeline {
            position: relative;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .timeline-line {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 4px;
            width: 100%;
            background: linear-gradient(90deg, #4361ee, #7209b7);
            transform: translateY(-50%);
        }

        .dynasty-marker {
            position: relative;
            margin: 0 15px;
            padding: 30px 0 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .dynasty-marker::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            width: 20px;
            height: 20px;
            background: #fff;
            border: 3px solid #4361ee;
            border-radius: 50%;
            transform: translate(-50%, 0);
            transition: all 0.3s ease;
            z-index: 1;
        }

        .dynasty-marker:hover::before {
            background: #4361ee;
            transform: translate(-50%, 0) scale(1.2);
        }

        .dynasty-marker.active::before {
            background: #4361ee;
            border-color: #7209b7;
            transform: translate(-50%, 0) scale(1.2);
        }

        .dynasty-label {
            background: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-weight: 500;
            transition: all 0.3s ease;
            word-break: keep-all;
            white-space: nowrap;
            text-align: center;
        }

        .dynasty-year {
            font-size: 0.8em;
            color: #666;
            display: block;
        }

        .events-container {
            flex: 1;
            position: relative;
            width: 100%;
        }

        .timeline-controls {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        .timeline-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4361ee;
        }

        .timeline-nav-btn:hover {
            background: linear-gradient(90deg, #4361ee, #7209b7);
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .event-display {
            position: relative;
            margin-top: 20px;
            width: 100%;
        }

        .events-carousel {
            width: 100%;
            position: relative;
        }

        .event-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        .event-nav-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 10px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
            position: relative;
        }

        .event-nav-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4361ee;
            font-size: 1.2rem;
        }

        .event-nav-btn:hover {
            background: linear-gradient(90deg, #4361ee, #7209b7);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
        }

        .event-counter {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4361ee;
            min-width: 80px;
            text-align: center;
        }

        .event-cards-wrapper {
            position: relative;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .event-cards {
            display: flex;
            gap: 0;
            transition: transform 0.5s ease;
        }

        .event-card {
            flex: 0 0 100%;
            max-width: 100%;
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0;
            box-sizing: border-box;
            width: 100%;
        }

        .event-card.active {
            border: 2px solid #4361ee;
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.3);
        }

        .event-year {
            font-size: 1.1em;
            font-weight: 600;
            color: #4361ee;
            margin-bottom: 0.5rem;
        }

        .event-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 0.7rem;
            color: #333;
            text-align: left;
            line-height: 1.4;
        }

        .event-description {
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
            margin-bottom: 0;
            text-align: justify;
        }

        .event-significance {
            font-size: 0.9em;
            color: #7209b7;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
        }

        .dynasty-poem {
            font-size: 1.3rem;
            color: #333;
            width: 100%;
            margin: 0.5rem auto;
            line-height: 1.8;
            font-family: "KaiTi", "楷体", serif;
            text-align: left;
            padding: 0;
            max-width: 800px;
        }

        .dynasty-poem p {
            margin: 0.2rem 0;
            width: 100%;
        }

        /* Mobile Responsive Styles - Updated to match events.html layout */
        @media screen and (max-width: 768px) {
            .dynasty-container {
                padding: 1rem 0.5rem;
                gap: 1rem;
            }
            
            .timeline-container {
                padding: 15px 10px;
                overflow-x: auto;
                margin-bottom: 20px;
            }
            
            .vertical-timeline {
                padding: 5px 0;
            }
            
            .dynasty-marker {
                margin: 0 10px;
            }
            
            .dynasty-label {
                font-size: 0.9rem;
                padding: 6px 10px;
            }
            
            .dynasty-year {
                font-size: 0.75rem;
            }
            
            .event-controls {
                position: relative;
                z-index: 10;
                margin-bottom: 15px;
            }
            
            .event-nav-buttons {
                padding: 8px 15px;
                position: relative;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 30px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }
            
            .event-nav-btn {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
            
            .event-counter {
                font-size: 0.9rem;
                min-width: 60px;
            }
            
            .timeline-controls {
                display: none; /* Hide timeline controls on mobile */
            }
            
            .event-cards-wrapper {
                overflow: hidden;
                width: 100%;
                padding: 0;
                box-sizing: border-box;
                border-radius: 12px;
            }
            
            .event-cards {
                width: 100% !important;
                display: flex !important;
                transition: transform 0.5s ease;
            }
            
            .event-card {
                width: 100% !important;
                max-width: 100% !important;
                flex: 0 0 100% !important;
                margin: 0;
                box-sizing: border-box;
                border-radius: 12px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            
            .event-image-container {
                max-width: 100%;
                width: 100%;
            }
            
            /* Ensure content text doesn't overflow */
            .event-title, .event-description {
                width: 100%;
                overflow-wrap: break-word;
                word-wrap: break-word;
                hyphens: auto;
            }
            
            .events-carousel {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
        }

        @media screen and (max-width: 480px) {
            .dynasty-container {
                padding: 0.8rem;
            }
            
            .timeline-container {
                padding: 10px 5px;
            }
            
            .dynasty-marker {
                margin: 0 8px;
            }
            
            .dynasty-label {
                font-size: 0.8rem;
                padding: 5px 8px;
            }
            
            .event-nav-buttons {
                padding: 5px 10px;
                gap: 15px;
            }
            
            .event-nav-btn {
                width: 36px;
                height: 36px;
            }
            
            .event-card {
                padding: 1rem;
                border-radius: 10px;
            }
            
            .event-title {
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
            }
            
            .event-description {
                font-size: 0.9rem;
                line-height: 1.5;
            }
        }

        /* Ensure timeline line connects all dots */
        .vertical-timeline {
            position: relative;
            padding: 0;
            margin: 20px 0;
        }

        .timeline-line {
            position: absolute;
            left: 42px;
            top: 10px;
            bottom: 10px;
            width: 4px;
            background: linear-gradient(180deg, #4361ee, #7209b7);
        }

        /* Tablet Responsive Styles */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .dynasty-container {
                gap: 1rem;
                padding: 1rem;
            }

            .timeline-container {
                flex: 0 0 250px;
            }

            .event-cards {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        /* Small height screens */
        @media screen and (max-height: 700px) {
            .subject-hero {
                padding: 0.5rem 0;
            }

            .subject-hero-content {
                padding: 0.5rem 0;
            }

            .dynasty-poem {
                margin: 0.3rem auto;
            }

            .dynasty-poem p {
                margin: 0.1rem 0;
            }
        }

        /* Add styles for event images */
        .event-image-container {
            width: 100%;
            margin-bottom: 1rem;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            padding-top: 56.25%; /* 16:9 aspect ratio */
            background-color: #f0f2f5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .event-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease, opacity 0.5s ease;
            opacity: 0;
        }
        
        .event-image.loaded {
            opacity: 1;
            transform: scale(1);
        }
        
        .event-image:hover {
            transform: scale(1.05);
        }
        
        .image-loading-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            font-size: 0.9rem;
            z-index: 1;
            background-color: #f7f8fa;
        }
        
        .image-loading-placeholder i {
            margin-right: 8px;
            animation: spin 1.5s linear infinite;
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Enhanced event card layout */
        @media (min-width: 769px) {
            .event-cards {
                display: flex;
            }
            
            .event-card {
                flex: 0 0 100%;
                width: 100%;
                max-width: 100%;
                margin: 0;
                box-sizing: border-box;
            }
        }
        
        @media (max-width: 992px) {
            .dynasty-container {
                flex-direction: column;
                padding: 1rem;
            }
            
            .timeline-container {
                flex: 0 0 auto;
                height: auto;
                max-height: 300px;
                width: 100%;
                margin-bottom: 1.5rem;
            }
            
            .vertical-timeline {
                padding: 10px 0;
            }
            
            .timeline-line {
                left: 50px; /* Keep it aligned with the desktop view */
            }
        }
        
        @media (max-width: 768px) {
            .event-cards-wrapper {
                width: 100%;
                padding: 0;
                box-sizing: border-box;
                overflow: hidden;
            }
            
            .event-cards {
                display: flex;
                width: 100%;
                transition: transform 0.5s ease;
            }
            
            .event-card {
                flex: 0 0 100%;
                width: 100%;
                max-width: 100%;
                margin: 0;
                box-sizing: border-box;
            }
            
            .event-image-container {
                padding-top: 52%; /* Slightly lower aspect ratio on mobile */
            }
        }
        
        @media (max-width: 480px) {
            .dynasty-container {
                padding: 0.8rem;
            }
            
            .timeline-container {
                padding: 15px;
                max-height: 250px;
            }
            
            .event-card {
                padding: 1rem;
            }
            
            .event-title {
                font-size: 1.1em;
            }
            
            .event-description {
                font-size: 0.95em;
            }
        }

        /* Add styles for the no-image placeholder */
        .no-image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            height: 100%;
            color: #a0aec0;
            font-size: 1rem;
            background-color: #f7f9fc;
            border-radius: 8px;
        }
        
        .no-image-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }
        
        /* Make image containers not take up space when empty */
        .event-image-container:empty {
            display: none;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../../index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span>Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="../../index.html#subjects">科目</a></li>
                        <li><a href="../../tts.html">语音</a></li>
                        <li><a href="../../draw.html">绘图</a></li>
                    </ul>
                </nav>
                <div class="profile-section">
                    <button id="profile-button" class="profile-button">
                        <i class="fas fa-user-circle"></i>
                        学习阶段
                    </button>
                    <div id="profile-display" class="profile-display"></div>
                </div>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <section class="subject-hero">
            <div class="container">
                <div class="subject-hero-content">
                    <h1>中国<span class="gradient-text">历朝历代</span></h1>
                    <div class="dynasty-poem">
                        <p>三皇五帝始，尧舜禹相传。夏商与西周，东周分两段。</p>
                        <p>春秋与战国，秦汉一统天。三国魏蜀吴，两晋前后延。</p>
                        <p>南北朝并立，隋唐五代传。宋元明清后，王朝至此完。</p>
                    </div>
                </div>
            </div>
        </section>

        <div class="dynasty-container">
            <div class="timeline-container">
                <div class="vertical-timeline">
                    <div class="timeline-line"></div>
                    <!-- Dynasty markers will be dynamically added here -->
                </div>
                <div class="timeline-controls">
                    <button class="timeline-nav-btn" id="timeline-prev"><i class="fas fa-chevron-left"></i></button>
                    <button class="timeline-nav-btn" id="timeline-next"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <div class="events-container">
                <div class="event-display">
                    <div class="events-carousel">
                        <div class="event-controls">
                            <div class="event-nav-buttons">
                                <button class="event-nav-btn" id="prev-event"><i class="fas fa-chevron-left"></i></button>
                                <div class="event-counter" id="event-counter">1 / 1</div>
                                <button class="event-nav-btn" id="next-event"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="event-cards-wrapper">
                            <div class="event-cards">
                                <!-- Event cards will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Alex的学习助手。保留所有权利。</p>
            </div>
        </div>
    </footer>

    <script src="../../js/common.js"></script>
    <script src="../../js/navigation.js"></script>
    <script src="../../js/profile.js"></script>
    <script>
        // Dynasty data with proper names matching the database Dynasty column
        const dynasties = [
            { name: '夏朝', period: '前2070-前1600' },
            { name: '商朝', period: '前1600-前1046' },
            { name: '西周', period: '前1046-前771' },
            { name: '东周', period: '前770-前256' },
            { name: '春秋', period: '前770-前476' },
            { name: '战国', period: '前475-前221' },
            { name: '秦朝', period: '前221-前207' },
            { name: '西汉', period: '前202-8' },
            { name: '新莽', period: '9-23' },
            { name: '东汉', period: '25-220' },
            { name: '三国', period: '220-280' },
            { name: '西晋', period: '265-317' },
            { name: '东晋', period: '317-420' },
            { name: '南北朝', period: '420-589' },
            { name: '隋朝', period: '581-618' },
            { name: '唐朝', period: '618-907' },
            { name: '五代十国', period: '907-960' },
            { name: '北宋', period: '960-1127' },
            { name: '南宋', period: '1127-1279' },
            { name: '辽、西夏、金', period: '907-1234' },
            { name: '元朝', period: '1271-1368' },
            { name: '明朝', period: '1368-1644' },
            { name: '清朝', period: '1644-1911' }
        ];

        // Global variables for navigation
        let currentDynastyIndex = 0;
        let currentEventIndex = 0;
        let totalEvents = 0;

        // Initialize timeline
        function initTimeline() {
            const timeline = document.querySelector('.vertical-timeline');
            
            dynasties.forEach((dynasty, index) => {
                const marker = document.createElement('div');
                marker.className = 'dynasty-marker';
                marker.setAttribute('data-dynasty', dynasty.name);
                marker.setAttribute('data-index', index);
                
                const label = document.createElement('div');
                label.className = 'dynasty-label';
                label.innerHTML = `
                    ${dynasty.name}
                    <span class="dynasty-year">${dynasty.period}</span>
                `;
                
                marker.appendChild(label);
                timeline.appendChild(marker);

                // Add click event
                marker.addEventListener('click', () => {
                    // Update the current dynasty index
                    currentDynastyIndex = index;
                    
                    // Remove active class from all markers
                    document.querySelectorAll('.dynasty-marker').forEach(m => m.classList.remove('active'));
                    // Add active class to clicked marker
                    marker.classList.add('active');
                    // Load events for the dynasty
                    loadDynastyEvents(dynasty.name);
                });
            });
            
            // Set first dynasty as active
            document.querySelector('.dynasty-marker').classList.add('active');
            
            // Add event listeners for timeline navigation
            document.getElementById('timeline-prev').addEventListener('click', scrollTimelinePrev);
            document.getElementById('timeline-next').addEventListener('click', scrollTimelineNext);
        }
        
        // Timeline navigation functions
        function scrollTimelinePrev() {
            const timeline = document.querySelector('.timeline-container');
            timeline.scrollBy({ left: -200, behavior: 'smooth' });
        }
        
        function scrollTimelineNext() {
            const timeline = document.querySelector('.timeline-container');
            timeline.scrollBy({ left: 200, behavior: 'smooth' });
        }
        
        // Event navigation functions
        function showPreviousEvent() {
            if (currentEventIndex > 0) {
                // Add transition class
                document.querySelector('.event-cards').classList.add('transitioning');
                
                // Update index
                currentEventIndex--;
                
                // Update display
                updateEventDisplay();
                
                // Remove transition class after animation completes
                setTimeout(() => {
                    document.querySelector('.event-cards').classList.remove('transitioning');
                }, 500);
            }
        }
        
        function showNextEvent() {
            if (currentEventIndex < totalEvents - 1) {
                // Add transition class
                document.querySelector('.event-cards').classList.add('transitioning');
                
                // Update index
                currentEventIndex++;
                
                // Update display
                updateEventDisplay();
                
                // Remove transition class after animation completes
                setTimeout(() => {
                    document.querySelector('.event-cards').classList.remove('transitioning');
                }, 500);
            }
        }
        
        function updateEventDisplay() {
            const eventsContainer = document.querySelector('.event-cards');
            const eventWidth = document.querySelector('.event-cards-wrapper').offsetWidth;
            
            // Handle case when no events are loaded yet
            if (eventWidth === 0) return;
            
            const translateValue = -currentEventIndex * eventWidth;
            eventsContainer.style.transform = `translateX(${translateValue}px)`;
            
            // Update active class
            document.querySelectorAll('.event-card').forEach((card, index) => {
                if (index === currentEventIndex) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            
            // Update event counter
            updateEventCounter();
            
            // Scroll to top of events container on mobile
            if (window.innerWidth <= 768) {
                const eventsWrapper = document.querySelector('.events-carousel');
                if (eventsWrapper) {
                    eventsWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }
        
        function updateEventCounter() {
            const counter = document.getElementById('event-counter');
            counter.textContent = `${currentEventIndex + 1} / ${totalEvents}`;
        }

        // Improved function to create image paths with better debugging
        function createImagePath(title, dynasty) {
            if (!title) return null;
            
            const sanitizedTitle = title
                .replace(/[^\w\s\u4e00-\u9fa5]/g, '') // Remove special characters, keep Chinese characters
                .replace(/\s+/g, '_'); // Replace spaces with underscores
            
            // Check for empty sanitized title
            if (!sanitizedTitle) return null;
            
            // Primary path for the specific event
            const specificPath = `../../assets/images/history/chinese/${sanitizedTitle}.jpg`;
            
            // Also create a backup dynasty-based path for fallback
            let dynastyPath = null;
            if (dynasty) {
                const sanitizedDynasty = dynasty.trim()
                    .replace(/[^\w\s\u4e00-\u9fa5]/g, '')
                    .replace(/\s+/g, '_');
                if (sanitizedDynasty) {
                    dynastyPath = `../../assets/images/history/chinese/dynasty_${sanitizedDynasty}.jpg`;
                }
            }
            
            return {
                specific: specificPath,
                dynasty: dynastyPath,
                default: '../../assets/images/history/chinese/default_history.jpg'
            };
        }

        // Handle image loading with fallbacks
        function handleImageLoad(image, loadingPlaceholder) {
            if (!image || !loadingPlaceholder) return;
            
            // Show loading placeholder
            loadingPlaceholder.innerHTML = `
                <i class="fas fa-spinner fa-spin"></i>
                <span style="margin-left: 8px;">加载图片中...</span>
            `;
            
            // Success handler - image loaded successfully
            image.addEventListener('load', function() {
                this.classList.add('loaded');
                loadingPlaceholder.style.display = 'none';
                // Small delay for smoother transition
                setTimeout(() => {
                    image.style.opacity = '1';
                }, 50);
            });
            
            // Error handler with fallback chain
            image.addEventListener('error', function() {
                const currentSrc = this.src;
                
                // Try different file extensions if current path ends with .jpg
                if (currentSrc.endsWith('.jpg')) {
                    // Try with PNG extension
                    this.src = currentSrc.replace('.jpg', '.png');
                    return;
                }
                
                // If we tried PNG and it failed, try dynasty-specific image
                const dynastySrc = this.getAttribute('data-dynasty-src');
                if (dynastySrc && this.src !== dynastySrc) {
                    this.src = dynastySrc;
                    return;
                }
                
                // If dynasty image fails, try default image
                const defaultSrc = this.getAttribute('data-default-src');
                if (defaultSrc && this.src !== defaultSrc) {
                    this.src = defaultSrc;
                    return;
                }
                
                // If all fails, show no-image placeholder
                createNoImagePlaceholder(loadingPlaceholder);
                // Hide only the broken image
                this.style.display = 'none';
            });
        }

        // Load events for a dynasty
        async function loadDynastyEvents(dynasty) {
            const eventsContainer = document.querySelector('.event-cards');
            eventsContainer.innerHTML = '<div class="loading">加载历史事件中...</div>';

            try {
                // Properly encode the SQL query
                const encodedDynasty = encodeURIComponent(dynasty.trim());
                const sql = `SELECT * FROM chinese_dynasty WHERE Dynasty LIKE '%${encodedDynasty}%'`;
                const params = new URLSearchParams({
                    sql: sql
                });
                
                const requestUrl = `/api/db/query/chinese_dynasty?${params}`;

                const response = await fetch(requestUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch events');
                }

                const data = await response.json();

                // Handle different response formats
                let events = [];
                if (Array.isArray(data)) {
                    events = data;
                } else if (data && typeof data === 'object' && data.success) {
                    events = data.data || [];
                    
                    // Filter events to match the dynasty (more lenient matching)
                    events = events.filter(event => {
                        const eventDynasty = (event.Dynasty || '').trim();
                        const targetDynasty = dynasty.trim();
                        
                        // Try different matching strategies
                        return eventDynasty === targetDynasty || 
                               eventDynasty.includes(targetDynasty) || 
                               targetDynasty.includes(eventDynasty);
                    });
                }

                if (events.length === 0) {
                    eventsContainer.innerHTML = `
                        <div class="error">
                            <p>未找到${dynasty}的历史事件</p>
                        </div>`;
                    // Reset event counter
                    document.getElementById('event-counter').textContent = '0 / 0';
                    return;
                }

                // Reset event index and update total
                currentEventIndex = 0;
                totalEvents = events.length;
                
                // Render event cards with images
                eventsContainer.innerHTML = '';
                
                // Set the container width to accommodate all events
                if (events.length > 0) {
                    const wrapper = document.querySelector('.event-cards-wrapper');
                    const wrapperWidth = wrapper.offsetWidth;
                    eventsContainer.style.width = `${events.length * wrapperWidth}px`;
                }
                
                events.forEach((event, index) => {
                    const eventTitle = event.Title ? event.Title.trim() : '未知事件';
                    const eventDescription = event.Event ? event.Event.trim() : '暂无描述';
                    const eventDynasty = event.Dynasty ? event.Dynasty.trim() : dynasty;
                    
                    // Get image paths using helper function
                    const imagePaths = createImagePath(eventTitle, eventDynasty);
                    
                    // Create event card element
                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card';
                    if (index === 0) {
                        eventCard.classList.add('active');
                    }
                    
                    // Create event content with image
                    const imageHtml = `
                        <div class="event-image-container">
                            <div class="image-loading-placeholder">
                                <i class="fas fa-spinner"></i> 加载图片中...
                            </div>
                            <img src="${imagePaths.specific}" alt="${eventTitle}" class="event-image" data-dynasty-src="${imagePaths.dynasty}" data-default-src="${imagePaths.default}">
                        </div>
                    `;
                    
                    eventCard.innerHTML = `
                        ${imageHtml}
                        <h3 class="event-title">${eventTitle}</h3>
                        <p class="event-description">${eventDescription}</p>
                    `;
                    
                    eventsContainer.appendChild(eventCard);
                    
                    // Handle image loading with our new function
                    const image = eventCard.querySelector('.event-image');
                    const loadingPlaceholder = eventCard.querySelector('.image-loading-placeholder');
                    handleImageLoad(image, loadingPlaceholder);
                });
                
                // Update the event counter
                updateEventCounter();
                updateEventDisplay();
                
            } catch (error) {
                eventsContainer.innerHTML = `
                    <div class="error">
                        <p>加载历史事件时出错，请稍后重试</p>
                        <p class="small">${error.message}</p>
                        <p class="small">Dynasty: ${dynasty}</p>
                        <button onclick="loadDynastyEvents('${dynasty}')" class="btn btn-primary mt-3">重试</button>
                    </div>
                `;
                // Reset event counter
                document.getElementById('event-counter').textContent = '0 / 0';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Add style rule for transitions
            addStyleRule();
            
            // Check for default images first
            await ensureDefaultImages();
            
            // Initialize the timeline
            initTimeline();
            
            // Load events for the first dynasty by default
            loadDynastyEvents(dynasties[0].name);
            
            // Add event listeners for navigation buttons
            document.getElementById('prev-event').addEventListener('click', showPreviousEvent);
            document.getElementById('next-event').addEventListener('click', showNextEvent);
            
            // Add keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') {
                    showPreviousEvent();
                } else if (e.key === 'ArrowRight') {
                    showNextEvent();
                }
            });
            
            // Add resize handler
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    // Recalculate event cards container width
                    const wrapper = document.querySelector('.event-cards-wrapper');
                    const events = document.querySelectorAll('.event-card');
                    if (wrapper && events.length > 0) {
                        const wrapperWidth = wrapper.offsetWidth;
                        const eventsContainer = document.querySelector('.event-cards');
                        eventsContainer.style.width = `${events.length * wrapperWidth}px`;
                    }
                    
                    // Update the display
                    updateEventDisplay();
                }, 250);
            });
        });

        // Function to check if an image exists without actually loading it
        async function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // Helper function to create a placeholder for missing images
        function createNoImagePlaceholder(loadingPlaceholder) {
            if (!loadingPlaceholder) return;
            
            loadingPlaceholder.classList.remove('image-loading-placeholder');
            loadingPlaceholder.classList.add('no-image-placeholder');
            loadingPlaceholder.innerHTML = `
                <i class="fas fa-image"></i>
                <span>暂无图片</span>
            `;
        }

        // Create a default image for dynasty pages if it doesn't exist
        async function ensureDefaultImages() {
            const defaultImagePath = '../../assets/images/history/chinese/default_history.jpg';
            const exists = await checkImageExists(defaultImagePath);
            
            // If the default image doesn't exist, we'll handle it in the error cases
            console.log('Default image check:', exists ? 'Found' : 'Not found');
        }

        // Add CSS rule for transitioning class
        function addStyleRule() {
            const style = document.createElement('style');
            style.textContent = `
                .event-cards.transitioning {
                    transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>