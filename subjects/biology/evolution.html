<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>进化论 - 生物学习助手</title>
    <link rel="icon" href="../../assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/utilities.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .evolution-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .evolution-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 2rem auto;
            max-width: 1600px;
        }

        .evolution-header {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .evolution-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .evolution-header p {
            margin: 1rem 0 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .evolution-tabs {
            background: #f8f9fa;
            padding: 0;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            overflow-x: auto;
        }

        .evolution-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .evolution-tab.active {
            color: #4caf50;
            border-bottom-color: #4caf50;
            background: white;
        }

        .evolution-tab:hover {
            color: #4caf50;
            background: #f0f8ff;
        }

        .evolution-content {
            padding: 2rem;
            min-height: 600px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .timeline-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            position: relative;
            overflow-x: auto;
        }

        .timeline {
            position: relative;
            height: 400px;
            background: linear-gradient(to right, #e8f5e8, #f0f8f0);
            border-radius: 10px;
            padding: 2rem;
        }

        .timeline-line {
            position: absolute;
            top: 50%;
            left: 50px;
            right: 50px;
            height: 4px;
            background: #4caf50;
            transform: translateY(-50%);
        }

        .timeline-event {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 3px solid #4caf50;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .timeline-label {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #4caf50;
            color: white;
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .timeline-description {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 200px;
            font-size: 0.9rem;
            display: none;
        }

        .timeline-event:hover .timeline-description {
            display: block;
        }

        .selection-simulator {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
        }

        .simulation-canvas {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
            height: 400px;
            position: relative;
        }

        .simulation-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .control-group {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }

        .control-group h4 {
            margin: 0 0 1rem 0;
            color: #4caf50;
        }

        .control-slider {
            width: 100%;
            margin: 0.5rem 0;
        }

        .control-value {
            text-align: center;
            font-weight: bold;
            color: #4caf50;
        }

        .phylogenetic-tree {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
        }

        .tree-canvas {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
            height: 500px;
            position: relative;
        }

        .species-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .species-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid #e9ecef;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .species-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.15);
        }

        .species-card.selected {
            border-color: #4caf50;
            background: #e8f5e8;
        }

        .species-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .species-name {
            font-size: 0.9rem;
            color: #666;
        }

        .adaptation-examples {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
        }

        .adaptation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .adaptation-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .adaptation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(76, 175, 80, 0.15);
        }

        .adaptation-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .adaptation-icon {
            font-size: 2rem;
            color: #4caf50;
        }

        .adaptation-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .adaptation-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .adaptation-example {
            background: #f0f8ff;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }

        .action-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        @media (max-width: 768px) {
            .evolution-tabs {
                flex-direction: column;
            }
            
            .evolution-tab {
                text-align: center;
            }
            
            .simulation-controls {
                grid-template-columns: 1fr;
            }
            
            .adaptation-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../../index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span>Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="main.html">生物</a></li>
                        <li><a href="../../index.html#subjects">科目</a></li>
                        <li><a href="../../tts.html">语音</a></li>
                        <li><a href="../../draw.html">绘图</a></li>
                    </ul>
                </nav>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="evolution-page">
        <div class="container">
            <div class="evolution-container">
                <div class="evolution-header">
                    <h1><i class="fas fa-dna"></i> 进化论</h1>
                    <p>探索生命的演化历程和自然选择机制</p>
                </div>

                <div class="evolution-tabs">
                    <button class="evolution-tab active" data-tab="timeline">进化时间线</button>
                    <button class="evolution-tab" data-tab="selection">自然选择</button>
                    <button class="evolution-tab" data-tab="phylogeny">系统发育</button>
                    <button class="evolution-tab" data-tab="adaptations">适应性进化</button>
                </div>

                <div class="evolution-content">
                    <!-- 进化时间线标签页 -->
                    <div class="tab-panel active" id="timeline-panel">
                        <h2>生命进化时间线</h2>
                        <div class="timeline-container">
                            <div class="timeline">
                                <div class="timeline-line"></div>
                                
                                <div class="timeline-event" style="left: 10%;">
                                    <div class="timeline-label">38亿年前</div>
                                    <div class="timeline-description">
                                        <strong>生命起源</strong><br>
                                        最早的原核生物出现，标志着地球生命的开始
                                    </div>
                                </div>
                                
                                <div class="timeline-event" style="left: 25%;">
                                    <div class="timeline-label">20亿年前</div>
                                    <div class="timeline-description">
                                        <strong>真核细胞</strong><br>
                                        具有细胞核的真核细胞出现，生命复杂性大幅提升
                                    </div>
                                </div>
                                
                                <div class="timeline-event" style="left: 40%;">
                                    <div class="timeline-label">5.4亿年前</div>
                                    <div class="timeline-description">
                                        <strong>寒武纪大爆发</strong><br>
                                        多细胞生物大量出现，生物多样性急剧增加
                                    </div>
                                </div>
                                
                                <div class="timeline-event" style="left: 55%;">
                                    <div class="timeline-label">4亿年前</div>
                                    <div class="timeline-description">
                                        <strong>植物登陆</strong><br>
                                        植物开始在陆地上生长，改变了地球环境
                                    </div>
                                </div>
                                
                                <div class="timeline-event" style="left: 70%;">
                                    <div class="timeline-label">2.3亿年前</div>
                                    <div class="timeline-description">
                                        <strong>恐龙时代</strong><br>
                                        恐龙成为地球上的主导生物群体
                                    </div>
                                </div>
                                
                                <div class="timeline-event" style="left: 85%;">
                                    <div class="timeline-label">700万年前</div>
                                    <div class="timeline-description">
                                        <strong>人类祖先</strong><br>
                                        人类和黑猩猩的共同祖先分化
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 自然选择标签页 -->
                    <div class="tab-panel" id="selection-panel">
                        <h2>自然选择模拟器</h2>
                        <div class="selection-simulator">
                            <div class="simulation-canvas">
                                <canvas id="selection-canvas" width="600" height="350"></canvas>
                            </div>
                            
                            <div class="simulation-controls">
                                <div class="control-group">
                                    <h4>环境压力</h4>
                                    <label>捕食压力</label>
                                    <input type="range" class="control-slider" id="predation-pressure" min="0" max="100" value="50">
                                    <div class="control-value" id="predation-value">50%</div>
                                </div>
                                
                                <div class="control-group">
                                    <h4>突变率</h4>
                                    <label>基因突变</label>
                                    <input type="range" class="control-slider" id="mutation-rate" min="0" max="10" value="2">
                                    <div class="control-value" id="mutation-value">2%</div>
                                </div>
                                
                                <div class="control-group">
                                    <h4>种群大小</h4>
                                    <label>个体数量</label>
                                    <input type="range" class="control-slider" id="population-size" min="50" max="500" value="200">
                                    <div class="control-value" id="population-value">200</div>
                                </div>
                                
                                <div class="control-group">
                                    <h4>选择强度</h4>
                                    <label>适应性差异</label>
                                    <input type="range" class="control-slider" id="selection-strength" min="0" max="100" value="30">
                                    <div class="control-value" id="selection-value">30%</div>
                                </div>
                            </div>

                            <div style="text-align: center;">
                                <button class="action-btn" id="start-evolution">开始进化模拟</button>
                                <button class="action-btn secondary" id="reset-evolution">重置模拟</button>
                            </div>
                        </div>
                    </div>

                    <!-- 系统发育标签页 -->
                    <div class="tab-panel" id="phylogeny-panel">
                        <h2>系统发育树</h2>
                        <div class="phylogenetic-tree">
                            <div class="tree-canvas">
                                <canvas id="phylogeny-canvas" width="600" height="450"></canvas>
                            </div>
                            
                            <div class="species-selector">
                                <div class="species-card selected" data-species="human">
                                    <div class="species-icon">🧑</div>
                                    <div class="species-name">人类</div>
                                </div>
                                <div class="species-card selected" data-species="chimp">
                                    <div class="species-icon">🐵</div>
                                    <div class="species-name">黑猩猩</div>
                                </div>
                                <div class="species-card selected" data-species="dog">
                                    <div class="species-icon">🐕</div>
                                    <div class="species-name">狗</div>
                                </div>
                                <div class="species-card selected" data-species="cat">
                                    <div class="species-icon">🐱</div>
                                    <div class="species-name">猫</div>
                                </div>
                                <div class="species-card selected" data-species="mouse">
                                    <div class="species-icon">🐭</div>
                                    <div class="species-name">小鼠</div>
                                </div>
                                <div class="species-card selected" data-species="bird">
                                    <div class="species-icon">🐦</div>
                                    <div class="species-name">鸟类</div>
                                </div>
                            </div>

                            <div style="text-align: center;">
                                <button class="action-btn" id="build-tree">构建系统发育树</button>
                                <button class="action-btn secondary" id="clear-tree">清空选择</button>
                            </div>
                        </div>
                    </div>

                    <!-- 适应性进化标签页 -->
                    <div class="tab-panel" id="adaptations-panel">
                        <h2>适应性进化实例</h2>
                        <div class="adaptation-examples">
                            <div class="adaptation-grid">
                                <div class="adaptation-card">
                                    <div class="adaptation-header">
                                        <div class="adaptation-icon">🦒</div>
                                        <div class="adaptation-title">长颈鹿的长脖子</div>
                                    </div>
                                    <div class="adaptation-description">
                                        长颈鹿的长脖子是为了适应高处取食的环境压力而进化出的特征。
                                    </div>
                                    <div class="adaptation-example">
                                        <strong>适应机制:</strong> 颈椎延长，血管系统特化，能够取食高处的树叶，减少竞争。
                                    </div>
                                </div>
                                
                                <div class="adaptation-card">
                                    <div class="adaptation-header">
                                        <div class="adaptation-icon">🐧</div>
                                        <div class="adaptation-title">企鹅的游泳适应</div>
                                    </div>
                                    <div class="adaptation-description">
                                        企鹅失去飞行能力，但获得了卓越的游泳和潜水能力。
                                    </div>
                                    <div class="adaptation-example">
                                        <strong>适应机制:</strong> 翅膀变成鳍状，骨骼密度增加，羽毛防水，适应海洋生活。
                                    </div>
                                </div>
                                
                                <div class="adaptation-card">
                                    <div class="adaptation-header">
                                        <div class="adaptation-icon">🌵</div>
                                        <div class="adaptation-title">仙人掌的抗旱性</div>
                                    </div>
                                    <div class="adaptation-description">
                                        仙人掌进化出多种抗旱特征，适应干旱的沙漠环境。
                                    </div>
                                    <div class="adaptation-example">
                                        <strong>适应机制:</strong> 叶片变成刺，茎部储水，表面蜡质层减少水分蒸发。
                                    </div>
                                </div>
                                
                                <div class="adaptation-card">
                                    <div class="adaptation-header">
                                        <div class="adaptation-icon">🦇</div>
                                        <div class="adaptation-title">蝙蝠的回声定位</div>
                                    </div>
                                    <div class="adaptation-description">
                                        蝙蝠进化出回声定位系统，在黑暗中精确导航和捕食。
                                    </div>
                                    <div class="adaptation-example">
                                        <strong>适应机制:</strong> 发声器官特化，听觉系统敏感，大脑处理声波信息。
                                    </div>
                                </div>
                                
                                <div class="adaptation-card">
                                    <div class="adaptation-header">
                                        <div class="adaptation-icon">🐟</div>
                                        <div class="adaptation-title">深海鱼的发光器官</div>
                                    </div>
                                    <div class="adaptation-description">
                                        深海鱼类进化出生物发光器官，适应黑暗的深海环境。
                                    </div>
                                    <div class="adaptation-example">
                                        <strong>适应机制:</strong> 发光细菌共生，化学发光反应，用于通讯和捕食。
                                    </div>
                                </div>
                                
                                <div class="adaptation-card">
                                    <div class="adaptation-header">
                                        <div class="adaptation-icon">🦋</div>
                                        <div class="adaptation-title">蝴蝶的拟态</div>
                                    </div>
                                    <div class="adaptation-description">
                                        某些蝴蝶进化出拟态特征，模仿有毒物种以避免被捕食。
                                    </div>
                                    <div class="adaptation-example">
                                        <strong>适应机制:</strong> 翅膀颜色和图案模仿，行为模仿，贝氏拟态和缪氏拟态。
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <p class="copyright-text">study-llm.me域名为Alex所有。保留所有权利。</p>
            </div>
        </div>
    </footer>

    <script src="../../js/common.js"></script>
    <script src="../../js/navigation.js"></script>
    <script>
        // 进化论功能
        class Evolution {
            constructor() {
                this.selectionCanvas = document.getElementById('selection-canvas');
                this.selectionCtx = this.selectionCanvas.getContext('2d');
                this.phylogenyCanvas = document.getElementById('phylogeny-canvas');
                this.phylogenyCtx = this.phylogenyCanvas.getContext('2d');
                
                this.isSimulating = false;
                this.generation = 0;
                this.population = [];
                this.selectedSpecies = ['human', 'chimp', 'dog', 'cat', 'mouse', 'bird'];
                
                this.initializeEventListeners();
                this.initializePopulation();
                this.drawPhylogeneticTree();
            }

            initializeEventListeners() {
                // 标签页切换
                document.querySelectorAll('.evolution-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // 滑块控制
                ['predation-pressure', 'mutation-rate', 'population-size', 'selection-strength'].forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        this.updateSliderValue(id, e.target.value);
                    });
                });

                // 进化模拟控制
                document.getElementById('start-evolution').addEventListener('click', () => {
                    this.startEvolutionSimulation();
                });

                document.getElementById('reset-evolution').addEventListener('click', () => {
                    this.resetEvolution();
                });

                // 物种选择
                document.querySelectorAll('.species-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        this.toggleSpecies(e.target.closest('.species-card'));
                    });
                });

                // 系统发育树控制
                document.getElementById('build-tree').addEventListener('click', () => {
                    this.buildPhylogeneticTree();
                });

                document.getElementById('clear-tree').addEventListener('click', () => {
                    this.clearSpeciesSelection();
                });
            }

            switchTab(tabName) {
                // 更新标签页状态
                document.querySelectorAll('.evolution-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // 显示对应面板
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById(`${tabName}-panel`).classList.add('active');
            }

            updateSliderValue(sliderId, value) {
                const valueId = sliderId.replace('-', '-') + '-value';
                const suffix = sliderId.includes('size') ? '' : '%';
                document.getElementById(valueId).textContent = value + suffix;
            }

            initializePopulation() {
                this.population = [];
                const size = parseInt(document.getElementById('population-size').value);
                
                for (let i = 0; i < size; i++) {
                    this.population.push({
                        x: Math.random() * 500,
                        y: Math.random() * 300,
                        color: this.randomColor(),
                        size: 3 + Math.random() * 4,
                        fitness: Math.random(),
                        speed: 1 + Math.random() * 2
                    });
                }
                
                this.generation = 0;
                this.drawPopulation();
            }

            randomColor() {
                const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            drawPopulation() {
                this.selectionCtx.clearRect(0, 0, this.selectionCanvas.width, this.selectionCanvas.height);
                
                // 绘制背景
                this.selectionCtx.fillStyle = '#f0f8f0';
                this.selectionCtx.fillRect(0, 0, this.selectionCanvas.width, this.selectionCanvas.height);
                
                // 绘制个体
                this.population.forEach(individual => {
                    this.selectionCtx.fillStyle = individual.color;
                    this.selectionCtx.beginPath();
                    this.selectionCtx.arc(individual.x, individual.y, individual.size, 0, 2 * Math.PI);
                    this.selectionCtx.fill();
                });
                
                // 显示统计信息
                this.selectionCtx.fillStyle = '#333';
                this.selectionCtx.font = '16px Arial';
                this.selectionCtx.fillText(`第 ${this.generation} 代`, 10, 25);
                this.selectionCtx.fillText(`种群大小: ${this.population.length}`, 10, 45);
                
                const avgFitness = this.population.reduce((sum, ind) => sum + ind.fitness, 0) / this.population.length;
                this.selectionCtx.fillText(`平均适应度: ${avgFitness.toFixed(2)}`, 10, 65);
            }

            startEvolutionSimulation() {
                if (this.isSimulating) return;
                
                this.isSimulating = true;
                
                const evolve = () => {
                    if (!this.isSimulating) return;
                    
                    this.runSelection();
                    this.reproduce();
                    this.mutate();
                    this.generation++;
                    this.drawPopulation();
                    
                    setTimeout(evolve, 500);
                };
                
                evolve();
            }

            runSelection() {
                const predationPressure = parseInt(document.getElementById('predation-pressure').value) / 100;
                const selectionStrength = parseInt(document.getElementById('selection-strength').value) / 100;
                
                // 计算适应度
                this.population.forEach(individual => {
                    // 基于颜色、大小等特征计算适应度
                    let fitness = individual.fitness;
                    
                    // 环境压力影响
                    if (predationPressure > 0.5) {
                        // 高捕食压力下，较小的个体更容易生存
                        fitness *= (1 - (individual.size - 3) / 4 * selectionStrength);
                    } else {
                        // 低捕食压力下，较大的个体竞争优势更大
                        fitness *= (1 + (individual.size - 3) / 4 * selectionStrength);
                    }
                    
                    individual.fitness = Math.max(0.1, fitness);
                });
                
                // 选择生存者
                this.population.sort((a, b) => b.fitness - a.fitness);
                const survivors = Math.floor(this.population.length * 0.7);
                this.population = this.population.slice(0, survivors);
            }

            reproduce() {
                const targetSize = parseInt(document.getElementById('population-size').value);
                const offspring = [];
                
                while (this.population.length + offspring.length < targetSize) {
                    // 选择父母（适应度越高，被选中概率越大）
                    const parent1 = this.selectParent();
                    const parent2 = this.selectParent();
                    
                    // 产生后代
                    const child = {
                        x: Math.random() * 500,
                        y: Math.random() * 300,
                        color: Math.random() < 0.5 ? parent1.color : parent2.color,
                        size: (parent1.size + parent2.size) / 2 + (Math.random() - 0.5) * 0.5,
                        fitness: (parent1.fitness + parent2.fitness) / 2,
                        speed: (parent1.speed + parent2.speed) / 2
                    };
                    
                    offspring.push(child);
                }
                
                this.population = this.population.concat(offspring);
            }

            selectParent() {
                const totalFitness = this.population.reduce((sum, ind) => sum + ind.fitness, 0);
                let random = Math.random() * totalFitness;
                
                for (let individual of this.population) {
                    random -= individual.fitness;
                    if (random <= 0) {
                        return individual;
                    }
                }
                
                return this.population[this.population.length - 1];
            }

            mutate() {
                const mutationRate = parseInt(document.getElementById('mutation-rate').value) / 100;
                
                this.population.forEach(individual => {
                    if (Math.random() < mutationRate) {
                        // 随机突变
                        if (Math.random() < 0.3) {
                            individual.color = this.randomColor();
                        }
                        if (Math.random() < 0.3) {
                            individual.size += (Math.random() - 0.5) * 1;
                            individual.size = Math.max(1, Math.min(8, individual.size));
                        }
                        if (Math.random() < 0.3) {
                            individual.fitness += (Math.random() - 0.5) * 0.2;
                            individual.fitness = Math.max(0.1, Math.min(1, individual.fitness));
                        }
                    }
                });
            }

            resetEvolution() {
                this.isSimulating = false;
                this.initializePopulation();
            }

            toggleSpecies(card) {
                const species = card.dataset.species;
                
                if (card.classList.contains('selected')) {
                    card.classList.remove('selected');
                    this.selectedSpecies = this.selectedSpecies.filter(s => s !== species);
                } else {
                    card.classList.add('selected');
                    this.selectedSpecies.push(species);
                }
            }

            buildPhylogeneticTree() {
                this.drawPhylogeneticTree();
            }

            drawPhylogeneticTree() {
                this.phylogenyCtx.clearRect(0, 0, this.phylogenyCanvas.width, this.phylogenyCanvas.height);
                
                if (this.selectedSpecies.length === 0) return;
                
                // 物种数据
                const speciesData = {
                    'human': { name: '人类', icon: '🧑', divergence: 7 },
                    'chimp': { name: '黑猩猩', icon: '🐵', divergence: 7 },
                    'dog': { name: '狗', icon: '🐕', divergence: 95 },
                    'cat': { name: '猫', icon: '🐱', divergence: 95 },
                    'mouse': { name: '小鼠', icon: '🐭', divergence: 95 },
                    'bird': { name: '鸟类', icon: '🐦', divergence: 310 }
                };
                
                // 绘制树结构
                const treeHeight = 400;
                const treeWidth = 500;
                const startX = 50;
                const startY = treeHeight - 50;
                
                // 主干
                this.phylogenyCtx.strokeStyle = '#4caf50';
                this.phylogenyCtx.lineWidth = 3;
                this.phylogenyCtx.beginPath();
                this.phylogenyCtx.moveTo(startX, startY);
                this.phylogenyCtx.lineTo(startX, 50);
                this.phylogenyCtx.stroke();
                
                // 绘制分支
                const selectedData = this.selectedSpecies.map(s => ({ species: s, ...speciesData[s] }));
                selectedData.sort((a, b) => a.divergence - b.divergence);
                
                let currentY = startY;
                const branchSpacing = (treeHeight - 100) / selectedData.length;
                
                selectedData.forEach((data, index) => {
                    const branchY = startY - (index + 1) * branchSpacing;
                    const branchX = startX + data.divergence * 1.5;
                    
                    // 水平分支
                    this.phylogenyCtx.beginPath();
                    this.phylogenyCtx.moveTo(startX, branchY);
                    this.phylogenyCtx.lineTo(branchX, branchY);
                    this.phylogenyCtx.stroke();
                    
                    // 物种标签
                    this.phylogenyCtx.fillStyle = '#333';
                    this.phylogenyCtx.font = '16px Arial';
                    this.phylogenyCtx.fillText(data.icon + ' ' + data.name, branchX + 10, branchY + 5);
                    
                    // 时间标签
                    this.phylogenyCtx.fillStyle = '#666';
                    this.phylogenyCtx.font = '12px Arial';
                    this.phylogenyCtx.fillText(data.divergence + '百万年前', branchX + 10, branchY + 20);
                });
                
                // 标题
                this.phylogenyCtx.fillStyle = '#333';
                this.phylogenyCtx.font = '18px Arial';
                this.phylogenyCtx.fillText('系统发育树', 250, 30);
                
                // 时间轴
                this.phylogenyCtx.fillStyle = '#666';
                this.phylogenyCtx.font = '12px Arial';
                this.phylogenyCtx.fillText('时间 (百万年前)', 10, treeHeight - 10);
            }

            clearSpeciesSelection() {
                this.selectedSpecies = [];
                document.querySelectorAll('.species-card').forEach(card => {
                    card.classList.remove('selected');
                });
                this.phylogenyCtx.clearRect(0, 0, this.phylogenyCanvas.width, this.phylogenyCanvas.height);
            }
        }

        // 初始化进化论
        let evolution;
        document.addEventListener('DOMContentLoaded', () => {
            evolution = new Evolution();
        });
    </script>
</body>
</html> 