<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟实验室 - 物理学习助手</title>
    <link rel="icon" href="../../assets/icons/alex.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/utilities.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .lab-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .lab-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 2rem auto;
            max-width: 1400px;
        }

        .lab-header {
            background: linear-gradient(135deg, #4361ee, #7209b7);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .lab-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .lab-header p {
            margin: 1rem 0 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .experiment-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            overflow-x: auto;
        }

        .experiment-tab {
            flex: 1;
            min-width: 150px;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .experiment-tab.active {
            background: white;
            color: #4361ee;
            border-bottom: 3px solid #4361ee;
        }

        .experiment-tab:hover {
            background: rgba(67, 97, 238, 0.1);
            color: #4361ee;
        }

        .lab-content {
            padding: 2rem;
            min-height: 600px;
        }

        .experiment-panel {
            display: none;
        }

        .experiment-panel.active {
            display: block;
        }

        .experiment-workspace {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 2rem;
            height: 600px;
        }

        .experiment-controls, .data-analysis {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .experiment-display {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .experiment-canvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #f8f9fa;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .control-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .control-button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #4361ee, #7209b7);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .coming-soon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #6c757d;
        }

        .coming-soon i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #4361ee;
        }

        @media (max-width: 768px) {
            .experiment-workspace {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .experiment-controls, .data-analysis {
                order: 2;
            }
            
            .experiment-display {
                height: 400px;
                order: 1;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../../index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span>Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="main.html">物理</a></li>
                        <li><a href="../../index.html#subjects">科目</a></li>
                        <li><a href="../../tts.html">语音</a></li>
                        <li><a href="../../draw.html">绘图</a></li>
                    </ul>
                </nav>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="lab-page">
        <div class="container">
            <div class="lab-container">
                <div class="lab-header">
                    <h1><i class="fas fa-flask"></i> 虚拟物理实验室</h1>
                    <p>在安全的虚拟环境中进行物理实验，学习科学方法和数据分析</p>
                </div>

                <div class="experiment-tabs">
                    <button class="experiment-tab active" data-tab="pendulum">
                        <i class="fas fa-clock"></i> 单摆实验
                    </button>
                    <button class="experiment-tab" data-tab="optics">
                        <i class="fas fa-eye"></i> 光学实验
                    </button>
                    <button class="experiment-tab" data-tab="circuits">
                        <i class="fas fa-bolt"></i> 电路实验
                    </button>
                    <button class="experiment-tab" data-tab="mechanics">
                        <i class="fas fa-cogs"></i> 力学实验
                    </button>
                    <button class="experiment-tab" data-tab="thermodynamics">
                        <i class="fas fa-thermometer-half"></i> 热学实验
                    </button>
                </div>

                <div class="lab-content">
                    <!-- 单摆实验 -->
                    <div class="experiment-panel active" id="pendulum-panel">
                        <div class="experiment-workspace">
                            <div class="experiment-controls">
                                <h3><i class="fas fa-clock"></i> 单摆周期测量</h3>
                                
                                <div class="control-group">
                                    <label>摆长 (cm)</label>
                                    <input type="number" class="control-input" id="pendulum-length" value="100" min="20" max="200">
                                </div>

                                <div class="control-group">
                                    <label>摆球质量 (g)</label>
                                    <input type="number" class="control-input" id="pendulum-mass" value="50" min="10" max="200">
                                </div>

                                <div class="control-group">
                                    <label>初始角度 (°)</label>
                                    <input type="number" class="control-input" id="pendulum-angle" value="15" min="5" max="30">
                                </div>

                                <button class="control-button" id="start-pendulum">开始实验</button>
                                <button class="control-button" id="record-data">记录数据</button>
                                <button class="control-button" id="reset-pendulum">重置实验</button>

                                <div class="control-group">
                                    <label>实验说明</label>
                                    <p style="font-size: 0.9rem; color: #666;">
                                        调整摆长和质量，观察对周期的影响。点击"记录数据"保存测量结果。
                                    </p>
                                </div>
                            </div>
                            
                            <div class="experiment-display">
                                <canvas class="experiment-canvas" id="pendulum-canvas" width="600" height="600"></canvas>
                            </div>
                            
                            <div class="data-analysis">
                                <h3><i class="fas fa-chart-line"></i> 数据分析</h3>
                                
                                <div class="control-group">
                                    <label>当前周期: <span id="current-period">--</span> s</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>理论周期: <span id="theoretical-period">--</span> s</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>误差: <span id="period-error">--</span> %</label>
                                </div>

                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>摆长(cm)</th>
                                            <th>周期(s)</th>
                                            <th>T²(s²)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendulum-data">
                                    </tbody>
                                </table>

                                <button class="control-button" id="analyze-pendulum">分析数据</button>
                                <button class="control-button" id="export-data">导出数据</button>
                            </div>
                        </div>
                    </div>

                    <!-- 光学实验 -->
                    <div class="experiment-panel" id="optics-panel">
                        <div class="experiment-workspace">
                            <div class="experiment-controls">
                                <h3><i class="fas fa-eye"></i> 折射率测量</h3>
                                
                                <div class="control-group">
                                    <label>入射角 (°)</label>
                                    <input type="number" class="control-input" id="optics-incident-angle" value="30" min="10" max="80">
                                </div>

                                <div class="control-group">
                                    <label>介质类型</label>
                                    <select class="control-input" id="medium-type">
                                        <option value="glass">玻璃</option>
                                        <option value="water">水</option>
                                        <option value="diamond">钻石</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                </div>

                                <div class="control-group" id="custom-refractive-index" style="display: none;">
                                    <label>折射率</label>
                                    <input type="number" class="control-input" id="custom-n" value="1.5" min="1.0" max="3.0" step="0.1">
                                </div>

                                <button class="control-button" id="start-optics">开始实验</button>
                                <button class="control-button" id="measure-angle">测量角度</button>
                                <button class="control-button" id="reset-optics">重置实验</button>

                                <div class="control-group">
                                    <label>实验说明</label>
                                    <p style="font-size: 0.9rem; color: #666;">
                                        调整入射角，观察折射现象，验证斯涅尔定律。
                                    </p>
                                </div>
                            </div>
                            
                            <div class="experiment-display">
                                <canvas class="experiment-canvas" id="optics-canvas" width="600" height="600"></canvas>
                            </div>
                            
                            <div class="data-analysis">
                                <h3><i class="fas fa-chart-line"></i> 数据分析</h3>
                                
                                <div class="control-group">
                                    <label>入射角: <span id="measured-incident">--</span>°</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>折射角: <span id="measured-refracted">--</span>°</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>计算折射率: <span id="calculated-n">--</span></label>
                                </div>

                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>入射角(°)</th>
                                            <th>折射角(°)</th>
                                            <th>折射率</th>
                                        </tr>
                                    </thead>
                                    <tbody id="optics-data">
                                    </tbody>
                                </table>

                                <button class="control-button" id="analyze-optics">分析数据</button>
                                <button class="control-button" id="export-optics">导出数据</button>
                            </div>
                        </div>
                    </div>

                    <div class="experiment-panel" id="circuits-panel">
                        <div class="experiment-workspace">
                            <div class="experiment-controls">
                                <h3><i class="fas fa-bolt"></i> 欧姆定律验证</h3>
                                
                                <div class="control-group">
                                    <label>电压 (V)</label>
                                    <input type="number" class="control-input" id="circuit-voltage" value="6" min="1" max="12" step="0.5">
                                </div>

                                <div class="control-group">
                                    <label>电阻 (Ω)</label>
                                    <input type="number" class="control-input" id="circuit-resistance" value="10" min="1" max="100">
                                </div>

                                <div class="control-group">
                                    <label>电路类型</label>
                                    <select class="control-input" id="circuit-config">
                                        <option value="single">单电阻</option>
                                        <option value="series">串联电阻</option>
                                        <option value="parallel">并联电阻</option>
                                    </select>
                                </div>

                                <button class="control-button" id="start-circuit">开始实验</button>
                                <button class="control-button" id="measure-current">测量电流</button>
                                <button class="control-button" id="reset-circuit">重置实验</button>

                                <div class="control-group">
                                    <label>实验说明</label>
                                    <p style="font-size: 0.9rem; color: #666;">
                                        改变电压和电阻值，验证欧姆定律 V = IR。
                                    </p>
                                </div>
                            </div>
                            
                            <div class="experiment-display">
                                <canvas class="experiment-canvas" id="circuit-canvas" width="600" height="600"></canvas>
                            </div>
                            
                            <div class="data-analysis">
                                <h3><i class="fas fa-chart-line"></i> 数据分析</h3>
                                
                                <div class="control-group">
                                    <label>电压: <span id="measured-voltage">--</span> V</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>电流: <span id="measured-current">--</span> A</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>功率: <span id="measured-power">--</span> W</label>
                                </div>

                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>电压(V)</th>
                                            <th>电流(A)</th>
                                            <th>电阻(Ω)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="circuit-data">
                                    </tbody>
                                </table>

                                <button class="control-button" id="analyze-circuit">分析数据</button>
                                <button class="control-button" id="export-circuit">导出数据</button>
                            </div>
                        </div>
                    </div>

                    <div class="experiment-panel" id="mechanics-panel">
                        <div class="experiment-workspace">
                            <div class="experiment-controls">
                                <h3><i class="fas fa-cogs"></i> 自由落体实验</h3>
                                
                                <div class="control-group">
                                    <label>释放高度 (m)</label>
                                    <input type="number" class="control-input" id="drop-height" value="2.0" min="0.5" max="5.0" step="0.1">
                                </div>

                                <div class="control-group">
                                    <label>物体质量 (kg)</label>
                                    <input type="number" class="control-input" id="object-mass" value="1.0" min="0.1" max="5.0" step="0.1">
                                </div>

                                <div class="control-group">
                                    <label>空气阻力</label>
                                    <select class="control-input" id="air-resistance">
                                        <option value="none">忽略</option>
                                        <option value="light">轻微</option>
                                        <option value="moderate">中等</option>
                                    </select>
                                </div>

                                <button class="control-button" id="start-mechanics">开始实验</button>
                                <button class="control-button" id="measure-time">测量时间</button>
                                <button class="control-button" id="reset-mechanics">重置实验</button>

                                <div class="control-group">
                                    <label>实验说明</label>
                                    <p style="font-size: 0.9rem; color: #666;">
                                        测量不同高度的自由落体时间，验证重力加速度。
                                    </p>
                                </div>
                            </div>
                            
                            <div class="experiment-display">
                                <canvas class="experiment-canvas" id="mechanics-canvas" width="600" height="600"></canvas>
                            </div>
                            
                            <div class="data-analysis">
                                <h3><i class="fas fa-chart-line"></i> 数据分析</h3>
                                
                                <div class="control-group">
                                    <label>下落时间: <span id="measured-time">--</span> s</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>计算重力加速度: <span id="calculated-g">--</span> m/s²</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>误差: <span id="g-error">--</span> %</label>
                                </div>

                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>高度(m)</th>
                                            <th>时间(s)</th>
                                            <th>g(m/s²)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mechanics-data">
                                    </tbody>
                                </table>

                                <button class="control-button" id="analyze-mechanics">分析数据</button>
                                <button class="control-button" id="export-mechanics">导出数据</button>
                            </div>
                        </div>
                    </div>

                    <div class="experiment-panel" id="thermodynamics-panel">
                        <div class="experiment-workspace">
                            <div class="experiment-controls">
                                <h3><i class="fas fa-thermometer-half"></i> 比热容测量</h3>
                                
                                <div class="control-group">
                                    <label>物质类型</label>
                                    <select class="control-input" id="substance">
                                        <option value="aluminum">铝</option>
                                        <option value="copper">铜</option>
                                        <option value="iron">铁</option>
                                        <option value="water">水</option>
                                    </select>
                        </div>

                                <div class="control-group">
                                    <label>质量 (kg)</label>
                                    <input type="number" class="control-input" id="sample-mass" value="0.1" min="0.01" max="1.0" step="0.01">
                    </div>

                                <div class="control-group">
                                    <label>初始温度 (°C)</label>
                                    <input type="number" class="control-input" id="initial-temp" value="20" min="0" max="100">
                </div>

                                <div class="control-group">
                                    <label>加热功率 (W)</label>
                                    <input type="number" class="control-input" id="heating-power" value="100" min="50" max="500" step="10">
                                </div>

                                <button class="control-button" id="start-thermo">开始实验</button>
                                <button class="control-button" id="record-temp">记录温度</button>
                                <button class="control-button" id="reset-thermo">重置实验</button>

                                <div class="control-group">
                                    <label>实验说明</label>
                                    <p style="font-size: 0.9rem; color: #666;">
                                        测量不同物质的温度变化，计算比热容。
                                    </p>
                                </div>
                            </div>
                            
                            <div class="experiment-display">
                                <canvas class="experiment-canvas" id="thermo-canvas" width="600" height="600"></canvas>
                            </div>
                            
                            <div class="data-analysis">
                                <h3><i class="fas fa-chart-line"></i> 数据分析</h3>
                                
                                <div class="control-group">
                                    <label>当前温度: <span id="current-temp">--</span> °C</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>加热时间: <span id="heating-time">--</span> s</label>
                                </div>
                                
                                <div class="control-group">
                                    <label>计算比热容: <span id="calculated-c">--</span> J/(kg·K)</label>
                                </div>

                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>时间(s)</th>
                                            <th>温度(°C)</th>
                                            <th>ΔT(K)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="thermo-data">
                                    </tbody>
                                </table>

                                <button class="control-button" id="analyze-thermo">分析数据</button>
                                <button class="control-button" id="export-thermo">导出数据</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <p class="copyright-text">study-llm.me域名为Alex所有。保留所有权利。</p>
            </div>
        </div>
    </footer>

    <script src="../../js/common.js"></script>
    <script src="../../js/navigation.js"></script>
    <script>
        // 虚拟实验室功能
        class PhysicsLab {
            constructor() {
                this.currentTab = 'pendulum';
                this.pendulumData = [];
                this.opticsData = [];
                this.circuitData = [];
                this.mechanicsData = [];
                this.thermoData = [];
                this.isRunning = false;
                this.experiments = {};
                this.initializeEventListeners();
                this.initializeCanvas();
            }

            initializeEventListeners() {
                // 标签切换
                document.querySelectorAll('.experiment-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // 单摆实验控制
                if (document.getElementById('start-pendulum')) {
                document.getElementById('start-pendulum').addEventListener('click', () => this.startPendulum());
                document.getElementById('record-data').addEventListener('click', () => this.recordData());
                document.getElementById('reset-pendulum').addEventListener('click', () => this.resetPendulum());
                document.getElementById('analyze-pendulum').addEventListener('click', () => this.analyzeData());
                document.getElementById('export-data').addEventListener('click', () => this.exportData());

                // 参数变化监听
                ['pendulum-length', 'pendulum-mass', 'pendulum-angle'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.updateTheoretical());
                });
                }

                // 光学实验控制
                if (document.getElementById('start-optics')) {
                    document.getElementById('start-optics').addEventListener('click', () => this.startOptics());
                    document.getElementById('measure-angle').addEventListener('click', () => this.measureAngle());
                    document.getElementById('reset-optics').addEventListener('click', () => this.resetOptics());
                    document.getElementById('analyze-optics').addEventListener('click', () => this.analyzeOptics());
                    document.getElementById('export-optics').addEventListener('click', () => this.exportOptics());
                    
                    document.getElementById('medium-type').addEventListener('change', (e) => {
                        document.getElementById('custom-refractive-index').style.display = 
                            e.target.value === 'custom' ? 'block' : 'none';
                    });
                }

                // 电路实验控制
                if (document.getElementById('start-circuit')) {
                    document.getElementById('start-circuit').addEventListener('click', () => this.startCircuit());
                    document.getElementById('measure-current').addEventListener('click', () => this.measureCurrent());
                    document.getElementById('reset-circuit').addEventListener('click', () => this.resetCircuit());
                    document.getElementById('analyze-circuit').addEventListener('click', () => this.analyzeCircuit());
                    document.getElementById('export-circuit').addEventListener('click', () => this.exportCircuit());
                }

                // 力学实验控制
                if (document.getElementById('start-mechanics')) {
                    document.getElementById('start-mechanics').addEventListener('click', () => this.startMechanics());
                    document.getElementById('measure-time').addEventListener('click', () => this.measureTime());
                    document.getElementById('reset-mechanics').addEventListener('click', () => this.resetMechanics());
                    document.getElementById('analyze-mechanics').addEventListener('click', () => this.analyzeMechanics());
                    document.getElementById('export-mechanics').addEventListener('click', () => this.exportMechanics());
                }

                // 热学实验控制
                if (document.getElementById('start-thermo')) {
                    document.getElementById('start-thermo').addEventListener('click', () => this.startThermo());
                    document.getElementById('record-temp').addEventListener('click', () => this.recordTemp());
                    document.getElementById('reset-thermo').addEventListener('click', () => this.resetThermo());
                    document.getElementById('analyze-thermo').addEventListener('click', () => this.analyzeThermo());
                    document.getElementById('export-thermo').addEventListener('click', () => this.exportThermo());
                }
            }

            initializeCanvas() {
                const canvasId = `${this.currentTab}-canvas`;
                const canvas = document.getElementById(canvasId);
                
                if (canvas) {
                    this.canvas = canvas;
                    this.ctx = canvas.getContext('2d');
                    
                    if (this.currentTab === 'pendulum') {
                this.updateTheoretical();
                    }
                }
            }

            switchTab(tabName) {
                // 停止当前实验
                this.isRunning = false;

                // 更新标签状态
                document.querySelectorAll('.experiment-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // 更新面板显示
                document.querySelectorAll('.experiment-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById(`${tabName}-panel`).classList.add('active');

                this.currentTab = tabName;
                
                // 初始化对应的画布
                this.initializeCanvas();
            }

            startPendulum() {
                this.isRunning = true;
                this.simulatePendulum();
            }

            simulatePendulum() {
                const length = parseFloat(document.getElementById('pendulum-length').value) / 100; // 转换为米
                const angle = parseFloat(document.getElementById('pendulum-angle').value) * Math.PI / 180;
                
                let currentAngle = angle;
                let angularVelocity = 0;
                const gravity = 9.8;
                const dt = 0.02;
                let time = 0;
                let lastZeroCrossing = 0;
                let period = 0;

                const centerX = this.canvas.width / 2;
                const centerY = 100;
                const scale = 200;

                const animate = () => {
                    if (!this.isRunning) return;

                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                    // 物理计算
                    const angularAcceleration = -(gravity / length) * Math.sin(currentAngle);
                    angularVelocity += angularAcceleration * dt;
                    currentAngle += angularVelocity * dt;

                    // 检测周期
                    if (Math.abs(currentAngle) < 0.01 && angularVelocity > 0 && time > 0.5) {
                        if (lastZeroCrossing > 0) {
                            period = (time - lastZeroCrossing) * 2; // 完整周期
                            document.getElementById('current-period').textContent = period.toFixed(3);
                            this.updateError();
                        }
                        lastZeroCrossing = time;
                    }

                    // 绘制摆
                    const bobX = centerX + length * scale * Math.sin(currentAngle);
                    const bobY = centerY + length * scale * Math.cos(currentAngle);

                    // 绘制摆线
                    this.ctx.strokeStyle = '#333';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.moveTo(centerX, centerY);
                    this.ctx.lineTo(bobX, bobY);
                    this.ctx.stroke();

                    // 绘制固定点
                    this.ctx.fillStyle = '#666';
                    this.ctx.beginPath();
                    this.ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
                    this.ctx.fill();

                    // 绘制摆球
                    this.ctx.fillStyle = '#4361ee';
                    this.ctx.beginPath();
                    this.ctx.arc(bobX, bobY, 15, 0, 2 * Math.PI);
                    this.ctx.fill();

                    // 绘制轨迹
                    this.ctx.strokeStyle = 'rgba(67, 97, 238, 0.3)';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();
                    this.ctx.arc(centerX, centerY, length * scale, 0, 2 * Math.PI);
                    this.ctx.stroke();

                    time += dt;
                    requestAnimationFrame(animate);
                };

                animate();
            }

            updateTheoretical() {
                const length = parseFloat(document.getElementById('pendulum-length').value) / 100;
                const theoretical = 2 * Math.PI * Math.sqrt(length / 9.8);
                document.getElementById('theoretical-period').textContent = theoretical.toFixed(3);
                this.updateError();
            }

            updateError() {
                const current = parseFloat(document.getElementById('current-period').textContent);
                const theoretical = parseFloat(document.getElementById('theoretical-period').textContent);
                
                if (current && theoretical) {
                    const error = Math.abs((current - theoretical) / theoretical * 100);
                    document.getElementById('period-error').textContent = error.toFixed(2);
                }
            }

            recordData() {
                const length = parseFloat(document.getElementById('pendulum-length').value);
                const period = parseFloat(document.getElementById('current-period').textContent);
                
                if (period) {
                    this.pendulumData.push({
                        length: length,
                        period: period,
                        periodSquared: period * period
                    });

                    this.updateDataTable();
                }
            }

            updateDataTable() {
                const tbody = document.getElementById('pendulum-data');
                tbody.innerHTML = '';

                this.pendulumData.forEach(data => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = data.length.toFixed(1);
                    row.insertCell(1).textContent = data.period.toFixed(3);
                    row.insertCell(2).textContent = data.periodSquared.toFixed(3);
                });
            }

            analyzeData() {
                if (this.pendulumData.length < 3) {
                    alert('需要至少3组数据进行分析');
                    return;
                }

                // 简单的线性回归分析 T² vs L
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
                const n = this.pendulumData.length;

                this.pendulumData.forEach(data => {
                    const x = data.length / 100; // 转换为米
                    const y = data.periodSquared;
                    sumX += x;
                    sumY += y;
                    sumXY += x * y;
                    sumX2 += x * x;
                });

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                // 理论斜率应该是 4π²/g
                const theoreticalSlope = 4 * Math.PI * Math.PI / 9.8;
                const calculatedG = 4 * Math.PI * Math.PI / slope;

                alert(`分析结果：
斜率: ${slope.toFixed(3)} s²/m
理论斜率: ${theoreticalSlope.toFixed(3)} s²/m
计算得到的g: ${calculatedG.toFixed(2)} m/s²
误差: ${Math.abs((calculatedG - 9.8) / 9.8 * 100).toFixed(2)}%`);
            }

            exportData() {
                if (this.pendulumData.length === 0) {
                    alert('没有数据可导出');
                    return;
                }

                let csv = '摆长(cm),周期(s),T²(s²)\n';
                this.pendulumData.forEach(data => {
                    csv += `${data.length},${data.period},${data.periodSquared}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '单摆实验数据.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            resetPendulum() {
                this.isRunning = false;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                document.getElementById('current-period').textContent = '--';
                document.getElementById('period-error').textContent = '--';
            }

            // 光学实验函数
            startOptics() {
                this.drawOpticsSetup();
            }

            drawOpticsSetup() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const incidentAngle = parseFloat(document.getElementById('optics-incident-angle').value) * Math.PI / 180;
                const mediumType = document.getElementById('medium-type').value;
                
                let n2;
                switch(mediumType) {
                    case 'glass': n2 = 1.5; break;
                    case 'water': n2 = 1.33; break;
                    case 'diamond': n2 = 2.42; break;
                    case 'custom': n2 = parseFloat(document.getElementById('custom-n').value); break;
                    default: n2 = 1.5;
                }

                const refractedAngle = Math.asin(Math.sin(incidentAngle) / n2);

                // 绘制界面
                this.ctx.fillStyle = 'rgba(67, 97, 238, 0.1)';
                this.ctx.fillRect(0, this.canvas.height / 2, this.canvas.width, this.canvas.height / 2);
                
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(0, this.canvas.height / 2);
                this.ctx.lineTo(this.canvas.width, this.canvas.height / 2);
                this.ctx.stroke();

                // 绘制法线
                this.ctx.strokeStyle = '#ccc';
                this.ctx.lineWidth = 1;
                this.ctx.setLineDash([5, 5]);
                this.ctx.beginPath();
                this.ctx.moveTo(this.canvas.width / 2, 100);
                this.ctx.lineTo(this.canvas.width / 2, this.canvas.height - 100);
                this.ctx.stroke();
                this.ctx.setLineDash([]);

                // 绘制入射光线
                const incidentX = this.canvas.width / 2 - 150 * Math.sin(incidentAngle);
                const incidentY = this.canvas.height / 2 - 150 * Math.cos(incidentAngle);
                
                this.ctx.strokeStyle = '#ffeb3b';
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.moveTo(incidentX, incidentY);
                this.ctx.lineTo(this.canvas.width / 2, this.canvas.height / 2);
                this.ctx.stroke();

                // 绘制折射光线
                const refractedX = this.canvas.width / 2 + 150 * Math.sin(refractedAngle);
                const refractedY = this.canvas.height / 2 + 150 * Math.cos(refractedAngle);
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.canvas.width / 2, this.canvas.height / 2);
                this.ctx.lineTo(refractedX, refractedY);
                this.ctx.stroke();

                // 更新显示
                document.getElementById('measured-incident').textContent = (incidentAngle * 180 / Math.PI).toFixed(1);
                document.getElementById('measured-refracted').textContent = (refractedAngle * 180 / Math.PI).toFixed(1);
                document.getElementById('calculated-n').textContent = n2.toFixed(2);
            }

            measureAngle() {
                const incident = parseFloat(document.getElementById('measured-incident').textContent);
                const refracted = parseFloat(document.getElementById('measured-refracted').textContent);
                const n = parseFloat(document.getElementById('calculated-n').textContent);

                this.opticsData.push({
                    incident: incident,
                    refracted: refracted,
                    refractiveIndex: n
                });

                this.updateOpticsTable();
            }

            updateOpticsTable() {
                const tbody = document.getElementById('optics-data');
                tbody.innerHTML = '';

                this.opticsData.forEach(data => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = data.incident.toFixed(1);
                    row.insertCell(1).textContent = data.refracted.toFixed(1);
                    row.insertCell(2).textContent = data.refractiveIndex.toFixed(2);
                });
            }

            analyzeOptics() {
                if (this.opticsData.length < 3) {
                    alert('需要至少3组数据进行分析');
                    return;
                }

                const avgN = this.opticsData.reduce((sum, data) => sum + data.refractiveIndex, 0) / this.opticsData.length;
                alert(`平均折射率: ${avgN.toFixed(3)}`);
            }

            exportOptics() {
                if (this.opticsData.length === 0) {
                    alert('没有数据可导出');
                    return;
                }

                let csv = '入射角(°),折射角(°),折射率\n';
                this.opticsData.forEach(data => {
                    csv += `${data.incident},${data.refracted},${data.refractiveIndex}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '光学实验数据.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            resetOptics() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                document.getElementById('measured-incident').textContent = '--';
                document.getElementById('measured-refracted').textContent = '--';
                document.getElementById('calculated-n').textContent = '--';
            }

            // 电路实验函数
            startCircuit() {
                this.drawCircuit();
            }

            drawCircuit() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const voltage = parseFloat(document.getElementById('circuit-voltage').value);
                const resistance = parseFloat(document.getElementById('circuit-resistance').value);
                const current = voltage / resistance;
                const power = voltage * current;

                // 绘制电路
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.rect(100, 200, 400, 200);
                this.ctx.stroke();

                // 电池
                this.ctx.fillStyle = '#ff4444';
                this.ctx.fillRect(120, 280, 60, 40);
                this.ctx.fillStyle = 'white';
                this.ctx.font = '14px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(`${voltage}V`, 150, 305);

                // 电阻
                this.ctx.strokeStyle = '#666';
                this.ctx.lineWidth = 8;
                this.ctx.beginPath();
                this.ctx.moveTo(400, 300);
                this.ctx.lineTo(480, 300);
                this.ctx.stroke();
                this.ctx.fillStyle = '#333';
                this.ctx.fillText(`${resistance}Ω`, 440, 330);

                // 更新显示
                document.getElementById('measured-voltage').textContent = voltage.toFixed(1);
                document.getElementById('measured-current').textContent = current.toFixed(3);
                document.getElementById('measured-power').textContent = power.toFixed(2);
            }

            measureCurrent() {
                const voltage = parseFloat(document.getElementById('measured-voltage').textContent);
                const current = parseFloat(document.getElementById('measured-current').textContent);
                const resistance = voltage / current;

                this.circuitData.push({
                    voltage: voltage,
                    current: current,
                    resistance: resistance
                });

                this.updateCircuitTable();
            }

            updateCircuitTable() {
                const tbody = document.getElementById('circuit-data');
                tbody.innerHTML = '';

                this.circuitData.forEach(data => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = data.voltage.toFixed(1);
                    row.insertCell(1).textContent = data.current.toFixed(3);
                    row.insertCell(2).textContent = data.resistance.toFixed(1);
                });
            }

            analyzeCircuit() {
                if (this.circuitData.length < 3) {
                    alert('需要至少3组数据进行分析');
                    return;
                }

                const avgR = this.circuitData.reduce((sum, data) => sum + data.resistance, 0) / this.circuitData.length;
                alert(`平均电阻: ${avgR.toFixed(2)}Ω\n验证了欧姆定律 V = IR`);
            }

            exportCircuit() {
                if (this.circuitData.length === 0) {
                    alert('没有数据可导出');
                    return;
                }

                let csv = '电压(V),电流(A),电阻(Ω)\n';
                this.circuitData.forEach(data => {
                    csv += `${data.voltage},${data.current},${data.resistance}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '电路实验数据.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            resetCircuit() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                document.getElementById('measured-voltage').textContent = '--';
                document.getElementById('measured-current').textContent = '--';
                document.getElementById('measured-power').textContent = '--';
            }

            // 力学实验函数
            startMechanics() {
                this.simulateFreeFall();
            }

            simulateFreeFall() {
                const height = parseFloat(document.getElementById('drop-height').value);
                const mass = parseFloat(document.getElementById('object-mass').value);
                const airResistance = document.getElementById('air-resistance').value;
                
                let y = 50;
                let v = 0;
                let t = 0;
                const g = 9.8;
                const dt = 0.02;
                let drag = 0;

                if (airResistance === 'light') drag = 0.1;
                else if (airResistance === 'moderate') drag = 0.3;

                const animate = () => {
                    if (y >= this.canvas.height - 100) {
                        const fallTime = Math.sqrt(2 * height / g);
                        const calculatedG = 2 * height / (t * t);
                        
                        document.getElementById('measured-time').textContent = t.toFixed(3);
                        document.getElementById('calculated-g').textContent = calculatedG.toFixed(2);
                        
                        const error = Math.abs((calculatedG - 9.8) / 9.8 * 100);
                        document.getElementById('g-error').textContent = error.toFixed(2);
                        return;
                    }

                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                    // 绘制地面
                    this.ctx.strokeStyle = '#8B4513';
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, this.canvas.height - 100);
                    this.ctx.lineTo(this.canvas.width, this.canvas.height - 100);
                    this.ctx.stroke();

                    // 绘制物体
                    this.ctx.fillStyle = '#4361ee';
                    this.ctx.fillRect(this.canvas.width / 2 - 15, y, 30, 30);

                    // 物理计算
                    const a = g - drag * v;
                    v += a * dt;
                    y += v * dt * 20; // 缩放因子

                    t += dt;
                    requestAnimationFrame(animate);
                };

                animate();
            }

            measureTime() {
                const height = parseFloat(document.getElementById('drop-height').value);
                const time = parseFloat(document.getElementById('measured-time').textContent);
                const g = parseFloat(document.getElementById('calculated-g').textContent);

                this.mechanicsData.push({
                    height: height,
                    time: time,
                    gravity: g
                });

                this.updateMechanicsTable();
            }

            updateMechanicsTable() {
                const tbody = document.getElementById('mechanics-data');
                tbody.innerHTML = '';

                this.mechanicsData.forEach(data => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = data.height.toFixed(1);
                    row.insertCell(1).textContent = data.time.toFixed(3);
                    row.insertCell(2).textContent = data.gravity.toFixed(2);
                });
            }

            analyzeMechanics() {
                if (this.mechanicsData.length < 3) {
                    alert('需要至少3组数据进行分析');
                    return;
                }

                const avgG = this.mechanicsData.reduce((sum, data) => sum + data.gravity, 0) / this.mechanicsData.length;
                const error = Math.abs((avgG - 9.8) / 9.8 * 100);
                alert(`平均重力加速度: ${avgG.toFixed(2)} m/s²\n误差: ${error.toFixed(2)}%`);
            }

            exportMechanics() {
                if (this.mechanicsData.length === 0) {
                    alert('没有数据可导出');
                    return;
                }

                let csv = '高度(m),时间(s),重力加速度(m/s²)\n';
                this.mechanicsData.forEach(data => {
                    csv += `${data.height},${data.time},${data.gravity}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '力学实验数据.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            resetMechanics() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                document.getElementById('measured-time').textContent = '--';
                document.getElementById('calculated-g').textContent = '--';
                document.getElementById('g-error').textContent = '--';
            }

            // 热学实验函数
            startThermo() {
                this.simulateHeating();
            }

            simulateHeating() {
                const substance = document.getElementById('substance').value;
                const mass = parseFloat(document.getElementById('sample-mass').value);
                const initialTemp = parseFloat(document.getElementById('initial-temp').value);
                const power = parseFloat(document.getElementById('heating-power').value);
                
                let specificHeat;
                switch(substance) {
                    case 'aluminum': specificHeat = 900; break;
                    case 'copper': specificHeat = 385; break;
                    case 'iron': specificHeat = 449; break;
                    case 'water': specificHeat = 4186; break;
                    default: specificHeat = 900;
                }

                let currentTemp = initialTemp;
                let time = 0;
                const dt = 0.1;

                const animate = () => {
                    if (time > 60) return; // 最多加热60秒

                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                    // 绘制加热器
                    this.ctx.fillStyle = '#ff4444';
                    this.ctx.fillRect(200, 400, 200, 50);
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '14px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(`${power}W`, 300, 430);

                    // 绘制样品
                    this.ctx.fillStyle = '#4361ee';
                    this.ctx.fillRect(250, 350, 100, 50);
                    this.ctx.fillStyle = 'white';
                    this.ctx.fillText(`${substance}`, 300, 375);
                    this.ctx.fillText(`${currentTemp.toFixed(1)}°C`, 300, 390);

                    // 温度计算
                    const deltaT = (power * dt) / (mass * specificHeat);
                    currentTemp += deltaT;

                    // 更新显示
                    document.getElementById('current-temp').textContent = currentTemp.toFixed(1);
                    document.getElementById('heating-time').textContent = time.toFixed(1);
                    
                    const calculatedC = (power * time) / (mass * (currentTemp - initialTemp));
                    document.getElementById('calculated-c').textContent = calculatedC.toFixed(0);

                    time += dt;
                    setTimeout(() => requestAnimationFrame(animate), 100);
                };

                animate();
            }

            recordTemp() {
                const time = parseFloat(document.getElementById('heating-time').textContent);
                const temp = parseFloat(document.getElementById('current-temp').textContent);
                const initialTemp = parseFloat(document.getElementById('initial-temp').value);
                const deltaT = temp - initialTemp;

                this.thermoData.push({
                    time: time,
                    temperature: temp,
                    deltaT: deltaT
                });

                this.updateThermoTable();
            }

            updateThermoTable() {
                const tbody = document.getElementById('thermo-data');
                tbody.innerHTML = '';

                this.thermoData.forEach(data => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = data.time.toFixed(1);
                    row.insertCell(1).textContent = data.temperature.toFixed(1);
                    row.insertCell(2).textContent = data.deltaT.toFixed(1);
                });
            }

            analyzeThermo() {
                if (this.thermoData.length < 3) {
                    alert('需要至少3组数据进行分析');
                    return;
                }

                const calculatedC = parseFloat(document.getElementById('calculated-c').textContent);
                alert(`计算得到的比热容: ${calculatedC} J/(kg·K)`);
            }

            exportThermo() {
                if (this.thermoData.length === 0) {
                    alert('没有数据可导出');
                    return;
                }

                let csv = '时间(s),温度(°C),温度变化(K)\n';
                this.thermoData.forEach(data => {
                    csv += `${data.time},${data.temperature},${data.deltaT}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '热学实验数据.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            resetThermo() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                document.getElementById('current-temp').textContent = '--';
                document.getElementById('heating-time').textContent = '--';
                document.getElementById('calculated-c').textContent = '--';
            }
        }

        // 初始化实验室
        document.addEventListener('DOMContentLoaded', () => {
            new PhysicsLab();
        });
    </script>
</body>
</html> 