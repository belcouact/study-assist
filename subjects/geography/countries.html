<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country Information</title>    
    <link rel="icon" href="../../assets/icons/alex.ico" type="image/x-icon">
    
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet JS for OpenStreetMap -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- ECharts Library -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
    /* Language Switcher Styles */
    .language-switcher {
      position: relative;
      margin: 0 auto 20px;
      z-index: 1000;
      display: flex;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      width: fit-content;
    }
    
    .lang-btn {
      padding: 8px 16px;
      border: none;
      background-color: #f5f5f5;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      min-height: 44px; /* Minimum touch target size for mobile */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .lang-btn.active {
      background-color: #4a90e2;
      color: white;
    }
    
    .lang-btn:hover:not(.active) {
      background-color: #e0e0e0;
    }
    
    @media (max-width: 768px) {
      .language-switcher {
        margin: 0 auto 15px;
      }
      
      .lang-btn {
        padding: 10px 12px; /* Increased padding for better touch target */
        font-size: 12px;
        min-height: 44px; /* Minimum touch target size for mobile */
      }
    }
    
    .tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(30,30,30,0.95);
      color: #fff;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 13px;
      z-index: 1000;
      white-space: normal;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      display: none;
      max-width: 300px;
      line-height: 1.3;
    }
    
    .tooltip strong {
      display: block;
      margin-bottom: 0;
      font-size: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.5);
      padding-bottom: 4px;
      margin-bottom: 4px;
    }
    
    svg {
      width: 100%;
      max-width: 1200px;
      height: auto;
      display: block;
      margin: 0 auto;
      cursor: pointer;
    }
    
    .country-hover {
      stroke: #222;
      stroke-width: 1.5;
      filter: drop-shadow(0 0 4px #0006);
      cursor: pointer;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
    }
    
    #svg-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      #svg-container {
        padding: 12px;
        margin-top: 15px;
      }
    }
    
    @media (max-width: 480px) {
      #svg-container {
        padding: 10px;
        margin-top: 10px;
      }
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .header h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #666;
      font-size: 16px;
    }
    
    .stats-selector {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      margin: 20px auto;
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    @media (max-width: 768px) {
      .stats-selector {
        max-width: 95%;
      }
    }
    
    @media (max-width: 480px) {
      .stats-selector {
        max-width: 98%;
        margin: 15px auto;
        padding: 12px;
      }
    }
    
    .stats-selector label {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }
    
    .stats-selector select {
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 16px;
      background-color: white;
      cursor: pointer;
    }
    
    @media (min-width: 768px) {
      .stats-selector {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
      
      .stats-selector label {
        margin-bottom: 0;
        flex: 1;
      }
      
      .stats-selector select {
        flex: 2;
      }
    }
    
    .color-legend {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      margin: 20px auto;
      max-width: 1400px;
    }
    
    @media (max-width: 768px) {
      .color-legend {
        max-width: 90%;
      }
    }
    
    @media (max-width: 480px) {
      .color-legend {
        max-width: 95%;
        margin: 15px auto;
        padding: 12px;
      }
    }
    
    .legend-title {
      font-weight: 600;
      color: #333;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    /* Loading state styles */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }
    
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 14px;
    }
    
    .chart-loading {
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .legend-scale {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .legend-low, .legend-high {
      font-size: 14px;
      color: #666;
      width: 40px;
      text-align: center;
    }
    
    .legend-gradient {
      flex: 1;
      height: 20px;
      background: linear-gradient(to right, 
        rgb(255, 255, 200),  /* Light yellow for very low values */
        rgb(155, 255, 155),  /* Light green for low values */
        rgb(155, 255, 255),  /* Light cyan for low-mid values */
        rgb(155, 155, 255),  /* Light blue for mid values */
        rgb(255, 192, 203),  /* Pink for mid-high values */
        rgb(255, 165, 0),    /* Orange for high values */
        rgb(255, 0, 0)       /* Red for very high values */
      );
      border-radius: 4px;
    }
    
    .legend-values {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }
    
    /* Tab Styles */
    .tab-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 20px auto;
      max-width: 80%;
      overflow: hidden;
    }
    
    @media (max-width: 768px) {
      .tab-container {
        max-width: 95%;
      }
    }
    
    @media (max-width: 480px) {
      .tab-container {
        max-width: 98%;
        margin: 15px auto;
      }
    }
    
    .tab-nav {
      display: flex;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    
    .tab-button {
      flex: 1;
      padding: 12px 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      color: #495057;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      min-height: 44px; /* Minimum touch target size for mobile */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tab-button:hover {
      background-color: #e9ecef;
    }
    
    .tab-button.active {
      color: #007bff;
      border-bottom-color: #007bff;
      background-color: white;
    }
    
    .tab-content {
      position: relative;
    }
    
    .tab-pane {
      display: none;
      padding: 20px;
    }
    
    .tab-pane.active {
      display: block;
    }
    
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      .card-container {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .card-container {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
      }
    }
    
    .country-card {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      text-align: center;
    }
    
    .country-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .country-card .country-name {
      margin-top: 0;
      color: #333;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .country-card .country-flag-container {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    .country-card .country-flag {
      width: 160px;
      height: 100px;
      object-fit: contain;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .country-card .country-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .country-card .country-common-name {
      color: #6c757d;
      font-size: 14px;
    }
    
    .country-card .country-capital {
      color: #495057;
      font-size: 14px;
    }
    
    .map-container {
      height: 750px;
      position: relative;
      background-color: #f8f9fa;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
    }
    
    /* Card Controls Styles */
    .card-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .search-container {
      flex: 1;
      min-width: 250px;
    }
    
    .filter-container {
      flex: 0 0 auto;
      min-width: 150px;
    }
    
    #country-search {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    #region-filter, #subregion-filter {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      background-color: white;
      box-sizing: border-box;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      max-height: 80vh;
      overflow-y: auto;
      /* Hide scrollbar while maintaining scrolling functionality */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    
    /* Hide scrollbar for Chrome, Safari and Opera */
    .modal-content::-webkit-scrollbar {
      display: none;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      min-width: 44px; /* Minimum touch target size for mobile */
      min-height: 44px; /* Minimum touch target size for mobile */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .modal-flag {
  width: 60px;
  height: 40px;
  margin-right: 15px;
  object-fit: contain;
}

.modal-coat-of-arms {
  display: flex;
  justify-content: center;
  margin: 15px 0;
  padding: 10px;
  border-bottom: 1px solid #eee;
  background-color: transparent;
  background: transparent;
}

.modal-coat-of-arms img {
  max-width: 150px;
  max-height: 150px;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  transition: transform 0.2s ease;
  background-color: transparent;
  background: transparent;
}

.modal-coat-of-arms img:hover {
  transform: scale(1.05);
}
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
    }
    
    .modal-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .detail-item {
      margin-bottom: 8px;
    }
    
    .detail-label {
      font-weight: bold;
      color: #555;
    }
    
    .detail-value {
      color: #333;
    }
    
    /* Style for links in modal */
    .detail-value a {
      color: #0066cc;
      text-decoration: none;
      font-weight: 500;
    }
    
    .detail-value a:hover {
      text-decoration: underline;
    }
    
    /* Style for images in modal */
    .detail-value img {
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    .detail-value img:hover {
      transform: scale(1.05);
    }
    
    /* Map View Styles */
    .map-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
      padding: 8px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .location-search-container {
      display: flex;
      gap: 10px;
    }
    
    #location-search {
      flex: 1;
      padding: 8px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 12px;
      background-color: #f9f9f9;
      transition: all 0.3s ease;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #location-search:focus {
      outline: none;
      border-color: #4CAF50;
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2), inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #location-search::placeholder {
      color: #999;
      font-style: italic;
    }
    
    #search-button {
      padding: 8px 12px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    #search-button:hover {
      background: linear-gradient(135deg, #45a049, #3d8b40);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    #search-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #map {
      height: 750px;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .search-results {
      margin-top: 15px;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-height: 200px;
      overflow-y: auto;
    }
    
    .search-result-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .search-result-item:hover {
      background-color: #f5f5f5;
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-name {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .search-result-details {
      font-size: 14px;
      color: #666;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .tab-button {
        font-size: 16px;
        padding: 10px 5px;
      }
      
      .card-container {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 15px;
      }
      
      .card-controls {
        flex-direction: column;
      }
      
      .search-container, .filter-container {
        width: 100%;
      }
      
      .modal-details {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 15px;
        /* Hide scrollbar while maintaining scrolling functionality */
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }
      
      .modal-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .modal-flag {
        margin-right: 0;
        margin-bottom: 10px;
      }
      
      .country-card .country-name {
        font-size: 16px;
      }
      
      .country-card .country-flag {
        width: 60px;
        height: 40px;
      }
      
      /* Responsive adjustments for modal images */
      .detail-value img {
        max-width: 80px;
        max-height: 80px;
      }
      
      .modal-coat-of-arms img {
        max-width: 120px;
        max-height: 120px;
        background-color: transparent;
        background: transparent;
      }
      
      /* Search Results Styles */
      .search-results {
        margin-top: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
      }
      
      .search-result-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      
      .search-result-item:hover {
        background-color: #f5f5f5;
      }
      
      .search-result-item:last-child {
        border-bottom: none;
      }
      
      .search-result-name {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 14px;
      }
      
      .search-result-details {
        font-size: 14px;
        color: #666;
      }
      
      /* Responsive Design for Map View */
      @media (max-width: 768px) {
        .map-controls {
          padding: 10px;
          gap: 10px;
        }
        
        .location-search-container {
          flex-direction: column;
        }
        
        #location-search {
          font-size: 14px;
          padding: 10px 12px;
        }
        
        #search-button {
          padding: 10px 20px;
          font-size: 14px;
        }
        
        .mode-button {
          padding: 10px;
          font-size: 14px;
        }
        
        #map {
          height: 600px;
        }
        
        .search-results {
          max-height: 150px;
          padding: 10px;
        }
        
        .search-result-item {
          padding: 8px;
        }
        
        .search-result-name {
          font-size: 14px;
        }
        
        .search-result-details {
          font-size: 12px;
        }
      }
      
      @media (max-width: 480px) {
        .map-controls {
          padding: 8px;
          gap: 8px;
        }
        
        #location-search {
          font-size: 12px;
          padding: 8px 10px;
        }
        
        #search-button {
          padding: 8px 12px;
          font-size: 12px;
        }
        
        .mode-button {
          padding: 6px;
          font-size: 12px;
        }
        
        #map {
          height: 450px;
        }
        
        .search-results {
          max-height: 120px;
          padding: 8px;
        }
        
        .search-result-item {
          padding: 6px;
        }
        
        .search-result-name {
          font-size: 12px;
        }
        
        .search-result-details {
          font-size: 10px;
        }
      }
      
      /* Bar Chart Styles */
      .chart-container {
        margin-top: 30px;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      /* Data Interpretation Button Styles */
      /* Data Interpretation Container Styles */
      .data-interpretation-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 15px;
        margin: 20px auto;
        max-width: 1400px;
      }
      
      @media (max-width: 768px) {
        .data-interpretation-container {
          max-width: 90%;
        }
      }
      
      @media (max-width: 480px) {
        .data-interpretation-container {
          max-width: 95%;
          margin: 15px auto;
          padding: 12px;
        }
      }
      
      .interpretation-header {
        margin-bottom: 10px;
      }
      
      .interpretation-header h3 {
        font-weight: 600;
        color: #333;
        font-size: 16px;
        margin: 0;
      }
      
      .interpretation-controls {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      
      /* Responsive Design for Data Interpretation Container */
      @media (max-width: 768px) {
        .interpretation-header h3 {
          font-size: 14px;
        }
        
        .interpretation-btn {
          padding: 8px 16px;
          font-size: 13px;
        }
      }
      
      @media (max-width: 480px) {
        .interpretation-header h3 {
          font-size: 13px;
        }
        
        .interpretation-btn {
          padding: 8px 14px;
          font-size: 12px;
        }
      }
      
      .interpretation-btn {
        font-size: 14px;
        color: #666;
        width: auto;
        text-align: center;
        padding: 5px 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
      }
      
      .interpretation-btn:hover {
        background-color: #e9ecef;
      }
      
      /* Data Interpretation Modal Styles */
      .interpretation-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
      }
      
      .interpretation-modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 800px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        max-height: 80vh;
        overflow-y: auto;
      }
      
      .interpretation-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }
      
      .interpretation-modal-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }
      
      .interpretation-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        min-width: 44px; /* Minimum touch target size for mobile */
        min-height: 44px; /* Minimum touch target size for mobile */
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .interpretation-close:hover,
      .interpretation-close:focus {
        color: black;
        text-decoration: none;
      }
      
      .interpretation-content {
        line-height: 1.6;
        color: #333;
      }
      
      .interpretation-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
      }
      
      .interpretation-loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }
      
      .interpretation-loading-text {
        color: #666;
        font-size: 16px;
      }
      
      .interpretation-result h3 {
        font-size: 20px;
        color: #333;
        margin-bottom: 15px;
      }
      
      .interpretation-text {
        white-space: pre-wrap;
        line-height: 1.6;
      }
      
      .interpretation-error h3 {
        font-size: 20px;
        color: #e74c3c;
        margin-bottom: 15px;
      }
      
      .error-message {
        color: #e74c3c;
        margin-bottom: 10px;
      }
      
      .error-suggestion {
        color: #666;
        font-style: italic;
      }
      
      /* Responsive Design for Data Interpretation */
      @media (max-width: 768px) {
        .interpretation-btn {
          padding: 10px 20px;
          font-size: 14px;
        }
        
        .interpretation-modal-content {
          width: 95%;
          margin: 10% auto;
          padding: 15px;
          max-height: 85vh;
        }
        
        .interpretation-modal-title {
          font-size: 20px;
        }
        
        .interpretation-close {
          font-size: 24px;
        }
        
        .interpretation-loading {
          padding: 30px;
        }
        
        .interpretation-loading-spinner {
          width: 35px;
          height: 35px;
        }
        
        .interpretation-loading-text {
          font-size: 14px;
        }
      }
      
      @media (max-width: 480px) {
        .interpretation-btn {
          padding: 14px 12px;
          font-size: 12px;
        }
        
        .interpretation-modal-content {
          width: 98%;
          margin: 15% auto;
          padding: 12px;
        }
        
        .interpretation-modal-title {
          font-size: 18px;
        }
        
        .interpretation-modal-header {
          margin-bottom: 10px;
          padding-bottom: 8px;
        }
        
        .interpretation-close {
          font-size: 22px;
          min-width: 44px; /* Minimum touch target size for mobile */
          min-height: 44px; /* Minimum touch target size for mobile */
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .interpretation-loading {
          padding: 20px;
        }
        
        .interpretation-loading-spinner {
          width: 30px;
          height: 30px;
        }
        
        .interpretation-loading-text {
          font-size: 13px;
        }
        
        /* Modal close button responsive styles */
        .close {
          min-width: 44px; /* Minimum touch target size for mobile */
          min-height: 44px; /* Minimum touch target size for mobile */
          font-size: 24px; /* Larger font size for better visibility */
          line-height: 1; /* Adjust line height for better centering */
        }
        
        /* Modal content responsive styles */
        .modal-content {
          width: 95%;
          margin: 10% auto;
          padding: 15px;
        }
        
        .modal-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        
        .modal-flag {
          width: 60px;
          height: 40px;
        }
        
        .modal-title {
          font-size: 18px;
        }
        
        .modal-details {
          grid-template-columns: 1fr;
          gap: 8px;
        }
        
        .detail-item {
          padding: 8px 0;
        }
        
        .detail-label {
          font-size: 12px;
          min-width: 100px;
        }
        
        .detail-value {
          font-size: 12px;
        }
      }
      
      @media (max-width: 768px) {
        .chart-container {
          padding: 15px;
          margin-top: 20px;
        }
      }
      
      @media (max-width: 480px) {
        .chart-container {
          padding: 10px;
          margin-top: 15px;
        }
      }
      
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      
      .chart-header h3 {
        margin: 0;
        font-size: 18px;
        color: #333;
      }
      
      .chart-info {
        font-size: 14px;
        color: #666;
      }
      
      /* Base styles for bar chart */
      .bar-chart {
        width: 100%;
        height: 600px;
      }
      
      /* Base styles for echart container */
      .echart-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #e0e0e0;
        min-height: 500px;
        display: flex;
        flex-direction: column;
      }
      
      .echart-container .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      
      .echart-container .chart-header h3 {
        margin: 0;
        font-size: 18px;
        color: #333;
      }
      
      .echart-container .bar-chart {
        width: 100%;
        height: 350px;
        flex-grow: 1;
      }
      
      .echart-container .chart-controls {
        display: flex;
        justify-content: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }
      
      .interpretation-results {
        margin-top: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        border-left: 4px solid #4a90e2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      
      .interpretation-results h3 {
        margin-top: 0;
        color: #333;
        font-size: 18px;
        margin-bottom: 10px;
      }
      
      .interpretation-results .interpretation-text {
        line-height: 1.6;
        color: #555;
        white-space: normal;
      }
      
      .interpretation-results h1, 
      .interpretation-results h2, 
      .interpretation-results h3,
      .interpretation-results h4,
      .interpretation-results h5,
      .interpretation-results h6 {
        margin-top: 15px;
        margin-bottom: 10px;
        color: #333;
      }
      
      .interpretation-results h1 {
        font-size: 22px;
        border-bottom: 2px solid #4a90e2;
        padding-bottom: 8px;
      }
      
      .interpretation-results h2 {
        font-size: 20px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 6px;
      }
      
      .interpretation-results h3 {
        font-size: 18px;
      }
      
      .interpretation-results ul, 
      .interpretation-results ol {
        margin: 10px 0;
        padding-left: 20px;
      }
      
      .interpretation-results li {
        margin: 5px 0;
      }
      
      .interpretation-results strong {
        color: #333;
        font-weight: 600;
      }
      
      .interpretation-results em {
        font-style: italic;
        color: #555;
      }
      
      .interpretation-results code {
        background-color: #f0f0f0;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        color: #e74c3c;
      }
      
      .interpretation-results pre {
        background-color: #f8f8f8;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        margin: 10px 0;
        border-left: 3px solid #4a90e2;
      }
      
      .interpretation-results pre code {
        background-color: transparent;
        padding: 0;
        color: #333;
      }
      
      .interpretation-results a {
        color: #4a90e2;
        text-decoration: none;
      }
      
      .interpretation-results a:hover {
        text-decoration: underline;
      }
      
      /* Responsive Design for Bar Chart */
      @media (max-width: 768px) {
        .chart-container {
          padding: 15px;
          margin-top: 20px;
        }
        
        .chart-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        
        .chart-header h3 {
          font-size: 16px;
        }
        
        .chart-info {
          font-size: 12px;
        }
        
        .bar-chart {
          height: 400px;
        }
        
        .echart-container {
          padding: 15px;
          margin-top: 15px;
          min-height: 500px;
        }
        
        .echart-container .bar-chart {
          height: 400px;
        }
        
        .echart-container .chart-controls {
          margin-top: 10px;
          padding-top: 10px;
        }
        
        .interpretation-results {
          margin-top: 15px;
          padding: 12px;
        }
        
        .interpretation-results h3 {
          font-size: 16px;
        }
      }
      
      @media (max-width: 480px) {
        .chart-container {
          padding: 10px;
          margin-top: 15px;
        }
        
        .echart-container {
          padding: 12px;
          margin-top: 10px;
          min-height: 400px;
        }
        
        .echart-container .chart-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        
        .echart-container .chart-header h3 {
          font-size: 16px;
        }
        
        .echart-container .bar-chart {
          height: 300px;
        }
        
        .echart-container .chart-controls {
          margin-top: 8px;
          padding-top: 8px;
        }
        
        .interpretation-results {
          margin-top: 12px;
          padding: 10px;
        }
        
        .interpretation-results h3 {
          font-size: 15px;
        }
        
        .chart-header h3 {
          font-size: 14px;
        }
        
        .chart-info {
          font-size: 11px;
        }
        
        .bar-chart {
          height: 300px;
        }
      }
      
      /* Large Display Optimization */
      @media (min-width: 1600px) {
        .stats-selector, .color-legend, .tab-container {
          max-width: 85%;
        }
        
        svg {
          max-width: 1400px;
        }
        
        .card-container {
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        
        .bar-chart {
          height: 700px;
        }
        
        .echart-container {
          padding: 25px;
          min-height: 750px;
        }
        
        .echart-container .chart-header h3 {
          font-size: 20px;
        }
        
        .echart-container .bar-chart {
          height: 600px;
        }
        
        .echart-container .chart-controls {
          margin-top: 20px;
          padding-top: 20px;
        }
        
        .interpretation-results {
          margin-top: 25px;
          padding: 20px;
        }
        
        .interpretation-results h3 {
          font-size: 20px;
        }
      }
      
      /* Map View Styles */
      .map-container {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .map-controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
      }
      
      .location-search-container {
        display: flex;
        gap: 10px;
      }
      
      .location-search-container input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }
      
      .location-search-container button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
        min-height: 44px; /* Minimum touch target size for mobile */
      }
      
      .location-search-container button:hover {
        background-color: #0056b3;
      }
      
      .map-mode-toggle {
        display: flex;
        gap: 10px;
      }
      
      .mode-button {
        flex: 1;
        padding: 10px 20px;
        background: linear-gradient(135deg, #4a90e2, #3a7bc8);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-height: 44px; /* Minimum touch target size for mobile */
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }
      
      .mode-button.active {
        background: linear-gradient(135deg, #3a7bc8, #2e6cb8);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      }
      
      .search-results {
        margin-top: 15px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
      }
      
      .search-result-item {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      
      .search-result-item:last-child {
        border-bottom: none;
      }
      
      .mode-button:hover {
        background: linear-gradient(135deg, #3a7bc8, #2e6cb8);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      }
      
      .search-result-item:hover {
        background-color: #f8f9fa;
      }
      
      .search-result-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }
      
      .search-result-details {
        font-size: 14px;
        color: #666;
      }
      
      /* Responsive Design for Map View */
      @media (max-width: 768px) {
        .map-container {
          height: 400px;
        }
        
        .location-search-container {
          flex-direction: column;
        }
        
        .location-search-container button {
          width: 100%;
        }
        
        .map-mode-toggle {
          flex-direction: column;
        }
        
        .mode-button {
          padding: 10px 20px;
          font-size: 14px;
        }
      }
      
      @media (max-width: 480px) {
        .map-container {
          height: 350px;
        }
        
        .location-search-container input,
        .location-search-container button {
          font-size: 14px;
          padding: 12px; /* Increased padding for better touch target */
          min-height: 44px; /* Minimum touch target size for mobile */
        }
        
        .mode-button {
          padding: 12px 16px;
          font-size: 13px;
        }
        
        .search-result-item {
          padding: 10px 12px;
        }
        
        .search-result-name {
          font-size: 14px;
        }
        
        .search-result-details {
          font-size: 12px;
        }
      }
    }
    
    @media (max-width: 480px) {
      .card-container {
        grid-template-columns: 1fr;
      }
      
      .country-card .country-flag {
        width: 320px; /* Double the size for mobile */
        height: 200px; /* Double the size for mobile */
      }
      
      .tab-button {
        font-size: 12px;
        padding: 12px 8px; /* Increased padding for better touch target */
        min-height: 44px; /* Minimum touch target size for mobile */
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .header p {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>Interactive World Map with Country Statistics</h1>
    <p>Hover over any country to view detailed statistics and information</p>
  </div>
  
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn active" data-lang="en">EN</button>
    <button class="lang-btn" data-lang="zh">中文</button>
  </div>
  
  <!-- Modal for country details -->
  <div id="country-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="modal-header">
        <img id="modal-flag" class="modal-flag" src="" alt="Flag">
        <div id="modal-title" class="modal-title"></div>
      </div>
      <div id="modal-coat-of-arms" class="modal-coat-of-arms">
        <!-- Coat of Arms will be displayed here -->
      </div>
      <div id="modal-details" class="modal-details">
        <!-- Details will be populated dynamically -->
      </div>
    </div>
  </div>
  
  <!-- Tab Navigation -->
  <div class="tab-container">
    <div class="tab-nav">
      <button class="tab-button active" data-tab="svg-view">SVG View</button>
      <button class="tab-button" data-tab="card-view">Card View</button>
      <button class="tab-button" data-tab="map-view">Map View</button>
    </div>
    
    <!-- Tab Content -->
    <div class="tab-content">
      <!-- SVG View Tab -->
      <div id="svg-view" class="tab-pane active">
        <!-- Statistics Selector -->
        <div class="stats-selector">
          <label for="stat-select">Select Statistic to Visualize:</label>
          <select id="stat-select">
            <option value="">-- Select a statistic --</option>
          </select>
        </div>
        
        <!-- Color Legend -->
        <div class="color-legend">
          <div class="legend-title">Color Scale:</div>
          <div class="legend-scale">
            <div class="legend-low">Low</div>
            <div class="legend-gradient"></div>
            <div class="legend-high">High</div>
          </div>
          <div class="legend-values" id="legend-values">
            <span id="legend-min">0</span>
            <span id="legend-max">100</span>
          </div>
        </div>
        
        <!-- Tooltip -->
        <div id="tooltip" class="tooltip"></div>

        <!-- SVG Map (paste your SVG content below) -->
        <div id="svg-container">
          <!-- SVG will be injected here -->
        </div>
        
        <!-- Bar Chart Container -->
        <div class="echart-container">
          <div class="chart-header">
            <h3>Country Statistics</h3>
            <div class="chart-info" id="chart-info">
              <!-- Chart information will be displayed here -->
            </div>
          </div>
          <div id="bar-chart" class="bar-chart">
            <!-- ECharts bar chart will be rendered here -->
          </div>
        </div>
        
        <!-- Data Interpretation Container -->
        <div id="data-interpretation-container" class="data-interpretation-container">
          <div class="interpretation-header">
            <h3 data-i18n="dataInterpretationTitle">数据分析解读</h3>
            <div class="interpretation-controls">
              <button id="interpretation-btn" class="interpretation-btn" data-i18n="dataInterpretationButton">数据解读</button>
            </div>
          </div>
          <div id="interpretation-results" class="interpretation-results" style="display: none;">
            <!-- Results will be displayed here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Card View Tab -->
      <div id="card-view" class="tab-pane">
        <div class="card-controls">
          <!-- Search Field -->
          <div class="search-container">
            <input type="text" id="country-search" placeholder="Search by country code, name, or Chinese name...">
          </div>
          
          <!-- Region Filter -->
          <div class="filter-container">
            <select id="region-filter">
              <option value="">All Regions</option>
            </select>
          </div>
          
          <!-- Subregion Filter -->
          <div class="filter-container">
            <select id="subregion-filter">
              <option value="">All Subregions</option>
            </select>
          </div>
        </div>
        
        <div class="card-container">
          <!-- Cards will be dynamically generated here -->
        </div>
      </div>
      
      <!-- Map View Tab -->
      <div id="map-view" class="tab-pane">
        <div class="map-controls">
          <!-- Location Search Field -->
          <div class="location-search-container">
            <input type="text" id="location-search" placeholder="Search location by name (Chinese/English)...">
            <button id="search-button">Search</button>
          </div>
          
          <!-- Map Mode Toggle -->
          <div class="map-mode-toggle">
            <button id="normal-mode-btn" class="mode-button">NORMAL</button>
            <button id="satellite-mode-btn" class="mode-button active">SATELLITE</button>
          </div>
        </div>
        
        <div id="map" class="map-container">
          <!-- OpenStreetMap will be rendered here -->
        </div>
        
        <!-- Search Results -->
        <div id="search-results" class="search-results">
          <!-- Search results will be displayed here -->
        </div>
      </div>
    </div>
  </div>
  
  

  <script>
    // Test if JavaScript is running
    console.log('JavaScript is executing');
    
    // Language switching functionality
    const translations = {
      en: {
        pageTitle: "Country Information",
        headerTitle: "Interactive World Map with Country Statistics",
        headerSubtitle: "Hover over any country to view detailed statistics and information",
        tabSvgView: "SVG View",
        tabCardView: "Card View",
        tabMapView: "Map View",
        statSelectorLabel: "Select Statistic to Visualize:",
        statSelectorDefault: "-- Select a statistic --",
        colorLegendTitle: "Color Scale:",
        legendLow: "Low",
        legendHigh: "High",
        chartTitle: "Country Statistics",
        selectStatisticText: "Select a statistic to view data",
        topCountriesText: "Top 20 Countries by",
        searchPlaceholder: "Search by country code, name, or Chinese name...",
        regionFilterDefault: "All Regions",
        subregionFilterDefault: "All Subregions",
        locationSearchPlaceholder: "Search location by name (Chinese/English)...",
        searchButton: "Search",
        normalModeButton: "NORMAL",
        satelliteModeButton: "SATELLITE",
        loadingText: "Loading country data...",
        noResultsText: "No countries match your search criteria. Please try different filters.",
        searchLocationPlaceholder: "Please enter a location name to search.",
        searchingText: "Searching...",
        noLocationResultsText: "No results found for your search. Please try a different location name.",
        searchErrorText: "Error searching for location. Please try again later.",
        searchTimeoutText: "Search request timed out. Please check your internet connection and try again.",
        serverErrorText: "Server error. Please try again later.",
        dataInterpretationTitle: "Data Analysis & Interpretation",
        dataInterpretationButton: "Interpret Data",
        dataInterpretationResultTitle: "Analysis Results",
        dataInterpretationLoading: "Analyzing data, please wait...",
        dataInterpretationErrorTitle: "Analysis Error",
        dataInterpretationErrorMessage: "Sorry, an error occurred during data analysis:",
        dataInterpretationErrorSuggestion: "Please try again later or select a different statistic.",
        // Statistic names
        gdp: "gdp",
        sex_ratio: "sex ratio (M/F)",
        surface_area: "surface area",
        life_expectancy_male: "life expectancy (male)",
        unemployment: "unemployment",
        imports: "imports",
        homicide_rate: "homicide rate",
        gdp_growth: "gdp growth",
        employment_services: "employment services",
        urban_population_growth: "urban population growth",
        secondary_school_enrollment_female: "secondary school enrollment (female)",
        employment_agriculture: "employment agriculture",
        co2_emissions: "co2 emissions",
        forested_area: "forested area",
        tourists: "tourists",
        exports: "exports",
        life_expectancy_female: "life expectancy (female)",
        post_secondary_enrollment_female: "post secondary enrollment (female)",
        post_secondary_enrollment_male: "post secondary enrollment (male)",
        primary_school_enrollment_female: "primary school enrollment (female)",
        infant_mortality: "infant mortality",
        secondary_school_enrollment_male: "secondary school enrollment (male)",
        threatened_species: "threatened species",
        population: "population",
        urban_population: "urban population",
        employment_industry: "employment industry",
        pop_growth: "pop growth",
        pop_density: "pop density",
        internet_users: "internet users",
        gdp_per_capita: "gdp per capita",
        fertility: "fertility",
        refugees: "refugees",
        primary_school_enrollment_male: "primary school enrollment (male)",

        // Modal labels
        countryCode: "Country Code",
        cca3: "CCA3",
        cioc: "CIOC",
        ccn3: "CCN3",
        officialName: "Official Name",
        commonName: "Common Name",
        officialNameChinese: "Official Name (Chinese)",
        commonNameChinese: "Common Name (Chinese)",
        region: "Region",
        subregion: "Subregion",
        capital: "Capital",
        populationLabel: "Population",
        area: "Area",
        continents: "Continents",
        language: "Language",
        currency: "Currency",
        borders: "Borders",
        latLng: "Latitude/Longitude",
        capitalCoordinates: "Capital Coordinates",
        googleMaps: "Google Maps",
        openStreetMaps: "OpenStreet Maps",
        viewOnGoogleMaps: "View on Google Maps",
        viewOnOpenStreetMaps: "View on OpenStreet Maps",
        view: "View"
      },
      zh: {
        pageTitle: "国家信息",
        headerTitle: "交互式世界地图与国家统计数据",
        headerSubtitle: "将鼠标悬停在任何国家上以查看详细统计信息和数据",
        tabSvgView: "矢量视图",
        tabCardView: "卡片视图",
        tabMapView: "地图视图",
        statSelectorLabel: "选择要可视化的统计数据：",
        statSelectorDefault: "-- 选择统计数据 --",
        colorLegendTitle: "颜色比例：",
        legendLow: "低",
        legendHigh: "高",
        chartTitle: "国家统计数据",
        selectStatisticText: "选择统计数据以查看数据",
        topCountriesText: "前20个国家按",
        searchPlaceholder: "按国家代码、名称或中文名称搜索...",
        regionFilterDefault: "所有地区",
        subregionFilterDefault: "所有子地区",
        locationSearchPlaceholder: "按名称搜索位置（中文/英文）...",
        searchButton: "搜索",
        normalModeButton: "普通",
        satelliteModeButton: "卫星",
        loadingText: "正在加载国家数据...",
        noResultsText: "没有符合搜索条件的国家。请尝试不同的筛选条件。",
        searchLocationPlaceholder: "请输入要搜索的位置名称。",
        searchingText: "搜索中...",
        noLocationResultsText: "未找到搜索结果。请尝试不同的位置名称。",
        searchErrorText: "搜索位置时出错。请稍后再试。",
        searchTimeoutText: "搜索请求超时。请检查您的互联网连接并重试。",
        serverErrorText: "服务器错误。请稍后再试。",
        dataInterpretationTitle: "数据分析解读",
        dataInterpretationButton: "数据解读",
        dataInterpretationResultTitle: "数据分析结果",
        dataInterpretationLoading: "正在分析数据，请稍候...",
        dataInterpretationErrorTitle: "分析出错",
        dataInterpretationErrorMessage: "抱歉，数据分析过程中出现错误：",
        dataInterpretationErrorSuggestion: "请稍后再试或选择其他统计指标。",
        // Statistic names
        gdp: "GDP国内生产总值",
        sex_ratio: "性别比（男/女）",
        surface_area: "国土面积",
        life_expectancy_male: "预期寿命（男性）",
        unemployment: "失业率",
        imports: "进口金额",
        homicide_rate: "凶杀率",
        gdp_growth: "GDP增长",
        employment_services: "就业服务",
        urban_population_growth: "城市人口增长",
        secondary_school_enrollment_female: "中学入学（女性）",
        employment_agriculture: "农业就业",
        co2_emissions: "二氧化碳排放量",
        forested_area: "森林区",
        tourists: "游客",
        exports: "出口",
        life_expectancy_female: "预期寿命（女性）",
        post_secondary_enrollment_female: "高等教育入学（女性）",
        post_secondary_enrollment_male: "高等教育入学（男性）",
        primary_school_enrollment_female: "小学入学（女性）",
        infant_mortality: "婴儿死亡率",
        secondary_school_enrollment_male: "中学入学（男性）",
        threatened_species: "濒危物种",
        population: "人口",
        urban_population: "城市人口",
        employment_industry: "工业就业",
        pop_growth: "人口增长",
        pop_density: "人口密度",
        internet_users: "网民",
        gdp_per_capita: "人均GDP",
        fertility: "生育能力",
        refugees: "难民",
        primary_school_enrollment_male: "小学入学（男性）",

        // Modal labels
        countryCode: "国家代码",
        cca3: "CCA3代码",
        cioc: "CIOC代码",
        ccn3: "CCN3代码",
        officialName: "官方名称",
        commonName: "通用名称",
        officialNameChinese: "中文名称（官方）",
        commonNameChinese: "中文名称（通用）",
        region: "地区",
        subregion: "子地区",
        capital: "首都",
        populationLabel: "人口",
        area: "面积",
        continents: "大洲",
        language: "语言",
        currency: "货币",
        borders: "边境国家",
        latLng: "纬度/经度",
        capitalCoordinates: "首都坐标",
        googleMaps: "谷歌地图",
        openStreetMaps: "开放街道地图",
        viewOnGoogleMaps: "在谷歌地图上查看",
        viewOnOpenStreetMaps: "在开放街道地图上查看",
        view: "查看"
      }
    };
    
    // Current language (default: English)
    let currentLanguage = 'en';
    
    // Initialize language switcher
    function initLanguageSwitcher() {
      const langButtons = document.querySelectorAll('.lang-btn');
      
      langButtons.forEach(button => {
        button.addEventListener('click', () => {
          const lang = button.getAttribute('data-lang');
          if (lang !== currentLanguage) {
            // Update active button
            document.querySelector('.lang-btn.active').classList.remove('active');
            button.classList.add('active');
            
            // Update current language
            currentLanguage = lang;
            
            // Apply translations
            applyTranslations();
            
            // Save language preference
            localStorage.setItem('preferredLanguage', lang);
          }
        });
      });
      
      // Load saved language preference
      const savedLanguage = localStorage.getItem('preferredLanguage');
      if (savedLanguage && savedLanguage !== currentLanguage && translations[savedLanguage]) {
        currentLanguage = savedLanguage;
        document.querySelector('.lang-btn.active').classList.remove('active');
        document.querySelector(`.lang-btn[data-lang="${savedLanguage}"]`).classList.add('active');
        applyTranslations();
      }
    }
    
    // Apply translations to UI elements
    function applyTranslations() {
      const t = translations[currentLanguage];
      
      // Update page title
      document.title = t.pageTitle;
      
      // Update header
      document.querySelector('.header h1').textContent = t.headerTitle;
      document.querySelector('.header p').textContent = t.headerSubtitle;
      
      // Update tab buttons
      document.querySelector('[data-tab="svg-view"]').textContent = t.tabSvgView;
      document.querySelector('[data-tab="card-view"]').textContent = t.tabCardView;
      document.querySelector('[data-tab="map-view"]').textContent = t.tabMapView;
      
      // Update statistics selector
      document.querySelector('.stats-selector label').textContent = t.statSelectorLabel;
      const statSelect = document.getElementById('stat-select');
      if (statSelect) {
        statSelect.options[0].textContent = t.statSelectorDefault;
      }
      
      // Update color legend
      document.querySelector('.legend-title').textContent = t.colorLegendTitle;
      document.querySelector('.legend-low').textContent = t.legendLow;
      document.querySelector('.legend-high').textContent = t.legendHigh;
      
      // Update chart title
      document.querySelector('.chart-header h3').textContent = t.chartTitle;
      
      // Update search and filters
      document.getElementById('country-search').placeholder = t.searchPlaceholder;
      const regionFilter = document.getElementById('region-filter');
      if (regionFilter && regionFilter.options[0]) {
        regionFilter.options[0].textContent = t.regionFilterDefault;
      }
      const subregionFilter = document.getElementById('subregion-filter');
      if (subregionFilter && subregionFilter.options[0]) {
        subregionFilter.options[0].textContent = t.subregionFilterDefault;
      }
      
      // Update map view
      document.getElementById('location-search').placeholder = t.locationSearchPlaceholder;
      document.getElementById('search-button').textContent = t.searchButton;
      document.getElementById('normal-mode-btn').textContent = t.normalModeButton;
      document.getElementById('satellite-mode-btn').textContent = t.satelliteModeButton;
      
      // Update data interpretation section
      const interpretationHeader = document.querySelector('.interpretation-header h3');
      if (interpretationHeader) {
        interpretationHeader.textContent = t.dataInterpretationTitle;
      }
      
      const interpretationBtn = document.getElementById('interpretation-btn');
      if (interpretationBtn) {
        interpretationBtn.textContent = t.dataInterpretationButton;
      }
      
      // Update statistics dropdown options
      updateStatisticsDropdownOptions();
      
      // Update chart titles if chart is initialized
      if (barChart) {
        if (selectedStatistic) {
          updateBarChart();
        } else {
          clearBarChart();
        }
      }
    }
    
    // Update statistics dropdown options with translations
    function updateStatisticsDropdownOptions() {
      const statSelect = document.getElementById('stat-select');
      if (!statSelect) return;
      
      const t = translations[currentLanguage];
      
      // Update each option (skip the first default option)
      for (let i = 1; i < statSelect.options.length; i++) {
        const option = statSelect.options[i];
        const statKey = option.value;
        if (t[statKey]) {
          option.textContent = t[statKey];
        }
      }
    }
    
    // Global variable to store country statistics
    let countryStats = {};
    // Global variable to store available statistics
    let availableStats = [];
    // Global variable to store the currently selected statistic
    let selectedStatistic = '';
    // Sample data for testing - we'll replace this with the full JSON loading later
    const sampleCountryStats = {
      "US": {
        "name": "United States",
        "region": "Northern America",
        "gdp": 21433226.0,
        "population": 331002.0,
        "gdp_per_capita": 65280.0,
        "life_expectancy_male": 76.3,
        "life_expectancy_female": 81.3,
        "unemployment": 3.9,
        "forested_area": 33.9
      },
      "CN": {
        "name": "China",
        "region": "Eastern Asia",
        "gdp": 14342903.0,
        "population": 1439324.0,
        "gdp_per_capita": 9961.0,
        "life_expectancy_male": 75.0,
        "life_expectancy_female": 77.9,
        "unemployment": 3.8,
        "forested_area": 22.3
      },
      "DE": {
        "name": "Germany",
        "region": "Western Europe",
        "gdp": 3845630.0,
        "population": 83784.0,
        "gdp_per_capita": 45888.0,
        "life_expectancy_male": 78.7,
        "life_expectancy_female": 83.4,
        "unemployment": 3.2,
        "forested_area": 32.7
      },
      "JP": {
        "name": "Japan",
        "region": "Eastern Asia",
        "gdp": 5081770.0,
        "population": 125508.0,
        "gdp_per_capita": 40498.0,
        "life_expectancy_male": 81.6,
        "life_expectancy_female": 87.3,
        "unemployment": 2.4,
        "forested_area": 68.5
      },
      "AU": {
        "name": "Australia",
        "region": "Oceania",
        "gdp": 1453871.0,
        "population": 25500.0,
        "gdp_per_capita": 58392.7,
        "life_expectancy_male": 81.2,
        "life_expectancy_female": 85.2,
        "unemployment": 5.3,
        "forested_area": 16.2
      }
    };
    
    // Function to load country statistics from JSON
    async function loadCountryStats() {
      try {
        console.log('Attempting to load country statistics...');
        const response = await fetch('/assets/data/geography/country_stats.json');
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        countryStats = await response.json();
        console.log('Country statistics loaded successfully. Sample data:', Object.keys(countryStats).slice(0, 5));
        
        // Extract available statistics from the first country
        if (Object.keys(countryStats).length > 0) {
          const firstCountry = Object.keys(countryStats)[0];
          console.log('First country:', firstCountry);
          console.log('First country data:', countryStats[firstCountry]);
          
          availableStats = Object.keys(countryStats[firstCountry])
            .filter(key => !['name', 'region'].includes(key)); // Exclude non-numeric fields
          
          console.log('Available statistics:', availableStats);
          
          // Populate the dropdown with available statistics
          populateStatsDropdown();
        } else {
          console.error('No country data found');
        }
      } catch (error) {
        console.error('Error loading country statistics:', error);
        console.log('Using sample data for testing');
        // Use sample data for testing
        countryStats = sampleCountryStats;
        
        // Extract available statistics from the sample data
        const firstCountry = Object.keys(sampleCountryStats)[0];
        console.log('Sample first country:', firstCountry);
        console.log('Sample first country data:', sampleCountryStats[firstCountry]);
        
        availableStats = Object.keys(sampleCountryStats[firstCountry])
          .filter(key => !['name', 'region'].includes(key)); // Exclude non-numeric fields
        
        console.log('Available statistics from sample data:', availableStats);
        
        // Populate the dropdown with available statistics
        populateStatsDropdown();
      }
    }
    
    // Function to populate the statistics dropdown
    function populateStatsDropdown() {
      console.log('Populating dropdown with available stats:', availableStats);
      
      const selectElement = document.getElementById('stat-select');
      if (!selectElement) {
        console.error('Dropdown element not found');
        return;
      }
      
      // Clear existing options except the default one
      while (selectElement.options.length > 1) {
        selectElement.remove(1);
      }
      
      // Get current language translations
      const t = translations[currentLanguage];
      
      // Add new options for each available statistic (sorted alphabetically)
      availableStats.sort().forEach(stat => {
        const option = document.createElement('option');
        option.value = stat;
        // Use translated statistic name if available, otherwise format the statistic name for display
        option.textContent = t[stat] || stat.split('_').map(word => 
          word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
        selectElement.appendChild(option);
        console.log('Added option:', stat);
      });
      
      // Add event listener for selection changes
      selectElement.addEventListener('change', handleStatisticSelection);
      console.log('Dropdown populated with', availableStats.length, 'options');
    }
    
    // Function to handle statistic selection
    function handleStatisticSelection() {
      const selectElement = document.getElementById('stat-select');
      selectedStatistic = selectElement.value;
      
      console.log('Selected statistic:', selectedStatistic);
      
      if (selectedStatistic) {
        // Apply color scale to the map based on the selected statistic
        applyColorScale();
        // Update the bar chart with the selected statistic
        updateBarChart();
      } else {
        // Reset the map colors if no statistic is selected
        resetMapColors();
        // Clear the bar chart if no statistic is selected
        clearBarChart();
      }
    }
    
    // Function to apply color scale based on selected statistic
    function applyColorScale() {
      if (!selectedStatistic || Object.keys(countryStats).length === 0) {
        console.log('Cannot apply color scale: no statistic selected or no data available');
        return;
      }
      
      console.log('Applying color scale for statistic:', selectedStatistic);
      
      // Find min and max values for the selected statistic
      let minValue = Infinity;
      let maxValue = -Infinity;
      
      Object.values(countryStats).forEach(country => {
        const value = country[selectedStatistic];
        if (value !== undefined && value !== null) {
          minValue = Math.min(minValue, value);
          maxValue = Math.max(maxValue, value);
        }
      });
      
      console.log(`Value range for ${selectedStatistic}: ${minValue} to ${maxValue}`);
      
      // Update the legend values
      document.getElementById('legend-min').textContent = formatLegendValue(minValue);
      document.getElementById('legend-max').textContent = formatLegendValue(maxValue);
      
      // Apply colors to each country path
      const paths = document.querySelectorAll('path[class*="highcharts-key-"]');
      
      paths.forEach(path => {
        // Extract country code from classes
        const classes = path.className.baseVal.split(' ');
        const keyClass = classes.find(cls => cls.startsWith('highcharts-key-'));
        
        if (keyClass) {
          let countryCode = keyClass.replace('highcharts-key-', '').toUpperCase();
          
          // Get the value for this country
          const countryData = countryStats[countryCode];
          if (countryData && countryData[selectedStatistic] !== undefined) {
            const value = countryData[selectedStatistic];
            
            // Calculate color based on value (0-100 scale)
            const normalizedValue = (value - minValue) / (maxValue - minValue);
            const colorValue = Math.round(normalizedValue * 100);
            
            // Generate color from blue (low) to red (high)
            const color = getColorForValue(colorValue);
            
            // Apply the color to the path
            path.style.fill = color;
            
            // Store the original fill color if not already stored
            if (!path.dataset.originalFill) {
              path.dataset.originalFill = path.style.fill || '';
            }
          } else {
            // If no data for this country, use a neutral color
            path.style.fill = '#cccccc';
          }
        }
      });
    }
    
    // Function to format legend values
    function formatLegendValue(value) {
      // Display raw numerical value without any formatting or units
      return value.toString();
    }
    
    // Function to reset map colors
    function resetMapColors() {
      const paths = document.querySelectorAll('path[class*="highcharts-key-"]');
      
      paths.forEach(path => {
        // Restore original fill color if it was stored
        if (path.dataset.originalFill) {
          path.style.fill = path.dataset.originalFill;
        } else {
          // Default color if no original was stored
          path.style.fill = '';
        }
      });
    }
    
    // Function to get color based on value (0-100)
 function getColorForValue(value) {
   // Clamp value between 0 and 100
   value = Math.max(0, Math.min(100, value));
   
   // Define color stops for our multi-color gradient
   // Each color stop is at a specific position (0-100) and has an RGB value
   const colorStops = [
     { pos: 0, r: 255, g: 255, b: 200 },   // Light yellow
     { pos: 17, r: 155, g: 255, b: 155 },  // Light green
     { pos: 33, r: 155, g: 255, b: 255 },  // Light cyan
     { pos: 50, r: 155, g: 155, b: 255 },  // Light blue
     { pos: 67, r: 255, g: 192, b: 203 },  // Pink
     { pos: 83, r: 255, g: 165, b: 0 },    // Orange
     { pos: 100, r: 255, g: 0, b: 0 }      // Red
   ];
   
   // Find the two color stops that our value falls between
   let lowerStop = colorStops[0];
   let upperStop = colorStops[colorStops.length - 1];
   
   for (let i = 0; i < colorStops.length - 1; i++) {
     if (value >= colorStops[i].pos && value <= colorStops[i + 1].pos) {
       lowerStop = colorStops[i];
       upperStop = colorStops[i + 1];
       break;
     }
   }
   
   // Calculate the position between the two stops
   const segmentRange = upperStop.pos - lowerStop.pos;
   const segmentPos = (value - lowerStop.pos) / segmentRange;
   
   // Interpolate between the two colors
   const r = Math.round(lowerStop.r + (upperStop.r - lowerStop.r) * segmentPos);
   const g = Math.round(lowerStop.g + (upperStop.g - lowerStop.g) * segmentPos);
   const b = Math.round(lowerStop.b + (upperStop.b - lowerStop.b) * segmentPos);
   
   return `rgb(${r}, ${g}, ${b})`;
 }
    
    // Function to load SVG from file path
    async function loadSVGFromPath() {
      try {
        console.log('loadSVGFromPath function called');
        console.log('Attempting to load SVG from: /assets/data/geography/world_countries.svg');
        const response = await fetch('/assets/data/geography/world_countries.svg');
        console.log('SVG Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const svgContent = await response.text();
        console.log('SVG content length:', svgContent.length);
        
        // Inject SVG content into the container
        const svgContainer = document.getElementById('svg-container');
        if (!svgContainer) {
          console.error('SVG container not found');
          return;
        }
        svgContainer.innerHTML = svgContent;
        console.log('SVG content injected into container');
        
        // Initialize tooltip functionality after SVG is loaded
        console.log('SVG loaded, initializing tooltips...');
        initializeTooltips();
        
        // Reapply color scale if a statistic is already selected
        if (selectedStatistic) {
          console.log('Reapplying color scale for selected statistic:', selectedStatistic);
          applyColorScale();
        }
      } catch (error) {
        console.error('Error loading SVG:', error);
        const svgContainer = document.getElementById('svg-container');
        if (svgContainer) {
          svgContainer.innerHTML = '<p>Error loading map. Please try again later.</p>';
        }
      }
    }
    
    // Function to format statistics for display
function formatCountryStats(countryCode) {
  console.log('Formatting stats for country code:', countryCode);
  const stats = countryStats[countryCode];
  console.log('Stats found:', stats ? 'Yes' : 'No');
  if (!stats) return `No data available for ${countryCode}`;
  
  // Always display country and region
  const formattedStats = [
    `Country: ${stats.name || 'N/A'}`,
    `Region: ${stats.region || 'N/A'}`
  ];
  
  // If a statistic is selected, display only that value
  if (selectedStatistic) {
    const value = stats[selectedStatistic];
    if (value !== undefined) {
      // Format the statistic name for display
      const statName = selectedStatistic.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
      
      formattedStats.push(`${statName}: ${value}`);
    } else {
      // Format the statistic name for display
      const statName = selectedStatistic.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
      
      formattedStats.push(`${statName}: No data available`);
    }
  }
  
  const result = formattedStats.join('<br>');
  console.log('Formatted stats:', result);
  return result;
}
    
    // Function to initialize the ECharts bar chart
    let barChart = null;
    
    function initializeBarChart() {
      console.log('Initializing bar chart...');
      
      // Check if ECharts library is loaded
      if (typeof echarts === 'undefined') {
        console.error('ECharts library is not loaded');
        const chartDom = document.getElementById('bar-chart');
        if (chartDom) {
          chartDom.innerHTML = '<p>Error: ECharts library not loaded. Please refresh the page.</p>';
        }
        return;
      }
      
      const chartDom = document.getElementById('bar-chart');
      if (!chartDom) {
        console.error('Bar chart container not found');
        return;
      }
      
      console.log('Bar chart container found, checking if already initialized...');
      
      // Check if the container is visible and has dimensions
      const containerRect = chartDom.getBoundingClientRect();
      console.log('Bar chart container dimensions:', containerRect);
      console.log('Bar chart container visibility:', chartDom.offsetParent !== null);
      
      // If the container has no dimensions or is not visible, try to set a minimum height
      if (containerRect.width === 0 || containerRect.height === 0 || chartDom.offsetParent === null) {
        console.warn('Bar chart container has no dimensions or is not visible, setting minimum height');
        chartDom.style.height = '400px';
        chartDom.style.width = '100%';
        
        // Force a reflow to ensure the dimensions are applied
        chartDom.offsetHeight;
        
        // If the container is still not visible, delay initialization
        if (chartDom.offsetParent === null) {
          console.log('Bar chart container is still not visible, delaying initialization...');
          setTimeout(() => {
            console.log('Retrying bar chart initialization...');
            initializeBarChart();
          }, 500);
          return;
        }
      }
      
      // If chart is already initialized, just resize it
      if (barChart) {
        console.log('Bar chart already initialized, resizing...');
        barChart.resize();
        return;
      }
      
      // Clear any loading state
      chartDom.innerHTML = '';
      
      // Initialize ECharts instance
      try {
        barChart = echarts.init(chartDom);
        console.log('Bar chart initialized successfully');
      } catch (error) {
        console.error('Error initializing bar chart:', error);
        chartDom.innerHTML = '<p>Error initializing chart. Please refresh the page.</p>';
        return;
      }
      
      // Set initial empty chart
      const t = translations[currentLanguage];
      const option = {
        title: {
          text: t.selectStatisticText,
          left: 'center'
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: [],
          axisLabel: {
            interval: 0,
            rotate: 30
          }
        },
        yAxis: {
          type: 'value'
        },
        series: [{
          name: 'Value',
          type: 'bar',
          data: []
        }]
      };
      
      try {
        barChart.setOption(option);
        console.log('Bar chart options set successfully');
        
        // Force a resize after a short delay to ensure the container is properly sized
        setTimeout(() => {
          if (barChart) {
            console.log('Forcing resize after initialization...');
            barChart.resize();
          }
        }, 100);
      } catch (error) {
        console.error('Error setting bar chart options:', error);
        chartDom.innerHTML = '<p>Error setting up chart. Please refresh the page.</p>';
      }
      
      // Add resize handler for responsive design
      window.addEventListener('resize', function() {
        if (barChart) {
          console.log('Resizing bar chart...');
          barChart.resize();
        }
      });
    }
    
    // Function to update the bar chart with the selected statistic
    function updateBarChart() {
      console.log('updateBarChart called');
      
      if (!barChart) {
        console.log('Bar chart not initialized, initializing now...');
        initializeBarChart();
        
        // If initialization failed, return
        if (!barChart) {
          console.error('Failed to initialize bar chart');
          return;
        }
      }
      
      if (!selectedStatistic || Object.keys(countryStats).length === 0) {
        console.log('Cannot update bar chart: no statistic selected or no data available');
        console.log('Selected statistic:', selectedStatistic);
        console.log('Country stats keys:', Object.keys(countryStats).length);
        return;
      }
      
      console.log('Updating bar chart for statistic:', selectedStatistic);
      
      // Get the top 20 countries for the selected statistic
      const countries = Object.entries(countryStats)
        .filter(([code, data]) => data[selectedStatistic] !== undefined && data[selectedStatistic] !== null)
        .sort((a, b) => b[1][selectedStatistic] - a[1][selectedStatistic])
        .slice(0, 20);
      
      console.log('Filtered countries for chart:', countries.length);
      
      if (countries.length === 0) {
        console.log('No data available for the selected statistic');
        clearBarChart();
        return;
      }
      
      // Extract country names and values for the chart
      const countryNames = countries.map(([code, data]) => data.name || code);
      const values = countries.map(([code, data]) => data[selectedStatistic]);
      
      // Format the statistic name for display
      const t = translations[currentLanguage];
      const statName = t[selectedStatistic] || selectedStatistic.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
      
      console.log('Chart data prepared:', { countryNames: countryNames.length, values: values.length, statName });
      
      // Update chart info
      const chartInfo = document.getElementById('chart-info');
      
      // Set chart options
      const option = {
        title: {
          text: `${t.topCountriesText} ${statName}`,
          left: 'center'
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            const countryName = params[0].axisValue;
            const value = params[0].value;
            return `${countryName}<br/>${statName}: ${value}`;
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '15%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: countryNames,
          axisLabel: {
            interval: 0,
            rotate: 45,
            fontSize: 10
          }
        },
        yAxis: {
          type: 'value',
          name: statName
        },
        series: [{
          name: statName,
          type: 'bar',
          data: values,
          itemStyle: {
            color: function(params) {
              // Use the same color scale as the map
              const allValues = Object.values(countryStats)
                .map(country => country[selectedStatistic])
                .filter(val => val !== undefined && val !== null);
              
              if (allValues.length === 0) return '#cccccc';
              
              const minValue = Math.min(...allValues);
              const maxValue = Math.max(...allValues);
              const normalizedValue = (params.value - minValue) / (maxValue - minValue);
              const colorValue = Math.round(normalizedValue * 100);
              
              return getColorForValue(colorValue);
            }
          }
        }]
      };
      
      try {
        barChart.setOption(option);
        console.log('Bar chart updated successfully with', countries.length, 'countries');
      } catch (error) {
        console.error('Error updating bar chart:', error);
      }
    }
    
    // Function to clear the bar chart
    function clearBarChart() {
      if (!barChart) {
        console.log('Bar chart not initialized');
        return;
      }
      
      console.log('Clearing bar chart');
      
      // Clear chart info
      const chartInfo = document.getElementById('chart-info');
      if (chartInfo) {
        chartInfo.textContent = '';
      }
      
      // Set empty chart options
      const t = translations[currentLanguage];
      const option = {
        title: {
          text: t.selectStatisticText,
          left: 'center'
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: []
        },
        yAxis: {
          type: 'value'
        },
        series: [{
          name: 'Value',
          type: 'bar',
          data: []
        }]
      };
      
      barChart.setOption(option);
    }
    
    // Function to initialize tooltips after SVG is loaded
function initializeTooltips() {
  console.log('Initializing tooltips...');
  console.log('Country stats available:', Object.keys(countryStats).length);
  console.log('ECharts library available:', typeof echarts !== 'undefined');
  
  const tooltip = document.getElementById('tooltip');
  const paths = document.querySelectorAll('path[class*="highcharts-key-"]');
  
  console.log('Found', paths.length, 'country paths');
  
  // Initialize bar chart if not already initialized
  if (!barChart && typeof echarts !== 'undefined') {
    console.log('Initializing bar chart from initializeTooltips...');
    initializeBarChart();
  }
  
  paths.forEach(path => {
        path.addEventListener('mouseenter', function(e) {
          // Extract country code from classes
          const classes = this.className.baseVal.split(' ');
          const keyClass = classes.find(cls => cls.startsWith('highcharts-key-'));
          
          if (keyClass) {
            let countryCode = keyClass.replace('highcharts-key-', '');
            // Convert to uppercase to match the countryStats keys
            countryCode = countryCode.toUpperCase();
            console.log('Hovering over country:', countryCode);
            console.log('Country stats available for this country:', countryStats[countryCode] ? 'Yes' : 'No');
            
            // Get country name from the name class if available
            const nameClass = classes.find(cls => cls.startsWith('highcharts-name-'));
            let countryName = '';
            if (nameClass) {
              countryName = nameClass.replace('highcharts-name-', '').replace(/-/g, ' ');
              countryName = countryName.replace(/\b\w/g, l => l.toUpperCase());
            }
            
            console.log('Country name:', countryName || 'Not available');
            
            // Format the tooltip content with country statistics
            let tooltipContent = '';
            if (countryName) {
              tooltipContent = `<strong>${countryName} (${countryCode})</strong><br>`;
            } else {
              tooltipContent = `<strong>${countryCode}</strong><br>`;
            }
            
            tooltipContent += formatCountryStats(countryCode);
            
            // Display the tooltip
            tooltip.innerHTML = tooltipContent;
            tooltip.style.display = 'block';
            console.log('Tooltip displayed');
            
            // Add hover effect
            this.classList.add('country-hover');
          }
        });
        
        path.addEventListener('mousemove', function(e) {
          tooltip.style.left = e.clientX + 10 + 'px';
          tooltip.style.top = e.clientY + 10 + 'px';
        });
        
        path.addEventListener('mouseleave', function() {
          tooltip.style.display = 'none';
          this.classList.remove('country-hover');
        });
      });
    }
    
    // Load data and SVG when page loads
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOM content loaded, starting initialization...');
      
      // Initialize language switcher first
      initLanguageSwitcher();
      
      // Initialize tabs
      initializeTabs();
      
      // Show loading state for charts
      const chartContainer = document.getElementById('bar-chart');
      if (chartContainer) {
        chartContainer.innerHTML = `
          <div class="chart-loading">
            <div class="loading-container">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading chart library...</div>
            </div>
          </div>
        `;
      }
      
      // Load country statistics and SVG map
      await loadCountryStats();
      loadSVGFromPath();
      
      // Ensure SVG tab is active before initializing bar chart
      const svgTab = document.querySelector('.tab-button[data-tab="svg-view"]');
      if (svgTab && !svgTab.classList.contains('active')) {
        console.log('Activating SVG tab...');
        svgTab.click();
      }
      
      // Initialize ECharts after a short delay to ensure the container is properly sized
      console.log('Initializing ECharts after a short delay...');
      setTimeout(() => {
        initializeBarChart();
      }, 300);
      
      // Initialize data interpretation functionality
      initializeDataInterpretation();
    });
    
    // Function to initialize ECharts when the library is ready
    function initializeEChartsWhenReady() {
      console.log('Checking if ECharts is ready...');
      
      if (typeof echarts !== 'undefined') {
        console.log('ECharts library is loaded, initializing...');
        initializeBarChart();
      } else {
        console.log('ECharts library not yet loaded, setting up listener...');
        // Set up a listener for when ECharts loads
        const checkEChartsInterval = setInterval(() => {
          if (typeof echarts !== 'undefined') {
            clearInterval(checkEChartsInterval);
            console.log('ECharts library detected, initializing...');
            initializeBarChart();
          }
        }, 100);
        
        // Fallback timeout in case ECharts never loads
        setTimeout(() => {
          clearInterval(checkEChartsInterval);
          if (typeof echarts === 'undefined') {
            console.error('ECharts library failed to load');
            const chartContainer = document.getElementById('bar-chart');
            if (chartContainer) {
              chartContainer.innerHTML = '<p>Error: ECharts library failed to load. Please refresh the page.</p>';
            }
          }
        }, 10000); // 10 second timeout
      }
    }
    
    // Function to test dropdown population
    function testDropdown() {
      console.log('Test dropdown function called');
      console.log('Country stats available:', Object.keys(countryStats).length);
      
      if (Object.keys(countryStats).length > 0) {
        const firstCountry = Object.keys(countryStats)[0];
        console.log('First country:', firstCountry);
        console.log('First country data:', countryStats[firstCountry]);
        
        availableStats = Object.keys(countryStats[firstCountry])
          .filter(key => !['name', 'region'].includes(key)); // Exclude non-numeric fields
        
        console.log('Available statistics:', availableStats);
        
        // Populate the dropdown with available statistics
        populateStatsDropdown();
      } else {
        console.error('No country data found');
        alert('No country data found');
      }
    }
    
    // Tab functionality
    function initializeTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          // Remove active class from all buttons and panes
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
          
          // Add active class to clicked button
          button.classList.add('active');
          
          // Show corresponding tab pane
          const tabId = button.getAttribute('data-tab');
          const tabPane = document.getElementById(tabId);
          if (tabPane) {
            tabPane.classList.add('active');
            
            // Show/hide data interpretation container based on selected tab
            const dataInterpretationContainer = document.getElementById('data-interpretation-container');
            if (dataInterpretationContainer) {
              if (tabId === 'svg-view') {
                dataInterpretationContainer.style.display = 'block';
              } else {
                dataInterpretationContainer.style.display = 'none';
              }
            }
            
            // If card view is selected, initialize it
            if (tabId === 'card-view') {
              initializeCardView();
            }
            
            // If map view is selected, initialize it
            if (tabId === 'map-view') {
              initializeMap();
            }
            
            // If SVG view is selected, initialize the bar chart
            if (tabId === 'svg-view') {
              console.log('SVG view tab selected, checking bar chart...');
              // Initialize bar chart if ECharts is ready
              if (typeof echarts !== 'undefined') {
                initializeBarChart();
                // If a statistic is already selected, update the chart
                if (selectedStatistic) {
                  updateBarChart();
                }
                // Force a resize after a short delay to ensure the container is properly sized
                setTimeout(() => {
                  if (barChart) {
                    console.log('Forcing resize after tab switch...');
                    barChart.resize();
                  }
                }, 100);
              } else {
                console.log('ECharts not ready yet, will initialize when loaded');
                // The chart will be initialized when ECharts loads via initializeEChartsWhenReady
              }
            }
          }
        });
      });
    }
    
    // Global variable to store country basics data
    let countryBasics = {};
    
    // Function to load country basics from JSON
    async function loadCountryBasics() {
      try {
        console.log('Attempting to load country basics...');
        const response = await fetch('/assets/data/geography/country_basics.json');
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        countryBasics = await response.json();
        console.log('Country basics loaded successfully. Sample data:', Object.keys(countryBasics).slice(0, 5));
        
        // Populate region and subregion filters
        populateFilters();
        
        // Initialize card view
        populateCardView();
      } catch (error) {
        console.error('Error loading country basics:', error);
        const cardContainer = document.querySelector('.card-container');
        if (cardContainer) {
          cardContainer.innerHTML = '<p>Error loading country data. Please try again later.</p>';
        }
      }
    }
    
    // Function to populate region and subregion filters
    function populateFilters() {
      const regions = new Set();
      const subregions = new Set();
      
      Object.values(countryBasics).forEach(country => {
        if (country.region && country.region !== "NaN") {
          regions.add(country.region);
        }
        if (country.subregion && country.subregion !== "NaN") {
          subregions.add(country.subregion);
        }
      });
      
      // Get current language translations
      const t = translations[currentLanguage];
      
      // Populate region filter
      const regionFilter = document.getElementById('region-filter');
      // Keep the default "All Regions" option
      Array.from(regions).sort().forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionFilter.appendChild(option);
      });
      
      // Populate subregion filter
      const subregionFilter = document.getElementById('subregion-filter');
      // Keep the default "All Subregions" option
      Array.from(subregions).sort().forEach(subregion => {
        const option = document.createElement('option');
        option.value = subregion;
        option.textContent = subregion;
        subregionFilter.appendChild(option);
      });
    }
    
    // Function to populate card view
    function populateCardView() {
      console.log('Populating card view...');
      const cardContainer = document.querySelector('.card-container');
      if (!cardContainer) {
        console.error('Card container not found');
        return;
      }
      
      // Get current language translations
      const t = translations[currentLanguage];
      
      // Clear existing cards
      cardContainer.innerHTML = '';
      
      // If countryBasics is empty, show loading message
      if (Object.keys(countryBasics).length === 0) {
        cardContainer.innerHTML = `<p>${t.loadingText}</p>`;
        return;
      }
      
      const searchTerm = document.getElementById('country-search').value.toLowerCase();
      const regionFilter = document.getElementById('region-filter').value;
      const subregionFilter = document.getElementById('subregion-filter').value;
      
      console.log('Filters applied:', { searchTerm, regionFilter, subregionFilter });
      
      let visibleCards = 0;
      
      Object.entries(countryBasics).forEach(([code, country]) => {
        // Apply filters
        if (searchTerm && !matchesSearch(country, searchTerm)) {
          return;
        }
        
        if (regionFilter && country.region !== regionFilter) {
          return;
        }
        
        if (subregionFilter && country.subregion !== subregionFilter) {
          return;
        }
        
        // Create card
        const card = document.createElement('div');
        card.className = 'country-card';
        card.dataset.countryCode = code;
        
        // Card content
        card.innerHTML = `
          <div class="country-name">${country['name.official.chn'] || country['name.common'] || code}</div>
          <div class="country-flag-container">
            <img class="country-flag" src="${country['flags.svg'] || ''}" alt="${country['name.common'] || code} flag" loading="lazy">
          </div>
          <div class="country-info">
            <div class="country-common-name"><strong>${country['name.common'] || code}</strong></div>
            <div class="country-capital">${t.capital}: ${country.capital || 'N/A'}</div>
          </div>
        `;
        
        // Add click event to show modal
        card.addEventListener('click', () => showCountryModal(code, country));
        
        cardContainer.appendChild(card);
        visibleCards++;
      });
      
      console.log(`Displayed ${visibleCards} country cards`);
      
      // If no cards match the filters, show a message
      if (visibleCards === 0) {
        cardContainer.innerHTML = `<p>${t.noResultsText}</p>`;
      }
    }
    
    // Function to check if country matches search term
    function matchesSearch(country, searchTerm) {
      return (
        (country.cca3 && country.cca3.toLowerCase().includes(searchTerm)) ||
        (country.cioc && country.cioc.toLowerCase().includes(searchTerm)) ||
        (country['name.common'] && country['name.common'].toLowerCase().includes(searchTerm)) ||
        (country['name.official'] && country['name.official'].toLowerCase().includes(searchTerm)) ||
        (country['name.common.chn'] && country['name.common.chn'].toLowerCase().includes(searchTerm)) ||
        (country['name.official.chn'] && country['name.official.chn'].toLowerCase().includes(searchTerm))
      );
    }
    
    // Function to show country modal
    function showCountryModal(code, country) {
      const modal = document.getElementById('country-modal');
      const modalFlag = document.getElementById('modal-flag');
      const modalTitle = document.getElementById('modal-title');
      const modalCoatOfArms = document.getElementById('modal-coat-of-arms');
      const modalDetails = document.getElementById('modal-details');
      
      // Get current language translations
      const t = translations[currentLanguage];
      
      // Set modal content
      modalFlag.src = country['flags.svg'] || '';
      modalFlag.alt = `${country['name.common'] || code} flag`;
      modalTitle.textContent = country['name.official.chn'] || country['name.common'] || code;
      
      // Set Coat of Arms
      if (country['coatOfArms.svg'] && country['coatOfArms.svg'] !== "NaN") {
        modalCoatOfArms.innerHTML = `<img src="${country['coatOfArms.svg']}" alt="${country['name.common'] || code} Coat of Arms">`;
        modalCoatOfArms.style.display = 'flex';
      } else {
        modalCoatOfArms.innerHTML = '';
        modalCoatOfArms.style.display = 'none';
      }
      
      // Clear and populate details
      modalDetails.innerHTML = '';
      
      // Helper function to add detail item
      function addDetail(label, value) {
        if (value && value !== "NaN") {
          const item = document.createElement('div');
          item.className = 'detail-item';
          item.innerHTML = `
            <span class="detail-label">${label}:</span>
            <span class="detail-value">${value}</span>
          `;
          modalDetails.appendChild(item);
        }
      }
      
      // Helper function to add clickable link
      function addLink(label, url, linkText) {
        if (url && url !== "NaN") {
          const item = document.createElement('div');
          item.className = 'detail-item';
          item.innerHTML = `
            <span class="detail-label">${label}:</span>
            <span class="detail-value"><a href="${url}" target="_blank">${linkText || t.view}</a></span>
          `;
          modalDetails.appendChild(item);
        }
      }
      
      // Helper function to add image
      function addImage(label, src, alt) {
        if (src && src !== "NaN") {
          const item = document.createElement('div');
          item.className = 'detail-item';
          item.innerHTML = `
            <span class="detail-label">${label}:</span>
            <span class="detail-value"><img src="${src}" alt="${alt}" style="max-width: 100px; max-height: 100px; border: 1px solid #ddd; border-radius: 4px;"></span>
          `;
          modalDetails.appendChild(item);
        }
      }
      
      // Add all country details with translated labels
      addDetail(t.countryCode, code);
      addDetail(t.cca3, country.cca3);
      addDetail(t.cioc, country.cioc);
      addDetail(t.ccn3, country.ccn3);
      addDetail(t.officialName, country['name.official']);
      addDetail(t.commonName, country['name.common']);
      addDetail(t.officialNameChinese, country['name.official.chn']);
      addDetail(t.commonNameChinese, country['name.common.chn']);
      addDetail(t.region, country.region);
      addDetail(t.subregion, country.subregion);
      addDetail(t.capital, country.capital);
      addDetail(t.populationLabel, country.population ? country.population.toLocaleString() : '');
      addDetail(t.area, country.area ? `${country.area.toLocaleString()} km²` : '');
      addDetail(t.continents, country.continents);
      addDetail(t.language, country.language);
      addDetail(t.currency, country.currency);
      addDetail(t.borders, country.borders);
      addDetail(t.latLng, country.latlng);
      addDetail(t.capitalCoordinates, country['capitalInfo.latlng']);
      
      // Add map links
      addLink(t.googleMaps, country['maps.googleMaps'], t.viewOnGoogleMaps);
      addLink(t.openStreetMaps, country['maps.openStreetMaps'], t.viewOnOpenStreetMaps);
      
      // Show modal
      modal.style.display = 'block';
    }
    
    // Initialize card view when tab is activated
    function initializeCardView() {
      console.log('Initializing card view...');
      
      // Add event listeners for search and filters
      document.getElementById('country-search').addEventListener('input', populateCardView);
      document.getElementById('region-filter').addEventListener('change', populateCardView);
      document.getElementById('subregion-filter').addEventListener('change', populateCardView);
      
      // Modal close functionality
      const modal = document.getElementById('country-modal');
      const closeBtn = document.querySelector('.close');
      
      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });
      
      window.addEventListener('click', (event) => {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
      
      // Load country basics data if not already loaded
      if (Object.keys(countryBasics).length === 0) {
        loadCountryBasics();
      } else {
        // If data is already loaded, populate the card view
        populateCardView();
      }
    }
    
    // Initialize tabs when page loads
    // Note: Tabs initialization is now handled in the main DOMContentLoaded event above
    
    // Map functionality
    let map;
    let markers = [];
    let currentMapMode = 'satellite';
    
    // Initialize map when map tab is activated
    function initializeMap() {
      console.log('Initializing map...');
      
      // Check if map is already initialized
      if (map) {
        return;
      }
      
      // Initialize the map with a default view
      map = L.map('map').setView([30, 0], 2);
      
      // Add the default tile layer (satellite mode)
      updateMapTileLayer('satellite');
      
      // Add event listeners for map controls
      document.getElementById('search-button').addEventListener('click', performLocationSearch);
      document.getElementById('location-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performLocationSearch();
        }
      });
      
      // Add event listeners for map mode toggle buttons
      document.getElementById('normal-mode-btn').addEventListener('click', function() {
        setMapMode('normal');
      });
      
      document.getElementById('satellite-mode-btn').addEventListener('click', function() {
        setMapMode('satellite');
      });
    }
    
    // Update map tile layer based on mode
    function updateMapTileLayer(mode) {
      if (!map) return;
      
      // Remove existing tile layers
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer) {
          map.removeLayer(layer);
        }
      });
      
      // Add new tile layer based on mode
      if (mode === 'normal') {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
      } else if (mode === 'satellite') {
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
          maxZoom: 19
        }).addTo(map);
      }
    }
    
// Set map mode and update UI
    function setMapMode(mode) {
      if (!map) return;
      
      // Update current map mode
      currentMapMode = mode;
      
      // Update tile layer
      updateMapTileLayer(mode);
      
      // Update button states
      const normalBtn = document.getElementById('normal-mode-btn');
      const satelliteBtn = document.getElementById('satellite-mode-btn');
      
      if (mode === 'normal') {
        normalBtn.classList.add('active');
        satelliteBtn.classList.remove('active');
      } else {
        normalBtn.classList.remove('active');
        satelliteBtn.classList.add('active');
      }
    }
    
    // Perform location search using geocode.maps.co API
    async function performLocationSearch() {
      const searchInput = document.getElementById('location-search');
      const searchResults = document.getElementById('search-results');
      const query = searchInput.value.trim();
      
      // Get current language translations
      const t = translations[currentLanguage];
      
      if (!query) {
        searchResults.innerHTML = `<p>${t.searchLocationPlaceholder}</p>`;
        return;
      }
      
      // Show loading message
      searchResults.innerHTML = `<p>${t.searchingText}</p>`;
      
      try {
        // Use geocode.maps.co API
        const apiKey = "68cabd7193331556752131jakae988d";
        const result = await tryGeocodeSearch(query, apiKey);
        
        if (result && result.length > 0) {
          displaySearchResults(result);
        } else {
          searchResults.innerHTML = `<p>${t.noLocationResultsText}</p>`;
        }
        
      } catch (error) {
        console.error('Error searching for location:', error);
        
        // Provide more specific error messages based on the error type
        let errorMessage = t.searchErrorText;
        
        if (error.name === 'AbortError') {
          errorMessage = t.searchTimeoutText;
        } else if (error.message.includes('Network response was not ok')) {
          errorMessage = t.serverErrorText;
        }
        
        searchResults.innerHTML = `<p>${errorMessage}</p>`;
      }
    }
    
    // Try to search using geocode.maps.co API
    async function tryGeocodeSearch(query, apiKey) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
        
        const response = await fetch(`https://geocode.maps.co/search?q=${encodeURIComponent(query)}&api_key=${apiKey}`, {
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`Network response was not ok: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
          return null;
        }
        
        return data;
      } catch (error) {
        console.error('Geocode search failed:', error);
        return null;
      }
    }
    
    // Display the search results on the map
    function displaySearchResults(results) {
      const searchResults = document.getElementById('search-results');
      
      // Clear existing markers
      clearMarkers();
      
      // Display search results
      searchResults.innerHTML = '';
      
      // Add each result to the list
      results.forEach((result, index) => {
        const resultItem = document.createElement('div');
        resultItem.className = 'search-result-item';
        
        // Extract display name and details
        const displayName = result.display_name || result.display_name;
        const lat = parseFloat(result.lat);
        const lon = parseFloat(result.lon);
        
        resultItem.innerHTML = `
          <div class="search-result-name">${displayName.split(',')[0]}</div>
          <div class="search-result-details">${displayName}</div>
        `;
        
        // Add click event to focus on this location
        resultItem.addEventListener('click', () => {
          focusOnLocation(lat, lon, displayName);
        });
        
        searchResults.appendChild(resultItem);
        
        // Add marker to map (but don't open popup yet)
        const marker = L.marker([lat, lon]).addTo(map);
        marker.bindPopup(`<strong>${displayName}</strong><br>Lat: ${lat.toFixed(4)}<br>Lon: ${lon.toFixed(4)}`);
        
        // Add marker to array for later removal
        markers.push(marker);
        
        // If this is the first result, center the map on it but don't zoom in yet
        if (index === 0) {
          map.setView([lat, lon], 10);
        }
      });
    }
    
    // Display a single search result on the map (for backward compatibility)
    function displaySearchResult(result) {
      const searchResults = document.getElementById('search-results');
      
      // Clear existing markers
      clearMarkers();
      
      // Display search results
      searchResults.innerHTML = '';
      
      // Create result item
      const resultItem = document.createElement('div');
      resultItem.className = 'search-result-item';
      
      resultItem.innerHTML = `
        <div class="search-result-name">${result.displayName.split(',')[0]}</div>
        <div class="search-result-details">${result.displayName}</div>
      `;
      
      searchResults.appendChild(resultItem);
      
      // Add marker to map
      const marker = L.marker([result.lat, result.lon]).addTo(map);
      marker.bindPopup(`<strong>${result.displayName}</strong><br>Lat: ${result.lat.toFixed(4)}<br>Lon: ${result.lon.toFixed(4)}`);
      marker.openPopup();
      
      // Add marker to array for later removal
      markers.push(marker);
      
      // Zoom to the exact coordinates of the searched location
      map.setView([result.lat, result.lon], 15);
    }
    
    // Clear all markers from the map
    function clearMarkers() {
      if (!map) return;
      
      markers.forEach(marker => {
        map.removeLayer(marker);
      });
      
      markers = [];
    }
    
    // Focus map on a specific location and zoom in
    function focusOnLocation(lat, lon, name) {
      if (!map) return;
      
      // Zoom to the exact coordinates of the selected location
      map.setView([lat, lon], 15);
      
      // Find and open the popup for this location
      markers.forEach(marker => {
        const markerLat = marker.getLatLng().lat;
        const markerLon = marker.getLatLng().lng;
        
        if (Math.abs(markerLat - lat) < 0.0001 && Math.abs(markerLon - lon) < 0.0001) {
          marker.openPopup();
        }
      });
    }
    
    // Data Interpretation functionality
    // Initialize data interpretation button and modal
    function initializeDataInterpretation() {
      console.log('Initializing data interpretation...');
      
      // Get the interpretation button and results container
      const interpretationBtn = document.getElementById('interpretation-btn');
      const interpretationResults = document.getElementById('interpretation-results');
      
      if (!interpretationBtn) {
        console.error('Interpretation button not found');
        return;
      }
      
      if (!interpretationResults) {
        console.error('Interpretation results container not found');
        return;
      }
      
      console.log('Interpretation button and results container found');
      
      // Add click event to the interpretation button
      interpretationBtn.addEventListener('click', async function() {
        console.log('Interpretation button clicked');
        
        // Get current translations
        const t = translations[currentLanguage];
        
        // Show loading state
        interpretationResults.style.display = 'block';
        interpretationResults.innerHTML = `
          <div class="interpretation-loading">
            <div class="interpretation-loading-spinner"></div>
            <div class="interpretation-loading-text">${t.dataInterpretationLoading}</div>
          </div>
        `;
        
        try {
          // Get the current selected statistic
          const statSelect = document.getElementById('stat-select');
          if (!statSelect) {
            throw new Error('Statistics dropdown not found');
          }
          
          const selectedStat = statSelect.value;
          console.log('Selected statistic:', selectedStat);
          
          // Get country data for interpretation
          const countryDataForAnalysis = prepareCountryDataForAnalysis(selectedStat);
          console.log('Country data for analysis:', countryDataForAnalysis);
          
          // Call GLM-4.5 API for data interpretation
          const interpretationResult = await callGLMAPIForDataInterpretation(countryDataForAnalysis, selectedStat);
          console.log('Interpretation result received');
          
          // Display the interpretation result
          interpretationResults.innerHTML = `
            <div class="interpretation-result">
              <h3>${t.dataInterpretationResultTitle}</h3>
              <div class="interpretation-text">${formatMarkdown(interpretationResult)}</div>
            </div>
          `;
        } catch (error) {
          console.error('Error during data interpretation:', error);
          
          // Get current translations for error message
          const t = translations[currentLanguage];
          
          // Display error message
          interpretationResults.innerHTML = `
            <div class="interpretation-error">
              <h3>${t.dataInterpretationErrorTitle}</h3>
              <div class="error-message">${t.dataInterpretationErrorMessage}${error.message}</div>
              <div class="error-suggestion">${t.dataInterpretationErrorSuggestion}</div>
            </div>
          `;
        }
      });
      
      console.log('Data interpretation initialized successfully');
    }
    
    // Format markdown text to HTML
    function formatMarkdown(text) {
      // Convert headers
      text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
      text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
      text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
      
      // Convert bold and italic
      text = text.replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>');
      text = text.replace(/\*(.*)\*/gim, '<em>$1</em>');
      
      // Convert lists
      text = text.replace(/^\* (.*$)/gim, '<li>$1</li>');
      text = text.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
      
      // Wrap lists in ul/ol tags
      text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
      
      // Convert line breaks
      text = text.replace(/\n/gim, '<br>');
      
      // Convert code blocks
      text = text.replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>');
      text = text.replace(/`(.*?)`/gim, '<code>$1</code>');
      
      // Convert links
      text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank">$1</a>');
      
      return text;
    }
    
    // Prepare country data for analysis
    function prepareCountryDataForAnalysis(selectedStat) {
      // If no statistic is selected, use population as default
      const statKey = selectedStat || 'population';
      
      // Check if we have countryStats data
      if (!countryStats || Object.keys(countryStats).length === 0) {
        console.error('No country statistics data available');
        return {
          statistic: statKey,
          statisticName: translations[currentLanguage][statKey] || statKey,
          countries: [],
          error: 'No country statistics data available'
        };
      }
      
      // Get all countries by the selected statistic from countryStats
      const sortedCountries = Object.entries(countryStats)
        .map(([code, data]) => {
          // Ensure the data has the required statistic
          if (data[statKey] === undefined || data[statKey] === null) {
            return null;
          }
          
          return {
            code: code,
            name: data.name,
            value: parseFloat(data[statKey]) || 0,
            region: data.region,
            // Get additional country details from countryBasics if available
            ...(countryBasics[code] || {})
          };
        })
        .filter(country => country !== null) // Filter out countries without the required statistic
        .sort((a, b) => b.value - a.value);
      
      console.log(`Prepared data for analysis: All ${sortedCountries.length} countries with ${statKey} data`);
      
      // Prepare data for analysis
      const analysisData = {
        statistic: statKey,
        statisticName: translations[currentLanguage][statKey] || statKey,
        countries: sortedCountries.map(country => ({
          name: country.name,
          nameChinese: country['name.common.chn'] || country.name,
          value: country.value,
          region: country.region,
          subregion: country.subregion || 'N/A'
        }))
      };
      
      return analysisData;
    }
    
    // Call GLM-4.5 API for data interpretation
    async function callGLMAPIForDataInterpretation(data, statistic) {
      // Check if there's an error or no countries data
      if (data.error || !data.countries || data.countries.length === 0) {
        const errorMessage = data.error || 'No country data available for analysis';
        console.error(errorMessage);
        const t = translations[currentLanguage];
        return `${t.dataInterpretationErrorMessage}${errorMessage}`;
      }
      
      // Get current language
      const lang = currentLanguage;
      const t = translations[lang];
      
      // Prepare the prompt for the GLM-4.5 API based on language
      const systemMessage = {
        role: "system",
        content: lang === 'zh' 
          ? "你是一位专业的地理数据分析师。请根据提供的国家统计数据，提供深入、专业且易于理解的数据分析。你的分析应该包括：1) 数据的整体趋势和模式；2) 区域差异和特点；3) 可能的原因和影响因素；4) 有趣的发现和洞察；5) 对比和排名分析。请使用中文回复，并确保分析内容既有专业性又易于理解。"
          : "You are a professional geographic data analyst. Please provide in-depth, professional, and easy-to-understand data analysis based on the provided country statistics. Your analysis should include: 1) Overall trends and patterns in the data; 2) Regional differences and characteristics; 3) Possible causes and influencing factors; 4) Interesting findings and insights; 5) Comparative and ranking analysis. Please respond in English and ensure your analysis is both professional and easy to understand."
      };
      
      const userMessage = {
        role: "user",
        content: lang === 'zh'
          ? `请分析以下国家的"${data.statisticName}"数据：

${data.countries.map(country => 
  `${country.name} (${country.nameChinese}): ${country.value}，位于${country.region}地区的${country.subregion}`
).join('\n')}

请提供详细的数据分析，包括趋势、区域差异、可能的原因和有趣的发现。`
          : `Please analyze the "${data.statisticName}" data for the following countries:

${data.countries.map(country => 
  `${country.name} (${country.nameChinese}): ${country.value}, located in ${country.subregion}, ${country.region}`
).join('\n')}

Please provide detailed data analysis, including trends, regional differences, possible causes, and interesting findings.`
      };
      
      // Call the GLM-4.5 API
      try {
        const response = await fetch('https://glm.study-llm.me/functions/api/chat-glm', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            messages: [systemMessage, userMessage]
          })
        });
        
        if (!response.ok) {
          throw new Error(`API request failed with status ${response.status}`);
        }
        
        const result = await response.json();
        
        // Extract the interpretation text from the response
        let interpretationText = '';
        
        if (result.choices && result.choices[0] && result.choices[0].message) {
          interpretationText = result.choices[0].message.content;
        } else if (result.output) {
          interpretationText = result.output;
        } else if (result.content) {
          interpretationText = result.content;
        } else {
          throw new Error('Unexpected API response format');
        }
        
        return interpretationText;
      } catch (error) {
        console.error('Error calling GLM-4.5 API:', error);
        const t = translations[lang];
        throw new Error(`${t.dataInterpretationErrorMessage}${error.message}`);
      }
    }
    
    </script>
</body>
</html>
