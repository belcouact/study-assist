<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fullscreen World Map</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }
    
    #map {
      height: 100vh;
      width: 100vw;
    }
    
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      width: 300px;
      transition: all 0.3s ease;
    }
    
    .panel-header {
      display: flex;
      justify-content: flex-end;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .toggle-button {
      background: linear-gradient(135deg, #4a90e2, #3a7bc8);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      color: white;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .toggle-button:hover {
      background: linear-gradient(135deg, #3a7bc8, #2e6cb8);
      transform: scale(1.1);
    }
    
    .panel-content {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .control-panel.collapsed .panel-content {
      display: none;
    }
    
    .control-panel.collapsed .toggle-button {
      transform: rotate(180deg);
    }
    
    .map-mode-toggle {
      display: flex;
      gap: 10px;
    }
    
    .mode-button {
      flex: 1;
      padding: 8px 12px;
      background: linear-gradient(135deg, #4a90e2, #3a7bc8);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .mode-button.active {
      background: linear-gradient(135deg, #3a7bc8, #2e6cb8);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .mode-button:hover {
      background: linear-gradient(135deg, #3a7bc8, #2e6cb8);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .location-search-container {
      display: flex;
      gap: 10px;
    }
    
    #location-search {
      flex: 1;
      padding: 8px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 12px;
      background-color: #f9f9f9;
      transition: all 0.3s ease;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #location-search:focus {
      outline: none;
      border-color: #4CAF50;
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2), inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #search-button {
      padding: 8px 12px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    #search-button:hover {
      background: linear-gradient(135deg, #45a049, #3d8b40);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .search-results {
      max-height: 200px;
      overflow-y: auto;
      background-color: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    
    .search-result-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .search-result-item:hover {
      background-color: #f5f5f5;
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-name {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .search-result-details {
      font-size: 12px;
      color: #666;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .control-panel {
        width: 250px;
      }
      
      .location-search-container {
        flex-direction: column;
      }
      
      #location-search {
        min-width: 150px;
      }
    }
    
    @media (max-width: 480px) {
      .control-panel {
        width: 200px;
      }
      
      .mode-button {
        padding: 6px;
        font-size: 10px;
      }
      
      #location-search {
        min-width: 120px;
        font-size: 10px;
      }
      
      #search-button {
        padding: 6px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="control-panel">
    <div class="panel-header">
      <button id="toggle-btn" class="toggle-button">▼</button>
    </div>
    
    <div class="panel-content">
      <div class="location-search-container">
        <input type="text" id="location-search" placeholder="Search location...">
        <button id="search-button">Search</button>
      </div>
      
      <div class="map-mode-toggle">
        <button id="normal-mode-btn" class="mode-button">NORMAL</button>
        <button id="satellite-mode-btn" class="mode-button active">SATELLITE</button>
      </div>
      
      <div id="search-results" class="search-results">
        <!-- Search results will be displayed here -->
      </div>
    </div>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <script>
    // Translations for UI elements
    const translations = {
      en: {
        locationSearchPlaceholder: "Search location...",
        searchButton: "Search",
        normalModeButton: "NORMAL",
        satelliteModeButton: "SATELLITE",
        togglePanel: "Toggle panel",
        searchingText: "Searching...",
        noResultsText: "No results found. Please try a different location name.",
        errorText: "Error searching for location. Please try again later."
      },
      zh: {
        locationSearchPlaceholder: "搜索位置...",
        searchButton: "搜索",
        normalModeButton: "普通",
        satelliteModeButton: "卫星",
        togglePanel: "切换面板",
        searchingText: "搜索中...",
        noResultsText: "未找到结果。请尝试其他位置名称。",
        errorText: "搜索位置时出错。请稍后再试。"
      }
    };
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const lat = parseFloat(urlParams.get('lat')) || 30;
    const lng = parseFloat(urlParams.get('lng')) || 0;
    const zoom = parseInt(urlParams.get('zoom')) || 2;
    const mode = urlParams.get('mode') || 'satellite';
    const lang = urlParams.get('lang') || 'en';
    
    // Set current language
    let currentLanguage = lang;
    
    // Apply translations to UI elements
    function applyTranslations() {
      const t = translations[currentLanguage];
      
      // Update search input placeholder
      document.getElementById('location-search').placeholder = t.locationSearchPlaceholder;
      
      // Update buttons
      document.getElementById('search-button').textContent = t.searchButton;
      document.getElementById('normal-mode-btn').textContent = t.normalModeButton;
      document.getElementById('satellite-mode-btn').textContent = t.satelliteModeButton;
      
      // Update control panel title
      document.getElementById('toggle-btn').title = t.togglePanel;
    }
    
    // Initialize map
    let map;
    let markers = [];
    let currentMapMode = mode;
    
    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Apply translations
      applyTranslations();
      
      // Initialize the map
      map = L.map('map').setView([lat, lng], zoom);
      
      // Add the default tile layer based on mode
      updateMapTileLayer(mode);
      
      // Update button states based on mode
      const normalBtn = document.getElementById('normal-mode-btn');
      const satelliteBtn = document.getElementById('satellite-mode-btn');
      
      if (mode === 'normal') {
        normalBtn.classList.add('active');
        satelliteBtn.classList.remove('active');
      } else {
        normalBtn.classList.remove('active');
        satelliteBtn.classList.add('active');
      }
      
      // Add control panel expand/collapse functionality
      const controlPanel = document.querySelector('.control-panel');
      const toggleButton = document.getElementById('toggle-btn');
      
      toggleButton.addEventListener('click', function() {
        controlPanel.classList.toggle('collapsed');
      });
      
      // Initialize as expanded
      controlPanel.classList.remove('collapsed');
      
      // Add event listeners
      document.getElementById('normal-mode-btn').addEventListener('click', function() {
        setMapMode('normal');
      });
      
      document.getElementById('satellite-mode-btn').addEventListener('click', function() {
        setMapMode('satellite');
      });
      
      document.getElementById('search-button').addEventListener('click', performLocationSearch);
      document.getElementById('location-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performLocationSearch();
        }
      });
    });
    
    // Update map tile layer based on mode
    function updateMapTileLayer(mode) {
      if (!map) return;
      
      // Remove existing tile layers
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer) {
          map.removeLayer(layer);
        }
      });
      
      // Add new tile layer based on mode
      if (mode === 'normal') {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
      } else if (mode === 'satellite') {
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
          maxZoom: 19
        }).addTo(map);
      }
    }
    
    // Set map mode and update UI
    function setMapMode(mode) {
      if (!map) return;
      
      // Update current map mode
      currentMapMode = mode;
      
      // Update tile layer
      updateMapTileLayer(mode);
      
      // Update button states
      const normalBtn = document.getElementById('normal-mode-btn');
      const satelliteBtn = document.getElementById('satellite-mode-btn');
      
      if (mode === 'normal') {
        normalBtn.classList.add('active');
        satelliteBtn.classList.remove('active');
      } else {
        normalBtn.classList.remove('active');
        satelliteBtn.classList.add('active');
      }
    }
    
    // Perform location search using geocode.maps.co API
    async function performLocationSearch() {
      const searchInput = document.getElementById('location-search');
      const searchResults = document.getElementById('search-results');
      const query = searchInput.value.trim();
      
      // Get current language translations
      const t = translations[currentLanguage];
      
      if (!query) {
        searchResults.style.display = 'none';
        return;
      }
      
      // Show loading message
      searchResults.style.display = 'block';
      searchResults.innerHTML = `<div class="search-result-item">${t.searchingText}</div>`;
      
      try {
        // Use geocode.maps.co API
        const apiKey = "68cabd7193331556752131jakae988d";
        const result = await tryGeocodeSearch(query, apiKey);
        
        if (result && result.length > 0) {
          displaySearchResults(result);
        } else {
          searchResults.innerHTML = `<div class="search-result-item">${t.noResultsText}</div>`;
        }
        
      } catch (error) {
        console.error('Error searching for location:', error);
        searchResults.innerHTML = `<div class="search-result-item">${t.errorText}</div>`;
      }
    }
    
    // Try to search using geocode.maps.co API
    async function tryGeocodeSearch(query, apiKey) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
        
        const response = await fetch(`https://geocode.maps.co/search?q=${encodeURIComponent(query)}&api_key=${apiKey}`, {
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`Network response was not ok: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
          return null;
        }
        
        return data;
      } catch (error) {
        console.error('Geocode search failed:', error);
        return null;
      }
    }
    
    // Display the search results on the map
    function displaySearchResults(results) {
  const searchResults = document.getElementById('search-results');
  
  // Clear existing markers
  clearMarkers();
  
  // Display search results
  searchResults.innerHTML = '';
  
  // Check if there are no results
  if (results.length === 0) {
    const t = translations[currentLanguage];
    searchResults.innerHTML = `<div class="search-result-item">${t.noResultsText}</div>`;
    searchResults.style.display = 'block';
    return;
  }
  
  // Add each result to the list
  results.forEach((result, index) => {
    const resultItem = document.createElement('div');
    resultItem.className = 'search-result-item';
    
    const name = document.createElement('div');
    name.className = 'search-result-name';
    name.textContent = result.display_name;
    
    const details = document.createElement('div');
    details.className = 'search-result-details';
    details.textContent = `${result.type || 'Location'} - Lat: ${result.lat}, Lon: ${result.lon}`;
    
    resultItem.appendChild(name);
    resultItem.appendChild(details);
    
    // Add click event to focus on this location
    resultItem.addEventListener('click', function() {
      focusOnLocation(parseFloat(result.lat), parseFloat(result.lon), result.display_name);
    });
    
    searchResults.appendChild(resultItem);
    
    // Add marker to map
    const marker = L.marker([result.lat, result.lon]).addTo(map);
    marker.bindPopup(result.display_name);
    
    // Add marker to array for later removal
    markers.push(marker);
  });
  
  // If only one result, automatically focus on it
  if (results.length === 1) {
    focusOnLocation(parseFloat(results[0].lat), parseFloat(results[0].lon), results[0].display_name);
  }
}
    
    // Clear all markers from the map
    function clearMarkers() {
      if (!map) return;
      
      markers.forEach(marker => {
        map.removeLayer(marker);
      });
      
      markers = [];
    }
    
    // Focus map on a specific location and zoom in
    function focusOnLocation(lat, lon, name) {
      if (!map) return;
      
      // Zoom to the exact coordinates of the selected location
      map.setView([lat, lon], 15);
      
      // Find and open the popup for this location
      markers.forEach(marker => {
        const markerLat = marker.getLatLng().lat;
        const markerLon = marker.getLatLng().lng;
        
        if (Math.abs(markerLat - lat) < 0.0001 && Math.abs(markerLon - lon) < 0.0001) {
          marker.openPopup();
        }
      });
    }
  </script>
</body>
</html>