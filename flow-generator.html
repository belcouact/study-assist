<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown æµç¨‹å›¾ç”Ÿæˆå™¨ - Alexçš„å­¦ä¹ åŠ©æ‰‹</title>
    <link rel="icon" href="../assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/utilities.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            padding: 2rem;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            border: none;
        }
        .card-header {
            background-color: #4caf50;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1rem;
            font-weight: 600;
        }
        .form-control {
            border-radius: 8px;
            padding: 0.8rem;
            border: 1px solid #ced4da;
        }
        .form-control:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }
        textarea.form-control {
            min-height: 150px;
            font-family: 'Courier New', Courier, monospace;
        }
        .btn-primary {
            background-color: #4caf50;
            border-color: #4caf50;
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        .btn-primary:hover, .btn-primary:focus {
            background-color: #3d8b40;
            border-color: #3d8b40;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
        }
        .output-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .output-section {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .output-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        .output-content {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
        }
        .diagram-container {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            margin-right: 0.5rem;
        }
        .loading-text {
            font-size: 0.9rem;
        }
        .copy-btn {
            background-color: transparent;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            color: #6c757d;
            transition: all 0.2s;
        }
        .copy-btn:hover {
            background-color: #f1f1f1;
        }
        .copy-btn:active {
            transform: scale(0.95);
        }
        .template-selector {
            margin-bottom: 1rem;
        }
        .template-btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            color: #495057;
        }
        .template-btn:hover {
            background-color: #d1d7dc;
        }
        .tab-content {
            margin-top: 1rem;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            color: #4caf50;
            border-color: #dee2e6 #dee2e6 #fff;
            border-bottom: 2px solid #4caf50;
        }
        #markdownPreview {
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: white;
        }
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 1rem;
        }
        /* è¿”å›é¦–é¡µé“¾æ¥æ ·å¼ */
        .back-to-home {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            text-decoration: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-to-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 1);
            color: #4caf50;
            text-decoration: none;
        }

        .back-to-home i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .back-to-home:hover i {
            transform: translateX(-2px);
        }

        /* å…³äºæŒ‰é’®æ ·å¼ */
        .about-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(76, 175, 80, 0.95);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .about-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            background: rgba(76, 175, 80, 1);
        }

        .about-btn i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .about-btn:hover i {
            transform: scale(1.1);
        }

        /* å…³äºæ¨¡æ€æ¡†æ ·å¼ */
        .about-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .about-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .about-modal-content {
            position: relative;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .about-close {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 40px;
            height: 40px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .about-close:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        /* å…³äºå¡ç‰‡åŠ¨ç”»æ ·å¼ */
        .about-card-animated {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            animation: slideIn 0.5s ease;
        }

        .about-card-inner {
            position: relative;
            z-index: 1;
        }

        .about-card-front {
            color: white;
        }

        .about-content {
            position: relative;
            padding: 1rem;
        }

        /* è£…é¥°å…ƒç´  */
        .about-decoration {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }

        .about-decoration.top-left {
            top: 20px;
            left: 20px;
            animation-delay: 0s;
        }

        .about-decoration.top-right {
            top: 20px;
            right: 20px;
            animation-delay: 1s;
        }

        .about-decoration.bottom-left {
            bottom: 20px;
            left: 20px;
            animation-delay: 2s;
        }

        .about-decoration.bottom-right {
            bottom: 20px;
            right: 20px;
            animation-delay: 1.5s;
        }

        .about-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .about-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ffd700;
            animation: pulse 2s ease-in-out infinite;
        }

        .about-header h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .about-header h3 {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .about-text {
            line-height: 1.8;
            font-size: 1rem;
        }

        .about-intro {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            font-style: italic;
            opacity: 0.95;
        }

        .about-text h4 {
            margin: 1.5rem 0 1rem 0;
            font-size: 1.3rem;
            color: #ffd700;
            font-weight: 600;
        }

        .about-text ul {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .about-text li {
            margin-bottom: 0.8rem;
            position: relative;
        }

        .about-questions li::before,
        .about-insights li::before {
            content: "âœ¨";
            position: absolute;
            left: -1.5rem;
            color: #ffd700;
        }

        .about-tools li::before {
            content: "ğŸ”§";
            position: absolute;
            left: -1.5rem;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .card-header {
                padding: 0.75rem;
            }
            .form-control {
                padding: 0.6rem;
            }
            .back-to-home {
                top: 15px;
                left: 15px;
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .back-to-home i {
                font-size: 14px;
            }
            
            .about-btn {
                top: 70px;
                right: 15px;
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .about-btn i {
                font-size: 14px;
            }
            
            .about-modal-content {
                margin: 10px;
                max-height: 95vh;
            }
            
            .about-card-animated {
                padding: 1.5rem;
            }
            
            .about-header h2 {
                font-size: 1.5rem;
            }
            
            .about-header h3 {
                font-size: 1rem;
            }
            
            .about-text {
                font-size: 0.9rem;
            }
            
            .about-icon {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- è¿”å›é¦–é¡µé“¾æ¥ -->
    <a href="../index.html" class="back-to-home">
        <i class="fas fa-arrow-left"></i>
        <span>è¿”å›é¦–é¡µ</span>
    </a>

    <!-- å…³äºæŒ‰é’® -->
    <button class="about-btn" id="aboutBtn">
        <i class="fas fa-info-circle"></i>
        <span>å…³äº</span>
    </button>

    <!-- å…³äºæ¨¡æ€æ¡† -->
    <div class="about-modal" id="aboutModal">
        <div class="about-modal-content">
            <div class="about-close" id="aboutClose">&times;</div>
            <div class="about-card-animated">
                <div class="about-card-inner">
                    <div class="about-card-front">
                        <div class="about-content">
                            <div class="about-decoration top-left"></div>
                            <div class="about-decoration top-right"></div>
                            <div class="about-header">
                                <i class="fas fa-graduation-cap about-icon"></i>
                                <h2>å…³äºAlexçš„å­¦ä¹ åŠ©æ‰‹</h2>
                                <h3>æ¢ç´¢AIçš„å¯èƒ½æ€§</h3>
                            </div>
                            <div class="about-text">
                                <p class="about-intro">è¿™æ˜¯ä¸€ä¸ªç”±å¥½å¥‡å¿ƒã€æ¢ç´¢æ¬²ä¸çƒ­å¿±ä¿ƒæˆçš„å°å°å®éªŒé¡¹ç›®ï¼Œå®ƒå§‹äºå‡ ä¸ªè¦ç»•å¿ƒå¤´çš„é—®é¢˜ï¼š</p>
                                <ul class="about-questions">
                                    <li>ç”Ÿæˆå¼AIå¦‚æ­¤å¼ºå¤§ï¼Œå¦‚ä½•è®©å®ƒé€‚é…ä¸ªæ€§åŒ–éœ€æ±‚ï¼Ÿ</li>
                                    <li>åœ¨AIæ—¶ä»£ï¼Œç¼–ç¨‹ä¸åˆ›é€ æ˜¯å¦çœŸçš„äººäººå¯ä¸ºï¼Ÿ</li>
                                    <li>å¦‚ä½•åˆ©ç”¨AIå¸®åŠ©å­©å­å­¦ä¹ ï¼Ÿ</li>
                                </ul>
                                
                                <h4>å®è·µä¸­çš„æ„Ÿæ‚Ÿï¼š</h4>
                                <ul class="about-insights">
                                    <li>æ‹’ç»èººå¹³ï¼Œå¼€å¯æ€è€ƒï¼›</li>
                                    <li>ä¸è¦æ‹–å»¶ï¼Œç«‹å³è¡ŒåŠ¨ï¼›</li>
                                    <li>æ— æƒ§è¯•é”™ï¼Œè¾¹é”™è¾¹å­¦ï¼›</li>
                                    <li>åšä¿¡åŠªåŠ›ï¼Œå¿…æœ‰æ‰€æˆã€‚</li>
                                </ul>
                                
                                <h4>é¡¹ç›®æ‰€ç”¨åˆ°çš„å·¥å…·ï¼ˆç°å­¦ç°ç”¨ï¼‰ï¼š</h4>
                                <ul class="about-tools">
                                    <li><strong>å†…å®¹ç”Ÿæˆï¼š</strong>DeepSeek-V3 API</li>
                                    <li><strong>éŸ³é¢‘ç”Ÿæˆï¼š</strong>MINIMAX API</li>
                                    <li><strong>ä»£ç ç”Ÿæˆï¼š</strong>Cursor + Claude-3.7-sonnet</li>
                                    <li><strong>ç½‘é¡µéƒ¨ç½²ï¼š</strong>Github + Cloudflare</li>
                                </ul>
                            </div>
                            <div class="about-decoration bottom-left"></div>
                            <div class="about-decoration bottom-right"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: 40px;">
        <h1 class="text-center mb-4">æµç¨‹å›¾ç”Ÿæˆå™¨</h1>
        
        <div class="card">
            <div class="card-header">
                ç”Ÿæˆ Markdown å’Œ Mermaid æµç¨‹å›¾
            </div>
            <div class="card-body">
                <div class="template-selector">
                    <h5>AIç”Ÿæˆæ¨¡æ¿ (éœ€è¦è°ƒç”¨API)ï¼š</h5>
                    <div class="mb-3">
                        <button class="btn template-btn" data-template="flowchart">æµç¨‹å›¾</button>
                        <button class="btn template-btn" data-template="sequence">æ—¶åºå›¾</button>
                        <button class="btn template-btn" data-template="classDiagram">ç±»å›¾</button>
                        <button class="btn template-btn" data-template="stateDiagram">çŠ¶æ€å›¾</button>
                        <button class="btn template-btn" data-template="entityRelationship">å®ä½“å…³ç³»å›¾</button>
                        <button class="btn template-btn" data-template="gantt">ç”˜ç‰¹å›¾</button>
                    </div>
                    
                    <h5>Mermaidä»£ç æ¨¡æ¿ (ç›´æ¥è½¬æ¢)ï¼š</h5>
                    <div class="mb-3">
                        <button class="btn template-btn" data-template="pie">é¥¼å›¾</button>
                        <button class="btn template-btn" data-template="userJourney">ç”¨æˆ·æ—…ç¨‹å›¾</button>
                        <button class="btn template-btn" data-template="mindmap">æ€ç»´å¯¼å›¾</button>
                        <button class="btn template-btn" data-template="gitGraph">Gitåˆ†æ”¯å›¾</button>
                        <button class="btn template-btn" data-template="timeline">æ—¶é—´è½´</button>
                        <button class="btn template-btn" data-template="requirementDiagram">éœ€æ±‚å›¾</button>
                        <button class="btn template-btn" data-template="c4Context">C4ä¸Šä¸‹æ–‡å›¾</button>
                        <button class="btn template-btn" data-template="complaint">å®¢æˆ·æŠ•è¯‰æµç¨‹å›¾</button>
                        <button class="btn template-btn" data-template="sequenceComplaint">å®¢æœæŠ•è¯‰æ—¶åºå›¾</button>
                        <button class="btn template-btn" data-template="quadrantChart">è±¡é™å›¾</button>
                    </div>
                </div>
                
                <div class="form-group mb-3">
                    <label for="promptInput" class="form-label">æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å†…å®¹ï¼š</label>
                    <textarea class="form-control" id="promptInput" rows="4" placeholder="ä¾‹å¦‚ï¼šè¯·ç”Ÿæˆä¸€ä¸ªæè¿°è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸçš„æµç¨‹å›¾ï¼ŒåŒ…æ‹¬éœ€æ±‚åˆ†æã€è®¾è®¡ã€å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²é˜¶æ®µã€‚"></textarea>
                </div>
                
                <div class="d-flex justify-content-between">
                    <div>
                        <button id="generateBtn" class="btn btn-primary me-2">
                            <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <span id="buttonText">ç”Ÿæˆ Markdown å’Œæµç¨‹å›¾</span>
                        </button>
                        <button id="testDiagramBtn" class="btn btn-info">è½¬æ¢ Markdown æˆæµç¨‹å›¾</button>
                    </div>
                    <button id="clearBtn" class="btn btn-secondary">æ¸…é™¤</button>
                </div>
                
                <div id="errorContainer" class="error-message d-none"></div>
            </div>
        </div>
        
        <div id="outputContainer" class="output-container d-none">
            <ul class="nav nav-tabs" id="outputTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="markdown-tab" data-bs-toggle="tab" data-bs-target="#markdownTab" type="button" role="tab" aria-controls="markdownTab" aria-selected="true">Markdown</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#previewTab" type="button" role="tab" aria-controls="previewTab" aria-selected="false">é¢„è§ˆ</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="diagram-tab" data-bs-toggle="tab" data-bs-target="#diagramTab" type="button" role="tab" aria-controls="diagramTab" aria-selected="false">æµç¨‹å›¾</button>
                </li>
            </ul>
            
            <div class="tab-content" id="outputTabContent">
                <div class="tab-pane fade show active" id="markdownTab" role="tabpanel" aria-labelledby="markdown-tab">
                    <div class="output-section">
                        <div class="output-header">
                            <div class="output-title">ç”Ÿæˆçš„ Markdown</div>
                            <button class="copy-btn" id="copyMarkdownBtn">å¤åˆ¶</button>
                        </div>
                        <pre class="output-content"><code id="markdownOutput" class="language-markdown"></code></pre>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="previewTab" role="tabpanel" aria-labelledby="preview-tab">
                    <div class="output-section">
                        <div class="output-header">
                            <div class="output-title">Markdown é¢„è§ˆ</div>
                        </div>
                        <div id="markdownPreview" class="output-content"></div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="diagramTab" role="tabpanel" aria-labelledby="diagram-tab">
                    <div class="output-section">
                        <div class="output-header">
                            <div class="output-title">Mermaid æµç¨‹å›¾</div>
                            <div>
                                <button class="copy-btn" id="copyDiagramBtn">å¤åˆ¶</button>
                                <button class="copy-btn ms-2" id="downloadSvgBtn">ä¸‹è½½ SVG</button>
                                <button class="copy-btn ms-2" id="downloadPngBtn">ä¸‹è½½ PNG</button>
                            </div>
                        </div>
                        <div class="diagram-container" id="diagramOutput"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Use complete highlight.js package from cdnjs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- Use marked from cdnjs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <!-- Use mermaid from cdnjs (latest stable version) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize highlight.js safely
            if (typeof hljs !== 'undefined') {
                hljs.highlightAll();
            } else {
                console.warn('highlight.js is not loaded');
            }
            
            // Initialize mermaid safely
            if (typeof mermaid !== 'undefined') {
                try {
                    mermaid.initialize({
                        startOnLoad: false, // Changed to false to manually render
                        theme: 'default',
                        securityLevel: 'loose',
                        fontFamily: 'Arial, sans-serif',
                        flowchart: {
                            curve: 'linear', // Changed to linear for better compatibility
                            htmlLabels: true,
                            useMaxWidth: true
                        },
                        logLevel: 'error' // Only show errors
                    });
                } catch (e) {
                    console.warn('Error initializing mermaid:', e);
                }
            } else {
                console.warn('mermaid library not loaded');
            }
            
            // DOM elements
            const promptInput = document.getElementById('promptInput');
            const generateBtn = document.getElementById('generateBtn');
            const testDiagramBtn = document.getElementById('testDiagramBtn');
            const clearBtn = document.getElementById('clearBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const buttonText = document.getElementById('buttonText');
            const outputContainer = document.getElementById('outputContainer');
            const markdownOutput = document.getElementById('markdownOutput');
            const markdownPreview = document.getElementById('markdownPreview');
            const diagramOutput = document.getElementById('diagramOutput');
            const copyMarkdownBtn = document.getElementById('copyMarkdownBtn');
            const copyDiagramBtn = document.getElementById('copyDiagramBtn');
            const downloadSvgBtn = document.getElementById('downloadSvgBtn');
            const downloadPngBtn = document.getElementById('downloadPngBtn');
            const errorContainer = document.getElementById('errorContainer');
            const templateButtons = document.querySelectorAll('.template-btn');
            
            // Template prompts
            const templates = {
                flowchart: "è¯·ç”Ÿæˆä¸€ä¸ªä½¿ç”¨Mermaidè¯­æ³•çš„æµç¨‹å›¾ï¼Œæè¿°è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬éœ€æ±‚åˆ†æã€è®¾è®¡ã€å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²é˜¶æ®µã€‚è¯·æä¾›å®Œæ•´çš„Markdownæ ¼å¼ï¼ŒåŒ…å«```mermaidå’Œ```æ ‡è®°ã€‚",
                sequence: "è¯·ç”Ÿæˆä¸€ä¸ªä½¿ç”¨Mermaidè¯­æ³•çš„æ—¶åºå›¾ï¼Œæè¿°ç”¨æˆ·ç™»å½•ç³»ç»Ÿçš„æµç¨‹ï¼ŒåŒ…æ‹¬ç”¨æˆ·ã€å‰ç«¯ã€åç«¯å’Œæ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚è¯·æä¾›å®Œæ•´çš„Markdownæ ¼å¼ï¼ŒåŒ…å«```mermaidå’Œ```æ ‡è®°ã€‚",
                classDiagram: "è¯·ç”Ÿæˆä¸€ä¸ªä½¿ç”¨Mermaidè¯­æ³•çš„ç±»å›¾ï¼Œæè¿°ä¸€ä¸ªç®€å•çš„ç”µå­å•†åŠ¡ç³»ç»Ÿï¼ŒåŒ…æ‹¬ç”¨æˆ·ã€å•†å“ã€è®¢å•å’Œè´­ç‰©è½¦ç±»ã€‚è¯·æä¾›å®Œæ•´çš„Markdownæ ¼å¼ï¼ŒåŒ…å«```mermaidå’Œ```æ ‡è®°ã€‚",
                stateDiagram: "è¯·ç”Ÿæˆä¸€ä¸ªä½¿ç”¨Mermaidè¯­æ³•çš„çŠ¶æ€å›¾ï¼Œæè¿°è®¢å•å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬åˆ›å»ºã€æ”¯ä»˜ã€å¤„ç†ã€å‘è´§å’Œå®ŒæˆçŠ¶æ€ã€‚è¯·æä¾›å®Œæ•´çš„Markdownæ ¼å¼ï¼ŒåŒ…å«```mermaidå’Œ```æ ‡è®°ã€‚",
                entityRelationship: "è¯·ç”Ÿæˆä¸€ä¸ªä½¿ç”¨Mermaidè¯­æ³•çš„å®ä½“å…³ç³»å›¾ï¼Œæè¿°å­¦æ ¡ç®¡ç†ç³»ç»Ÿä¸­çš„å­¦ç”Ÿã€æ•™å¸ˆã€è¯¾ç¨‹å’Œç­çº§ä¹‹é—´çš„å…³ç³»ã€‚è¯·æä¾›å®Œæ•´çš„Markdownæ ¼å¼ï¼ŒåŒ…å«```mermaidå’Œ```æ ‡è®°ã€‚",
                gantt: "è¯·ç”Ÿæˆä¸€ä¸ªä½¿ç”¨Mermaidè¯­æ³•çš„ç”˜ç‰¹å›¾ï¼Œæè¿°ä¸€ä¸ªä¸ºæœŸ3ä¸ªæœˆçš„è½¯ä»¶é¡¹ç›®è®¡åˆ’ï¼ŒåŒ…æ‹¬éœ€æ±‚åˆ†æã€è®¾è®¡ã€å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²é˜¶æ®µã€‚è¯·æä¾›å®Œæ•´çš„Markdownæ ¼å¼ï¼ŒåŒ…å«```mermaidå’Œ```æ ‡è®°ã€‚",
                pie: `pie
    title ç¼–ç¨‹è¯­è¨€å¸‚åœºä»½é¢
    "JavaScript" : 45
    "Python" : 25
    "Java" : 15
    "C++" : 10
    "å…¶ä»–" : 5`,
                userJourney: `journey
    title åœ¨çº¿è´­ç‰©ç”¨æˆ·æ—…ç¨‹
    section å‘ç°
      è®¿é—®ç½‘ç«™: 5: ç”¨æˆ·A
      æµè§ˆå•†å“: 4: ç”¨æˆ·A
    section è´­ä¹°
      åŠ å…¥è´­ç‰©è½¦: 5: ç”¨æˆ·A
      ç»“ç®—: 5: ç”¨æˆ·A
      æ”¯ä»˜: 5: ç”¨æˆ·A
    section æ”¶è´§
      ç­‰å¾…é…é€: 3: ç”¨æˆ·A
      æ”¶åˆ°å•†å“: 5: ç”¨æˆ·A`,
                mindmap: `mindmap
  root((é¡¹ç›®è§„åˆ’))
    é˜¶æ®µä¸€
      éœ€æ±‚åˆ†æ
      åŸå‹è®¾è®¡
    é˜¶æ®µäºŒ
      å¼€å‘
        å‰ç«¯
        åç«¯
      æµ‹è¯•
    é˜¶æ®µä¸‰
      éƒ¨ç½²
      ç»´æŠ¤`,
                gitGraph: `gitGraph
   commit
   branch feature-A
   checkout feature-A
   commit
   commit
   checkout main
   merge feature-A
   commit
   branch feature-B
   checkout feature-B
   commit`,
                timeline: `timeline
    title WebæŠ€æœ¯å‘å±•å²
    1990 : HTML
    1994 : Netscape Navigator
    1995 : JavaScript
    1996 : CSS
    2002 : Firefox
    2008 : Google Chrome
    2009 : Node.js
    2015 : HTML5 & ES6`,
                requirementDiagram: `requirementDiagram

requirement "ç™»å½•åŠŸèƒ½" {
    id: 1
    text: "ç”¨æˆ·éœ€è¦èƒ½å¤Ÿä½¿ç”¨é‚®ç®±å’Œå¯†ç ç™»å½•ç³»ç»Ÿã€‚"
    risk: Medium
    verifymethod: Test
}

element "ç™»å½•é¡µé¢" {
    type: "UI"
}

element "åç«¯éªŒè¯æœåŠ¡" {
    type: "Service"
}

"ç™»å½•é¡µé¢" - satisfies -> "ç™»å½•åŠŸèƒ½"
"åç«¯éªŒè¯æœåŠ¡" - satisfies -> "ç™»å½•åŠŸèƒ½"`,
                c4Context: `C4Context
  title ç³»ç»Ÿä¸Šä¸‹æ–‡å›¾ - ç½‘ä¸Šé“¶è¡Œç³»ç»Ÿ

  Person(customer, "é“¶è¡Œå®¢æˆ·", "ä½¿ç”¨ç½‘ä¸Šé“¶è¡ŒæœåŠ¡çš„å®¢æˆ·")
  System(internetBanking, "ç½‘ä¸Šé“¶è¡Œç³»ç»Ÿ", "å…è®¸å®¢æˆ·åœ¨çº¿ç®¡ç†ä»–ä»¬çš„è´¦æˆ·")
  System_Ext(emailSystem, "é‚®ä»¶ç³»ç»Ÿ", "ç”¨äºå‘é€é€šçŸ¥çš„å†…éƒ¨é‚®ä»¶ç³»ç»Ÿ")
  System_Ext(mainFrame, "å¤§å‹æœºé“¶è¡Œç³»ç»Ÿ", "å­˜å‚¨æ‰€æœ‰å®¢æˆ·è´¦æˆ·å’Œäº¤æ˜“ä¿¡æ¯")

  Rel(customer, internetBanking, "ä½¿ç”¨")
  Rel(internetBanking, emailSystem, "å‘é€é‚®ä»¶é€šçŸ¥", "SMTP")
  Rel(internetBanking, mainFrame, "ä½¿ç”¨", "API")`,
                sequenceComplaint: `sequenceDiagram
    actor Customer
    participant CustomerService
    participant TechnicalSupport
    participant Manager

    Customer->>CustomerService: Submit complaint
    CustomerService->>TechnicalSupport: Forward complaint
    TechnicalSupport->>TechnicalSupport: Analyze problem
    TechnicalSupport->>CustomerService: Provide solution suggestion
    CustomerService->>Manager: Request approval
    Manager->>CustomerService: Approve solution
    CustomerService->>Customer: Inform solution
    Customer->>CustomerService: Confirm satisfaction
    CustomerService->>TechnicalSupport: Close case`,
                quadrantChart: `quadrantChart
    title Reach and engagement of campaigns
    x-axis Low Reach --> High Reach
    y-axis Low Engagement --> High Engagement
    quadrant-1 We should expand
    quadrant-2 Need to promote
    quadrant-3 Re-evaluate
    quadrant-4 May be improved
    Campaign A: [0.3, 0.6]
    Campaign B: [0.45, 0.23]
    Campaign C: [0.57, 0.69]
    Campaign D: [0.78, 0.34]
    Campaign E: [0.40, 0.34]
    Campaign F: [0.35, 0.78]`,
                complaint: `flowchart TD
    A[æ”¶åˆ°å®¢æˆ·æŠ•è¯‰] --> B{æŠ•è¯‰åˆ†ç±»}
    B -->|è´¨é‡ç±»| C[è´¨é‡éƒ¨é—¨è°ƒæŸ¥]
    B -->|ç‰©æµç±»| D[ç‰©æµéƒ¨é—¨è°ƒæŸ¥]
    B -->|æœåŠ¡ç±»| E[å®¢æœéƒ¨é—¨è°ƒæŸ¥]
    C --> F[åŸå› åˆ†æ]
    D --> F
    E --> F
    F --> G[åˆ¶å®šè§£å†³æ–¹æ¡ˆ]
    G --> H[æ‰§è¡Œè§£å†³æ–¹æ¡ˆ]
    H --> I{å®¢æˆ·æ˜¯å¦æ»¡æ„}
    I -->|æ˜¯| J[è®°å½•å¹¶å…³é—­æŠ•è¯‰]
    I -->|å¦| K[å‡çº§å¤„ç†]
    K --> G
    J --> L[æµç¨‹ç»“æŸ]`
            };
            
            // Event listeners for template buttons
            templateButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const templateType = button.getAttribute('data-template');
                    promptInput.value = templates[templateType];
                });
            });
            
            // Generate button click event
            generateBtn.addEventListener('click', async () => {
                const prompt = promptInput.value.trim();
                
                if (!prompt) {
                    showError('è¯·è¾“å…¥æè¿°å†…å®¹');
                    return;
                }
                
                setLoading(true);
                hideError();
                
                try {
                    const response = await callDeepSeekAPI(prompt);
                    await processResponse(response);
                    outputContainer.classList.remove('d-none');
                } catch (error) {
                    console.error('Error:', error);
                    showError('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
                } finally {
                    setLoading(false);
                }
            });
            
            // Test diagram button click event
            testDiagramBtn.addEventListener('click', async () => {
                const prompt = promptInput.value.trim();
                
                if (!prompt) {
                    showError('è¯·è¾“å…¥Markdownå†…å®¹æˆ–Mermaidè¯­æ³•');
                    return;
                }
                
                setLoading(true);
                hideError();
                
                try {
                    let markdown = '';
                    let rawCode = prompt;

                    // Check if it's raw mermaid code and clean it up
                    if (!rawCode.includes('```mermaid')) {
                        const lines = rawCode.trim().split('\n');
                        if (lines.length > 1 && lines[0].trim().match(/^(sequenceDiagram)/i) && lines[lines.length - 1].trim() === 'end') {
                            rawCode = lines.slice(0, -1).join('\n');
                        }
                    }

                    // Check if the input already contains mermaid code blocks
                    if (rawCode.includes('```mermaid') && rawCode.includes('```')) {
                        // Input already contains mermaid code blocks, use as-is
                        markdown = rawCode;
                    } else {
                        // Check if it's raw mermaid code (starts with mermaid keywords)
                        if (rawCode.match(/^(flowchart|graph|sequenceDiagram|classDiagram|stateDiagram|gantt|pie|journey|gitGraph|erDiagram|mindmap|timeline|quadrantChart|requirement|c4Context)/i)) {
                            // It's raw mermaid code, wrap it in markdown
                            markdown = `# Mermaid æµç¨‹å›¾

## è½¬æ¢ç»“æœ

\`\`\`mermaid
${rawCode}
\`\`\`

`;
                        } else {
                            // It might be markdown without mermaid blocks, or mixed content
                            // Try to extract any existing mermaid code or treat as markdown
                            markdown = rawCode;
                        }
                    }
                    
                    await processResponse(markdown);
                    outputContainer.classList.remove('d-none');
                    
                    // Switch to the diagram tab if mermaid code was found
                    const extractedCode = extractMermaidCode(markdown);
                    if (extractedCode) {
                        document.getElementById('diagram-tab').click();
                    } else {
                        document.getElementById('preview-tab').click();
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    showError('è½¬æ¢å¤±è´¥ï¼š' + error.message);
                } finally {
                    setLoading(false);
                }
            });
            
            // Clear button click event
            clearBtn.addEventListener('click', () => {
                promptInput.value = '';
                outputContainer.classList.add('d-none');
                hideError();
            });
            
            // Copy buttons event listeners
            copyMarkdownBtn.addEventListener('click', () => {
                copyToClipboard(markdownOutput.textContent);
                showCopyFeedback(copyMarkdownBtn);
            });
            
            copyDiagramBtn.addEventListener('click', () => {
                // Extract Mermaid code from the diagram
                const mermaidCode = extractMermaidCode(markdownOutput.textContent);
                copyToClipboard(mermaidCode);
                showCopyFeedback(copyDiagramBtn);
            });
            
            // Download SVG button event listener
            downloadSvgBtn.addEventListener('click', () => {
                downloadDiagramAsSvg();
            });
            
            // Download PNG button event listener
            downloadPngBtn.addEventListener('click', () => {
                downloadDiagramAsPng();
            });
            
            // Call the DeepSeek API
            async function callDeepSeekAPI(prompt) {
                // Enhanced prompt to get better Mermaid diagrams
                const enhancedPrompt = `
                è¯·æ ¹æ®ä»¥ä¸‹æè¿°ç”ŸæˆMarkdownå†…å®¹ï¼Œå¹¶åŒ…å«ä¸€ä¸ªä½¿ç”¨Mermaidè¯­æ³•çš„æµç¨‹å›¾ã€‚
                
                è¦æ±‚ï¼š
                1. ç”Ÿæˆçš„Markdownåº”è¯¥åŒ…å«æ ‡é¢˜ã€ç®€çŸ­ä»‹ç»å’ŒMermaidæµç¨‹å›¾
                2. Mermaidä»£ç å¿…é¡»æ”¾åœ¨ \`\`\`mermaid å’Œ \`\`\` æ ‡è®°ä¹‹é—´
                3. ç¡®ä¿Mermaidè¯­æ³•æ­£ç¡®ï¼Œå¯ä»¥è¢«æ¸²æŸ“
                4. æµç¨‹å›¾åº”è¯¥æ¸…æ™°ã€ç®€æ´ï¼Œä½¿ç”¨é€‚å½“çš„å½¢çŠ¶å’Œè¿æ¥çº¿
                5. ä¸è¦ç”Ÿæˆè¿‡äºå¤æ‚çš„å›¾è¡¨ï¼Œä¿æŒèŠ‚ç‚¹æ•°é‡åˆç†
                
                ç”¨æˆ·æè¿°ï¼š
                ${prompt}
                `;
                
                try {
                    // First try the API endpoint
                    try {
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                messages: [
                                    {
                                        role: 'system',
                                        content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£ç¼–å†™è€…ï¼Œæ“…é•¿ä½¿ç”¨Markdownå’ŒMermaidåˆ›å»ºæµç¨‹å›¾å’ŒæŠ€æœ¯æ–‡æ¡£ã€‚'
                                    },
                                    {
                                        role: 'user',
                                        content: enhancedPrompt
                                    }
                                ]
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`APIé”™è¯¯ï¼š${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.choices && data.choices[0]?.message?.content) {
                            return data.choices[0].message.content;
                        } else {
                            throw new Error('APIè¿”å›æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (apiError) {
                        console.warn('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', apiError);
                        
                        // If API call fails, return a mock response for testing
                        return `# ${prompt.split('.')[0]}

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨Mermaidè¯­æ³•ç”Ÿæˆçš„æµç¨‹å›¾ç¤ºä¾‹ã€‚

## ç®€ä»‹

æµç¨‹å›¾æ˜¯è¡¨ç¤ºå·¥ä½œæµç¨‹æˆ–è¿‡ç¨‹çš„å›¾å½¢è¡¨ç¤ºã€‚é€šè¿‡å¯è§†åŒ–æ–¹å¼å±•ç¤ºæ­¥éª¤ã€å†³ç­–å’Œè¡ŒåŠ¨ï¼Œä½¿å¤æ‚è¿‡ç¨‹æ›´å®¹æ˜“ç†è§£ã€‚

## Mermaidæµç¨‹å›¾

\`\`\`mermaid
flowchart TD
    A[å¼€å§‹] --> B{æ˜¯å¦æœ‰ç°æœ‰æ¨¡æ¿?}
    B -->|æ˜¯| C[é€‰æ‹©æ¨¡æ¿]
    B -->|å¦| D[ç¼–å†™è‡ªå®šä¹‰æç¤º]
    C --> E[ç‚¹å‡»ç”ŸæˆæŒ‰é’®]
    D --> E
    E --> F[è°ƒç”¨ DeepSeek API]
    F --> G[å¤„ç† API å“åº”]
    G --> H[æ˜¾ç¤º Markdown æ–‡æœ¬]
    G --> I[æ¸²æŸ“ Markdown é¢„è§ˆ]
    G --> J[æ¸²æŸ“ Mermaid æµç¨‹å›¾]
    H --> K[å¤åˆ¶ Markdown]
    J --> L[å¤åˆ¶ Mermaid ä»£ç ]
    K --> M[ç»“æŸ]
    L --> M
\`\`\`

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šæµç¨‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°äº†è§£æ•´ä¸ªè¿‡ç¨‹çš„å„ä¸ªæ­¥éª¤å’Œå†³ç­–ç‚¹ã€‚è¿™ç§å¯è§†åŒ–è¡¨ç¤ºæœ‰åŠ©äºæ›´å¥½åœ°ç†è§£å’Œæ²Ÿé€šå¤æ‚çš„å·¥ä½œæµç¨‹ã€‚
`;
                    }
                } catch (error) {
                    console.error('æ‰€æœ‰APIè°ƒç”¨å°è¯•éƒ½å¤±è´¥:', error);
                    throw error;
                }
            }
            
            // Process the API response
            async function processResponse(response) {
                // Display markdown
                markdownOutput.textContent = response;
                
                // Safely highlight code
                if (typeof hljs !== 'undefined') {
                    try {
                        hljs.highlightElement(markdownOutput);
                    } catch (e) {
                        console.warn('Error highlighting code:', e);
                    }
                }
                
                // Render markdown preview safely
                try {
                    if (typeof marked !== 'undefined') {
                        if (typeof marked.marked === 'function') {
                            markdownPreview.innerHTML = marked.marked(response);
                        } else if (typeof marked.parse === 'function') {
                            markdownPreview.innerHTML = marked.parse(response);
                        } else {
                            markdownPreview.innerHTML = response;
                            console.warn('Marked library found but no parse/marked method available');
                        }
                    } else {
                        markdownPreview.innerHTML = response;
                        console.warn('Marked library not found');
                    }
                } catch (e) {
                    console.error('Error rendering markdown:', e);
                    markdownPreview.innerHTML = response;
                }
                
                // Extract and render Mermaid diagram
                const mermaidCode = extractMermaidCode(response);
                if (mermaidCode) {
                    await renderMermaidDiagram(mermaidCode);
                } else {
                    diagramOutput.innerHTML = `
                        <div class="alert alert-warning">
                            <h5>æœªæ‰¾åˆ°Mermaidä»£ç </h5>
                            <p>åœ¨ç”Ÿæˆçš„Markdownä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„Mermaidä»£ç å—ã€‚è¯·ç¡®ä¿ç”Ÿæˆçš„å†…å®¹åŒ…å«ä»¥ \`\`\`mermaid å¼€å§‹çš„ä»£ç å—ã€‚</p>
                        </div>
                    `;
                }
            }
            
            // Extract Mermaid code from markdown
            function extractMermaidCode(markdown) {
                const mermaidRegex = /```mermaid\s*([\s\S]*?)\s*```/;
                const match = markdown.match(mermaidRegex);
                return match ? match[1].trim() : null;
            }
            
            // Render Mermaid diagram
            async function renderMermaidDiagram(mermaidCode) {
                diagramOutput.innerHTML = '';
                
                if (typeof mermaid !== 'undefined') {
                    try {
                        // Create a unique ID for the diagram
                        const id = 'mermaid-diagram-' + Date.now();
                        
                        // First, validate the syntax
                        try {
                            mermaid.parse(mermaidCode);
                        } catch (parseError) {
                            console.error('Mermaid parsing error:', parseError);
                            diagramOutput.innerHTML = `
                                <div class="alert alert-danger">
                                    <h5>Mermaidè¯­æ³•é”™è¯¯</h5>
                                    <p>${parseError.message || 'æœªçŸ¥é”™è¯¯'}</p>
                                    <pre class="p-3 bg-light border rounded"><code>${mermaidCode}</code></pre>
                                </div>
                            `;
                            return;
                        }
                        
                        // If parsing succeeded, render the diagram
                        try {
                            const { svg } = await mermaid.render(id, mermaidCode);
                            diagramOutput.innerHTML = svg;
                        } catch (renderError) {
                            console.error('Mermaid rendering error:', renderError);
                            diagramOutput.innerHTML = `
                                <div class="alert alert-danger">
                                    <h5>Mermaidæ¸²æŸ“é”™è¯¯</h5>
                                    <p>${renderError.message || 'æœªçŸ¥é”™è¯¯'}</p>
                                    <pre class="p-3 bg-light border rounded"><code>${mermaidCode}</code></pre>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Mermaid general error:', error);
                        diagramOutput.innerHTML = `
                            <div class="alert alert-danger">
                                <h5>Mermaidé”™è¯¯</h5>
                                <p>${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                                <pre class="p-3 bg-light border rounded"><code>${mermaidCode}</code></pre>
                            </div>
                        `;
                    }
                } else {
                    // If mermaid is not available, display the code and a message
                    diagramOutput.innerHTML = `
                        <div class="alert alert-warning">
                            <h5>Mermaidåº“æœªåŠ è½½</h5>
                            <p>æ— æ³•æ¸²æŸ“å›¾è¡¨ã€‚ä»¥ä¸‹æ˜¯å›¾è¡¨ä»£ç ï¼š</p>
                            <pre class="p-3 bg-light border rounded"><code>${mermaidCode}</code></pre>
                        </div>
                    `;
                }
            }
            
            // Download diagram as SVG
            function downloadDiagramAsSvg() {
                const svgElement = diagramOutput.querySelector('svg');
                if (!svgElement) {
                    showError('æ²¡æœ‰æ‰¾åˆ°å¯ä¸‹è½½çš„å›¾è¡¨');
                    return;
                }
                
                // Clone the SVG to avoid modifying the original
                const clonedSvg = svgElement.cloneNode(true);
                
                // Get the actual dimensions of the SVG content
                const bbox = svgElement.getBBox();
                const padding = 20;
                
                // Set proper viewBox and dimensions
                clonedSvg.setAttribute('viewBox', `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + 2 * padding} ${bbox.height + 2 * padding}`);
                clonedSvg.setAttribute('width', bbox.width + 2 * padding);
                clonedSvg.setAttribute('height', bbox.height + 2 * padding);
                
                // Add XML declaration and namespace
                clonedSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                clonedSvg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
                
                // Convert to string
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(clonedSvg);
                const fullSvgString = '<?xml version="1.0" encoding="UTF-8"?>\n' + svgString;
                
                // Create download
                const blob = new Blob([fullSvgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'mermaid-diagram.svg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            // Download diagram as PNG
            function downloadDiagramAsPng() {
                const svgElement = diagramOutput.querySelector('svg');
                if (!svgElement) {
                    showError('æ²¡æœ‰æ‰¾åˆ°å¯ä¸‹è½½çš„å›¾è¡¨');
                    return;
                }
                
                // Clone the SVG to avoid modifying the original
                const clonedSvg = svgElement.cloneNode(true);
                
                // Get the actual dimensions of the SVG content
                const bbox = svgElement.getBBox();
                const padding = 20;
                const scale = 2; // High resolution multiplier
                
                // Set proper viewBox and dimensions
                clonedSvg.setAttribute('viewBox', `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + 2 * padding} ${bbox.height + 2 * padding}`);
                clonedSvg.setAttribute('width', bbox.width + 2 * padding);
                clonedSvg.setAttribute('height', bbox.height + 2 * padding);
                
                // Add XML declaration and namespace
                clonedSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                clonedSvg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
                
                // Convert SVG to data URL
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(clonedSvg);
                const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
                
                // Create canvas for high-resolution rendering
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Set canvas size with high resolution
                    canvas.width = (bbox.width + 2 * padding) * scale;
                    canvas.height = (bbox.height + 2 * padding) * scale;
                    
                    // Enable high-DPI rendering
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // Fill background with white
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw the SVG
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Convert to PNG and download
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'mermaid-diagram.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 'image/png', 1.0);
                };
                
                img.onerror = function() {
                    showError('PNGè½¬æ¢å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½SVGæ ¼å¼');
                };
                
                img.src = svgDataUrl;
            }
            
            // Copy text to clipboard
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                });
            }
            
            // Show copy feedback
            function showCopyFeedback(button) {
                const originalText = button.textContent;
                button.textContent = 'å·²å¤åˆ¶!';
                button.disabled = true;
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            }
            
            // Set loading state
            function setLoading(isLoading) {
                if (isLoading) {
                    loadingSpinner.classList.remove('d-none');
                    buttonText.textContent = 'ç”Ÿæˆä¸­...';
                    generateBtn.disabled = true;
                } else {
                    loadingSpinner.classList.add('d-none');
                    buttonText.textContent = 'ç”Ÿæˆ Markdown å’Œæµç¨‹å›¾';
                    generateBtn.disabled = false;
                }
            }
            
            // Show error message
            function showError(message) {
                errorContainer.textContent = message;
                errorContainer.classList.remove('d-none');
            }
            
            // Hide error message
            function hideError() {
                errorContainer.classList.add('d-none');
                errorContainer.textContent = '';
            }
            
            // About modal functionality
            const aboutBtn = document.getElementById('aboutBtn');
            const aboutModal = document.getElementById('aboutModal');
            const aboutClose = document.getElementById('aboutClose');
            
            // Open about modal
            aboutBtn.addEventListener('click', () => {
                aboutModal.classList.add('show');
                document.body.style.overflow = 'hidden';
            });
            
            // Close about modal
            aboutClose.addEventListener('click', () => {
                aboutModal.classList.remove('show');
                document.body.style.overflow = 'auto';
            });
            
            // Close modal when clicking outside
            aboutModal.addEventListener('click', (e) => {
                if (e.target === aboutModal) {
                    aboutModal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && aboutModal.classList.contains('show')) {
                    aboutModal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            });
        });
    </script>
    
    <script src="../js/common.js"></script>
</body>
</html>