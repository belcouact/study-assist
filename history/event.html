<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史事件 - Study Assist</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --ancient-color: #8B4513;
            --imperial-color: #800020;
            --modern-early-color: #2F4F4F;
            --modern-color: #191970;
            --contemporary-color: #006400;
        }

        .event-section {
            min-height: calc(100vh - 160px);
            padding: 4rem 0;
            background-color: var(--bg-light);
            transition: background-color 0.5s ease;
        }

        .event-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
        }

        .event-card {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            margin: 2rem 0;
            opacity: 0;
            transform: translateX(0);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .event-card.slide-in {
            opacity: 1;
        }

        .event-card.slide-left {
            transform: translateX(-100%);
        }

        .event-card.slide-right {
            transform: translateX(100%);
        }

        .event-title {
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 1rem;
        }

        .event-date {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .event-background, .event-impact {
            margin-bottom: 2rem;
        }

        .event-background h3, .event-impact h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .event-background p, .event-impact p {
            color: var(--text-secondary);
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .nav-buttons {
            position: absolute;
            top: 50%;
            width: 100%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 10;
        }

        .nav-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            pointer-events: auto;
            opacity: 0.8;
        }

        .nav-button:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .nav-button i {
            font-size: 1.5rem;
        }

        .event-progress {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 2rem;
            font-size: 1.1rem;
        }

        /* Period-specific styles */
        .period-ancient {
            --primary-color: var(--ancient-color);
        }

        .period-imperial {
            --primary-color: var(--imperial-color);
        }

        .period-modern-early {
            --primary-color: var(--modern-early-color);
        }

        .period-modern {
            --primary-color: var(--modern-color);
        }

        .period-contemporary {
            --primary-color: var(--contemporary-color);
        }
    </style>
</head>
<body>
    <!-- Header (same as index.html) -->
    <header class="main-header">
        <div class="container">
            <div class="logo">
                <a href="../index.html">Study Assist</a>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="../index.html">首页</a></li>
                    <li><a href="../subjects.html">学科</a></li>
                    <li><a href="../profile.html">个人中心</a></li>
                </ul>
            </nav>
            <div class="profile-display" id="profile-display">
                <!-- Profile info will be loaded here -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section class="event-section">
            <div class="event-container">
                <div class="nav-buttons">
                    <button class="nav-button prev-button" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-button next-button">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="event-card">
                    <!-- Event content will be loaded here -->
                </div>
                <div class="event-progress">
                    <!-- Progress info will be shown here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Footer (same as index.html) -->
    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2024 Study Assist. All rights reserved.</p>
        </div>
    </footer>

    <script>
        class HistoryEvents {
            constructor() {
                this.events = [];
                this.currentIndex = 0;
                this.period = '';
                this.isLoading = false;

                // Get DOM elements
                this.eventCard = document.querySelector('.event-card');
                this.prevButton = document.querySelector('.prev-button');
                this.nextButton = document.querySelector('.next-button');
                this.progressDisplay = document.querySelector('.event-progress');
                this.eventSection = document.querySelector('.event-section');

                // Initialize
                this.init();
            }

            async init() {
                // Get period from URL
                const urlParams = new URLSearchParams(window.location.search);
                this.period = urlParams.get('period') || 'ancient';

                // Add period-specific class
                document.body.classList.add(`period-${this.period}`);

                // Set up event listeners
                this.setupEventListeners();

                // Load events
                await this.loadEvents();
            }

            setupEventListeners() {
                this.prevButton.addEventListener('click', () => this.showPreviousEvent());
                this.nextButton.addEventListener('click', () => this.showNextEvent());

                // Add keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') this.showPreviousEvent();
                    if (e.key === 'ArrowRight') this.showNextEvent();
                });
            }

            async loadEvents() {
                this.isLoading = true;
                this.showLoading();

                try {
                    // Get education level from profile
                    const profileDisplay = document.getElementById('profile-display');
                    let educationLevel = 'middle-school';
                    let grade = '';

                    if (profileDisplay) {
                        const levelText = profileDisplay.textContent.toLowerCase();
                        const profile = levelText.split(" | ");

                        if (levelText.includes('小学')) {
                            educationLevel = 'elementary-school';
                            grade = profile[1];
                        } else if (levelText.includes('初中')) {
                            educationLevel = 'middle-school';
                            grade = profile[1];
                        } else if (levelText.includes('高中')) {
                            educationLevel = 'high-school';
                            grade = profile[1];
                        }
                    }

                    // Get period name in Chinese
                    const periodNames = {
                        'ancient': '先秦时期',
                        'imperial': '帝国时期',
                        'modern-early': '近代史',
                        'modern': '现代史',
                        'contemporary': '当代史'
                    };

                    // Build prompt based on education level
                    const prompt = `作为一个专业的历史教育专家，请为${grade || '初中'}学生提供${periodNames[this.period]}的重要历史事件。

要求：
1. 提供不少于20个该时期最重要的历史事件
2. 每个事件需包含：
   - 事件标题
   - 具体发生时间
   - 历史背景（适合${grade || '初中'}学生理解的深度）
   - 历史影响（重点说明对中国历史发展的影响）

3. 考虑到学生的认知水平，请：
   - 使用适合其年龄的语言
   - 重点解释关键概念
   - 通过具体例子帮助理解
   - 建立与现代生活的联系

4. 按时间顺序排列，使用JSON格式返回：
{
  "events": [
    {
      "title": "事件标题",
      "date": "发生时间",
      "background": "历史背景",
      "impact": "历史影响"
    }
  ]
}`;

                    // Call DeepSeek API
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: [
                                {
                                    "role": "system",
                                    "content": "你是一个专业的历史教育专家，擅长用适合学生理解的方式讲解历史事件。"
                                },
                                {
                                    "role": "user",
                                    "content": prompt
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }

                    const data = await response.json();
                    const content = data.choices[0].message.content;

                    // Parse JSON from response
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('无法从响应中提取JSON数据');
                    }

                    const result = JSON.parse(jsonMatch[0]);
                    this.events = result.events;

                    // Show first event
                    this.showEvent(0);

                } catch (error) {
                    console.error('加载历史事件时出错:', error);
                    this.showError(error.message);
                }

                this.isLoading = false;
            }

            showEvent(index) {
                if (index < 0 || index >= this.events.length) return;

                const event = this.events[index];
                
                // Prepare new content
                const newContent = `
                    <h2 class="event-title">${event.title}</h2>
                    <div class="event-date">${event.date}</div>
                    <div class="event-background">
                        <h3>历史背景</h3>
                        <p>${event.background}</p>
                    </div>
                    <div class="event-impact">
                        <h3>历史影响</h3>
                        <p>${event.impact}</p>
                    </div>
                `;

                // Update progress display
                this.progressDisplay.textContent = `第 ${index + 1} 个事件，共 ${this.events.length} 个`;

                // Update navigation buttons
                this.prevButton.disabled = index === 0;
                this.nextButton.disabled = index === this.events.length - 1;

                // Apply slide animation
                const direction = index > this.currentIndex ? 'right' : 'left';
                this.animateCardTransition(newContent, direction);

                this.currentIndex = index;
            }

            animateCardTransition(newContent, direction) {
                // Add exit animation class
                this.eventCard.classList.remove('slide-in');
                this.eventCard.classList.add(`slide-${direction === 'right' ? 'left' : 'right'}`);

                // After exit animation, update content and animate entrance
                setTimeout(() => {
                    this.eventCard.innerHTML = newContent;
                    this.eventCard.classList.remove(`slide-${direction === 'right' ? 'left' : 'right'}`);
                    this.eventCard.classList.add(`slide-${direction === 'right' ? 'right' : 'left'}`);

                    // Trigger reflow
                    void this.eventCard.offsetWidth;

                    // Animate entrance
                    this.eventCard.classList.remove(`slide-${direction === 'right' ? 'right' : 'left'}`);
                    this.eventCard.classList.add('slide-in');
                }, 500);
            }

            showPreviousEvent() {
                if (this.currentIndex > 0 && !this.isLoading) {
                    this.showEvent(this.currentIndex - 1);
                }
            }

            showNextEvent() {
                if (this.currentIndex < this.events.length - 1 && !this.isLoading) {
                    this.showEvent(this.currentIndex + 1);
                }
            }

            showLoading() {
                this.eventCard.innerHTML = `
                    <div class="loading-message">
                        <p>正在加载历史事件...</p>
                    </div>
                `;
            }

            showError(message) {
                this.eventCard.innerHTML = `
                    <div class="error-message">
                        <p>加载历史事件时出错</p>
                        <p class="error-details">${message}</p>
                    </div>
                `;
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new HistoryEvents();
        });
    </script>
</body>
</html> 