<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对话语音转换 - 学习助手</title>
    <link rel="icon" href="assets/icons/logo_btrfly.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e0c3fc 100%);
            background-attachment: fixed;
            font-family: 'Poppins', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 200px);
        }
        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .section-header h1 {
            color: #7209b7;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #7209b7, #4361ee, #4cc9f0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 2px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(76,201,240,0.08);
        }
        .section-header p {
            color: #666;
            font-size: 1.15rem;
            letter-spacing: 1px;
        }
        .assistant-container {
            background: rgba(255,255,255,0.85);
            border-radius: 2rem;
            box-shadow: 0 8px 32px 0 rgba(76,201,240,0.12), 0 1.5px 8px 0 rgba(114,9,183,0.08);
            backdrop-filter: blur(2px);
            max-width: 1100px;
            margin: 0 auto;
            padding: 2.5rem 2rem 2rem 2rem;
        }
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #7209b7;
        }
        textarea {
            width: 100%;
            padding: 1.1rem 1rem;
            border: 1.5px solid #e0c3fc;
            border-radius: 1.1rem;
            min-height: 300px;
            font-size: 1.13rem;
            box-sizing: border-box;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 8px rgba(76,201,240,0.06);
            outline: none;
            transition: border 0.2s;
            resize: vertical;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        textarea:focus {
            border: 1.5px solid #7209b7;
            background: #f8fafc;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1.1rem;
            margin-bottom: 24px;
        }
        .control-group {
            flex: 1 1 180px;
            min-width: 150px;
            background: rgba(236,222,255,0.7);
            border-radius: 0.9rem;
            padding: 0.7rem 1rem 0.7rem 1rem;
            margin-bottom: 0;
            border: 1.5px solid #e0c3fc;
            box-shadow: 0 1px 4px rgba(76,201,240,0.04);
        }
        select, input[type="range"] {
            width: 100%;
            padding: 0.9rem;
            border: 1.5px solid #e0c3fc;
            border-radius: 0.9rem;
            font-size: 1.08rem;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 1px 4px rgba(76,201,240,0.05);
            transition: border 0.2s;
        }
        select:focus, input[type="range"]:focus {
            border: 1.5px solid #7209b7;
        }
        button {
            background: linear-gradient(90deg, #7209b7, #4361ee 80%);
            color: #fff;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 0.9rem;
            cursor: pointer;
            font-size: 1.13rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(76,201,240,0.08);
            transition: opacity 0.3s, background 0.2s;
            width: 100%;
        }
        button:hover {
            opacity: 0.92;
            background: linear-gradient(90deg, #4361ee, #7209b7 80%);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .audio-container {
            margin-top: 30px;
            text-align: center;
            display: none;
        }
        .audio-container.visible {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            display: none;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
            display: block;
        }
        .status.loading {
            background-color: #e3f2fd;
            color: #1565c0;
            display: block;
        }
        .audio-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        .audio-actions button {
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 4px;
            width: auto;
        }
        .btn-download {
            background-color: #28a745;
        }
        .btn-download:hover {
            background-color: #218838;
        }
        .dialog-info {
            margin-top: 20px;
            background: rgba(255,255,255,0.95);
            border-radius: 1.2rem;
            border: 2px solid #e0c3fc;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(76,201,240,0.13);
            display: none;
        }
        .dialog-info.visible {
            display: block;
            animation: fadeIn 0.5s;
        }
        .role-list {
            margin-top: 15px;
        }
        .role-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0c3fc;
        }
        .role-name {
            font-weight: 500;
            flex: 1;
        }
        .role-voice-select {
            min-width: 200px;
        }
        .example-btn {
            display: inline-block;
            padding: 6px 12px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #4361ee;
            background: rgba(236,222,255,0.7);
            border: 1px solid #e0c3fc;
            border-radius: 6px;
            cursor: pointer;
        }
        .example-btn:hover {
            background: rgba(236,222,255,0.9);
        }
        
        @media (max-width: 768px) {
            .assistant-container {
                padding: 1.5rem 1.2rem;
                border-radius: 1.5rem;
                max-width: 100%;
                margin: 0 0.8rem;
            }
            .section-header {
                padding: 1rem 0;
            }
            .section-header h1 {
                font-size: 1.8rem;
                margin-bottom: 0.5rem;
            }
            .section-header p {
                font-size: 1rem;
            }
            .form-group label, .control-group label {
                font-size: 1.01rem;
            }
            textarea {
                font-size: 1.01rem;
                min-height: 200px;
                border-radius: 0.8rem;
                padding: 0.8rem;
            }
            .controls {
                gap: 0.6rem;
                flex-direction: column;
            }
            .control-group {
                flex: 1 1 100%;
                border-radius: 0.8rem;
            }
            .role-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .role-voice-select {
                width: 100%;
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="index.html">
                        <i class="fas fa-graduation-cap" style="background: linear-gradient(90deg, #4361ee, #7209b7); -webkit-background-clip: text; background-clip: text; color: transparent;"></i>
                        <span class="gradient-text">Alex的学习助手</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="index.html">首页</a></li>
                        <li><a href="index.html#subjects">科目</a></li>
                        <li><a href="tts.html">语音</a></li>
                        <li><a href="draw.html">绘图</a></li>
                    </ul>
                </nav>
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="section-header">
                <h1>对话<span class="gradient-text">语音</span>转换</h1>
                <p>为不同角色自动选择不同的声音，让对话更生动</p>
            </div>
            <div class="assistant-container">
                <div class="form-group">
                    <label for="dialog-input">输入对话文本（每个角色的台词以"角色名: "开头）：</label>
                    <textarea id="dialog-input" placeholder="例如：
Mom: Wake up, sweetheart! It's time for school. 
妈妈：醒醒，宝贝！该上学了。 
Child: Just five more minutes, please! 
孩子：再睡五分钟嘛，求你了！"></textarea>
                    <button class="example-btn" id="load-example">加载示例对话</button>
                </div>
                
                <button id="analyze-btn" class="mb-4">分析对话</button>
                
                <div id="dialog-info" class="dialog-info">
                    <h3>角色配音设置</h3>
                    <p>我们已识别出以下角色，您可以为每个角色选择不同的声音：</p>
                    
                    <div id="role-list" class="role-list">
                        <!-- Roles will be inserted here by JS -->
                    </div>
                </div>
                
                <button id="generate-btn" style="margin-top: 20px; display: none;">生成对话语音</button>
                
                <div class="status" id="status"></div>
                
                <div class="audio-container" id="audio-container">
                    <audio id="audio-player" controls style="width: 100%; border-radius: 1.1rem;"></audio>
                    <div class="audio-actions">
                        <button id="download-btn" class="btn-download">
                            <i class="fas fa-download"></i> 下载音频
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p style="margin: 0;">&copy; 2025 Alex的学习助手。保留所有权利。</p>
            </div>
        </div>
    </footer>

    <script src="js/common.js"></script>
    <script src="js/navigation.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dialogInput = document.getElementById('dialog-input');
            const analyzeBtn = document.getElementById('analyze-btn');
            const generateBtn = document.getElementById('generate-btn');
            const dialogInfo = document.getElementById('dialog-info');
            const roleList = document.getElementById('role-list');
            const audioContainer = document.getElementById('audio-container');
            const audioPlayer = document.getElementById('audio-player');
            const downloadBtn = document.getElementById('download-btn');
            const status = document.getElementById('status');
            const loadExampleBtn = document.getElementById('load-example');
            
            let currentAudioBlob = null;
            let identifiedRoles = [];
            
            // Voice options for different roles
            const voiceOptions = {
                male: [
                    { value: "Chinese (Mandarin)_Elite_Young", label: "精英男青年" },
                    { value: "Chinese (Mandarin)_Lyrical_Voice", label: "抒情男声" },
                    { value: "Chinese (Mandarin)_Male_Announcer", label: "雄浑播音男士" },
                    { value: "Chinese (Mandarin)_Pure-hearted_Boy", label: "纯真少年男生" },
                    { value: "English_Gentle_Voiced_Man", label: "Gentle-voiced Man" },
                    { value: "English_Trustworth_Man", label: "Trustworthy Man" },
                    { value: "Cantonese_Professional_Host_Male", label: "粤语专业男主持" }
                ],
                female: [
                    { value: "Chinese (Mandarin)_Young_Girl", label: "智慧少女" },
                    { value: "Chinese (Mandarin)_Warm_Girl", label: "温暖少年女生" },
                    { value: "English_Graceful_Lady", label: "Graceful Lady" },
                    { value: "English_UpsetGirl", label: "Upset Girl" },
                    { value: "English_Wiselady", label: "Wise Lady" },
                    { value: "Cantonese_Professional_Host_Female", label: "粤语专业女主持" }
                ],
                child: [
                    { value: "Chinese (Mandarin)_Pure-hearted_Boy", label: "纯真少年男生" },
                    { value: "Chinese (Mandarin)_Warm_Girl", label: "温暖少年女生" },
                    { value: "English_UpsetGirl", label: "Upset Girl" }
                ]
            };
            
            // Common role name mappings
            const roleCategories = {
                male: ["dad", "father", "grandpa", "grandfather", "uncle", "brother", "boy", "man", "mr", "sir", "male"],
                female: ["mom", "mother", "grandma", "grandmother", "aunt", "sister", "girl", "woman", "mrs", "ms", "miss", "lady", "female"],
                child: ["child", "kid", "baby", "boy", "girl", "son", "daughter"]
            };
            
            // Load example dialog
            loadExampleBtn.addEventListener('click', () => {
                dialogInput.value = `Mom: Wake up, sweetheart! It's time for school. 
妈妈：醒醒，宝贝！该上学了。 
Child: Just five more minutes, please! 
孩子：再睡五分钟嘛，求你了！ 
Dad: Did you sleep well last night? 
爸爸：昨晚睡得好吗？ 
Child: Yes, but I had a strange dream. 
孩子：是的，不过我做了个奇怪的梦。 
Mom: Hurry up, or you'll be late! 
妈妈：快点，不然你要迟到了！ 
Child: Okay, I'm getting up now! 
孩子：好吧，我起来了！ 
Dad: Did you brush your teeth? 
爸爸：你刷牙了吗？ 
Child: Not yet. I'll do it now! 
孩子：还没有，我现在去刷！ 
Mom: What do you want for breakfast? 
妈妈：你早餐想吃什么？ 
Child: Can I have some pancakes? 
孩子：我可以吃点煎饼吗？ 
Dad: Don't forget to pack your school bag. 
爸爸：别忘了整理你的书包。 
Child: I already did it last night! 
孩子：我昨晚已经整理好了！ 
Mom: Wear your sweater. It's cold outside. 
妈妈：穿上你的毛衣，外面很冷。 
Child: But I don't like sweaters! 
孩子：可是我不喜欢毛衣！ 
Dad: Do you have your lunchbox? 
爸爸：你的午餐盒带了吗？ 
Child: Oh no! I left it in the kitchen! 
孩子：哦不！我把它忘在厨房了！ 
Mom: Give me a hug before you go! 
妈妈：走之前给我一个拥抱！ 
Child: Love you, Mom! 
孩子：爱你，妈妈！ 
Dad: Have a great day at school! 
爸爸：祝你在学校度过美好的一天！ 
Child: Thanks, Dad! See you later! 
孩子：谢谢，爸爸！待会见！`;
            });
            
            // Analyze the dialog text using DeepSeek API
            analyzeBtn.addEventListener('click', async () => {
                const dialogText = dialogInput.value.trim();
                
                if (!dialogText) {
                    showError('请输入对话文本');
                    return;
                }
                
                showLoading('正在分析对话文本...');
                generateBtn.style.display = 'none';
                dialogInfo.classList.remove('visible');
                audioContainer.classList.remove('visible');
                
                try {
                    // Call DeepSeek API to analyze the dialog
                    const messages = [
                        {
                            role: "system",
                            content: "你是一个专业的对话分析助手，擅长解析双语对话内容。请帮助从对话中提取所有说话者角色，并从英文部分分析每个角色可能的性别和年龄段。对于每一个角色，仅基于角色名判断其性别（男性/女性）和类型（成人/孩子/不确定）。"
                        },
                        {
                            role: "user",
                            content: `请分析以下对话文本，找出所有说话的角色，并仅基于英文部分和角色名称判断其可能的性别和类型。结果必须按以下严格的JSON格式返回：
                            
{
  "roles": [
    {
      "name": "角色名称，保持原文中的拼写和大小写",
      "gender": "male或female或unknown，根据角色名判断",
      "type": "adult或child或unknown，根据角色名判断",
      "lines": [
        {
          "english": "该角色的一段英文台词",
          "chinese": "该角色的一段中文台词"
        },
        ...更多台词...
      ]
    },
    ...更多角色...
  ]
}

对话文本：

${dialogText}`
                        }
                    ];
                    
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ messages })
                    });
                    
                    if (!response.ok) {
                        throw new Error('对话分析请求失败');
                    }
                    
                    const data = await response.json();
                    const assistantMessage = data.choices[0].message.content;
                    
                    // Extract JSON from response
                    const jsonMatch = assistantMessage.match(/```json\n([\s\S]*?)\n```/) || 
                                      assistantMessage.match(/{[\s\S]*?}/);
                    
                    if (!jsonMatch) {
                        throw new Error('未能从响应中提取有效数据');
                    }
                    
                    let jsonStr = jsonMatch[0];
                    if (jsonStr.startsWith('```json')) {
                        jsonStr = jsonMatch[1];
                    }
                    
                    // Parse the JSON response
                    const dialogData = JSON.parse(jsonStr);
                    identifiedRoles = dialogData.roles;
                    
                    // Render the role list
                    renderRoleList(identifiedRoles);
                    
                    // Show the dialog info section
                    dialogInfo.classList.add('visible');
                    generateBtn.style.display = 'block';
                    clearStatus();
                    
                } catch (error) {
                    console.error('Dialog analysis error:', error);
                    showError('对话分析失败: ' + error.message);
                }
            });
            
            // Render the list of identified roles
            function renderRoleList(roles) {
                roleList.innerHTML = '';
                
                roles.forEach((role, index) => {
                    const roleDiv = document.createElement('div');
                    roleDiv.className = 'role-item';
                    
                    // Determine voice category based on role name and type
                    let voiceCategory = 'male'; // default
                    if (role.gender === 'female' || isInCategory(role.name.toLowerCase(), roleCategories.female)) {
                        voiceCategory = 'female';
                    }
                    if (role.type === 'child' || isInCategory(role.name.toLowerCase(), roleCategories.child)) {
                        voiceCategory = 'child';
                    }
                    
                    // Create voice select dropdown
                    const voiceSelect = document.createElement('select');
                    voiceSelect.className = 'role-voice-select';
                    voiceSelect.id = `voice-${index}`;
                    
                    // Add voice options based on category
                    const voices = voiceOptions[voiceCategory] || voiceOptions.male;
                    voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.value;
                        option.textContent = voice.label;
                        voiceSelect.appendChild(option);
                    });
                    
                    // Create role element
                    roleDiv.innerHTML = `
                        <div class="role-name">
                            ${role.name}
                            <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                ${role.lines.length} 句台词
                                ${role.gender !== 'unknown' ? ` • ${role.gender === 'male' ? '男性' : '女性'}` : ''}
                                ${role.type !== 'unknown' ? ` • ${role.type === 'adult' ? '成人' : '儿童'}` : ''}
                            </div>
                        </div>
                    `;
                    roleDiv.appendChild(voiceSelect);
                    roleList.appendChild(roleDiv);
                });
            }
            
            // Check if a name belongs to a category
            function isInCategory(name, categoryTerms) {
                return categoryTerms.some(term => name.includes(term));
            }
            
            // Generate dialog audio with selected voices
            generateBtn.addEventListener('click', async () => {
                if (!identifiedRoles || identifiedRoles.length === 0) {
                    showError('请先分析对话文本');
                    return;
                }
                
                generateBtn.disabled = true;
                showLoading('正在生成对话语音...');
                audioContainer.classList.remove('visible');
                
                try {
                    // Collect voice selections for each role
                    const roleVoices = {};
                    identifiedRoles.forEach((role, index) => {
                        const voiceSelect = document.getElementById(`voice-${index}`);
                        roleVoices[role.name] = voiceSelect.value;
                    });
                    
                    // Prepare the TTS request with role and voice mapping
                    const requestData = {
                        dialog: identifiedRoles,
                        roleVoices: roleVoices,
                        model: "speech-02-hd"
                    };
                    
                    // Call the TTS API
                    const response = await fetch('/api/tts-dialog', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!response.ok) {
                        let errorMessage = '语音生成失败';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            errorMessage = `语音生成失败: ${response.status} ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }
                    
                    // Process the audio response
                    const audioData = await response.arrayBuffer();
                    const audioBlob = new Blob([audioData], { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Store the blob for download
                    currentAudioBlob = audioBlob;
                    
                    // Update audio player and show it
                    audioPlayer.src = audioUrl;
                    audioContainer.classList.add('visible');
                    clearStatus();
                    
                    // Try to play the audio
                    audioPlayer.play().catch(e => {
                        console.error('Audio playback error:', e);
                        showError('音频播放失败：' + e.message);
                    });
                    
                } catch (error) {
                    console.error('TTS Error:', error);
                    showError(error.message || '语音生成失败，请重试');
                } finally {
                    // Re-enable button
                    generateBtn.disabled = false;
                }
            });
            
            // Download button handler
            downloadBtn.addEventListener('click', () => {
                if (!currentAudioBlob) {
                    showError('没有可下载的音频');
                    return;
                }
                
                const downloadUrl = URL.createObjectURL(currentAudioBlob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `dialog-${new Date().toISOString().slice(0,10)}.mp3`;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl);
                }, 100);
            });
            
            // Helper functions
            function showError(message) {
                status.textContent = message;
                status.className = 'status error';
            }
            
            function showLoading(message) {
                status.textContent = message;
                status.className = 'status loading';
            }
            
            function clearStatus() {
                status.textContent = '';
                status.className = 'status';
            }
        });
    </script>
</body>
</html> 