<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang="fault-list-title">故障列表</title>
    <link rel="icon" href="../assets/icons/alex.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <script src="language.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 导航栏样式 */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-menu a:hover {
            background-color: #34495e;
        }
        
        /* 主内容区域 */
        main {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            margin-top: 60px; /* 为固定导航栏留出空间 */
        }
        
        .content-header {
            margin-bottom: 2rem;
        }
        
        .content-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .content-description {
            color: #7f8c8d;
        }
        
        .fault-list-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        /* 表格容器样式 - 用于响应式表格 */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* 在iOS上提供平滑滚动 */
        }
        
        /* 可折叠搜索区域样式 */
        .search-section {
            margin-bottom: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .search-header {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .search-header:hover {
            background-color: #e9ecef;
        }
        
        .search-title {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .search-toggle {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }
        
        .search-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .search-content {
            padding: 1rem;
            display: none;
        }
        
        .search-content.expanded {
            display: block;
        }
        
        .filter-bar {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .search-row {
            display: flex;
            width: 100%;
            gap: 0.5rem;
            align-items: center;
        }
        
        .filter-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            margin-right: 0.5rem;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .filter-button {
            padding: 0.5rem 1rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
            min-width: 80px;
        }
        
        .filter-button:hover {
            background-color: #2980b9;
        }
        
        .level-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .level-urgent {
            background-color: #f8d7da;
            color: #721c24;
        }

        .level-high {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .level-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .level-low {
            background-color: #d4edda;
            color: #155724;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .fault-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            min-width: 1200px;
        }
        
        .fault-table th, .fault-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }
        
        /* Allow text wrapping in fault description column */
        .fault-table th:nth-child(8), .fault-table td:nth-child(8) {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* 可调整列宽的表格样式 */
        .resizable-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            min-width: 1200px;
        }
        
        .resizable-table th, .resizable-table td {
            position: relative;
        }
        
        .resizable-table th {
            position: relative;
            padding-right: 15px !important;
        }
        
        /* 列宽调整手柄 */
        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
            user-select: none;
            z-index: 10;
        }
        
        .resize-handle:hover {
            background-color: rgba(52, 152, 219, 0.5);
        }
        
        .resize-handle.active {
            background-color: rgba(52, 152, 219, 0.7);
        }
        
        /* 调整时的遮罩层 */
        .resize-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: none;
        }
        
        .resize-overlay.active {
            display: block;
        }
        
        /* 故障描述列特殊样式 */
        .fault-table td:nth-child(8) {
            max-width: 900px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            overflow: visible;
            line-height: 1.4;
        }
        
        .fault-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        /* 排序相关样式 */
        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 20px !important;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: #e9ecef;
        }
        
        .sort-icon {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 12px;
        }
        
        .sort-asc .sort-icon::after {
            content: '↑';
        }
        
        .sort-desc .sort-icon::after {
            content: '↓';
        }
        
        .fault-table tr {
            transition: background-color 0.3s;
        }
        
        .fault-table tr:hover {
            background-color: #f5f5f5;
        }
        
        /* 确保表格行能够根据内容自动调整高度 */
        .fault-table tbody tr {
            height: auto;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-processing {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        /* 页脚样式 */
        footer {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .footer-divider {
            border-top: 1px solid #34495e;
            margin-bottom: 1rem;
        }
        
        .footer-text {
            font-size: 0.9rem;
            color: #ecf0f1;
        }
        
        /* 模态框样式 */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .detail-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        .detail-col {
            flex: 1;
            min-width: 300px;
            padding-right: 1rem;
        }
        
        .detail-group {
            margin-bottom: 0.8rem;
        }
        
        .detail-group label {
            font-weight: bold;
            margin-right: 0.5rem;
            color: #2c3e50;
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
        }
        
        .detail-section h3 {
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
            margin-bottom: 0.8rem;
        }
        
        .detail-section p {
            line-height: 1.6;
        }
        
        .detail-section ul {
            padding-left: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* 移动端响应式设计 */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .mobile-menu-toggle {
                display: block;
                position: absolute;
                right: 1rem;
                top: 1rem;
            }
            
            .nav-menu {
                flex-direction: column;
                width: 100%;
                margin-top: 1rem;
                display: none;
            }
            
            .nav-menu.active {
                display: flex;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .search-row {
                flex-direction: column;
                width: 100%;
            }
            
            .search-box {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* 移动端表格样式 */
            .fault-table {
                font-size: 0.8rem;
                min-width: 1200px; /* 确保表格有最小宽度，触发水平滚动 */
                table-layout: fixed;
            }
            
            .fault-table th, .fault-table td {
                padding: 0.4rem;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
            }
            
            /* Allow text wrapping in fault description column on mobile */
            .fault-table th:nth-child(8), .fault-table td:nth-child(8) {
                white-space: normal;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* 确保故障描述列字体大小与其他列一致 */
            .fault-table td:nth-child(8) {
                font-size: inherit;
                max-width: 200px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* 移动端故障描述列样式 - 允许文本换行 */
            @media (max-width: 768px) {
                .fault-table td:nth-child(8) {
                    max-width: 800px;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                    white-space: normal;
                    overflow: visible;
                    text-overflow: unset;
                    line-height: 1.4;
                    height: auto;
                }
            }
            
            .fault-table th {
                position: sticky;
                top: 0;
                background-color: #f8f9fa;
                z-index: 10;
            }
            
            /* 操作按钮在移动端更紧凑 */
            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            
            main {
                padding: 1rem;
            }
            
            /* 确保表格容器有明确的滚动指示 */
            .table-container {
                margin-bottom: 1rem;
                border-radius: 4px;
                border: 1px solid #e9ecef;
            }
            
            /* 添加滚动提示 */
            .table-container::after {
                content: "← 左右滑动查看更多 →";
                display: block;
                text-align: center;
                color: #6c757d;
                font-size: 0.75rem;
                padding: 0.25rem;
                background-color: #f8f9fa;
                border-top: 1px solid #e9ecef;
            }
            
            /* 分页控件样式 */
            .pagination-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 1rem;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .pagination-info {
                color: #6c757d;
                font-size: 0.9rem;
            }
            
            .pagination-controls {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .pagination-btn {
                padding: 0.5rem 0.75rem;
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.3s;
            }
            
            .pagination-btn:hover:not(:disabled) {
                background-color: #e9ecef;
            }
            
            .pagination-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .page-numbers {
                display: flex;
                gap: 0.25rem;
            }
            
            .page-number {
                min-width: 2rem;
                height: 2rem;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                background-color: #f8f9fa;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.3s;
            }
            
            .page-number:hover {
                background-color: #e9ecef;
            }
            
            .page-number.active {
                background-color: #3498db;
                color: white;
                border-color: #3498db;
            }
            
            .reset-button {
                background-color: #6c757d;
                margin-left: 0.5rem;
            }
            
            .reset-button:hover {
                background-color: #5a6268;
            }
        }
        
        /* 桌面端分页控件样式 - 确保所有控件在同一行 */
        @media (min-width: 769px) {
            .pagination-container {
                flex-wrap: nowrap;
            }
            
            .pagination-controls {
                flex-wrap: nowrap;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <div class="page-title" data-lang="page-title">戈尔设备故障管理</div>
            <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
            <nav class="nav-menu" id="navMenu">
                <a href="index.html" data-lang="nav-home">首页</a>
                <a href="fault-list.html" data-lang="nav-fault-list">故障列表</a>
                <a href="new-fault.html" data-lang="nav-new-fault">新建故障</a>
                <a href="fault-statistics.html" data-lang="nav-fault-stats">故障统计</a>
                <a href="info-management.html" data-lang="nav-info-mgmt" id="infoManagementLink">信息管理</a>
            </nav>
        </div>
    </header>
    
    <main>
        <div class="content-header">
                <h1 class="content-title" data-lang="fault-list-title">故障列表</h1>
                <p class="content-description" data-lang="fault-list-description">查看所有设备故障记录和处理状态</p>
            </div>
        
        <div class="fault-list-container">
            <div class="search-section">
                <div class="search-header" onclick="toggleSearch()">
                    <div class="search-title" data-lang="search-title">搜索和筛选</div>
                    <div class="search-toggle collapsed" id="searchToggle">▼</div>
                </div>
                <div class="search-content" id="searchContent">
                    <div class="filter-bar">
                        <select id="status-filter" class="filter-select">
                            <option value="" data-lang="all-statuses">所有状态</option>
                        </select>
                        <select id="level-filter" class="filter-select">
                            <option value="" data-lang="all-levels">所有级别</option>
                        </select>
                        <select id="plant-filter" class="filter-select">
                            <option value="" data-lang="all-plants">所有工厂</option>
                        </select>
                        <select id="category-filter" class="filter-select">
                            <option value="" data-lang="all-categories">所有分类</option>
                        </select>
                        <select id="equipment-filter" class="filter-select">
                            <option value="" data-lang="all-equipment">所有设备</option>
                        </select>
                        <select id="area-filter" class="filter-select">
                            <option value="" data-lang="all-areas">所有区域</option>
                        </select>
                        <select id="subarea-filter" class="filter-select">
                            <option value="" data-lang="all-subareas">所有子区域</option>
                        </select>
                        <select id="reporter-filter" class="filter-select">
                            <option value="" data-lang="all-reporters">所有报告人</option>
                        </select>
                        <div class="search-row">
                            <input type="text" id="search-input" class="search-box" data-lang-placeholder="search-placeholder" placeholder="搜索故障ID、设备名称、故障类型、故障描述...">
                            <button class="filter-button" onclick="filterFaults()" data-lang="filter-button">筛选</button>
                            <button class="filter-button reset-button" onclick="resetFilters()" data-lang="reset-button">重置</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="loading-indicator" style="text-align: center; padding: 20px; display: none;">
                <p data-lang="loading-faults">正在加载故障数据...</p>
            </div>
            
            <div id="no-data-message" style="text-align: center; padding: 20px; display: none;">
                <p data-lang="no-fault-data">暂无故障数据</p>
            </div>
            
            <div class="table-container">
                <table class="fault-table resizable-table" id="fault-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="id" data-lang="table-header-id">ID<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="plant" data-lang="table-header-plant">工厂<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="equipmentName" data-lang="table-header-equipment">设备<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="faultArea" data-lang="table-header-area">区域<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="faultSubArea" data-lang="table-header-subarea">子区域<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="faultCategory" data-lang="table-header-category">分类<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="faultLevel" data-lang="table-header-level">等级<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="faultDescription" data-lang="table-header-description">故障描述<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="reportTime" data-lang="table-header-report-time">报告时间<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="updateTime" data-lang="table-header-update-time">更新时间<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="reporter" data-lang="table-header-reporter">报告人<div class="resize-handle"></div></th>
                            <th class="sortable" data-column="status" data-lang="table-header-status">状态<div class="resize-handle"></div></th>
                            <th data-lang="table-header-actions">操作<div class="resize-handle"></div></th>
                        </tr>
                    </thead>
                    <tbody id="fault-table-body">
                        <!-- 故障数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 列宽调整遮罩层 -->
            <div class="resize-overlay" id="resizeOverlay"></div>
            
            <!-- 分页控件 -->
            <div class="pagination-container">
                <div class="pagination-info">
                    <span id="pagination-info" data-lang="pagination-info">显示 0-0 条，共 0 条记录</span>
                </div>
                <div class="pagination-controls">
                    <button id="prev-page" class="pagination-btn" onclick="changePage(-1)" disabled data-lang="prev-page">上一页</button>
                    <div id="page-numbers" class="page-numbers">
                        <!-- 页码将通过JavaScript动态生成 -->
                    </div>
                    <button id="next-page" class="pagination-btn" onclick="changePage(1)" disabled data-lang="next-page">下一页</button>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="footer-text" data-lang="footer-text">网页基于智谱大模型GLM-4.5创建</div>
    </footer>
    
    <script>
        // 格式化日期为仅日期格式
        function formatDate(dateString) {
            if (!dateString) return '未知时间';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        // 分页相关变量
        let allFaults = []; // 存储所有故障数据
        let currentPage = 1; // 当前页码
        const recordsPerPage = 10; // 每页显示记录数
        
        // 排序相关变量
        let sortColumn = ''; // 当前排序列
        let sortDirection = 'asc'; // 排序方向：asc 或 desc
        
        // 切换搜索区域的展开/折叠状态
        function toggleSearch() {
            const searchContent = document.getElementById('searchContent');
            const searchToggle = document.getElementById('searchToggle');
            
            if (searchContent.classList.contains('expanded')) {
                searchContent.classList.remove('expanded');
                searchToggle.classList.add('collapsed');
            } else {
                searchContent.classList.add('expanded');
                searchToggle.classList.remove('collapsed');
            }
        }
        
        // 处理窗口大小变化，重新渲染表格以适应新的屏幕尺寸
function handleResize() {
    // 重新渲染当前页的故障数据
    renderFaultTable();
}

// 移动端菜单切换
document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.getElementById('mobileMenuToggle');
    const navMenu = document.getElementById('navMenu');
    
    if (menuToggle && navMenu) {
        menuToggle.addEventListener('click', function() {
            navMenu.classList.toggle('active');
        });
        
        // 点击页面任意位置隐藏导航菜单
        document.addEventListener('click', function(event) {
            // 如果点击的不是菜单按钮且菜单是展开状态，则关闭菜单
            if (!menuToggle.contains(event.target) && navMenu.classList.contains('active')) {
                navMenu.classList.remove('active');
            }
        });
    }

    // 添加窗口大小变化监听器
    window.addEventListener('resize', handleResize);
    
    // 初始化列宽调整功能
    initColumnResizing();
    
    // 移除访客访问控制调用
    
    // 移除访客访问控制 - 信息管理链接对所有用户可见
    
    // 从KV表加载故障数据
    console.log('页面加载完成，开始加载故障数据...');
    loadFaultData();
});

        // 移除访客访问控制 - 所有功能对所有用户可见

        // 从KV表加载故障数据
async function loadFaultData() {
    console.log('开始加载故障数据...');
    
    const tableBody = document.getElementById('fault-table-body');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noDataMessage = document.getElementById('no-data-message');
    
    if (!tableBody) return;
    
    // 显示加载指示器
    if (loadingIndicator) loadingIndicator.style.display = 'block';
    if (noDataMessage) noDataMessage.style.display = 'none';
    
    try {
        // 直接调用Worker API获取故障数据
        const apiUrl = 'https://study-llm.me/ws/api/faults';
        console.log('正在请求API:', apiUrl);
        
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('API响应状态:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const faults = await response.json();
        console.log('获取到的故障数据:', faults);
        
        // 存储所有故障数据
        allFaults = faults || [];
        
        // 重置到第一页
        currentPage = 1;
        
        // 清空表格
        tableBody.innerHTML = '';
        
        // 收集所有可能的选项用于筛选器
        const plants = new Set();
        const categories = new Set();
        const equipments = new Set();
        const areas = new Set();
        const subAreas = new Set();
        const reporters = new Set();
        const statuses = new Set();
        const levels = new Set();
                
        if (allFaults && allFaults.length > 0) {
            // 收集筛选器选项
            allFaults.forEach(fault => {
                // 收集筛选器选项
                if (fault.plant) plants.add(fault.plant);
                if (fault.faultCategory) categories.add(fault.faultCategory);
                if (fault.equipmentName) equipments.add(fault.equipmentName);
                if (fault.faultArea) areas.add(fault.faultArea);
                if (fault.faultSubArea) subAreas.add(fault.faultSubArea);
                if (fault.reporter) reporters.add(fault.reporter);
                if (fault.status) statuses.add(fault.status);
                if (fault.faultLevel) levels.add(fault.faultLevel);
            });
            
            // 填充筛选器选项
            populateFilterOptions('plant-filter', plants);
            populateFilterOptions('category-filter', categories);
            populateFilterOptions('equipment-filter', equipments);
            populateFilterOptions('area-filter', areas);
            populateFilterOptions('subarea-filter', subAreas);
            populateFilterOptions('reporter-filter', reporters);
            populateFilterOptions('status-filter', statuses);
            populateFilterOptions('level-filter', levels);
            
            // 渲染当前页的故障数据
            renderFaultTable();
            
            // 更新分页控件
            updatePaginationControls();
        } else {
            // 没有数据时显示提示
            if (noDataMessage) noDataMessage.style.display = 'block';
            
            // 更新分页信息
            updatePaginationInfo();
        }
                
    } catch (error) {
        console.error('加载故障数据失败:', error);
        
        // 显示错误信息
        tableBody.innerHTML = `
            <tr>
                <td colspan="11" style="text-align: center; color: #e74c3c;">
                    ${getTranslation('load-faults-failed')}: ${error.message}
                </td>
            </tr>
        `;
    } finally {
        // 隐藏加载指示器
        if (loadingIndicator) loadingIndicator.style.display = 'none';
    }
}

// 故障数据排序函数
function sortFaultData(column) {
    // 如果点击的是当前排序列，则切换排序方向
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // 否则，设置新的排序列，并默认为升序
        sortColumn = column;
        sortDirection = 'asc';
    }
    
    // 对数据进行排序
    allFaults.sort((a, b) => {
        let valueA = a[column] || '';
        let valueB = b[column] || '';
        
        // 特殊处理时间字段
        if (column === 'reportTime') {
            valueA = new Date(valueA).getTime() || 0;
            valueB = new Date(valueB).getTime() || 0;
        }
        
        // 特殊处理数字字段
        if (column === 'id') {
            valueA = parseInt(valueA) || 0;
            valueB = parseInt(valueB) || 0;
        }
        
        // 字符串比较
        if (typeof valueA === 'string' && typeof valueB === 'string') {
            valueA = valueA.toLowerCase();
            valueB = valueB.toLowerCase();
        }
        
        if (sortDirection === 'asc') {
            return valueA > valueB ? 1 : -1;
        } else {
            return valueA < valueB ? 1 : -1;
        }
    });
    
    // 更新排序图标
    updateSortIcons();
    
    // 重新渲染表格
    renderFaultTable();
    
    // 更新分页控件
    updatePaginationControls();
}

// 更新排序图标状态
function updateSortIcons() {
    // 移除所有表头的排序状态类
    document.querySelectorAll('#fault-table th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    
    // 如果有当前排序列，则为该列添加对应的排序状态类
    if (sortColumn) {
        const currentTh = document.querySelector(`#fault-table th.sortable[data-column="${sortColumn}"]`);
        if (currentTh) {
            currentTh.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    }
}

// 渲染故障表格（当前页）
function renderFaultTable() {
    const tableBody = document.getElementById('fault-table-body');
    if (!tableBody) return;
    
    // 清空表格
    tableBody.innerHTML = '';
    
    // 计算当前页的起始和结束索引
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = Math.min(startIndex + recordsPerPage, allFaults.length);
    
    // 获取当前页的故障数据
    const currentPageFaults = allFaults.slice(startIndex, endIndex);
    
    // 渲染当前页的故障数据
    currentPageFaults.forEach(fault => {
        const row = document.createElement('tr');
        
        // 格式化状态标签
        let statusClass = '';
        let statusText = '';
        
        switch(fault.status) {
            case 'pending':
                statusClass = 'status-pending';
                statusText = getTranslation('status-pending');
                break;
            case 'processing':
                statusClass = 'status-processing';
                statusText = getTranslation('status-processing');
                break;
            case 'resolved':
                statusClass = 'status-completed';
                statusText = getTranslation('status-resolved');
                break;
            case 'completed':
                statusClass = 'status-completed';
                statusText = getTranslation('status-completed');
                break;
            default:
                statusClass = 'status-pending';
                statusText = getTranslation('status-unknown');
        }
        
        // 格式化故障级别
        let levelClass = '';
        let levelText = '';
        
        switch(fault.faultLevel) {
            case 'urgent':
                levelClass = 'level-urgent';
                levelText = getTranslation('level-urgent');
                break;
            case 'high':
                levelClass = 'level-high';
                levelText = getTranslation('level-high');
                break;
            case 'medium':
                levelClass = 'level-medium';
                levelText = getTranslation('level-medium');
                break;
            case 'low':
                levelClass = 'level-low';
                levelText = getTranslation('level-low');
                break;
            default:
                levelClass = 'level-medium';
                levelText = getTranslation('level-medium');
        }
        
        // 格式化时间
        const reportTime = formatDate(fault.reportTime);
        const updateTime = formatDate(fault.updateTime || fault.reportUpdateTime);
        
        // 格式化故障描述，根据屏幕尺寸调整显示长度
        let shortDescription;
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            // 移动端显示更多字符，因为我们会使用CSS控制显示行数
            shortDescription = fault.faultDescription && fault.faultDescription.length > 100 
                ? fault.faultDescription.substring(0, 100) + '...' 
                : fault.faultDescription || getTranslation('no-description');
        } else {
            // 桌面端保持原来的50字符限制
            shortDescription = fault.faultDescription && fault.faultDescription.length > 50 
                ? fault.faultDescription.substring(0, 50) + '...' 
                : fault.faultDescription || getTranslation('no-description');
        }
        
        // 获取用户角色
        const userRole = sessionStorage.getItem('userRole');
        
        // 根据用户角色决定是否显示编辑按钮
        let editButtonHtml = '';
        if (userRole !== 'visitor') {
            editButtonHtml = '<button class="btn btn-success" onclick="editFault(\'' + fault.id + '\')">' + getTranslation('edit-button') + '</button>';
        }
        
        row.innerHTML = `
            <td>${fault.id || getTranslation('unknown')}</td>
            <td>${fault.plant || getTranslation('unknown-plant')}</td>
            <td>${fault.equipmentName || getTranslation('unknown-equipment')}</td>
            <td>${fault.faultArea || getTranslation('unknown-area')}</td>
            <td>${fault.faultSubArea || 'None'}</td>
            <td>${fault.faultCategory || getTranslation('unknown-category')}</td>
            <td><span class="level-badge ${levelClass}">${levelText}</span></td>
            <td title="${fault.faultDescription || ''}">${shortDescription}</td>
            <td>${reportTime}</td>
            <td>${updateTime}</td>
            <td>${fault.reporter || getTranslation('unknown-reporter')}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="viewFaultDetail('${fault.id}')">${getTranslation('view-button')}</button>
                    ${editButtonHtml}
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // 加载保存的列宽设置
    loadColumnWidths();
    
    // 重新初始化列宽调整功能
    initColumnResizing();
}

// 更新分页控件
function updatePaginationControls() {
    const totalPages = Math.ceil(allFaults.length / recordsPerPage);
    
    // 更新上一页/下一页按钮状态
    const prevButton = document.getElementById('prev-page');
    const nextButton = document.getElementById('next-page');
    
    if (prevButton) {
        prevButton.disabled = currentPage <= 1;
    }
    
    if (nextButton) {
        nextButton.disabled = currentPage >= totalPages;
    }
    
    // 更新页码
    const pageNumbersContainer = document.getElementById('page-numbers');
    if (pageNumbersContainer) {
        pageNumbersContainer.innerHTML = '';
        
        // 计算显示的页码范围（最多显示5个页码）
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        // 调整起始页码，确保始终显示5个页码（如果总页数足够）
        if (endPage - startPage < 4 && totalPages > 5) {
            startPage = Math.max(1, endPage - 4);
        }
        
        // 添加第一页和省略号（如果需要）
        if (startPage > 1) {
            addPageNumber(1);
            if (startPage > 2) {
                addEllipsis();
            }
        }
        
        // 添加页码
        for (let i = startPage; i <= endPage; i++) {
            addPageNumber(i);
        }
        
        // 添加最后一页和省略号（如果需要）
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                addEllipsis();
            }
            addPageNumber(totalPages);
        }
    }
    
    // 更新分页信息
    updatePaginationInfo();
}

// 添加页码按钮
function addPageNumber(pageNum) {
    const pageNumbersContainer = document.getElementById('page-numbers');
    if (!pageNumbersContainer) return;
    
    const pageNumber = document.createElement('div');
    pageNumber.className = 'page-number';
    if (pageNum === currentPage) {
        pageNumber.classList.add('active');
    }
    pageNumber.textContent = pageNum;
    pageNumber.onclick = () => goToPage(pageNum);
    
    pageNumbersContainer.appendChild(pageNumber);
}

// 添加省略号
function addEllipsis() {
    const pageNumbersContainer = document.getElementById('page-numbers');
    if (!pageNumbersContainer) return;
    
    const ellipsis = document.createElement('div');
    ellipsis.className = 'page-number';
    ellipsis.textContent = '...';
    ellipsis.style.cursor = 'default';
    ellipsis.style.border = 'none';
    
    pageNumbersContainer.appendChild(ellipsis);
}

// 更新分页信息
function updatePaginationInfo() {
    const paginationInfo = document.getElementById('pagination-info');
    if (!paginationInfo) return;
    
    const totalRecords = allFaults.length;
    const startIndex = totalRecords > 0 ? (currentPage - 1) * recordsPerPage + 1 : 0;
    const endIndex = Math.min(currentPage * recordsPerPage, totalRecords);
    
    paginationInfo.textContent = getTranslation('pagination-info', {
    start: startIndex,
    end: endIndex,
    total: totalRecords
});
}

// 切换页面
function changePage(direction) {
    const totalPages = Math.ceil(allFaults.length / recordsPerPage);
    const newPage = currentPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderFaultTable();
        updatePaginationControls();
    }
}

// 跳转到指定页面
function goToPage(pageNum) {
    const totalPages = Math.ceil(allFaults.length / recordsPerPage);
    
    if (pageNum >= 1 && pageNum <= totalPages) {
        currentPage = pageNum;
        renderFaultTable();
        updatePaginationControls();
    }
}
        
        // 填充筛选器选项
        function populateFilterOptions(filterId, optionsSet) {
            const filterElement = document.getElementById(filterId);
            if (!filterElement) return;
            
            // 保存当前选中的值
            const currentValue = filterElement.value;
            
            // 清空现有选项，保留第一个"所有"选项
            while (filterElement.children.length > 1) {
                filterElement.removeChild(filterElement.lastChild);
            }
            
            // 添加新的选项
            const sortedOptions = Array.from(optionsSet).sort();
            sortedOptions.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                
                // 根据筛选器类型格式化显示文本
                if (filterId === 'status-filter') {
                    optionElement.textContent = formatFaultStatus(option);
                } else if (filterId === 'level-filter') {
                    optionElement.textContent = formatFaultLevel(option);
                } else {
                    optionElement.textContent = option;
                }
                
                filterElement.appendChild(optionElement);
            });
            
            // 恢复之前选中的值
            filterElement.value = currentValue;
        }

        // 查看故障详情（新页面）
        function viewFaultDetail(faultId) {
            // 跳转到故障详情页面
            window.location.href = `fault-detail.html?id=${faultId}`;
        }
        
        // 编辑故障
        function editFault(faultId) {
            // 跳转到新建故障页面，并传递故障ID用于编辑
            window.location.href = `new-fault.html?id=${faultId}`;
        }

        // 查看故障详情（模态框）- 保留原有函数以防其他地方调用
async function viewFault(faultId) {
    try {
        const response = await fetch(`https://study-llm.me/ws/api/faults/${faultId}`);
        if (response.ok) {
            const fault = await response.json();
            
            // 创建模态框显示故障详情
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${getTranslation('fault-detail-title')}</h2>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-row">
                            <div class="detail-col">
                                <div class="detail-group">
                                    <label>${getTranslation('fault-id-label')}:</label>
                                    <span>${fault.id || getTranslation('unknown')}</span>
                                </div>
                                <div class="detail-group">
                                    <label>${getTranslation('plant-label')}:</label>
                                    <span>${fault.plant || getTranslation('unknown-plant')}</span>
                                </div>
                                <div class="detail-group">
                                    <label>${getTranslation('equipment-label')}:</label>
                                    <span>${fault.equipmentName || getTranslation('unknown-equipment')}</span>
                                </div>
                                <div class="detail-group">
                                    <label>${getTranslation('area-label')}:</label>
                                    <span>${fault.faultArea || getTranslation('unknown-area')}</span>
                                </div>
                                <div class="detail-group">
                                    <label>${getTranslation('category-label')}:</label>
                                    <span>${fault.faultCategory || getTranslation('unknown-category')}</span>
                                </div>
                                <div class="detail-group">
                                    <label>${getTranslation('level-label')}:</label>
                                    <span>${formatFaultLevel(fault.faultLevel)}</span>
                                </div>
                            </div>
                            <div class="detail-col">
                                <div class="detail-group">
                                    <label>${getTranslation('report-time-label')}:</label>
                                    <span>${formatDateTime(fault.reportTime)}</span>
                                </div>
                                <div class="detail-group">
                                    <label>${getTranslation('reporter-label')}:</label>
                                    <span>${fault.reporter || getTranslation('unknown-reporter')}</span>
                                </div>
                                <div class="detail-group">
                                    <label>${getTranslation('status-label')}:</label>
                                    <span>${formatFaultStatus(fault.status)}</span>
                                </div>
                                ${fault.handler ? `
                                <div class="detail-group">
                                    <label>${getTranslation('handler-label')}:</label>
                                    <span>${fault.handler}</span>
                                </div>
                                ` : ''}
                                ${fault.handleTime ? `
                                <div class="detail-group">
                                    <label>${getTranslation('handle-time-label')}:</label>
                                    <span>${formatDateTime(fault.handleTime)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3>${getTranslation('description-section')}</h3>
                            <p>${fault.faultDescription || getTranslation('no-description')}</p>
                        </div>
                        <div class="detail-section">
                            <h3>${getTranslation('troubleshooting-section')}</h3>
                            <p>${fault.troubleshootingSteps || getTranslation('no-troubleshooting')}</p>
                        </div>
                        <div class="detail-section">
                            <h3>${getTranslation('root-cause-section')}</h3>
                            <p>${fault.rootCause || getTranslation('no-root-cause')}</p>
                        </div>
                        <div class="detail-section">
                            <h3>${getTranslation('resolution-section')}</h3>
                            <p>${fault.resolution || getTranslation('no-resolution')}</p>
                        </div>
                        ${fault.additionalInfo ? `
                        <div class="detail-section">
                            <h3>${getTranslation('additional-info-section')}</h3>
                            <p>${fault.additionalInfo}</p>
                        </div>
                        ` : ''}
                        ${fault.fileUpload && fault.fileUpload.length > 0 ? `
                        <div class="detail-section">
                            <h3>${getTranslation('uploaded-files-section')}</h3>
                            <ul>
                                ${fault.fileUpload.map(file => `<li>${file}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        ${fault.handleDescription ? `
                        <div class="detail-section">
                            <h3>${getTranslation('handle-description-section')}</h3>
                            <p>${fault.handleDescription}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 关闭模态框
            const closeBtn = modal.querySelector('.close');
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        } else {
            alert(getTranslation('get-fault-detail-failed'));
        }
    } catch (error) {
        console.error('查看故障详情时出错:', error);
        alert(getTranslation('get-fault-detail-error'));
    }
}

        // 处理故障
        async function processFault(faultId) {
            try {
                // 创建模态框用于处理故障
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${getTranslation('process-fault-title')}</h2>
                            <span class="close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="process-fault-form">
                                <div class="form-group">
                                    <label for="process-status">${getTranslation('status-label')}:</label>
                                    <select id="process-status" name="status" required>
                                        <option value="pending">${getTranslation('status-pending')}</option>
                                        <option value="processing">${getTranslation('status-processing')}</option>
                                        <option value="resolved">${getTranslation('status-resolved')}</option>
                                        <option value="completed">${getTranslation('status-completed')}</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="process-handler">${getTranslation('handler-label')}:</label>
                                    <input type="text" id="process-handler" name="handler" required>
                                </div>
                                <div class="form-group">
                                    <label for="process-description">${getTranslation('handle-description-label')}:</label>
                                    <textarea id="process-description" name="handleDescription" rows="4"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="process-resolution">${getTranslation('resolution-label')}:</label>
                                    <textarea id="process-resolution" name="resolution" rows="4"></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">${getTranslation('submit-button')}</button>
                                    <button type="button" class="btn btn-secondary cancel-btn">${getTranslation('cancel-button')}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 关闭模态框
                const closeBtn = modal.querySelector('.close');
                const cancelBtn = modal.querySelector('.cancel-btn');
                
                const closeModal = () => {
                    document.body.removeChild(modal);
                };
                
                closeBtn.addEventListener('click', closeModal);
                cancelBtn.addEventListener('click', closeModal);
                
                // 点击模态框外部关闭
                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeModal();
                    }
                });
                
                // 表单提交处理
                const form = document.getElementById('process-fault-form');
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        status: document.getElementById('process-status').value,
                        handler: document.getElementById('process-handler').value,
                        handleDescription: document.getElementById('process-description').value,
                        resolution: document.getElementById('process-resolution').value
                    };
                    
                    try {
                        const response = await fetch(`https://study-llm.me/ws/api/faults/${faultId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        if (response.ok) {
                            alert(getTranslation('fault-status-updated'));
                            closeModal();
                            // 重新加载故障列表
                            loadFaultData();
                        } else {
                            const errorData = await response.json();
                            alert(`${getTranslation('update-failed')}: ${errorData.error || getTranslation('unknown-error')}`);
                        }
                    } catch (error) {
                        console.error('更新故障状态时出错:', error);
                        alert(getTranslation('update-fault-status-error'));
                    }
                });
            } catch (error) {
                console.error('处理故障时出错:', error);
                alert(getTranslation('process-fault-error'));
            }
        }

// 删除故障
        async function deleteFault(faultId) {
            if (confirm(getTranslation('delete-fault-confirm'))) {
                try {
                    const response = await fetch(`https://study-llm.me/ws/api/faults/${faultId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert(getTranslation('fault-deleted'));
                        // 重新加载故障列表
                        loadFaultData();
                    } else {
                        const errorData = await response.json();
                        alert(`${getTranslation('delete-failed')}: ${errorData.error || getTranslation('unknown-error')}`);
                    }
                } catch (error) {
                    console.error('删除故障时出错:', error);
                    alert(getTranslation('delete-fault-error'));
                }
            }
        }

        // 格式化故障等级
        function formatFaultLevel(level) {
            switch(level) {
                case 'high': return getTranslation('level-high');
                case 'medium': return getTranslation('level-medium');
                case 'low': return getTranslation('level-low');
                case 'urgent': return getTranslation('level-urgent');
                default: return getTranslation('unknown');
            }
        }
        
        // 格式化故障状态
        function formatFaultStatus(status) {
            switch(status) {
                case 'pending': return getTranslation('status-pending');
                case 'processing': return getTranslation('status-processing');
                case 'resolved': return getTranslation('status-resolved');
                case 'completed': return getTranslation('status-completed');
                default: return getTranslation('unknown');
            }
        }
        
        // 格式化日期时间
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return getTranslation('unknown-time');
            const date = new Date(dateTimeString);
            return date.toLocaleString();
        }
        
        // 筛选功能
function filterFaults() {
    const statusFilter = document.getElementById('status-filter').value;
    const levelFilter = document.getElementById('level-filter').value;
    const plantFilter = document.getElementById('plant-filter').value;
    const categoryFilter = document.getElementById('category-filter').value;
    const equipmentFilter = document.getElementById('equipment-filter').value;
    const areaFilter = document.getElementById('area-filter').value;
    const subareaFilter = document.getElementById('subarea-filter').value;
    const reporterFilter = document.getElementById('reporter-filter').value;
    const searchInput = document.getElementById('search-input').value.toLowerCase();
    
    // 筛选数据
    const filteredFaults = allFaults.filter(fault => {
        // 状态筛选
        if (statusFilter && fault.status !== statusFilter) {
            return false;
        }
        
        // 级别筛选
        if (levelFilter && fault.faultLevel !== levelFilter) {
            return false;
        }
        
        // 工厂筛选
        if (plantFilter && fault.plant !== plantFilter) {
            return false;
        }
        
        // 分类筛选
        if (categoryFilter && fault.faultCategory !== categoryFilter) {
            return false;
        }
        
        // 设备筛选
        if (equipmentFilter && fault.equipmentName !== equipmentFilter) {
            return false;
        }
        
        // 区域筛选
        if (areaFilter && fault.faultArea !== areaFilter) {
            return false;
        }
        
        // 子区域筛选
        if (subareaFilter && fault.faultSubArea !== subareaFilter) {
            return false;
        }
        
        // 报告人筛选
        if (reporterFilter && fault.reporter !== reporterFilter) {
            return false;
        }
        
        // 搜索筛选（检查故障描述和其他文本字段）
        if (searchInput) {
            const id = (fault.id || '').toString().toLowerCase();
            const description = (fault.faultDescription || '').toLowerCase();
            const equipment = (fault.equipmentName || '').toLowerCase();
            const area = (fault.faultArea || '').toLowerCase();
            const category = (fault.faultCategory || '').toLowerCase();
            const plant = (fault.plant || '').toLowerCase();
            const reporter = (fault.reporter || '').toLowerCase();
            
            if (!description.includes(searchInput) && 
                !id.includes(searchInput) &&
                !equipment.includes(searchInput) && 
                !area.includes(searchInput) && 
                !category.includes(searchInput) && 
                !plant.includes(searchInput) && 
                !reporter.includes(searchInput)) {
                return false;
            }
        }
        
        return true;
    });
    
    // 重置到第一页
    currentPage = 1;
    
    // 临时存储筛选后的数据
    const originalAllFaults = allFaults;
    allFaults = filteredFaults;
    
    // 如果有排序列，重新应用排序
    if (sortColumn) {
        sortFaultData(sortColumn);
        // 恢复排序方向，因为sortFaultData会切换方向
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        sortFaultData(sortColumn);
    } else {
        // 渲染当前页的故障数据
        renderFaultTable();
        // 更新分页控件
        updatePaginationControls();
    }
    
    // 恢复原始数据
    allFaults = originalAllFaults;
    
    // 如果没有筛选结果，显示提示
    if (filteredFaults.length === 0) {
        const noDataMessage = document.getElementById('no-data-message');
        if (noDataMessage) {
            noDataMessage.style.display = 'block';
            noDataMessage.textContent = getTranslation('no-matching-faults');
        }
    } else {
        const noDataMessage = document.getElementById('no-data-message');
        if (noDataMessage) {
            noDataMessage.style.display = 'none';
        }
    }
}

        // 重置筛选器
function resetFilters() {
    // 重置所有筛选器
    const filters = ['status-filter', 'level-filter', 'plant-filter', 'category-filter', 'equipment-filter', 'area-filter', 'subarea-filter', 'reporter-filter'];
    filters.forEach(filterId => {
        const filter = document.getElementById(filterId);
        if (filter) {
            filter.value = '';
        }
    });
    
    // 重置搜索输入
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // 重新加载所有数据
    loadFaultData();
}

        // 添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始加载故障数据...');
            
            // 故障表格排序事件监听器
            document.querySelectorAll('#fault-table th.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-column');
                    sortFaultData(column);
                });
            });
            
            const statusFilter = document.getElementById('status-filter');
            const levelFilter = document.getElementById('level-filter');
            const plantFilter = document.getElementById('plant-filter');
            const categoryFilter = document.getElementById('category-filter');
            const equipmentFilter = document.getElementById('equipment-filter');
            const areaFilter = document.getElementById('area-filter');
            const subareaFilter = document.getElementById('subarea-filter');
            const reporterFilter = document.getElementById('reporter-filter');
            const searchInput = document.getElementById('search-input');
            
            if (statusFilter) statusFilter.addEventListener('change', filterFaults);
            if (levelFilter) levelFilter.addEventListener('change', filterFaults);
            if (plantFilter) plantFilter.addEventListener('change', filterFaults);
            if (categoryFilter) categoryFilter.addEventListener('change', filterFaults);
            if (equipmentFilter) equipmentFilter.addEventListener('change', filterFaults);
            if (areaFilter) areaFilter.addEventListener('change', filterFaults);
            if (subareaFilter) subareaFilter.addEventListener('change', filterFaults);
            if (reporterFilter) reporterFilter.addEventListener('change', filterFaults);
            if (searchInput) searchInput.addEventListener('input', filterFaults);
            
            // 初始化列宽调整功能
            initColumnResizing();
            
            // 加载故障数据
            loadFaultData();
        });
        
        // 列宽调整功能
        function initColumnResizing() {
            console.log('初始化列宽调整功能...');
            
            const table = document.getElementById('fault-table');
            if (!table) {
                console.error('找不到故障表格元素');
                return;
            }
            
            const resizeHandles = table.querySelectorAll('.resize-handle');
            console.log('找到调整手柄数量:', resizeHandles.length);
            
            const resizeOverlay = document.getElementById('resizeOverlay');
            if (!resizeOverlay) {
                console.error('找不到调整遮罩层元素');
            }
            
            let currentColumn = null;
            let startX = 0;
            let startWidth = 0;
            let isResizing = false;
            
            // 为每个调整手柄添加事件监听器
            resizeHandles.forEach((handle, index) => {
                console.log('为调整手柄', index, '添加事件监听器');
                
                handle.addEventListener('mousedown', function(e) {
                    console.log('鼠标按下调整手柄', index);
                    e.preventDefault();
                    
                    // 获取当前列索引
                    const th = this.parentElement;
                    const ths = Array.from(th.parentElement.children);
                    const columnIndex = ths.indexOf(th);
                    
                    currentColumn = columnIndex;
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    isResizing = true;
                    
                    // 显示遮罩层，防止文本选择
                    if (resizeOverlay) {
                        resizeOverlay.style.display = 'block';
                    }
                    
                    // 添加临时样式
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                });
            });
            
            // 添加全局鼠标移动事件
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                console.log('正在调整列宽，当前列:', currentColumn);
                
                const diffX = e.pageX - startX;
                const newWidth = Math.max(50, startWidth + diffX); // 最小宽度为50px
                
                // 更新表头宽度
                const ths = table.querySelectorAll('thead th');
                if (ths[currentColumn]) {
                    ths[currentColumn].style.width = `${newWidth}px`;
                }
                
                // 更新表格列宽度
                const tableRows = table.querySelectorAll('tbody tr');
                tableRows.forEach(row => {
                    const tds = row.querySelectorAll('td');
                    if (tds[currentColumn]) {
                        tds[currentColumn].style.width = `${newWidth}px`;
                    }
                });
            });
            
            // 添加全局鼠标释放事件
            document.addEventListener('mouseup', function() {
                if (!isResizing) return;
                
                console.log('结束调整列宽');
                
                isResizing = false;
                currentColumn = null;
                
                // 隐藏遮罩层
                if (resizeOverlay) {
                    resizeOverlay.style.display = 'none';
                }
                
                // 恢复默认样式
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // 保存列宽到本地存储（可选）
                saveColumnWidths();
            });
            
            // 添加触摸事件支持（移动设备）
            resizeHandles.forEach(handle => {
                handle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    
                    const touch = e.touches[0];
                    const th = this.parentElement;
                    const ths = Array.from(th.parentElement.children);
                    const columnIndex = ths.indexOf(th);
                    
                    currentColumn = columnIndex;
                    startX = touch.pageX;
                    startWidth = th.offsetWidth;
                    isResizing = true;
                    
                    // 显示遮罩层
                    if (resizeOverlay) {
                        resizeOverlay.style.display = 'block';
                    }
                }, { passive: false });
            });
            
            // 添加触摸移动事件
            document.addEventListener('touchmove', function(e) {
                if (!isResizing) return;
                
                const touch = e.touches[0];
                const diffX = touch.pageX - startX;
                const newWidth = Math.max(50, startWidth + diffX); // 最小宽度为50px
                
                // 更新表头宽度
                const ths = table.querySelectorAll('thead th');
                if (ths[currentColumn]) {
                    ths[currentColumn].style.width = `${newWidth}px`;
                }
                
                // 更新表格列宽度
                const tableRows = table.querySelectorAll('tbody tr');
                tableRows.forEach(row => {
                    const tds = row.querySelectorAll('td');
                    if (tds[currentColumn]) {
                        tds[currentColumn].style.width = `${newWidth}px`;
                    }
                });
            }, { passive: false });
            
            // 添加触摸结束事件
            document.addEventListener('touchend', function() {
                if (!isResizing) return;
                
                isResizing = false;
                currentColumn = null;
                
                // 隐藏遮罩层
                if (resizeOverlay) {
                    resizeOverlay.style.display = 'none';
                }
                
                // 保存列宽到本地存储（可选）
                saveColumnWidths();
            });
        }
        
        // 保存列宽到本地存储
        function saveColumnWidths() {
            console.log('保存列宽到本地存储...');
            
            const table = document.getElementById('fault-table');
            if (!table) {
                console.error('保存列宽时找不到表格元素');
                return;
            }
            
            const ths = table.querySelectorAll('thead th');
            const columnWidths = [];
            
            ths.forEach(th => {
                columnWidths.push(th.style.width || th.offsetWidth);
            });
            
            console.log('保存的列宽:', columnWidths);
            
            // 保存到本地存储
            localStorage.setItem('faultTableColumnWidths', JSON.stringify(columnWidths));
        }
        
        // 从本地存储加载列宽
        function loadColumnWidths() {
            console.log('从本地存储加载列宽...');
            
            const savedWidths = localStorage.getItem('faultTableColumnWidths');
            if (!savedWidths) {
                console.log('没有找到保存的列宽');
                return;
            }
            
            try {
                const columnWidths = JSON.parse(savedWidths);
                console.log('加载的列宽:', columnWidths);
                
                const table = document.getElementById('fault-table');
                if (!table) {
                    console.error('加载列宽时找不到表格元素');
                    return;
                }
                
                const ths = table.querySelectorAll('thead th');
                
                // 应用保存的宽度
                columnWidths.forEach((width, index) => {
                    if (ths[index]) {
                        console.log(`应用第${index}列宽度: ${width}`);
                        ths[index].style.width = width;
                        
                        // 同时更新表格列宽度
                        const tableRows = table.querySelectorAll('tbody tr');
                        tableRows.forEach(row => {
                            const tds = row.querySelectorAll('td');
                            if (tds[index]) {
                                tds[index].style.width = width;
                            }
                        });
                    }
                });
                
                console.log('列宽加载完成');
            } catch (e) {
                console.error('加载列宽时出错:', e);
            }
        }
    </script>
</body>
</html>