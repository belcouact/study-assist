<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>故障列表</title>
    <link rel="icon" href="../assets/icons/alex.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 导航栏样式 */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-menu a:hover {
            background-color: #34495e;
        }
        
        /* 主内容区域 */
        main {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            margin-top: 60px; /* 为固定导航栏留出空间 */
        }
        
        .content-header {
            margin-bottom: 2rem;
        }
        
        .content-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .content-description {
            color: #7f8c8d;
        }
        
        .fault-list-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        /* 表格容器样式 - 用于响应式表格 */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* 在iOS上提供平滑滚动 */
        }
        
        .filter-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .filter-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            margin-right: 0.5rem;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 0.5rem;
        }
        
        .filter-button {
            padding: 0.5rem 1rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .filter-button:hover {
            background-color: #2980b9;
        }
        
        .level-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .level-high {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .level-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .level-low {
            background-color: #d4edda;
            color: #155724;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .fault-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .fault-table th, .fault-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .fault-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .fault-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-processing {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        /* 页脚样式 */
        footer {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .footer-divider {
            border-top: 1px solid #34495e;
            margin-bottom: 1rem;
        }
        
        .footer-text {
            font-size: 0.9rem;
            color: #ecf0f1;
        }
        
        /* 模态框样式 */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .detail-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        .detail-col {
            flex: 1;
            min-width: 300px;
            padding-right: 1rem;
        }
        
        .detail-group {
            margin-bottom: 0.8rem;
        }
        
        .detail-group label {
            font-weight: bold;
            margin-right: 0.5rem;
            color: #2c3e50;
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
        }
        
        .detail-section h3 {
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
            margin-bottom: 0.8rem;
        }
        
        .detail-section p {
            line-height: 1.6;
        }
        
        .detail-section ul {
            padding-left: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* 移动端响应式设计 */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .mobile-menu-toggle {
                display: block;
                position: absolute;
                right: 1rem;
                top: 1rem;
            }
            
            .nav-menu {
                flex-direction: column;
                width: 100%;
                margin-top: 1rem;
                display: none;
            }
            
            .nav-menu.active {
                display: flex;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
            }
            
            /* 移动端表格样式 */
            .fault-table {
                font-size: 0.8rem;
                min-width: 800px; /* 确保表格有最小宽度，触发水平滚动 */
            }
            
            .fault-table th, .fault-table td {
                padding: 0.4rem;
                white-space: nowrap; /* 防止文本换行 */
            }
            
            .fault-table th {
                position: sticky;
                top: 0;
                background-color: #f8f9fa;
                z-index: 10;
            }
            
            /* 操作按钮在移动端更紧凑 */
            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            
            main {
                padding: 1rem;
            }
            
            /* 确保表格容器有明确的滚动指示 */
            .table-container {
                margin-bottom: 1rem;
                border-radius: 4px;
                border: 1px solid #e9ecef;
            }
            
            /* 添加滚动提示 */
            .table-container::after {
                content: "← 左右滑动查看更多 →";
                display: block;
                text-align: center;
                color: #6c757d;
                font-size: 0.75rem;
                padding: 0.25rem;
                background-color: #f8f9fa;
                border-top: 1px solid #e9ecef;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <div class="page-title">戈尔设备故障管理</div>
            <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
            <nav class="nav-menu" id="navMenu">
                <a href="index.html">首页</a>
                <a href="fault-list.html">故障列表</a>
                <a href="new-fault.html">新建故障</a>
                <a href="fault-statistics.html">故障统计</a>
                <a href="info-management.html">信息管理</a>
            </nav>
        </div>
    </header>
    
    <main>
        <div class="content-header">
            <h1 class="content-title">故障列表</h1>
            <p class="content-description">查看所有设备故障记录和处理状态</p>
        </div>
        
        <div class="fault-list-container">
            <div class="filter-bar">
                <select id="status-filter" class="filter-select">
                    <option value="">所有状态</option>
                    <option value="待处理">待处理</option>
                    <option value="处理中">处理中</option>
                    <option value="已解决">已解决</option>
                    <option value="已完成">已完成</option>
                </select>
                <select id="level-filter" class="filter-select">
                    <option value="">所有级别</option>
                    <option value="高">高</option>
                    <option value="中">中</option>
                    <option value="低">低</option>
                </select>
                <select id="plant-filter" class="filter-select">
                    <option value="">所有工厂</option>
                </select>
                <select id="category-filter" class="filter-select">
                    <option value="">所有分类</option>
                </select>
                <select id="equipment-filter" class="filter-select">
                    <option value="">所有设备</option>
                </select>
                <select id="area-filter" class="filter-select">
                    <option value="">所有区域</option>
                </select>
                <select id="reporter-filter" class="filter-select">
                    <option value="">所有报告人</option>
                </select>
                <input type="text" id="search-input" class="search-box" placeholder="搜索设备名称、故障类型、故障描述...">
                <button class="filter-button" onclick="filterFaults()">筛选</button>
            </div>
            
            <div id="loading-indicator" style="text-align: center; padding: 20px; display: none;">
                <p>正在加载故障数据...</p>
            </div>
            
            <div id="no-data-message" style="text-align: center; padding: 20px; display: none;">
                <p>暂无故障数据</p>
            </div>
            
            <div class="table-container">
                <table class="fault-table">
                    <thead>
                        <tr>
                            <th>故障ID</th>
                            <th>工厂</th>
                            <th>故障设备</th>
                            <th>故障区域</th>
                            <th>故障分类</th>
                            <th>故障等级</th>
                            <th>故障描述</th>
                            <th>报告时间</th>
                            <th>报告人</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="fault-table-body">
                        <!-- 故障数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="footer-text">网页基于智谱大模型GLM-4.5创建</div>
    </footer>
    
    <script>
        // 移动端菜单切换
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('mobileMenuToggle');
            const navMenu = document.getElementById('navMenu');
            
            if (menuToggle && navMenu) {
                menuToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }

            // 从KV表加载故障数据
            console.log('页面加载完成，开始加载故障数据...');
            loadFaultData();
        });

        // 从KV表加载故障数据
async function loadFaultData() {
    console.log('开始加载故障数据...');
    
    const tableBody = document.getElementById('fault-table-body');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noDataMessage = document.getElementById('no-data-message');
    
    if (!tableBody) return;
    
    // 显示加载指示器
    if (loadingIndicator) loadingIndicator.style.display = 'block';
    if (noDataMessage) noDataMessage.style.display = 'none';
    
    try {
        // 直接调用Worker API获取故障数据
        const apiUrl = 'https://study-llm.me/ws/api/faults';
        console.log('正在请求API:', apiUrl);
        
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('API响应状态:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const faults = await response.json();
        console.log('获取到的故障数据:', faults);
        
        // 清空表格
        tableBody.innerHTML = '';
        
        // 收集所有可能的选项用于筛选器
        const plants = new Set();
        const categories = new Set();
        const equipments = new Set();
        const areas = new Set();
        const reporters = new Set();
                
                if (faults && faults.length > 0) {
                    // 渲染故障数据并收集筛选器选项
                    faults.forEach(fault => {
                        // 收集筛选器选项
                        if (fault.plant) plants.add(fault.plant);
                        if (fault.faultCategory) categories.add(fault.faultCategory);
                        if (fault.equipmentName) equipments.add(fault.equipmentName);
                        if (fault.faultArea) areas.add(fault.faultArea);
                        if (fault.reporter) reporters.add(fault.reporter);
                        
                        const row = document.createElement('tr');
                        
                        // 格式化状态标签
                        let statusClass = '';
                        let statusText = '';
                        
                        switch(fault.status) {
                            case 'pending':
                                statusClass = 'status-pending';
                                statusText = '待处理';
                                break;
                            case 'processing':
                                statusClass = 'status-processing';
                                statusText = '处理中';
                                break;
                            case 'resolved':
                                statusClass = 'status-completed';
                                statusText = '已解决';
                                break;
                            case 'completed':
                                statusClass = 'status-completed';
                                statusText = '已完成';
                                break;
                            default:
                                statusClass = 'status-pending';
                                statusText = '未知';
                        }
                        
                        // 格式化故障级别
                        let levelClass = '';
                        let levelText = '';
                        
                        switch(fault.faultLevel) {
                            case 'high':
                                levelClass = 'level-high';
                                levelText = '高';
                                break;
                            case 'medium':
                                levelClass = 'level-medium';
                                levelText = '中';
                                break;
                            case 'low':
                                levelClass = 'level-low';
                                levelText = '低';
                                break;
                            default:
                                levelClass = 'level-medium';
                                levelText = '中';
                        }
                        
                        // 格式化时间
                        const reportTime = fault.reportTime ? new Date(fault.reportTime).toLocaleString() : '未知时间';
                        
                        // 格式化故障描述，只显示前50个字符
                        const shortDescription = fault.faultDescription && fault.faultDescription.length > 50 
                            ? fault.faultDescription.substring(0, 50) + '...' 
                            : fault.faultDescription || '无描述';
                        
                        row.innerHTML = `
                            <td>${fault.id || '未知'}</td>
                            <td>${fault.plant || '未知工厂'}</td>
                            <td>${fault.equipmentName || '未知设备'}</td>
                            <td>${fault.faultArea || '未知区域'}</td>
                            <td>${fault.faultCategory || '未知分类'}</td>
                            <td><span class="level-badge ${levelClass}">${levelText}</span></td>
                            <td title="${fault.faultDescription || ''}">${shortDescription}</td>
                            <td>${reportTime}</td>
                            <td>${fault.reporter || '未知'}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="viewFaultDetail('${fault.id}')">查看</button>
                                    <button class="btn btn-success" onclick="editFault('${fault.id}')">编辑</button>
                                </div>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // 填充筛选器选项
                    populateFilterOptions('plant-filter', plants);
                    populateFilterOptions('category-filter', categories);
                    populateFilterOptions('equipment-filter', equipments);
                    populateFilterOptions('area-filter', areas);
                    populateFilterOptions('reporter-filter', reporters);
                } else {
                    // 没有数据时显示提示
                    if (noDataMessage) noDataMessage.style.display = 'block';
                }
                
            } catch (error) {
                console.error('加载故障数据失败:', error);
                
                // 显示错误信息
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #e74c3c;">
                            加载故障数据失败: ${error.message}
                        </td>
                    </tr>
                `;
            } finally {
                // 隐藏加载指示器
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }
        
        // 填充筛选器选项
        function populateFilterOptions(filterId, optionsSet) {
            const filterElement = document.getElementById(filterId);
            if (!filterElement) return;
            
            // 保存当前选中的值
            const currentValue = filterElement.value;
            
            // 清空现有选项，保留第一个"所有"选项
            while (filterElement.children.length > 1) {
                filterElement.removeChild(filterElement.lastChild);
            }
            
            // 添加新的选项
            const sortedOptions = Array.from(optionsSet).sort();
            sortedOptions.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                filterElement.appendChild(optionElement);
            });
            
            // 恢复之前选中的值
            filterElement.value = currentValue;
        }

        // 查看故障详情（新页面）
        function viewFaultDetail(faultId) {
            // 跳转到故障详情页面
            window.location.href = `fault-detail.html?id=${faultId}`;
        }
        
        // 编辑故障
        function editFault(faultId) {
            // 跳转到新建故障页面，并传递故障ID用于编辑
            window.location.href = `new-fault.html?id=${faultId}`;
        }

        // 查看故障详情（模态框）- 保留原有函数以防其他地方调用
async function viewFault(faultId) {
    try {
        const response = await fetch(`https://study-llm.me/ws/api/faults/${faultId}`);
        if (response.ok) {
            const fault = await response.json();
            
            // 创建模态框显示故障详情
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>故障详情</h2>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-row">
                            <div class="detail-col">
                                <div class="detail-group">
                                    <label>故障ID:</label>
                                    <span>${fault.id || '未知'}</span>
                                </div>
                                <div class="detail-group">
                                    <label>工厂:</label>
                                    <span>${fault.plant || '未知'}</span>
                                </div>
                                <div class="detail-group">
                                    <label>故障设备:</label>
                                    <span>${fault.equipmentName || '未知'}</span>
                                </div>
                                <div class="detail-group">
                                    <label>故障区域:</label>
                                    <span>${fault.faultArea || '未知'}</span>
                                </div>
                                <div class="detail-group">
                                    <label>故障分类:</label>
                                    <span>${fault.faultCategory || '未知'}</span>
                                </div>
                                <div class="detail-group">
                                    <label>故障等级:</label>
                                    <span>${formatFaultLevel(fault.faultLevel)}</span>
                                </div>
                            </div>
                            <div class="detail-col">
                                <div class="detail-group">
                                    <label>报告时间:</label>
                                    <span>${formatDateTime(fault.reportTime)}</span>
                                </div>
                                <div class="detail-group">
                                    <label>报告人:</label>
                                    <span>${fault.reporter || '未知'}</span>
                                </div>
                                <div class="detail-group">
                                    <label>状态:</label>
                                    <span>${formatFaultStatus(fault.status)}</span>
                                </div>
                                ${fault.handler ? `
                                <div class="detail-group">
                                    <label>处理人:</label>
                                    <span>${fault.handler}</span>
                                </div>
                                ` : ''}
                                ${fault.handleTime ? `
                                <div class="detail-group">
                                    <label>处理时间:</label>
                                    <span>${formatDateTime(fault.handleTime)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3>故障描述</h3>
                            <p>${fault.faultDescription || '无描述'}</p>
                        </div>
                        <div class="detail-section">
                            <h3>故障排查</h3>
                            <p>${fault.troubleshootingSteps || '无排查信息'}</p>
                        </div>
                        <div class="detail-section">
                            <h3>故障根因</h3>
                            <p>${fault.rootCause || '无根因分析'}</p>
                        </div>
                        <div class="detail-section">
                            <h3>故障解决</h3>
                            <p>${fault.resolution || '无解决方案'}</p>
                        </div>
                        ${fault.additionalInfo ? `
                        <div class="detail-section">
                            <h3>补充信息</h3>
                            <p>${fault.additionalInfo}</p>
                        </div>
                        ` : ''}
                        ${fault.fileUpload && fault.fileUpload.length > 0 ? `
                        <div class="detail-section">
                            <h3>上传文件</h3>
                            <ul>
                                ${fault.fileUpload.map(file => `<li>${file}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        ${fault.handleDescription ? `
                        <div class="detail-section">
                            <h3>处理说明</h3>
                            <p>${fault.handleDescription}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 关闭模态框
            const closeBtn = modal.querySelector('.close');
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        } else {
            alert('获取故障详情失败');
        }
    } catch (error) {
        console.error('查看故障详情时出错:', error);
        alert('获取故障详情时出错，请稍后重试');
    }
}

        // 处理故障
        async function processFault(faultId) {
            try {
                // 创建模态框用于处理故障
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>处理故障</h2>
                            <span class="close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="process-fault-form">
                                <div class="form-group">
                                    <label for="process-status">状态:</label>
                                    <select id="process-status" name="status" required>
                                        <option value="pending">待处理</option>
                                        <option value="processing">处理中</option>
                                        <option value="resolved">已解决</option>
                                        <option value="completed">已完成</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="process-handler">处理人:</label>
                                    <input type="text" id="process-handler" name="handler" required>
                                </div>
                                <div class="form-group">
                                    <label for="process-description">处理说明:</label>
                                    <textarea id="process-description" name="handleDescription" rows="4"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="process-resolution">故障解决:</label>
                                    <textarea id="process-resolution" name="resolution" rows="4"></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">提交</button>
                                    <button type="button" class="btn btn-secondary cancel-btn">取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 关闭模态框
                const closeBtn = modal.querySelector('.close');
                const cancelBtn = modal.querySelector('.cancel-btn');
                
                const closeModal = () => {
                    document.body.removeChild(modal);
                };
                
                closeBtn.addEventListener('click', closeModal);
                cancelBtn.addEventListener('click', closeModal);
                
                // 点击模态框外部关闭
                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeModal();
                    }
                });
                
                // 表单提交处理
                const form = document.getElementById('process-fault-form');
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        status: document.getElementById('process-status').value,
                        handler: document.getElementById('process-handler').value,
                        handleDescription: document.getElementById('process-description').value,
                        resolution: document.getElementById('process-resolution').value
                    };
                    
                    try {
                        const response = await fetch(`https://study-llm.me/ws/api/faults/${faultId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        if (response.ok) {
                            alert('故障处理状态已更新');
                            closeModal();
                            // 重新加载故障列表
                            loadFaultData();
                        } else {
                            const errorData = await response.json();
                            alert(`更新失败: ${errorData.error || '未知错误'}`);
                        }
                    } catch (error) {
                        console.error('更新故障状态时出错:', error);
                        alert('更新故障状态时出错，请稍后重试');
                    }
                });
            } catch (error) {
                console.error('处理故障时出错:', error);
                alert('处理故障时出错，请稍后重试');
            }
        }

// 删除故障
        async function deleteFault(faultId) {
            if (confirm('确定要删除此故障记录吗？此操作不可撤销。')) {
                try {
                    const response = await fetch(`https://study-llm.me/ws/api/faults/${faultId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('故障记录已删除');
                        // 重新加载故障列表
                        loadFaultData();
                    } else {
                        const errorData = await response.json();
                        alert(`删除失败: ${errorData.error || '未知错误'}`);
                    }
                } catch (error) {
                    console.error('删除故障时出错:', error);
                    alert('删除故障时出错，请稍后重试');
                }
            }
        }

        // 格式化故障等级
        function formatFaultLevel(level) {
            switch(level) {
                case 'high': return '高';
                case 'medium': return '中';
                case 'low': return '低';
                default: return '未知';
            }
        }
        
        // 格式化故障状态
        function formatFaultStatus(status) {
            switch(status) {
                case 'pending': return '待处理';
                case 'processing': return '处理中';
                case 'resolved': return '已解决';
                case 'completed': return '已完成';
                default: return '未知';
            }
        }
        
        // 格式化日期时间
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '未知时间';
            const date = new Date(dateTimeString);
            return date.toLocaleString();
        }
        
        // 筛选功能
        function filterFaults() {
            const statusFilter = document.getElementById('status-filter').value;
            const levelFilter = document.getElementById('level-filter').value;
            const plantFilter = document.getElementById('plant-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const equipmentFilter = document.getElementById('equipment-filter').value;
            const areaFilter = document.getElementById('area-filter').value;
            const reporterFilter = document.getElementById('reporter-filter').value;
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            
            const rows = document.querySelectorAll('#fault-table-body tr');
            
            rows.forEach(row => {
                const statusCell = row.querySelector('td:nth-child(9) .status-badge');
                const levelCell = row.querySelector('td:nth-child(6) .level-badge');
                const plantCell = row.querySelector('td:nth-child(2)');
                const equipmentCell = row.querySelector('td:nth-child(3)');
                const areaCell = row.querySelector('td:nth-child(4)');
                const categoryCell = row.querySelector('td:nth-child(5)');
                const reporterCell = row.querySelector('td:nth-child(9)');
                const descriptionCell = row.querySelector('td:nth-child(7)');
                
                const status = statusCell ? statusCell.textContent : '';
                const level = levelCell ? levelCell.textContent : '';
                const plant = plantCell ? plantCell.textContent : '';
                const equipment = equipmentCell ? equipmentCell.textContent : '';
                const area = areaCell ? areaCell.textContent : '';
                const category = categoryCell ? categoryCell.textContent : '';
                const reporter = reporterCell ? reporterCell.textContent : '';
                const description = descriptionCell ? descriptionCell.textContent : '';
                
                const statusMatch = !statusFilter || status === statusFilter;
                const levelMatch = !levelFilter || level === levelFilter;
                const plantMatch = !plantFilter || plant === plantFilter;
                const categoryMatch = !categoryFilter || category === categoryFilter;
                const equipmentMatch = !equipmentFilter || equipment === equipmentFilter;
                const areaMatch = !areaFilter || area === areaFilter;
                const reporterMatch = !reporterFilter || reporter === reporterFilter;
                const searchMatch = !searchInput || 
                    plant.toLowerCase().includes(searchInput) || 
                    equipment.toLowerCase().includes(searchInput) ||
                    area.toLowerCase().includes(searchInput) ||
                    category.toLowerCase().includes(searchInput) ||
                    description.toLowerCase().includes(searchInput);
                
                if (statusMatch && levelMatch && plantMatch && categoryMatch && equipmentMatch && areaMatch && reporterMatch && searchMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // 添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始加载故障数据...');
            
            const statusFilter = document.getElementById('status-filter');
            const levelFilter = document.getElementById('level-filter');
            const plantFilter = document.getElementById('plant-filter');
            const categoryFilter = document.getElementById('category-filter');
            const equipmentFilter = document.getElementById('equipment-filter');
            const areaFilter = document.getElementById('area-filter');
            const reporterFilter = document.getElementById('reporter-filter');
            const searchInput = document.getElementById('search-input');
            
            if (statusFilter) statusFilter.addEventListener('change', filterFaults);
            if (levelFilter) levelFilter.addEventListener('change', filterFaults);
            if (plantFilter) plantFilter.addEventListener('change', filterFaults);
            if (categoryFilter) categoryFilter.addEventListener('change', filterFaults);
            if (equipmentFilter) equipmentFilter.addEventListener('change', filterFaults);
            if (areaFilter) areaFilter.addEventListener('change', filterFaults);
            if (reporterFilter) reporterFilter.addEventListener('change', filterFaults);
            if (searchInput) searchInput.addEventListener('input', filterFaults);
            
            // 加载故障数据
            loadFaultData();
        });
    </script>
</body>
</html>