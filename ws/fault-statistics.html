<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>故障统计</title>
    <link rel="icon" href="../assets/icons/alex.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <script src="language.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 导航栏样式 */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-menu a:hover {
            background-color: #34495e;
        }
        
        /* 主内容区域 */
        main {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            margin-top: 60px; /* 为固定导航栏留出空间 */
        }
        
        .content-header {
            margin-bottom: 2rem;
        }
        
        .content-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .content-description {
            color: #7f8c8d;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .chart-filter {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-select {
            padding: 0.5rem 1rem;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 120px;
        }
        
        .filter-select:hover {
            border-color: #3498db;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .filter-button {
            padding: 0.5rem 1rem;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .filter-button:hover {
            background-color: #e9ecef;
        }
        
        .filter-button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .chart-placeholder {
            height: 300px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
        }
        
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            overflow-x: auto;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .stats-table th, .stats-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .stats-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .stats-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .trend-up {
            color: #e74c3c;
        }
        
        .trend-down {
            color: #2ecc71;
        }
        
        /* 页脚样式 */
        footer {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .footer-divider {
            border-top: 1px solid #34495e;
            margin-bottom: 1rem;
        }
        
        .footer-text {
            font-size: 0.9rem;
            color: #ecf0f1;
        }
        
        /* 移动端响应式设计 */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .mobile-menu-toggle {
                display: block;
                position: absolute;
                right: 1rem;
                top: 1rem;
            }
            
            .nav-menu {
                flex-direction: column;
                width: 100%;
                margin-top: 1rem;
                display: none;
            }
            
            .nav-menu.active {
                display: flex;
            }
            
            .stats-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .chart-filter {
                width: 100%;
                overflow-x: auto;
            }
            
            main {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <div class="page-title" data-lang="page-title">戈尔设备故障管理</div>
            <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
            <nav class="nav-menu" id="navMenu">
                <a href="index.html" data-lang="nav-home">首页</a>
                <a href="fault-list.html" data-lang="nav-fault-list">故障列表</a>
                <a href="new-fault.html" data-lang="nav-new-fault">新建故障</a>
                <a href="fault-statistics.html" data-lang="nav-fault-stats">故障统计</a>
                <a href="info-management.html" data-lang="nav-info-mgmt">信息管理</a>
            </nav>
        </div>
    </header>
    
    <main>
        <div class="content-header">
            <h1 class="content-title" data-lang="fault-stats-title">故障统计</h1>
            <p class="content-description" data-lang="fault-stats-description">查看设备故障数据分析与趋势</p>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-value" id="totalFaults">-</div>
                <div class="stat-label" data-lang="stat-total-faults">故障总数</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">🔄</div>
                <div class="stat-value" id="inProgressFaults">-</div>
                <div class="stat-label" data-lang="stat-processing">处理中</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">⏳</div>
                <div class="stat-value" id="pendingFaults">-</div>
                <div class="stat-label" data-lang="stat-pending">待处理</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">🚨</div>
                <div class="stat-value" id="urgentFaults">-</div>
                <div class="stat-label" data-lang="stat-urgent">紧急故障数</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title" data-lang="chart-distribution-title">故障分布</h2>
                <div class="chart-filter">
                    <select id="faultTypeFilter" class="filter-select">
                            <option value="faultCategory" data-lang="filter-category">故障分类</option>
                            <option value="plant" data-lang="filter-plant">工厂</option>
                            <option value="equipmentName" data-lang="filter-equipment">故障设备</option>
                            <option value="faultArea" data-lang="filter-area">故障区域</option>
                            <option value="faultLevel" data-lang="filter-level">故障等级</option>
                            <option value="reporter" data-lang="filter-reporter">报告人</option>
                            <option value="status" data-lang="filter-status">状态</option>
                        </select>
                </div>
            </div>
            <div id="faultTypeChart" class="chart-placeholder">
                <p data-lang="chart-distribution-placeholder">故障类型分布图表将显示在这里</p>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title" data-lang="chart-trend-title">故障时间趋势</h2>
                <div class="chart-filter">
                    <select id="trendFilter" class="filter-select">
                            <option value="month" data-lang="filter-month">按月统计</option>
                            <option value="quarter" data-lang="filter-quarter">按季度统计</option>
                            <option value="year" data-lang="filter-year">按年统计</option>
                        </select>
                </div>
            </div>
            <div id="trendChart" class="chart-placeholder">
                <p data-lang="chart-trend-placeholder">故障时间趋势图表将显示在这里</p>
            </div>
        </div>
        
    </main>
    
    <footer>
        <div class="footer-text">网页基于智谱大模型GLM-4.5创建</div>
    </footer>
    
    <script>
        // 移动端菜单切换
        document.getElementById('mobileMenuToggle').addEventListener('click', function() {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('active');
        });
        
        // 点击页面任意位置隐藏导航菜单
        document.addEventListener('click', function(event) {
            const navMenu = document.getElementById('navMenu');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            
            // 如果点击的不是菜单按钮且菜单是展开状态，则关闭菜单
            if (!mobileMenuToggle.contains(event.target) && navMenu.classList.contains('active')) {
                navMenu.classList.remove('active');
            }
        });
        
        // 图表筛选按钮切换
        document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // 如果是设备/区域分布的筛选按钮，更新图表
                if (this.closest('.chart-header').querySelector('.chart-title').textContent === '故障设备和区域分布') {
                    updateEquipmentAreaChart(this.textContent);
                }
            });
        });
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            fetchFaultData();
            
            // 添加下拉筛选器事件监听
            const filterSelect = document.getElementById('faultTypeFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', function() {
                    updateFaultTypeChart(this.value);
                });
            }
            
            // 添加趋势图表筛选器事件监听
            const trendFilter = document.getElementById('trendFilter');
            if (trendFilter) {
                trendFilter.addEventListener('change', function() {
                    updateTrendChart(this.value);
                });
            }
            
            // 移除访客访问控制 - 信息管理链接对所有用户可见
        });
        
        // 从KV数据集获取故障数据
        async function fetchFaultData() {
            try {
                const response = await fetch('https://study-llm.me/ws/api/faults');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const faults = await response.json();
                updateStatisticsCards(faults);
                initFaultTypeChart(faults);
                initTrendChart(faults);
            } catch (error) {
                console.error('获取故障数据失败:', error);
                // 如果API不可用，使用模拟数据
                const mockFaults = generateMockFaultData();
                updateStatisticsCards(mockFaults);
                initFaultTypeChart(mockFaults);
                initTrendChart(mockFaults);
            }
        }
        
        // 生成模拟数据（仅用于演示，实际应用中应使用真实数据）
        function generateMockFaultData() {
            const plants = ['工厂A', '工厂B', '工厂C'];
            const equipmentNames = ['生产线1', '生产线2', '检测仪1', '检测仪2', '传送带1', '传送带2'];
            const faultAreas = ['区域1', '区域2', '区域3'];
            const faultCategories = ['电气', '机械', '软件', '其他'];
            const faultLevels = ['低', '中', '高', '紧急'];
            const statuses = ['pending', 'in-progress', 'resolved'];
            const reporters = ['张三', '李四', '王五', '赵六', '钱七', '孙八'];
            
            const mockFaults = [];
            for (let i = 0; i < 30; i++) {
                mockFaults.push({
                    id: `fault-${i}`,
                    plant: plants[Math.floor(Math.random() * plants.length)],
                    equipmentName: equipmentNames[Math.floor(Math.random() * equipmentNames.length)],
                    faultArea: faultAreas[Math.floor(Math.random() * faultAreas.length)],
                    faultCategory: faultCategories[Math.floor(Math.random() * faultCategories.length)],
                    faultLevel: faultLevels[Math.floor(Math.random() * faultLevels.length)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    reporter: reporters[Math.floor(Math.random() * reporters.length)],
                    reportTime: new Date(Date.now() - Math.floor(Math.random() * 30 * 24 * 60 * 60 * 1000)).toISOString()
                });
            }
            return mockFaults;
        }
        
        // 更新统计卡片
        function updateStatisticsCards(faults) {
            const totalFaults = faults.length;
            const inProgressFaults = faults.filter(f => f.status === 'processing').length;
            const pendingFaults = faults.filter(f => f.status === 'pending').length;
            const urgentFaults = faults.filter(f => f.faultLevel === 'urgent' && f.status !== 'resolved').length;
            
            document.getElementById('totalFaults').textContent = totalFaults;
            document.getElementById('inProgressFaults').textContent = inProgressFaults;
            document.getElementById('pendingFaults').textContent = pendingFaults;
            document.getElementById('urgentFaults').textContent = urgentFaults;
        }
        
        // 全局变量存储故障数据
        let globalFaultsData = [];
        
        // 初始化故障类型分布图表（支持下拉筛选）
        function initFaultTypeChart(faults) {
            globalFaultsData = faults; // 存储数据供后续使用
            updateFaultTypeChart('faultCategory'); // 默认按故障分类显示
        }
        
        // 更新故障类型分布图表（根据筛选条件）
        function updateFaultTypeChart(filterType) {
            const chartDom = document.getElementById('faultTypeChart');
            const myChart = echarts.init(chartDom);
            
            if (!globalFaultsData || globalFaultsData.length === 0) {
                // 如果没有数据，重新获取
                fetch('https://study-llm.me/ws/api/faults')
                    .then(response => response.json())
                    .then(data => {
                        globalFaultsData = data;
                        updateFaultTypeChart(filterType);
                    })
                    .catch(error => {
                        console.error('获取故障数据失败:', error);
                        const mockFaults = generateMockFaultData();
                        globalFaultsData = mockFaults;
                        updateFaultTypeChart(filterType);
                    });
                return;
            }
            
            // 根据筛选类型统计故障数量
            const countData = {};
            const fieldNames = {
                'faultCategory': '故障分类',
                'plant': '工厂',
                'equipmentName': '故障设备',
                'faultArea': '故障区域',
                'faultLevel': '故障等级',
                'reporter': '报告人',
                'status': '状态'
            };
            
            globalFaultsData.forEach(fault => {
                const key = fault[filterType] || '未知';
                countData[key] = (countData[key] || 0) + 1;
            });
            
            const data = Object.keys(countData).map(name => ({
                name: name,
                value: countData[name]
            }));
            
            const option = {
                title: {
                    text: `按${fieldNames[filterType]}分布`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: data.map(item => item.name)
                },
                series: [
                    {
                        name: fieldNames[filterType],
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: data
                    }
                ]
            };
            
            myChart.setOption(option);
            
            // 响应式调整
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }
        
        // 初始化设备和区域分布图表
        function initEquipmentAreaChart(faults) {
            const chartDom = document.getElementById('equipmentAreaChart');
            const myChart = echarts.init(chartDom);
            
            // 默认显示按设备分布
            updateEquipmentAreaChart('按设备', faults, myChart);
            
            // 响应式调整
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }
        
        // 更新设备和区域分布图表
        function updateEquipmentAreaChart(type, faults, myChart) {
            if (!myChart) {
                const chartDom = document.getElementById('equipmentAreaChart');
                myChart = echarts.init(chartDom);
            }
            
            if (!faults) {
                // 如果没有传入faults数据，重新获取
                fetch('https://study-llm.me/ws/api/faults')
                    .then(response => response.json())
                    .then(data => {
                        updateEquipmentAreaChart(type, data, myChart);
                    })
                    .catch(error => {
                        console.error('获取故障数据失败:', error);
                        const mockFaults = generateMockFaultData();
                        updateEquipmentAreaChart(type, mockFaults, myChart);
                    });
                return;
            }
            
            let data = [];
            let title = '';
            
            if (type === '按设备') {
                // 按设备统计故障数量
                const equipmentCount = {};
                faults.forEach(fault => {
                    if (fault.equipmentName) {
                        equipmentCount[fault.equipmentName] = (equipmentCount[fault.equipmentName] || 0) + 1;
                    }
                });
                
                data = Object.keys(equipmentCount).map(name => ({
                    name: name,
                    value: equipmentCount[name]
                }));
                
                title = '故障设备分布';
            } else {
                // 按区域统计故障数量
                const areaCount = {};
                faults.forEach(fault => {
                    if (fault.faultArea) {
                        areaCount[fault.faultArea] = (areaCount[fault.faultArea] || 0) + 1;
                    }
                });
                
                data = Object.keys(areaCount).map(name => ({
                    name: name,
                    value: areaCount[name]
                }));
                
                title = '故障区域分布';
            }
            
            const option = {
                title: {
                    text: title,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: data.map(item => item.name)
                },
                series: [
                    {
                        name: title,
                        type: 'pie',
                        radius: '50%',
                        center: ['60%', '50%'],
                        data: data,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };
            
            myChart.setOption(option);
        }
        
        // 初始化故障类型分布图表
        function initFaultTypeChart(faults) {
            const chartDom = document.getElementById('faultTypeChart');
            const myChart = echarts.init(chartDom);
            
            // 按故障类型统计
            const categoryCount = {};
            faults.forEach(fault => {
                if (fault.faultCategory) {
                    categoryCount[fault.faultCategory] = (categoryCount[fault.faultCategory] || 0) + 1;
                }
            });
            
            const data = Object.keys(categoryCount).map(name => ({
                name: name,
                value: categoryCount[name]
            }));
            
            const option = {
                title: {
                    text: '故障分布',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: data.map(item => item.name)
                },
                series: [
                    {
                        name: '故障类型',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: data
                    }
                ]
            };
            
            myChart.setOption(option);
            
            // 响应式调整
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }
        
        // 初始化趋势图表
        function initTrendChart(faults) {
            globalFaultsData = faults; // 存储数据供后续使用
            updateTrendChart('month'); // 默认按月显示
        }
        
        // 更新趋势图表
        function updateTrendChart(timeUnit) {
            const chartDom = document.getElementById('trendChart');
            const myChart = echarts.init(chartDom);
            
            if (!globalFaultsData || globalFaultsData.length === 0) {
                // 如果没有数据，重新获取
                fetch('https://study-llm.me/ws/api/faults')
                    .then(response => response.json())
                    .then(data => {
                        globalFaultsData = data;
                        updateTrendChart(timeUnit);
                    })
                    .catch(error => {
                        console.error('获取故障数据失败:', error);
                        const mockFaults = generateMockFaultData();
                        globalFaultsData = mockFaults;
                        updateTrendChart(timeUnit);
                    });
                return;
            }
            
            // 按时间单位统计故障数量
            const countData = {};
            
            globalFaultsData.forEach(fault => {
                if (!fault.reportTime) return;
                
                const date = new Date(fault.reportTime);
                let key = '';
                
                if (timeUnit === 'month') {
                    // 按年月统计，格式：YYYY-MM
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                } else if (timeUnit === 'quarter') {
                    // 按季度统计，格式：YYYY-QX
                    const quarter = Math.floor(date.getMonth() / 3) + 1;
                    key = `${date.getFullYear()}-Q${quarter}`;
                } else if (timeUnit === 'year') {
                    // 按年统计，格式：YYYY
                    key = `${date.getFullYear()}`;
                }
                
                countData[key] = (countData[key] || 0) + 1;
            });
            
            // 对时间单位进行排序
            const sortedKeys = Object.keys(countData).sort();
            
            const data = sortedKeys.map(key => ({
                name: key,
                value: countData[key]
            }));
            
            const unitNames = {
                'month': '月',
                'quarter': '季度',
                'year': '年'
            };
            
            const option = {
                title: {
                    text: `按${unitNames[timeUnit]}统计故障数量`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: '{b}: {c} 个故障'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: true,
                    data: sortedKeys,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '故障数量'
                },
                series: [
                    {
                        name: '故障数量',
                        type: 'bar',
                        data: sortedKeys.map(key => countData[key]),
                        itemStyle: {
                            color: '#3498db'
                        },
                        markPoint: {
                            data: [
                                { type: 'max', name: '最大值' },
                                { type: 'min', name: '最小值' }
                            ]
                        }
                    }
                ]
            };
            
            myChart.setOption(option);
            
            // 响应式调整
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }
    </script>
</body>
</html>