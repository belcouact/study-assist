<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库数据上传 - 学习助手</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .upload-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        .upload-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .section-title {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #333;
            font-size: 1.8rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .select-group {
            min-width: 250px;
            margin-bottom: 20px;
        }
        .select-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        .select-group select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #3a0ca3, #4361ee);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
            border: none;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #4361ee, #4cc9f0);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .preview-table-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        .preview-table th {
            position: sticky;
            top: 0;
            background: #f0f2f5;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
            z-index: 1;
        }
        .preview-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            color: #444;
        }
        .preview-table tr:hover {
            background-color: #f9f9f9;
        }
        .status {
            margin-top: 20px;
            padding: 12px 15px;
            border-radius: 6px;
            font-weight: 500;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #e6f7ff;
            color: #0070f3;
            border: 1px solid #b8e2fc;
        }
        .loader {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            margin: 0 auto;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .upload-container {
                padding: 1rem;
                margin: 1rem;
            }
            .btn {
                width: 100%;
                min-height: 48px;
            }
            .preview-table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="upload-container">
        <h1>数据库数据上传</h1>
        <div class="upload-section">
            <h2 class="section-title">选择数据类型并上传</h2>
            <div class="select-group">
                <label for="table-select">选择数据类型/表</label>
                <select id="table-select" class="form-control">
                    <option value="">-- 请选择数据类型 --</option>
                    <option value="chinese_dynasty">中国朝代历史</option>
                    <option value="chinese_poem">中国古诗词</option>
                    <option value="quote">名言名句</option>
                    <option value="world_history">世界历史</option>
                    <option value="vocabulary">词汇表</option>
                </select>
            </div>
            <input type="file" id="excel-file" class="file-input" accept=".xlsx, .xls" disabled />
            <div class="button-row">
                <button id="preview-data" class="btn btn-secondary" disabled>预览数据</button>
                <button id="upload-data" class="btn btn-primary" disabled>上传到数据库</button>
            </div>
            <div id="status-message" class="status info" style="display: none;"></div>
            <div class="preview-table-container" id="preview-table-container" style="display:none;">
                <table class="preview-table">
                    <thead id="table-header">
                        <tr></tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            <div id="loader" class="loader"></div>
        </div>
    </div>
    <script>
        // Table config: headers and upload endpoint
        const tableConfigs = {
            chinese_dynasty: {
                headers: ["Number", "Dynasty", "Period", "Title", "Event", "Significance"],
                endpoint: "/api/db/upload/chinese_dynasty"
            },
            chinese_poem: {
                headers: ["Title", "Number", "Poem", "Remark_1", "Remark_2", "Remark_3", "Author", "Dynasty"],
                endpoint: "/api/db/upload/chinese_poem"
            },
            quote: {
                headers: ["Number", "Type", "Chinese", "English", "Remark_1", "Remark_2"],
                endpoint: "/api/db/upload/quote"
            },
            world_history: {
                headers: ["CATEGORY", "REGION", "PERIOD", "SUB_CATEGORY_1", "SUB_CATEGORY_2", "TITLE", "BACKGROUND", "EVENT", "IMPACT", "REMARK_1", "REMARK_2", "REMARK_3"],
                endpoint: "/api/db/upload/world_history"
            },
            vocabulary: {
                headers: ["Word_Rank", "Word", "Word_ID", "US_Pronunciation", "UK_Pronunciation", "US_Speech", "UK_Speech", "Translations", "Synonyms", "Example_Sentences", "Remark_1", "Remark_2", "Remark_3", "Remark_4", "Remark_5"],
                endpoint: "/api/db/upload/vocabulary"
            }
        };
        let currentTable = "";
        let previewData = [];
        const tableSelect = document.getElementById('table-select');
        const excelFileInput = document.getElementById('excel-file');
        const previewBtn = document.getElementById('preview-data');
        const uploadBtn = document.getElementById('upload-data');
        const statusMsg = document.getElementById('status-message');
        const loader = document.getElementById('loader');
        const previewTableContainer = document.getElementById('preview-table-container');
        const tableHeader = document.getElementById('table-header').querySelector('tr');
        const tableBody = document.getElementById('table-body');

        tableSelect.addEventListener('change', function() {
            currentTable = this.value;
            previewData = [];
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            previewTableContainer.style.display = 'none';
            statusMsg.style.display = 'none';
            excelFileInput.value = '';
            excelFileInput.disabled = !currentTable;
            previewBtn.disabled = true;
            uploadBtn.disabled = true;
        });

        excelFileInput.addEventListener('change', function() {
            previewBtn.disabled = !this.files.length;
            uploadBtn.disabled = true;
            previewTableContainer.style.display = 'none';
            statusMsg.style.display = 'none';
        });

        previewBtn.addEventListener('click', function() {
            if (!excelFileInput.files.length || !currentTable) return;
            loader.style.display = 'block';
            statusMsg.style.display = 'none';
            const file = excelFileInput.files[0];
            const config = tableConfigs[currentTable];
            const headers = config.headers;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    previewData = jsonData;
                    // Render table
                    tableHeader.innerHTML = '';
                    headers.forEach(h => {
                        const th = document.createElement('th');
                        th.textContent = h;
                        tableHeader.appendChild(th);
                    });
                    tableBody.innerHTML = '';
                    jsonData.slice(0, 10).forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = headers.map(h => `<td>${row[h] || ''}</td>`).join('');
                        tableBody.appendChild(tr);
                    });
                    previewTableContainer.style.display = '';
                    uploadBtn.disabled = false;
                } catch (error) {
                    statusMsg.textContent = '预览失败: ' + error.message;
                    statusMsg.className = 'status error';
                    statusMsg.style.display = '';
                    previewTableContainer.style.display = 'none';
                } finally {
                    loader.style.display = 'none';
                }
            };
            reader.onerror = function(error) {
                statusMsg.textContent = '文件读取失败: ' + error;
                statusMsg.className = 'status error';
                statusMsg.style.display = '';
                loader.style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        });

        uploadBtn.addEventListener('click', async function() {
            if (!previewData.length || !currentTable) return;
            loader.style.display = 'block';
            statusMsg.style.display = 'none';
            const config = tableConfigs[currentTable];
            try {
                const response = await fetch(config.endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: previewData })
                });
                const result = await response.json();
                if (result.success) {
                    statusMsg.textContent = `上传成功！共上传 ${result.insertedCount || previewData.length} 条记录`;
                    statusMsg.className = 'status success';
                } else {
                    throw new Error(result.error || result.message || '未知错误');
                }
            } catch (error) {
                statusMsg.textContent = '上传失败: ' + error.message;
                statusMsg.className = 'status error';
            } finally {
                statusMsg.style.display = '';
                loader.style.display = 'none';
            }
        });
    </script>
</body>
</html> 